---
phase: 03-catalog-storefront-seed-data
plan: 05
type: execute
wave: 3
depends_on: ["03-03"]
files_modified:
  - code/MicroCommerce.Web/src/components/storefront/product-filters.tsx
  - code/MicroCommerce.Web/src/components/storefront/search-bar.tsx
  - code/MicroCommerce.Web/src/components/storefront/header.tsx
  - code/MicroCommerce.Web/src/app/(storefront)/page.tsx
  - code/MicroCommerce.Web/src/components/storefront/product-grid.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter products by clicking category chips"
    - "User can search products by typing in search bar with instant results"
    - "User can sort products by price, name, or newest"
    - "Filter, search, and sort state is in the URL (shareable links)"
    - "Changing filters resets the product grid and loads fresh results"
  artifacts:
    - path: "code/MicroCommerce.Web/src/components/storefront/product-filters.tsx"
      provides: "Category chips and sort dropdown"
      min_lines: 40
    - path: "code/MicroCommerce.Web/src/components/storefront/search-bar.tsx"
      provides: "Debounced search input"
      min_lines: 25
  key_links:
    - from: "src/components/storefront/product-filters.tsx"
      to: "URL search params"
      via: "Updates categoryId and sortBy in URL"
      pattern: "searchParams|URLSearchParams|router\\.push|router\\.replace"
    - from: "src/components/storefront/search-bar.tsx"
      to: "URL search params"
      via: "Debounced update of search param in URL"
      pattern: "setTimeout|search.*param"
    - from: "src/components/storefront/product-grid.tsx"
      to: "URL search params"
      via: "Reads categoryId, search, sortBy from URL to pass to API"
      pattern: "searchParams|categoryId|sortBy"
---

<objective>
Add category filtering, search, and sort controls with URL-synced state to the storefront.

Purpose: Fulfills CAT-03 (filter by category) and CAT-04 (search by name/description). Sort options complete the browsing experience. URL state makes filter combinations shareable and supports browser back/forward navigation.
Output: Category chip filters, debounced search bar in header, sort dropdown, all synced to URL params and driving the product grid.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-catalog-storefront-seed-data/03-CONTEXT.md
@.planning/phases/03-catalog-storefront-seed-data/03-RESEARCH.md
@.planning/phases/03-catalog-storefront-seed-data/03-03-SUMMARY.md

@code/MicroCommerce.Web/src/lib/api.ts
@code/MicroCommerce.Web/src/app/(storefront)/page.tsx
@code/MicroCommerce.Web/src/components/storefront/product-grid.tsx
@code/MicroCommerce.Web/src/components/storefront/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search bar with debounce and category/sort filter controls</name>
  <files>
    code/MicroCommerce.Web/src/components/storefront/search-bar.tsx
    code/MicroCommerce.Web/src/components/storefront/product-filters.tsx
    code/MicroCommerce.Web/src/components/storefront/header.tsx
  </files>
  <action>
    1. **Create `src/components/storefront/search-bar.tsx`:**
       - `"use client"` component
       - Input field with Search icon (lucide-react) and clear button (X icon when text present)
       - Local state for input value (immediate feedback while typing)
       - Debounce: after 300ms of no typing, update URL search param `search` via `useRouter().replace()`
       - On mount, read initial value from URL search params via `useSearchParams()`
       - When URL search param changes externally, sync local state
       - Styling: rounded input with icon prefix, matching Apple Store clean look
       - Use shadcn Input component as base

    2. **Update `src/components/storefront/header.tsx`:**
       - Replace the search icon placeholder with the actual SearchBar component
       - Position it in the center or right area of the header
       - On mobile, search bar can collapse to just an icon that expands on tap, or remain always visible (Claude's discretion on mobile UX)

    3. **Create `src/components/storefront/product-filters.tsx`:**
       - `"use client"` component
       - Fetches categories via `getCategories()` on mount
       - **Category chips:** Row of pill/chip buttons, one per category plus "All" option. Active chip is visually distinct (filled vs outlined). Clicking updates `categoryId` URL param. "All" removes the categoryId param.
       - **Sort dropdown:** Select/dropdown with options: "Newest" (default), "Price: Low to High", "Price: High to Low", "Name: A-Z". Changing updates `sortBy` and `sortDirection` URL params.
       - Layout: Categories on left, sort on right, in a single row. Wraps on mobile.
       - Use `useSearchParams()` to read current state, `useRouter().replace()` to update
       - When updating any param, preserve other existing params (don't lose search when changing category)

    URL param mapping:
    - `search` -> search text
    - `category` -> categoryId (use the UUID)
    - `sort` -> one of: "newest", "price-asc", "price-desc", "name-asc"

    Parse `sort` into `sortBy` and `sortDirection` before passing to API.
  </action>
  <verify>
    `cd code/MicroCommerce.Web && npm run build` succeeds. Read search-bar.tsx to confirm debounce logic with setTimeout/clearTimeout. Read product-filters.tsx to confirm category chips and sort dropdown both update URL params.
  </verify>
  <done>
    Search bar in header debounces input and updates URL. Category chips and sort dropdown render below hero and update URL params. All preserve each other's state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire filter state from URL into product grid</name>
  <files>
    code/MicroCommerce.Web/src/app/(storefront)/page.tsx
    code/MicroCommerce.Web/src/components/storefront/product-grid.tsx
  </files>
  <action>
    1. **Update `src/app/(storefront)/page.tsx`:**
       - Add `ProductFilters` component between the hero and the product grid
       - Read URL search params and pass them to ProductGrid as props: `categoryId`, `search`, `sortBy`, `sortDirection`
       - Since this page needs to read searchParams, it must use `"use client"` or receive searchParams as a page prop (Next.js App Router pages receive searchParams). Use the `searchParams` page prop approach if possible, otherwise wrap in a client component.
       - Parse the `sort` URL param into sortBy/sortDirection (e.g., "price-asc" -> sortBy="price", sortDirection="asc")

    2. **Update `src/components/storefront/product-grid.tsx`:**
       - Accept filter props: `categoryId?: string`, `search?: string`, `sortBy?: string`, `sortDirection?: string`
       - When any filter prop changes, reset products array to empty, set page back to 1, and refetch
       - Use a `key` prop or useEffect dependency array to handle resets cleanly
       - Pass filter props to the `getStorefrontProducts` call (or getProducts with status='Published')
       - Ensure the grid still handles infinite scroll correctly after filter changes

    The flow: User types in search -> URL updates after 300ms -> page reads new searchParams -> passes to ProductGrid -> grid resets and fetches filtered results.

    IMPORTANT: Avoid useEffect dependency chains. Use a single consolidated fetch function that reads all current filter values.
  </action>
  <verify>
    `cd code/MicroCommerce.Web && npm run build` succeeds. Read page.tsx to confirm it passes filter params from URL to ProductGrid. Read product-grid.tsx to confirm it resets and refetches when filter props change.
  </verify>
  <done>
    Changing category chip filters products to that category. Typing in search filters by name/description after 300ms debounce. Changing sort reorders results. All filters work together. URL is shareable.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- Clicking a category chip updates URL and shows only matching products
- Typing in search shows filtered results after debounce
- Changing sort dropdown reorders the grid
- Combining filters works (search + category + sort)
- Browser back button restores previous filter state
- Infinite scroll still works with filters applied
</verification>

<success_criteria>
- Category filter chips show all categories plus "All"
- Search debounces at 300ms and updates URL
- Sort dropdown offers 4 options (newest, price asc/desc, name)
- All filter state lives in URL search params
- ProductGrid resets and refetches on filter change
- Filters compose correctly (can search within a category with sort)
</success_criteria>

<output>
After completion, create `.planning/phases/03-catalog-storefront-seed-data/03-05-SUMMARY.md`
</output>
