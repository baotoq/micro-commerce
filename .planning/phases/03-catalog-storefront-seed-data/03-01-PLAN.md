---
phase: 03-catalog-storefront-seed-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQuery.cs
  - code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs
  - code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDbContext.cs
  - code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDataSeeder.cs
  - code/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "API returns products sorted by price-asc, price-desc, name-asc, or newest"
    - "Fresh database has ~50 sample products across electronics categories after startup"
    - "Seed data only runs when tables are empty (idempotent)"
  artifacts:
    - path: "code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQuery.cs"
      provides: "SortBy and SortDirection parameters"
      contains: "SortBy"
    - path: "code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDataSeeder.cs"
      provides: "Seed data with ~50 products across categories"
      min_lines: 100
  key_links:
    - from: "GetProductsQueryHandler.cs"
      to: "GetProductsQuery.cs"
      via: "SortBy/SortDirection applied in OrderBy clause"
      pattern: "SortBy|OrderBy"
    - from: "CatalogDataSeeder.cs"
      to: "CatalogDbContext.cs"
      via: "Seeds categories and products using domain factory methods"
      pattern: "Product\\.Create|Category\\.Create"
---

<objective>
Add sort support to the products query API and create seed data for ~50 electronics products.

Purpose: The storefront needs sort options (price, name, newest) and sample data to display. Without sort support the frontend cannot offer sorting. Without seed data there is nothing to browse.
Output: Extended GetProductsQuery with SortBy/SortDirection, CatalogDataSeeder that populates ~50 products across 6-8 electronics categories on first startup.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-catalog-storefront-seed-data/03-RESEARCH.md

@code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQuery.cs
@code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs
@code/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
@code/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
@code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDbContext.cs
@code/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sort parameters to GetProductsQuery</name>
  <files>
    code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQuery.cs
    code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs
  </files>
  <action>
    Add `SortBy` (string?, default null) and `SortDirection` (string?, default "asc") parameters to GetProductsQuery record.

    In GetProductsQueryHandler, replace the hardcoded `.OrderByDescending(p => p.CreatedAt)` with dynamic sorting based on SortBy:
    - "price" -> order by p.Price.Amount
    - "name" -> order by p.Name.Value
    - "newest" -> order by p.CreatedAt descending (ignore SortDirection for newest)
    - null/default -> order by p.CreatedAt descending (same as current behavior)

    SortDirection "desc" reverses the order for price and name. Use a simple switch expression, not a library.

    Also update the API endpoint mapping (find it in the Catalog module registration, likely in a MapCatalogEndpoints or similar) to bind the new query parameters from the request.
  </action>
  <verify>
    `dotnet build code/` succeeds. Inspect the handler to confirm sort logic covers price, name, newest, and default cases.
  </verify>
  <done>
    GET /api/catalog/products?sortBy=price&sortDirection=asc returns products sorted by price ascending.
    GET /api/catalog/products?sortBy=name returns products sorted by name A-Z.
    GET /api/catalog/products?sortBy=newest returns newest first.
    Default (no sortBy) returns newest first (backward compatible).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seed data with ~50 electronics products</name>
  <files>
    code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDataSeeder.cs
    code/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    Create `CatalogDataSeeder` as an `IHostedService` (or use EF Core's `UseAsyncSeeding` if available with Aspire's AddNpgsqlDbContext -- try UseAsyncSeeding first on CatalogDbContext options, fall back to IHostedService if it doesn't work).

    The seeder should:
    1. Check if Categories table is empty -- if not, skip entirely (idempotent)
    2. Create 6-8 electronics categories: Laptops, Smartphones, Tablets, Audio, Accessories, Monitors, Gaming, Wearables
    3. Create ~50 products spread across categories using `Product.Create()` factory method and `Category.Create()` factory method
    4. Set all products to Published status via `product.Publish()`
    5. Use realistic electronics product names and descriptions (e.g., "ProBook 15 Laptop", "UltraSound Pro Headphones")
    6. Price range: $9.99 to $2,499.99 with realistic pricing per category
    7. Use placeholder image URLs -- use `https://placehold.co/600x400/EEE/31343C?text={ProductName}` format (URL-encoded product name)
    8. Generate SKU values like "LAP-001", "PHN-001", etc.
    9. Only run in Development environment (check IHostEnvironment.IsDevelopment())

    Register the seeder in Program.cs. Make sure it runs after database migrations are applied (EnsureCreated or after migration application).

    IMPORTANT: Use the domain factory methods (Product.Create, Category.Create) and value objects (ProductName.From, Money.From, CategoryId, etc.) -- do NOT directly construct entities. This ensures domain events fire and validation runs.
  </action>
  <verify>
    `dotnet build code/` succeeds. Read the seeder file and confirm: idempotency guard exists, ~50 products created, all use factory methods, Development-only check present.
  </verify>
  <done>
    Running `dotnet run --project code/MicroCommerce.AppHost` with an empty database results in ~50 published products across 6-8 categories. Re-running does not duplicate data.
  </done>
</task>

</tasks>

<verification>
- `dotnet build code/` compiles without errors
- Seeder creates categories and products using domain factory methods
- Products are Published status (not Draft)
- Idempotency guard prevents duplicate seeding
- Sort parameter works for price, name, newest
</verification>

<success_criteria>
- GetProductsQuery accepts SortBy and SortDirection parameters
- Handler applies correct ordering for each sort option
- CatalogDataSeeder creates ~50 products across 6-8 categories
- Seed data only runs in Development and only when DB is empty
- All products use factory methods and are Published
</success_criteria>

<output>
After completion, create `.planning/phases/03-catalog-storefront-seed-data/03-01-SUMMARY.md`
</output>
