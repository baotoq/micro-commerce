---
phase: 08-order-history-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrdersByBuyer/GetOrdersByBuyerQuery.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrdersByBuyer/GetOrdersByBuyerQueryHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetAllOrders/GetAllOrdersQuery.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetAllOrders/GetAllOrdersQueryHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderDashboard/GetOrderDashboardQuery.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderDashboard/GetOrderDashboardQueryHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/UpdateOrderStatus/UpdateOrderStatusCommand.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/UpdateOrderStatus/UpdateOrderStatusCommandHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/UpdateOrderStatus/UpdateOrderStatusCommandValidator.cs
  - src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
autonomous: true

must_haves:
  truths:
    - "Order domain supports Shipped and Delivered status transitions with guard clauses"
    - "API returns paginated orders filtered by buyer ID and optional status"
    - "API returns all orders for admin with optional status filter"
    - "API returns dashboard statistics (total orders, revenue, average order value, pending count, orders per day)"
    - "Admin can update order status via API with forward-only validation"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs"
      provides: "Shipped and Delivered enum values"
      contains: "Shipped"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs"
      provides: "Ship() and Deliver() methods with guard clauses"
      contains: "Ship()"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrdersByBuyer/GetOrdersByBuyerQuery.cs"
      provides: "Buyer order history query"
      contains: "GetOrdersByBuyerQuery"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderDashboard/GetOrderDashboardQuery.cs"
      provides: "Dashboard statistics query"
      contains: "GetOrderDashboardQuery"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/UpdateOrderStatus/UpdateOrderStatusCommand.cs"
      provides: "Admin status transition command"
      contains: "UpdateOrderStatusCommand"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs"
      provides: "New API routes for order history, admin orders, dashboard, status update"
  key_links:
    - from: "OrderingEndpoints.cs"
      to: "GetOrdersByBuyerQuery"
      via: "MediatR Send"
      pattern: "Send.*GetOrdersByBuyerQuery"
    - from: "UpdateOrderStatusCommandHandler"
      to: "Order.Ship() / Order.Deliver()"
      via: "Domain method call"
      pattern: "order\\.Ship|order\\.Deliver"
---

<objective>
Extend the Order domain with Shipped/Delivered status transitions and add all backend API endpoints needed for Phase 8: order history by buyer, admin order list, dashboard statistics, and admin status update command.

Purpose: Provide the complete backend API surface for customer order history pages and admin order management (dashboard + kanban).
Output: Extended Order aggregate, 3 new queries, 1 new command, 5 new API endpoints, Status column index.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs
@src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
@src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/OrderDto.cs
@src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/GetOrderByIdQueryHandler.cs
@src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
@src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
@src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQuery.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Order domain with Shipped/Delivered statuses and transition methods</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
  </files>
  <action>
    1. **OrderStatus.cs** -- Add `Shipped` and `Delivered` values to the enum. Place them AFTER `Confirmed` and BEFORE `Failed`:
       ```
       Submitted, StockReserved, Paid, Confirmed, Shipped, Delivered, Failed, Cancelled
       ```

    2. **Order.cs** -- Add two new public methods with guard clauses:
       - `Ship()`: Only valid when Status == OrderStatus.Confirmed. Sets Status to Shipped.
       - `Deliver()`: Only valid when Status == OrderStatus.Shipped. Sets Status to Delivered.
       Both should throw `InvalidOperationException` with descriptive message if guard fails (same pattern as existing Confirm/MarkAsPaid methods). No domain events needed for Ship/Deliver -- these are simple admin transitions.

    3. **OrderConfiguration.cs** -- Add a database index on the Status column for dashboard query performance:
       ```csharp
       builder.HasIndex(o => o.Status);
       ```
       This is added to the existing OrderConfiguration class. No EF migration is needed for the enum change (stored as string), but the index addition DOES require a migration.

    4. **Generate EF migration** for the Status index:
       ```bash
       cd src/MicroCommerce.ApiService
       dotnet ef migrations add AddOrderStatusIndex --context OrderingDbContext --output-dir Features/Ordering/Infrastructure/Migrations
       ```
  </action>
  <verify>
    - `dotnet build src/MicroCommerce.ApiService` compiles without errors
    - Migration file exists in Features/Ordering/Infrastructure/Migrations/ with "AddOrderStatusIndex" in the name
    - OrderStatus enum has 8 values: Submitted, StockReserved, Paid, Confirmed, Shipped, Delivered, Failed, Cancelled
  </verify>
  <done>Order domain supports full lifecycle: Submitted -> StockReserved -> Paid -> Confirmed -> Shipped -> Delivered, with guard clauses preventing invalid transitions. Status column has database index for query performance.</done>
</task>

<task type="auto">
  <name>Task 2: Add queries (GetOrdersByBuyer, GetAllOrders, GetOrderDashboard), UpdateOrderStatus command, and extend endpoints</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrdersByBuyer/GetOrdersByBuyerQuery.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrdersByBuyer/GetOrdersByBuyerQueryHandler.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetAllOrders/GetAllOrdersQuery.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetAllOrders/GetAllOrdersQueryHandler.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderDashboard/GetOrderDashboardQuery.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderDashboard/GetOrderDashboardQueryHandler.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/UpdateOrderStatus/UpdateOrderStatusCommand.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/UpdateOrderStatus/UpdateOrderStatusCommandHandler.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/UpdateOrderStatus/UpdateOrderStatusCommandValidator.cs
    src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
  </files>
  <action>
    **GetOrdersByBuyer query:**
    - `GetOrdersByBuyerQuery(Guid BuyerId, string? Status, int Page = 1, int PageSize = 20) : IRequest<OrderListDto>`
    - Create `OrderListDto(IReadOnlyList<OrderSummaryDto> Items, int TotalCount, int Page, int PageSize)` -- place DTOs in same file as query.
    - Create `OrderSummaryDto(Guid Id, string OrderNumber, OrderStatus Status, decimal Total, int ItemCount, List<string?> ItemThumbnails, DateTimeOffset CreatedAt, string? FailureReason)`.
    - Handler: Query OrderingDbContext.Orders filtered by BuyerId. Optional Status filter (parse string to OrderStatus enum). Order by CreatedAt descending. Project to OrderSummaryDto using `.Select()` with `Items.Count()` for ItemCount and `Items.Take(3).Select(i => i.ImageUrl)` for thumbnails. Apply pagination with Skip/Take. Include TotalCount via separate `.CountAsync()`.

    **GetAllOrders query (admin):**
    - `GetAllOrdersQuery(string? Status, int Page = 1, int PageSize = 50) : IRequest<OrderListDto>`
    - Reuses the same `OrderListDto` and `OrderSummaryDto` from GetOrdersByBuyer (import from that namespace).
    - Handler: Same as GetOrdersByBuyer but without BuyerId filter. Returns all orders, newest first. Optional status filter.

    **GetOrderDashboard query:**
    - `GetOrderDashboardQuery(string TimeRange = "today") : IRequest<OrderDashboardDto>`
    - `OrderDashboardDto(int TotalOrders, decimal Revenue, decimal AverageOrderValue, int PendingOrders, List<DailyOrderCount> OrdersPerDay)`
    - `DailyOrderCount(DateOnly Date, int Count)`
    - Handler: Parse TimeRange to date filter ("today" = today, "7d" = last 7 days, "30d" = last 30 days, "all" = no filter). Compute:
      - TotalOrders: Count of orders in time range (exclude Failed/Cancelled)
      - Revenue: Sum of Total for orders in time range (exclude Failed/Cancelled)
      - AverageOrderValue: Revenue / TotalOrders (0 if no orders)
      - PendingOrders: Count where Status is Submitted, StockReserved, or Paid (in time range)
      - OrdersPerDay: Group by CreatedAt.Date for last 7 days, return daily counts. Use server-side GROUP BY.

    **UpdateOrderStatus command:**
    - `UpdateOrderStatusCommand(Guid OrderId, string NewStatus) : IRequest`
    - Validator: OrderId not empty, NewStatus must be one of "Shipped" or "Delivered" (only admin-triggerable transitions).
    - Handler: Load Order by ID from DbContext. Based on NewStatus string, call `order.Ship()` or `order.Deliver()`. SaveChangesAsync. If order not found, throw NotFoundException. Domain guard clauses handle invalid transitions (will throw InvalidOperationException, caught by global exception handler).

    **Extend OrderingEndpoints.cs:**
    Add 5 new routes to the existing route group:
    - `GET /api/ordering/orders/my` -- GetOrdersByBuyer (uses BuyerIdentity.GetOrCreateBuyerId for buyer ID)
    - `GET /api/ordering/orders` -- GetAllOrders (admin, accepts ?status=&page=&pageSize=)
    - `GET /api/ordering/dashboard` -- GetOrderDashboard (admin, accepts ?timeRange=today)
    - `PATCH /api/ordering/orders/{id:guid}/status` -- UpdateOrderStatus (admin)
    - Note: Existing `GET /api/ordering/orders/{id:guid}` already exists for GetOrderById.

    For the "my orders" endpoint, extract BuyerId using `BuyerIdentity.GetOrCreateBuyerId(httpContext)`. For PATCH status, accept a body with `{ newStatus: "Shipped" }`.

    Follow existing endpoint patterns in OrderingEndpoints.cs: private static async handler methods, ISender for MediatR, proper Produces annotations.
  </action>
  <verify>
    - `dotnet build src/MicroCommerce.ApiService` compiles without errors or warnings
    - All 5 new endpoints are registered in OrderingEndpoints.cs
    - `curl http://localhost:5000/api/ordering/dashboard` returns JSON with totalOrders, revenue, averageOrderValue, pendingOrders, ordersPerDay fields
  </verify>
  <done>Backend has 5 new API endpoints: buyer order history (paginated + status filter), admin order list (paginated + status filter), dashboard statistics (time range), and admin status update (Ship/Deliver). All follow vertical slice architecture with MediatR CQRS pattern.</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService` -- zero errors, zero warnings
2. OrderStatus enum has 8 values including Shipped and Delivered
3. Order.Ship() throws for non-Confirmed orders, Order.Deliver() throws for non-Shipped orders
4. GET /api/ordering/orders/my returns OrderListDto with pagination
5. GET /api/ordering/orders returns all orders for admin
6. GET /api/ordering/dashboard returns OrderDashboardDto with stats
7. PATCH /api/ordering/orders/{id}/status accepts {newStatus} and transitions order
8. Migration file for Status index exists
</verification>

<success_criteria>
- Backend compiles and all 5 new endpoints respond correctly
- Order lifecycle supports full chain: Submitted -> StockReserved -> Paid -> Confirmed -> Shipped -> Delivered
- Dashboard query returns aggregated statistics with time range filtering
- Status transitions are validated by domain guard clauses
</success_criteria>

<output>
After completion, create `.planning/phases/08-order-history-management/08-01-SUMMARY.md`
</output>
