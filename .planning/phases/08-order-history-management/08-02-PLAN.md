---
phase: 08-order-history-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.Web/package.json
  - src/MicroCommerce.Web/src/app/admin/layout.tsx
  - src/MicroCommerce.Web/src/lib/api.ts
  - src/MicroCommerce.Web/src/hooks/use-orders.ts
  - src/MicroCommerce.Web/src/components/ui/chart.tsx
autonomous: true

must_haves:
  truths:
    - "Admin layout has QueryProvider wrapping children for React Query hooks"
    - "API functions exist for order history, admin orders, dashboard, and status update"
    - "React Query hooks exist for order list polling, dashboard data, and status mutation"
    - "shadcn/ui chart component and dnd-kit packages are installed"
  artifacts:
    - path: "src/MicroCommerce.Web/src/hooks/use-orders.ts"
      provides: "Order hooks for storefront and admin"
      contains: "useOrdersByBuyer"
    - path: "src/MicroCommerce.Web/src/lib/api.ts"
      provides: "API functions for new ordering endpoints"
      contains: "getOrdersByBuyer"
    - path: "src/MicroCommerce.Web/src/app/admin/layout.tsx"
      provides: "QueryProvider in admin layout + Orders nav link"
      contains: "QueryProvider"
    - path: "src/MicroCommerce.Web/src/components/ui/chart.tsx"
      provides: "shadcn/ui chart component"
      contains: "ChartContainer"
  key_links:
    - from: "use-orders.ts"
      to: "api.ts"
      via: "import API functions"
      pattern: "import.*from.*@/lib/api"
    - from: "admin/layout.tsx"
      to: "query-provider.tsx"
      via: "import QueryProvider"
      pattern: "import.*QueryProvider"
---

<objective>
Install new frontend dependencies (chart, dnd-kit), add QueryProvider to admin layout, create API functions for all new ordering endpoints, and build React Query hooks for order data fetching and mutations.

Purpose: Establish the frontend infrastructure (dependencies, providers, data layer) that all Phase 8 UI plans depend on.
Output: Installed packages, admin QueryProvider, 5 new API functions, 6 new React Query hooks.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/hooks/use-checkout.ts
@src/MicroCommerce.Web/src/hooks/use-cart.ts
@src/MicroCommerce.Web/src/app/admin/layout.tsx
@src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
@src/MicroCommerce.Web/src/components/providers/query-provider.tsx
@src/MicroCommerce.Web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add shadcn/ui chart, and add QueryProvider to admin layout</name>
  <files>
    src/MicroCommerce.Web/package.json
    src/MicroCommerce.Web/src/components/ui/chart.tsx
    src/MicroCommerce.Web/src/app/admin/layout.tsx
  </files>
  <action>
    1. **Install dnd-kit packages:**
       ```bash
       cd src/MicroCommerce.Web
       npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
       ```

    2. **Add shadcn/ui chart component** (installs recharts automatically):
       ```bash
       cd src/MicroCommerce.Web
       npx shadcn@latest add chart --yes
       ```
       This creates `src/components/ui/chart.tsx` with ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent, and ChartConfig type.

    3. **Add QueryProvider to admin layout** (`src/app/admin/layout.tsx`):
       - Import `QueryProvider` from `@/components/providers/query-provider` (same one used in storefront layout).
       - Wrap `{children}` with `<QueryProvider>...</QueryProvider>`.
       - Add "Orders" navigation link to the admin nav bar (between "Categories" and "Dead Letters"):
         ```tsx
         <Link href="/admin/orders" className="inline-flex items-center px-1 pt-1 text-sm font-medium text-gray-500 hover:text-gray-900">
           <ShoppingBag className="w-4 h-4 mr-2" />
           Orders
         </Link>
         ```
       - Import `ShoppingBag` from `lucide-react`.
  </action>
  <verify>
    - `cd src/MicroCommerce.Web && npm ls @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities recharts` shows all packages installed
    - `src/MicroCommerce.Web/src/components/ui/chart.tsx` exists
    - Admin layout.tsx contains `<QueryProvider>` and an "Orders" nav link
  </verify>
  <done>All new dependencies installed, shadcn/ui chart component available, admin layout has QueryProvider and Orders nav link.</done>
</task>

<task type="auto">
  <name>Task 2: Add ordering API functions and React Query hooks</name>
  <files>
    src/MicroCommerce.Web/src/lib/api.ts
    src/MicroCommerce.Web/src/hooks/use-orders.ts
  </files>
  <action>
    1. **Extend api.ts** with new types and functions. Add these AFTER the existing ordering section:

       **New types:**
       ```typescript
       export interface OrderSummaryDto {
         id: string;
         orderNumber: string;
         status: string;
         total: number;
         itemCount: number;
         itemThumbnails: (string | null)[];
         createdAt: string;
         failureReason: string | null;
       }

       export interface OrderListDto {
         items: OrderSummaryDto[];
         totalCount: number;
         page: number;
         pageSize: number;
       }

       export interface OrderDashboardDto {
         totalOrders: number;
         revenue: number;
         averageOrderValue: number;
         pendingOrders: number;
         ordersPerDay: { date: string; count: number }[];
       }

       export interface UpdateOrderStatusRequest {
         newStatus: string;
       }
       ```

       **New API functions:**
       - `getOrdersByBuyer(params: { status?: string; page?: number; pageSize?: number })`: GET `/api/ordering/orders/my` with query params. Include `credentials: "include"` for buyer cookie.
       - `getAllOrders(params: { status?: string; page?: number; pageSize?: number })`: GET `/api/ordering/orders` with query params.
       - `getOrderDashboard(timeRange?: string)`: GET `/api/ordering/dashboard?timeRange={timeRange}`.
       - `updateOrderStatus(orderId: string, newStatus: string)`: PATCH `/api/ordering/orders/{orderId}/status` with body `{ newStatus }`.

       All follow the existing pattern in api.ts: use API_BASE, throw Error on non-ok response, return typed JSON.

    2. **Create use-orders.ts** with React Query hooks:

       ```typescript
       "use client";

       import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
       import { toast } from "sonner";
       import {
         getAllOrders,
         getOrderById,
         getOrderDashboard,
         getOrdersByBuyer,
         updateOrderStatus,
       } from "@/lib/api";
       ```

       **Hooks to create:**
       - `useOrdersByBuyer(params: { status?: string; page?: number; pageSize?: number })`: useQuery with key `["orders", "buyer", params]`. Enabled always (auth gate is on the page level).
       - `useOrderWithPolling(orderId: string)`: useQuery with key `["order", orderId]`, calls `getOrderById`. Uses `refetchInterval` callback: return `false` for terminal states (Delivered, Failed, Cancelled), return `20_000` (20s) otherwise. Enabled when orderId is truthy.
       - `useAllOrders(params: { status?: string; page?: number; pageSize?: number })`: useQuery with key `["orders", "admin", params]`.
       - `useOrderDashboard(timeRange?: string)`: useQuery with key `["dashboard", timeRange]`, calls `getOrderDashboard(timeRange)`.
       - `useUpdateOrderStatus()`: useMutation calling `updateOrderStatus`. On success, invalidate `["orders", "admin"]` queries. On error, `toast.error("Failed to update order status")`.
  </action>
  <verify>
    - `cd src/MicroCommerce.Web && npx tsc --noEmit` compiles without type errors
    - api.ts contains getOrdersByBuyer, getAllOrders, getOrderDashboard, updateOrderStatus functions
    - use-orders.ts exports useOrdersByBuyer, useOrderWithPolling, useAllOrders, useOrderDashboard, useUpdateOrderStatus
  </verify>
  <done>Complete data layer for Phase 8: 4 new API functions in api.ts, 5 new React Query hooks in use-orders.ts with polling support for order status and optimistic invalidation for admin mutations.</done>
</task>

</tasks>

<verification>
1. `npm ls @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities recharts` -- all installed
2. `chart.tsx` exists in components/ui/
3. Admin layout wraps children in QueryProvider
4. Admin nav has Orders link with ShoppingBag icon
5. api.ts has 4 new API functions + OrderSummaryDto, OrderListDto, OrderDashboardDto types
6. use-orders.ts has 5 hooks including polling logic
7. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- All frontend dependencies installed and chart component scaffolded
- Admin layout has QueryProvider (React Query hooks work in admin pages)
- All new API functions match backend endpoint contracts
- React Query hooks implement polling with terminal state detection
</success_criteria>

<output>
After completion, create `.planning/phases/08-order-history-management/08-02-SUMMARY.md`
</output>
