---
phase: 08-order-history-management
plan: 05
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/MicroCommerce.Web/src/app/admin/orders/page.tsx
  - src/MicroCommerce.Web/src/app/admin/orders/[id]/page.tsx
  - src/MicroCommerce.Web/src/components/admin/order-kanban.tsx
  - src/MicroCommerce.Web/src/components/admin/order-kanban-column.tsx
  - src/MicroCommerce.Web/src/components/admin/order-kanban-card.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees kanban board with columns for Submitted, Confirmed, Paid, Shipped, Delivered"
    - "Admin can drag order cards between adjacent columns to transition status"
    - "Dragging to non-adjacent columns is rejected client-side (forward-only, no skipping)"
    - "Clicking an order card navigates to admin order detail page"
    - "Admin order detail page shows full order info with breadcrumb back to kanban"
  artifacts:
    - path: "src/MicroCommerce.Web/src/app/admin/orders/page.tsx"
      provides: "Admin orders page rendering kanban board"
      contains: "OrderKanban"
    - path: "src/MicroCommerce.Web/src/app/admin/orders/[id]/page.tsx"
      provides: "Admin order detail page with breadcrumb"
      contains: "useOrderWithPolling"
    - path: "src/MicroCommerce.Web/src/components/admin/order-kanban.tsx"
      provides: "Kanban board with DndContext and column layout"
      contains: "DndContext"
    - path: "src/MicroCommerce.Web/src/components/admin/order-kanban-column.tsx"
      provides: "Droppable kanban column"
      contains: "useDroppable"
    - path: "src/MicroCommerce.Web/src/components/admin/order-kanban-card.tsx"
      provides: "Draggable order card"
      contains: "useDraggable"
  key_links:
    - from: "order-kanban.tsx"
      to: "use-orders.ts"
      via: "useAllOrders + useUpdateOrderStatus hooks"
      pattern: "useAllOrders|useUpdateOrderStatus"
    - from: "order-kanban.tsx"
      to: "@dnd-kit/core"
      via: "DndContext, DragEndEvent"
      pattern: "DndContext"
    - from: "order-kanban.tsx handleDragEnd"
      to: "updateOrderStatus mutation"
      via: "validates adjacent transition then calls mutate"
      pattern: "handleDragEnd"
---

<objective>
Build the admin kanban board for order management with drag-and-drop status transitions using @dnd-kit, plus an admin order detail page with breadcrumb navigation.

Purpose: Give admins a visual workflow for managing order lifecycle with intuitive drag-and-drop (ADM-04).
Output: Kanban board page with 5 status columns, draggable order cards with forward-only validation, and admin order detail page.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-order-history-management/08-01-SUMMARY.md
@.planning/phases/08-order-history-management/08-02-SUMMARY.md
@src/MicroCommerce.Web/src/hooks/use-orders.ts
@src/MicroCommerce.Web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build kanban board with DnD columns, cards, and status transition validation</name>
  <files>
    src/MicroCommerce.Web/src/components/admin/order-kanban.tsx
    src/MicroCommerce.Web/src/components/admin/order-kanban-column.tsx
    src/MicroCommerce.Web/src/components/admin/order-kanban-card.tsx
    src/MicroCommerce.Web/src/app/admin/orders/page.tsx
  </files>
  <action>
    1. **order-kanban-card.tsx** -- "use client" component:
       - Props: `order: OrderSummaryDto`
       - Use `useDraggable` from `@dnd-kit/core` with `id: order.id` and `data: { order }`.
       - Render as a Card (shadcn/ui) with drag handle styling:
         - Order number (bold, truncated)
         - Total price (formatted USD)
         - Item count ("X items")
         - Date (short format)
         - Status badge (same color scheme as storefront)
       - Apply transform from useDraggable via CSS transform style.
       - The card is a clickable Link to `/admin/orders/{order.id}`.
       - When dragging, add visual feedback: opacity-50, shadow-lg, z-50.

    2. **order-kanban-column.tsx** -- "use client" component:
       - Props: `status: string`, `orders: OrderSummaryDto[]`, `isValidDrop: boolean` (whether this column is a valid drop target for the currently dragged item)
       - Use `useDroppable` from `@dnd-kit/core` with `id: status`.
       - Render as a vertical column:
         - Header: status name + order count badge
         - Body: scrollable list of `<OrderKanbanCard>` components
         - Visual feedback: highlight border (green) when `isOver && isValidDrop`, red border when `isOver && !isValidDrop`
       - Column min-width: 250px, max-height: calc(100vh - 200px) with overflow-y-auto
       - Column background: light gray (bg-gray-100), rounded corners

    3. **order-kanban.tsx** -- "use client" component:
       - Import `DndContext`, `DragEndEvent`, `DragStartEvent`, `DragOverlay`, `closestCorners` from `@dnd-kit/core`.
       - Use `useAllOrders({ pageSize: 200 })` to fetch all orders (kanban shows all).
       - Use `useUpdateOrderStatus()` mutation.
       - Define kanban columns: `["Submitted", "Confirmed", "Paid", "Shipped", "Delivered"]`
       - Define valid transitions map:
         ```typescript
         const VALID_TRANSITIONS: Record<string, string> = {
           Submitted: "Confirmed",
           Confirmed: "Paid",
           Paid: "Shipped",
           Shipped: "Delivered",
         };
         ```
         Note: Submitted -> Confirmed and Confirmed -> Paid are not admin-triggerable in the backend (they're saga-managed). But the kanban should still show these columns. Only Confirmed -> Shipped and Shipped -> Delivered are admin API calls. For Submitted/Confirmed/Paid transitions, show a toast explaining "This transition is managed automatically by the system" and reject the drop.
       - Actually, simplify: the valid admin transitions are ONLY `Confirmed -> Shipped` and `Shipped -> Delivered` (matching the backend UpdateOrderStatus command which only accepts "Shipped" and "Delivered"). All other drag attempts should be rejected.
       - State: `activeCard` (OrderSummaryDto | null) for DragOverlay.
       - `onDragStart`: set activeCard from `active.data.current.order`.
       - `onDragEnd(event: DragEndEvent)`:
         - Get source status from `active.data.current.order.status`
         - Get target status from `over.id` (column id)
         - If source === target, do nothing
         - Validate: check if the transition is valid (source is "Confirmed" and target is "Shipped", or source is "Shipped" and target is "Delivered")
         - If invalid: `toast.error("Invalid transition. Orders can only move forward one step.")`, return
         - If valid: call `updateOrderStatus.mutate({ orderId: active.id, newStatus: targetStatus })`
       - Pass `isValidDrop` prop to columns based on active card's status
       - DragOverlay: render a ghost card showing the dragged order
       - Render columns in horizontal flex row with gap-4, overflow-x-auto for small screens.
       - Loading state: skeleton columns.

    4. **admin/orders/page.tsx** -- page:
       ```tsx
       "use client";
       import { OrderKanban } from "@/components/admin/order-kanban";

       export default function AdminOrdersPage() {
         return (
           <div>
             <h1 className="text-2xl font-bold text-gray-900 mb-6">Order Management</h1>
             <OrderKanban />
           </div>
         );
       }
       ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - order-kanban.tsx imports DndContext and validates transitions
    - order-kanban-column.tsx uses useDroppable with visual drop feedback
    - order-kanban-card.tsx uses useDraggable with transform styles
    - Only Confirmed->Shipped and Shipped->Delivered transitions trigger API call
  </verify>
  <done>Kanban board renders 5 status columns with draggable order cards. DnD transitions validated client-side: only admin-allowed transitions (Confirmed->Shipped, Shipped->Delivered) call the API. Invalid drops show error toast. Visual feedback on valid/invalid drop zones.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin order detail page with breadcrumb navigation</name>
  <files>
    src/MicroCommerce.Web/src/app/admin/orders/[id]/page.tsx
  </files>
  <action>
    Create "use client" admin order detail page:

    - Extract `id` from params.
    - Use `useOrderWithPolling(id)` hook (reuse from use-orders.ts).
    - **Breadcrumb:** "Orders" (link to /admin/orders) > "Order #{orderNumber}". Use ChevronRight icon as separator.
    - **Content:** Full order detail view (similar to storefront order-detail but admin-styled):
      - Header row: Order number, status badge, date
      - Status stepper (reuse `OrderStatusStepper` from storefront components -- it's generic enough)
      - Two-column layout on large screens:
        - Left: Items table (image, name, qty, unit price, line total)
        - Right: Order summary card (subtotal, shipping, tax, total) + Shipping address card + Buyer email
      - If order is Confirmed: show "Mark as Shipped" button. If Shipped: show "Mark as Delivered" button.
      - Button uses `useUpdateOrderStatus()` mutation. On success, order data refetches via polling.
    - Loading state: skeleton layout
    - Error state: "Order not found" with link back to kanban

    Style with Tailwind, consistent with admin page patterns (gray-50 bg, Card components for sections).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Page renders breadcrumb, full order detail, and action buttons
    - "Mark as Shipped" button only visible for Confirmed orders
    - "Mark as Delivered" button only visible for Shipped orders
  </verify>
  <done>Admin order detail page shows full order info with breadcrumb back to kanban. Admin action buttons for status transitions (Ship/Deliver) are conditionally rendered based on current order status.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. Visit /admin/orders -> kanban board with 5 columns
3. Orders appear in correct columns based on their status
4. Drag Confirmed order to Shipped column -> API called, card moves
5. Drag Submitted order to Shipped -> rejected with toast error
6. Click order card -> navigates to /admin/orders/{id}
7. Admin detail page shows breadcrumb, full order info, and action buttons
8. "Mark as Shipped" button calls API and order updates
</verification>

<success_criteria>
- ADM-04: Admin can view and manage orders via kanban board
- Drag-and-drop transitions are validated (forward-only, admin-allowed only)
- Admin order detail page provides full visibility and manual status transition buttons
- Breadcrumb navigation connects detail page back to kanban
</success_criteria>

<output>
After completion, create `.planning/phases/08-order-history-management/08-05-SUMMARY.md`
</output>
