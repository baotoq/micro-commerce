---
phase: 08-order-history-management
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/MicroCommerce.Web/src/app/(storefront)/orders/page.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/orders/[id]/page.tsx
  - src/MicroCommerce.Web/src/components/storefront/order-history-list.tsx
  - src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
  - src/MicroCommerce.Web/src/components/storefront/order-status-stepper.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Logged-in user can view their order history as a card list"
    - "User can filter orders by status using tab navigation"
    - "User can click an order card to see full order detail"
    - "Order detail page shows horizontal status stepper with lifecycle progression"
    - "Order status polls every 20 seconds and stops for terminal states"
    - "Unauthenticated users are redirected to sign-in"
  artifacts:
    - path: "src/MicroCommerce.Web/src/app/(storefront)/orders/page.tsx"
      provides: "Order history page with auth gate"
      contains: "useSession"
    - path: "src/MicroCommerce.Web/src/app/(storefront)/orders/[id]/page.tsx"
      provides: "Order detail page with polling"
      contains: "useOrderWithPolling"
    - path: "src/MicroCommerce.Web/src/components/storefront/order-status-stepper.tsx"
      provides: "Horizontal stepper showing 5-step lifecycle"
      contains: "Submitted"
    - path: "src/MicroCommerce.Web/src/components/storefront/order-history-list.tsx"
      provides: "Card-based order list with status filter tabs"
      contains: "OrderSummaryDto"
  key_links:
    - from: "orders/page.tsx"
      to: "order-history-list.tsx"
      via: "component import"
      pattern: "OrderHistoryList"
    - from: "orders/[id]/page.tsx"
      to: "use-orders.ts"
      via: "hook import"
      pattern: "useOrderWithPolling"
    - from: "order-status-stepper.tsx"
      to: "OrderDto.status"
      via: "status prop mapping"
      pattern: "mapToCustomerStep"
---

<objective>
Build the customer-facing order history page (card list with status filter tabs) and order detail page (full summary with horizontal status stepper and polling).

Purpose: Allow logged-in customers to view past orders and track their order status in real time (ORD-01, ORD-02, ORD-03).
Output: 2 new pages, 3 new components, auth-gated order history with polling status updates.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-order-history-management/08-01-SUMMARY.md
@.planning/phases/08-order-history-management/08-02-SUMMARY.md
@src/MicroCommerce.Web/src/hooks/use-orders.ts
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
@src/MicroCommerce.Web/src/app/(storefront)/order-confirmation/page.tsx
@src/MicroCommerce.Web/src/components/storefront/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order status stepper component and order history list with filter tabs</name>
  <files>
    src/MicroCommerce.Web/src/components/storefront/order-status-stepper.tsx
    src/MicroCommerce.Web/src/components/storefront/order-history-list.tsx
  </files>
  <action>
    1. **order-status-stepper.tsx** -- "use client" component:
       - Props: `status: string` (the raw order status from API)
       - Define the 5 customer-visible steps: `["Submitted", "Paid", "Confirmed", "Shipped", "Delivered"]`
       - Create a mapping function `mapToCustomerStep(status: string): number`:
         - "Submitted" | "StockReserved" -> 0
         - "Paid" -> 1
         - "Confirmed" -> 2
         - "Shipped" -> 3
         - "Delivered" -> 4
         - "Failed" | "Cancelled" -> use last active step, mark as failed
       - Render a horizontal stepper with 5 steps connected by lines:
         - Completed steps: green circle with check icon (Check from lucide-react), green connecting line
         - Current step: blue circle with pulsing animation, gray line ahead
         - Future steps: gray circle, gray line
         - Failed/Cancelled: current step turns red with X icon (X from lucide-react), display `failureReason` below the stepper if provided
       - Accept optional `failureReason?: string` prop
       - Use Tailwind classes. Steps should be flex row with responsive sizing.
       - Each step shows a label below the circle (the step name).

    2. **order-history-list.tsx** -- "use client" component:
       - Props: none (fetches data via hooks)
       - Import `useOrdersByBuyer` from `@/hooks/use-orders`
       - State: `activeTab` (string, default "All"), `page` (number, default 1)
       - Tab bar: "All", "Submitted", "Confirmed", "Paid", "Shipped", "Delivered" -- render as horizontal button row
       - When tab changes, set status filter and reset page to 1
       - Pass `{ status: activeTab === "All" ? undefined : activeTab, page }` to `useOrdersByBuyer`
       - Render order cards in a vertical list (flex col gap-4):
         - Each card (shadcn/ui Card): order number, date (formatted with Intl.DateTimeFormat), status badge (Badge component with color variant based on status), total (formatted with Intl.NumberFormat as USD), item count, first 2-3 item thumbnail images (small circles).
         - Status badge colors: Submitted=yellow, Confirmed=blue, Paid=green, Shipped=purple, Delivered=green, Failed=red, Cancelled=gray
         - Card is a Link to `/orders/{id}`
       - Pagination: simple "Previous" / "Next" buttons using page and totalCount
       - Loading state: show skeleton cards (4 placeholder cards with Skeleton component)
       - Empty state: "No orders yet" message with a link to browse products
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - order-status-stepper.tsx renders 5 steps with proper status mapping
    - order-history-list.tsx uses useOrdersByBuyer hook and renders cards with filter tabs
  </verify>
  <done>Status stepper maps internal statuses to customer-visible 5-step lifecycle. Order history list renders cards with thumbnails, status badges, and tab-based filtering.</done>
</task>

<task type="auto">
  <name>Task 2: Create order history page (auth-gated) and order detail page with polling</name>
  <files>
    src/MicroCommerce.Web/src/app/(storefront)/orders/page.tsx
    src/MicroCommerce.Web/src/app/(storefront)/orders/[id]/page.tsx
    src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
    src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
  </files>
  <action>
    1. **orders/page.tsx** -- "use client" page:
       - Import `useSession` from `next-auth/react`
       - Check session status: if "loading", show a full-page skeleton. If no session, call `redirect("/api/auth/signin")` (from `next/navigation`).
       - If authenticated, render page heading "My Orders" and the `<OrderHistoryList />` component.
       - Style: max-w-4xl mx-auto px-4 py-8

    2. **order-detail.tsx** -- "use client" component:
       - Props: `orderId: string`
       - Use `useOrderWithPolling(orderId)` hook for data with auto-polling
       - Loading state: skeleton layout
       - Render full order detail:
         - Top: Order number + date + status badge
         - Status stepper: `<OrderStatusStepper status={order.status} failureReason={order.failureReason} />`
         - Items section: list each item with image (64x64, rounded), product name, unit price x quantity, line total
         - Shipping address section: name, street, city/state/zip
         - Order summary section: subtotal, shipping cost, tax, total (bold)
         - Use Card components from shadcn/ui for sections
       - Format all prices with `Intl.NumberFormat("en-US", { style: "currency", currency: "USD" })`

    3. **orders/[id]/page.tsx** -- "use client" page:
       - Extract `id` from `params`
       - Render breadcrumb: "My Orders" (link to /orders) > "Order #{orderNumber}"
       - Render `<OrderDetail orderId={id} />`
       - Style: max-w-4xl mx-auto px-4 py-8

    4. **Update storefront layout** (optional): Add "Orders" link to the storefront header navigation if there's a visible nav. Check existing header.tsx -- if it has navigation links, add an "Orders" link. If not, skip this step. The orders page is accessible via URL `/orders`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - orders/page.tsx redirects unauthenticated users to sign-in
    - orders/[id]/page.tsx renders order detail with status stepper and polling
    - Breadcrumb navigation connects detail back to history
  </verify>
  <done>Customer-facing order history and detail pages are complete. Auth gate redirects guests. Detail page shows full order summary with horizontal status stepper. Status polls every 20 seconds, stopping for terminal states (Delivered, Failed, Cancelled).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. Navigate to /orders without auth -> redirected to sign-in
3. Navigate to /orders with auth -> see order list with filter tabs
4. Click order card -> navigates to /orders/{id} with full detail
5. Status stepper shows correct step highlighted based on order status
6. Failed orders show red stepper step with failure reason
7. Polling stops when order reaches Delivered/Failed/Cancelled
</verification>

<success_criteria>
- ORD-01: Logged-in user sees list of past orders with status badges and thumbnails
- ORD-02: Order detail status polls every 20s, stepper updates in real time
- ORD-03: Order detail page shows all items, shipping address, payment summary, and totals
- Auth gate prevents unauthenticated access
</success_criteria>

<output>
After completion, create `.planning/phases/08-order-history-management/08-03-SUMMARY.md`
</output>
