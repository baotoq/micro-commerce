---
phase: 09-api-gateway
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/MicroCommerce.AppHost/AppHost.cs
  - src/MicroCommerce.Web/src/lib/config.ts
  - src/MicroCommerce.Web/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "Frontend server-side calls route through gateway (not directly to apiservice)"
    - "Frontend client-side calls route through gateway"
    - "Aspire service discovery resolves gateway URL for the frontend"
    - "Existing storefront and admin pages continue to function correctly through gateway"
  artifacts:
    - path: "src/MicroCommerce.Web/src/lib/config.ts"
      provides: "Server-side API base URL pointing to gateway via Aspire service discovery"
      contains: "services__gateway"
    - path: "src/MicroCommerce.Web/src/lib/api.ts"
      provides: "Client-side API base URL fallback updated for gateway"
    - path: "src/MicroCommerce.AppHost/AppHost.cs"
      provides: "Frontend wired to gateway instead of apiservice"
      contains: "WithReference(gateway)"
  key_links:
    - from: "src/MicroCommerce.AppHost/AppHost.cs"
      to: "frontend JavaScript app"
      via: "WithReference(gateway) service discovery"
      pattern: "frontend.*WithReference.*gateway"
    - from: "src/MicroCommerce.Web/src/lib/config.ts"
      to: "gateway service"
      via: "Aspire environment variable"
      pattern: "services__gateway"
---

<objective>
Update the frontend to route all API calls through the gateway instead of directly to ApiService. Update the Aspire AppHost to wire the frontend service discovery to the gateway.

Purpose: Completes the gateway integration — frontend becomes a consumer of the gateway, which is the single entry point for all API traffic. Without this, the gateway would exist but receive no traffic.
Output: Frontend config files updated to reference gateway, AppHost wires frontend -> gateway.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-api-gateway/09-01-SUMMARY.md

@src/MicroCommerce.AppHost/AppHost.cs
@src/MicroCommerce.Web/src/lib/config.ts
@src/MicroCommerce.Web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AppHost to wire frontend to gateway</name>
  <files>
    src/MicroCommerce.AppHost/AppHost.cs
  </files>
  <action>
    In AppHost.cs, change the frontend's service reference from `apiService` to `gateway`.

    **Before:**
    ```csharp
    builder.AddJavaScriptApp("frontend", "../MicroCommerce.Web")
        .WithReference(apiService)
        .WithReference(keycloak)
        .WithHttpEndpoint(port: 3000, env: "PORT");
    ```

    **After:**
    ```csharp
    builder.AddJavaScriptApp("frontend", "../MicroCommerce.Web")
        .WithReference(gateway)
        .WithReference(keycloak)
        .WithHttpEndpoint(port: 3000, env: "PORT");
    ```

    This single change causes Aspire to inject `services__gateway__https__0` and `services__gateway__http__0` environment variables into the frontend process instead of `services__apiservice__*`. The frontend's config.ts reads these variables to determine the API base URL.

    **Important:** The gateway variable must be defined BEFORE the frontend line in AppHost.cs (it already is from Plan 09-01). Verify the ordering is correct: apiService -> gateway -> frontend.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj` — zero errors.
    Grep AppHost.cs for the frontend section — should contain `WithReference(gateway)` not `WithReference(apiService)`.
  </verify>
  <done>Frontend Aspire service discovery now resolves to gateway. Aspire injects gateway URL as environment variable into the Next.js process.</done>
</task>

<task type="auto">
  <name>Task 2: Update frontend config to use gateway service discovery</name>
  <files>
    src/MicroCommerce.Web/src/lib/config.ts
    src/MicroCommerce.Web/src/lib/api.ts
  </files>
  <action>
    **config.ts** — Update server-side config to read gateway environment variables:

    Change the Aspire service discovery variable names from `apiservice` to `gateway`:

    **Before:**
    ```typescript
    export function getApiBaseUrl(): string {
      const aspireUrl =
        process.env.services__apiservice__https__0 ||
        process.env.services__apiservice__http__0;
      if (aspireUrl) {
        return aspireUrl;
      }
      return process.env.API_URL || "http://localhost:5182";
    }
    ```

    **After:**
    ```typescript
    export function getApiBaseUrl(): string {
      // Aspire injects gateway service URL (gateway is the API entry point)
      const aspireUrl =
        process.env.services__gateway__https__0 ||
        process.env.services__gateway__http__0;
      if (aspireUrl) {
        return aspireUrl;
      }
      // Fallback for local development without Aspire
      return process.env.API_URL || "http://localhost:5200";
    }
    ```

    The fallback port changes from `5182` (ApiService) to `5200` (Gateway) to match the Gateway's launchSettings.json profile created in Plan 09-01.

    **api.ts** — Update client-side API base URL fallback:

    Change the `API_BASE` constant fallback to point to the gateway port:

    **Before:**
    ```typescript
    const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000';
    ```

    **After:**
    ```typescript
    const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5200';
    ```

    The fallback port `5200` matches the Gateway's HTTP port from launchSettings.json.

    **No other changes needed in api.ts** — all the `fetch()` calls use relative paths like `/api/catalog/products`, which are the same paths the gateway proxies to ApiService. The API paths are preserved as-is per the context decision.
  </action>
  <verify>
    Grep config.ts for `services__gateway` — should be present.
    Grep config.ts for `services__apiservice` — should NOT be present.
    Grep api.ts for `API_BASE` — should show fallback to port 5200.
    Run `cd /Users/baotoq/Work/micro-commerce/src/MicroCommerce.Web && npx tsc --noEmit` to verify TypeScript compiles (if tsconfig is set up for type checking).
  </verify>
  <done>Frontend server-side config reads gateway URL from Aspire. Client-side fallback points to gateway port. All existing API paths preserved (no fetch URL changes needed).</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj` — zero errors
2. AppHost.cs: frontend has `.WithReference(gateway)` (not apiService)
3. config.ts: reads `services__gateway__https__0` / `services__gateway__http__0`
4. config.ts: fallback URL uses gateway port (5200)
5. api.ts: `API_BASE` fallback uses gateway port (5200)
6. api.ts: all fetch URLs still use `/api/*` paths (unchanged)
7. No TypeScript compilation errors
</verification>

<success_criteria>
- AppHost wires frontend to gateway via `.WithReference(gateway)`
- Server-side config reads gateway Aspire environment variables
- Client-side API base URL defaults to gateway port
- All existing API paths preserved (zero fetch URL changes in api.ts)
- Frontend builds without TypeScript errors
- Complete traffic flow: Browser -> Next.js -> Gateway -> ApiService
</success_criteria>

<output>
After completion, create `.planning/phases/09-api-gateway/09-03-SUMMARY.md`
</output>
