---
phase: 09-api-gateway
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.Gateway/MicroCommerce.Gateway.csproj
  - src/MicroCommerce.Gateway/Program.cs
  - src/MicroCommerce.Gateway/appsettings.json
  - src/MicroCommerce.Gateway/appsettings.Development.json
  - src/MicroCommerce.Gateway/Properties/launchSettings.json
  - src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj
  - src/MicroCommerce.AppHost/AppHost.cs
  - src/MicroCommerce.slnx
autonomous: true

must_haves:
  truths:
    - "Gateway project builds without errors"
    - "Gateway appears in Aspire dashboard with healthy status"
    - "Requests to gateway /api/* are proxied to ApiService and return correct responses"
    - "Gateway health endpoint /health returns healthy"
  artifacts:
    - path: "src/MicroCommerce.Gateway/MicroCommerce.Gateway.csproj"
      provides: "Gateway project with YARP and ServiceDefaults references"
      contains: "Yarp.ReverseProxy"
    - path: "src/MicroCommerce.Gateway/Program.cs"
      provides: "YARP reverse proxy pipeline with route configuration"
      contains: "MapReverseProxy"
    - path: "src/MicroCommerce.AppHost/AppHost.cs"
      provides: "Aspire orchestration including gateway project"
      contains: "MicroCommerce_Gateway"
  key_links:
    - from: "src/MicroCommerce.AppHost/AppHost.cs"
      to: "src/MicroCommerce.Gateway"
      via: "AddProject reference"
      pattern: "AddProject.*MicroCommerce_Gateway"
    - from: "src/MicroCommerce.Gateway/Program.cs"
      to: "apiservice cluster"
      via: "YARP ReverseProxy config"
      pattern: "AddReverseProxy|MapReverseProxy"
---

<objective>
Create the MicroCommerce.Gateway project with YARP reverse proxy that routes all `/api/*` requests to the ApiService backend. Register the gateway in the Aspire AppHost and add it to the solution file.

Purpose: Establishes the gateway project as the foundation for Phase 9. All subsequent plans add security, rate limiting, and frontend migration on top of this working proxy.
Output: A new ASP.NET Core project with YARP that proxies requests to ApiService, visible and healthy in the Aspire dashboard.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/MicroCommerce.AppHost/AppHost.cs
@src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj
@src/MicroCommerce.ServiceDefaults/MicroCommerce.ServiceDefaults.csproj
@src/MicroCommerce.slnx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MicroCommerce.Gateway project with YARP reverse proxy</name>
  <files>
    src/MicroCommerce.Gateway/MicroCommerce.Gateway.csproj
    src/MicroCommerce.Gateway/Program.cs
    src/MicroCommerce.Gateway/appsettings.json
    src/MicroCommerce.Gateway/appsettings.Development.json
    src/MicroCommerce.Gateway/Properties/launchSettings.json
  </files>
  <action>
    Create a new ASP.NET Core web project at `src/MicroCommerce.Gateway/`.

    **MicroCommerce.Gateway.csproj:**
    - Target `net10.0`, enable nullable, implicit usings
    - Add package reference: `Yarp.ReverseProxy` (latest 2.2+)
    - Add project reference: `../MicroCommerce.ServiceDefaults/MicroCommerce.ServiceDefaults.csproj`
    - Match existing project conventions (see ApiService.csproj for reference)

    **Program.cs:**
    - Call `builder.AddServiceDefaults()` for Aspire telemetry, health checks, service discovery
    - Register YARP reverse proxy with `builder.Services.AddReverseProxy().LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"))`
    - Build the app, then map: `app.MapReverseProxy()` and `app.MapDefaultEndpoints()`
    - Keep Program.cs minimal in this plan — no auth, no rate limiting, no CORS yet. Just the bare proxy pipeline:
      ```
      app.MapReverseProxy();
      app.MapDefaultEndpoints();
      app.Run();
      ```

    **appsettings.json:**
    - Configure YARP ReverseProxy section with:
      - One route: `api-catch-all` matching path `/api/{**catch-all}` pointing to cluster `apiservice`
      - One cluster: `apiservice` with a destination using Aspire service discovery URL `https+http://apiservice`
    - Example configuration:
      ```json
      {
        "ReverseProxy": {
          "Routes": {
            "api-catch-all": {
              "ClusterId": "apiservice",
              "Match": {
                "Path": "/api/{**catch-all}"
              }
            }
          },
          "Clusters": {
            "apiservice": {
              "Destinations": {
                "default": {
                  "Address": "https+http://apiservice"
                }
              }
            }
          }
        }
      }
      ```
    - The `https+http://apiservice` address uses Aspire service discovery — at runtime, Aspire resolves `apiservice` to the actual URL

    **appsettings.Development.json:**
    - Standard Aspire development logging settings (match ApiService pattern):
      ```json
      {
        "Logging": {
          "LogLevel": {
            "Default": "Information",
            "Microsoft.AspNetCore": "Warning",
            "Yarp": "Information"
          }
        }
      }
      ```

    **Properties/launchSettings.json:**
    - Add profile for local development with HTTP port (e.g., 5200) and HTTPS port (e.g., 7200)
    - Match format from ApiService launchSettings.json

    Add the project to the solution file `src/MicroCommerce.slnx` using:
    ```bash
    dotnet sln src/MicroCommerce.slnx add src/MicroCommerce.Gateway/MicroCommerce.Gateway.csproj
    ```
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.Gateway/MicroCommerce.Gateway.csproj` and confirm zero errors.
    Run `dotnet sln src/MicroCommerce.slnx list` and confirm MicroCommerce.Gateway appears.
  </verify>
  <done>Gateway project compiles, is in solution, and has YARP configured with catch-all route to apiservice cluster.</done>
</task>

<task type="auto">
  <name>Task 2: Register gateway in Aspire AppHost</name>
  <files>
    src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj
    src/MicroCommerce.AppHost/AppHost.cs
  </files>
  <action>
    **MicroCommerce.AppHost.csproj:**
    - Add ProjectReference to `../MicroCommerce.Gateway/MicroCommerce.Gateway.csproj`

    **AppHost.cs:**
    - Add the gateway as a new Aspire project resource AFTER the apiService definition:
      ```csharp
      var gateway = builder.AddProject<Projects.MicroCommerce_Gateway>("gateway")
          .WithReference(apiService)
          .WithHttpHealthCheck("/health");
      ```
    - The `.WithReference(apiService)` enables Aspire service discovery — the gateway can resolve `apiservice` hostname
    - Do NOT change the frontend reference yet (that happens in Plan 09-03). Frontend still points to apiService for now.
    - Keep all existing resources (postgres, messaging, storage, keycloak, apiService, frontend) exactly as they are
    - The gateway goes between apiService and frontend in the file for readability

    After making changes, verify the full Aspire stack can build:
    ```bash
    dotnet build src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj
    ```
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj` and confirm zero errors.
    Grep AppHost.cs for `MicroCommerce_Gateway` to confirm the project reference is registered.
  </verify>
  <done>AppHost builds successfully with gateway project registered. Gateway has service discovery reference to apiService. Frontend still references apiService directly (unchanged).</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.Gateway/MicroCommerce.Gateway.csproj` — zero errors
2. `dotnet build src/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj` — zero errors
3. `dotnet sln src/MicroCommerce.slnx list` — includes MicroCommerce.Gateway
4. Gateway Program.cs contains `AddReverseProxy`, `MapReverseProxy`, `AddServiceDefaults`, `MapDefaultEndpoints`
5. appsettings.json has YARP route configuration pointing to `apiservice` cluster
6. AppHost.cs registers gateway with `.WithReference(apiService)`
</verification>

<success_criteria>
- Gateway project exists with YARP NuGet package and ServiceDefaults reference
- YARP configured with catch-all route `/api/{**catch-all}` proxying to apiservice cluster
- Gateway registered in Aspire AppHost with service discovery to apiService
- All projects build cleanly with zero errors
- Gateway added to solution file
</success_criteria>

<output>
After completion, create `.planning/phases/09-api-gateway/09-01-SUMMARY.md`
</output>
