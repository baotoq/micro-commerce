---
phase: 14-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/orders/[id]/review/page.tsx
  - src/MicroCommerce.Web/src/components/storefront/order-review-page.tsx
  - src/MicroCommerce.Web/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "Completed orders show a single 'Review Products' button instead of per-item review links"
    - "Clicking 'Review Products' navigates to a page showing all items from that order with review forms"
    - "Already-reviewed items show as reviewed with edit option on the review products page"
    - "Items not yet reviewed show a 'Write a Review' button that opens the review form dialog"
  artifacts:
    - path: "src/MicroCommerce.Web/src/app/(storefront)/orders/[id]/review/page.tsx"
      provides: "Order review products page route"
    - path: "src/MicroCommerce.Web/src/components/storefront/order-review-page.tsx"
      provides: "Order review page component showing all order items with review status"
    - path: "src/MicroCommerce.Web/src/components/storefront/order-detail.tsx"
      provides: "Updated order detail with single Review Products button"
  key_links:
    - from: "src/MicroCommerce.Web/src/components/storefront/order-detail.tsx"
      to: "/orders/[id]/review"
      via: "Link component with Review Products button"
      pattern: "href=.*orders.*review"
    - from: "src/MicroCommerce.Web/src/components/storefront/order-review-page.tsx"
      to: "src/MicroCommerce.Web/src/components/reviews/review-form-dialog.tsx"
      via: "Dialog trigger for writing/editing reviews"
      pattern: "ReviewFormDialog"
---

<objective>
Create the consolidated "Review Products" experience for orders. Replace per-item "Write a Review" links in order detail with a single "Review Products" button per completed order. Create a new `/orders/[orderId]/review` page that shows all items from the order with their review status, allowing users to submit or edit reviews for each product.

Purpose: Implements the locked user decision that "each completed order has a single 'Review products' link showing all reviewable items (not per-product links)."
Output: Updated order-detail.tsx + new order review page route and component.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
@src/MicroCommerce.Web/src/hooks/use-reviews.ts
@src/MicroCommerce.Web/src/hooks/use-orders.ts
@src/MicroCommerce.Web/src/components/reviews/review-form-dialog.tsx
@src/MicroCommerce.Web/src/components/reviews/star-rating-display.tsx
@src/MicroCommerce.Web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create order review products page and component</name>
  <files>
    src/MicroCommerce.Web/src/app/(storefront)/orders/[id]/review/page.tsx
    src/MicroCommerce.Web/src/components/storefront/order-review-page.tsx
    src/MicroCommerce.Web/src/lib/api.ts
  </files>
  <action>
Create the new `/orders/[orderId]/review` route and its component.

**Page route** (`orders/[id]/review/page.tsx`):
- Client component that extracts `id` from params
- Renders `OrderReviewPage` component with the orderId prop

**OrderReviewPage component** (`order-review-page.tsx`):
- "use client" component
- Fetch order data using `useOrderWithPolling(orderId)` from use-orders.ts
- For each order item, call `useCanReview(item.productId)` and `useMyReview(item.productId)` to check review status
- Note: Since we need per-item review status, create a sub-component `OrderItemReviewRow` that handles each item's hooks independently

**Layout:**
- Page title: "Review Products" with order number subtitle (e.g., "Order #ORD-20260213-XXXX")
- Back link: "Back to order" linking to `/orders/{orderId}`
- List of order items, each showing:
  - Product image (size-16 rounded-md), name, quantity x price
  - Review status: If user has already reviewed, show StarRatingDisplay of their rating + "Edit Review" button
  - If not yet reviewed: "Write a Review" button
  - Both buttons open ReviewFormDialog (existing component) — pass `productId`, existing review data for edit mode
- Loading state: Skeleton matching layout structure
- Error state: Inline error with "Try again" button

**API additions (api.ts):**
- If needed, add a `getOrderReviewStatus` helper or reuse existing `canReview` and `getMyReview` per product. The existing per-product hooks are sufficient — no new API endpoint needed.

**Style:** Clean & minimal per Vercel aesthetic. Items separated by `border-b border-zinc-200`. Generous spacing (`space-y-6`). Rounded-full buttons.

**IMPORTANT:** Do NOT add a "My Reviews" section to account sidebar (locked decision).
  </action>
  <verify>
- File exists: `src/MicroCommerce.Web/src/app/(storefront)/orders/[id]/review/page.tsx`
- File exists: `src/MicroCommerce.Web/src/components/storefront/order-review-page.tsx`
- TypeScript compiles: `cd src/MicroCommerce.Web && npx tsc --noEmit`
- Component imports ReviewFormDialog from existing reviews components
- Component uses useOrderWithPolling, useMyReview, useCanReview hooks
  </verify>
  <done>
- Order review page route exists at /orders/[id]/review
- Page shows all items from the order with product image, name, quantity, price
- Each item shows review status (already reviewed with stars, or "Write a Review" button)
- ReviewFormDialog opens for writing new reviews or editing existing ones
- Back link navigates to order detail
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace per-item review links with single Review Products button</name>
  <files>
    src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
  </files>
  <action>
Update `order-detail.tsx` to replace the per-item "Write a Review" links with a single "Review Products" button for the entire order.

**Remove:**
- The `canReview` variable inside the `order.items.map()` loop (line 114)
- The per-item `{canReview && (<Link ...>Write a Review</Link>)}` block (lines 147-155)
- The `<div className="space-y-2">` wrapper around each item (lines 116, 156) — simplify back to just the flex row

**Add (after the items CardContent, inside the Card):**
- Check if order status is reviewable: `["Paid", "Confirmed", "Shipped", "Delivered"].includes(order.status)`
- If reviewable, add a section after items list:
```tsx
<div className="border-t border-zinc-200 px-6 py-4">
  <Button asChild variant="outline" className="w-full rounded-full">
    <Link href={`/orders/${order.id}/review`}>
      <MessageSquare className="mr-2 size-4" />
      Review Products
    </Link>
  </Button>
</div>
```
- Keep MessageSquare import (already imported)

**Result:** Order detail shows items cleanly without per-item review links, and a single "Review Products" button at the bottom of the items card for eligible orders.
  </action>
  <verify>
- `grep -c "Write a Review" src/MicroCommerce.Web/src/components/storefront/order-detail.tsx` returns 0 (per-item links removed)
- `grep -c "Review Products" src/MicroCommerce.Web/src/components/storefront/order-detail.tsx` returns 1 (single button present)
- `grep "orders.*review" src/MicroCommerce.Web/src/components/storefront/order-detail.tsx` shows the link to /orders/[id]/review
- TypeScript compiles: `cd src/MicroCommerce.Web && npx tsc --noEmit`
  </verify>
  <done>
- Per-item "Write a Review" links are completely removed from order detail
- Single "Review Products" button appears after items section for orders with Paid/Confirmed/Shipped/Delivered status
- Button links to /orders/{orderId}/review page
- Non-reviewable orders (Submitted, Failed, Cancelled) do not show the button
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles cleanly: `cd src/MicroCommerce.Web && npx tsc --noEmit`
2. Order detail no longer has per-item review links
3. Order detail has single "Review Products" button for completed orders
4. New /orders/[id]/review route exists and renders order items with review status
5. ReviewFormDialog integration works for both new and edit review flows
</verification>

<success_criteria>
- Per-item "Write a Review" links removed from order detail (locked user decision honored)
- Single "Review Products" button present on order detail for reviewable orders
- /orders/[orderId]/review page shows all order items with review forms
- Already-reviewed items show their rating with edit capability
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-integration-polish/14-01-SUMMARY.md`
</output>
