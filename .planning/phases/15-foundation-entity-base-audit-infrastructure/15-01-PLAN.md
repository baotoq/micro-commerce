---
phase: 15-foundation-entity-base-audit-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/BuildingBlocks/BuildingBlocks.Common/Entity.cs
  - src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs
  - src/BuildingBlocks/BuildingBlocks.Common/IAuditable.cs
  - src/BuildingBlocks/BuildingBlocks.Common/AuditableAggregateRoot.cs
  - src/BuildingBlocks/BuildingBlocks.Common/IConcurrencyToken.cs
  - src/BuildingBlocks/BuildingBlocks.Common/ISoftDeletable.cs
autonomous: true

must_haves:
  truths:
    - "Entity<TId> provides typed Id property for child entities without custom equality"
    - "BaseAggregateRoot<TId> extends Entity<TId> to inherit identity while providing domain events"
    - "AuditableAggregateRoot<TId> combines aggregate root behavior with IAuditable timestamps"
    - "IAuditable defines CreatedAt/UpdatedAt as settable DateTimeOffset properties"
    - "IConcurrencyToken defines int Version for optimistic concurrency"
    - "ISoftDeletable defines IsDeleted and DeletedAt for soft deletion"
  artifacts:
    - path: "src/BuildingBlocks/BuildingBlocks.Common/Entity.cs"
      provides: "Abstract base class for all entities with typed ID"
      contains: "public abstract class Entity<TId>"
    - path: "src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs"
      provides: "Aggregate root extending Entity with domain events"
      contains: "BaseAggregateRoot<TId> : Entity<TId>"
    - path: "src/BuildingBlocks/BuildingBlocks.Common/IAuditable.cs"
      provides: "Audit timestamp interface"
      contains: "interface IAuditable"
    - path: "src/BuildingBlocks/BuildingBlocks.Common/AuditableAggregateRoot.cs"
      provides: "Convenience base for auditable aggregates"
      contains: "AuditableAggregateRoot<TId> : BaseAggregateRoot<TId>, IAuditable"
    - path: "src/BuildingBlocks/BuildingBlocks.Common/IConcurrencyToken.cs"
      provides: "Concurrency token interface with int Version"
      contains: "interface IConcurrencyToken"
    - path: "src/BuildingBlocks/BuildingBlocks.Common/ISoftDeletable.cs"
      provides: "Soft delete marker interface"
      contains: "interface ISoftDeletable"
  key_links:
    - from: "src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs"
      to: "src/BuildingBlocks/BuildingBlocks.Common/Entity.cs"
      via: "class inheritance"
      pattern: "BaseAggregateRoot<TId> : Entity<TId>"
    - from: "src/BuildingBlocks/BuildingBlocks.Common/AuditableAggregateRoot.cs"
      to: "src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs"
      via: "class inheritance"
      pattern: "AuditableAggregateRoot<TId> : BaseAggregateRoot<TId>"
---

<objective>
Create the DDD entity hierarchy and marker interfaces in BuildingBlocks.Common: Entity<TId> base class for child entities, refactor BaseAggregateRoot<TId> to extend Entity<TId>, create IAuditable/IConcurrencyToken/ISoftDeletable interfaces, and AuditableAggregateRoot<TId> convenience base class.

Purpose: Establish the foundational type hierarchy that all entity/aggregate modifications in Phase 21 will build upon. These types define the contracts that interceptors (Plan 02) will operate on.
Output: 6 files in BuildingBlocks.Common providing the complete entity/aggregate type system with audit, concurrency, and soft-delete marker interfaces.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs
@src/BuildingBlocks/BuildingBlocks.Common/IAggregateRoot.cs
@src/BuildingBlocks/BuildingBlocks.Common/StronglyTypedId.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Entity base class and refactor BaseAggregateRoot to extend it</name>
  <files>
    src/BuildingBlocks/BuildingBlocks.Common/Entity.cs
    src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs
  </files>
  <action>
    **Create `Entity.cs`** in `BuildingBlocks.Common`:
    - Abstract class `Entity<TId>` in namespace `MicroCommerce.BuildingBlocks.Common`
    - Public property: `TId Id { get; protected init; } = default!;`
    - Two protected constructors: parameterless `Entity()` and `Entity(TId id)` that sets `Id = id`
    - Do NOT override Equals/GetHashCode (reference equality only, per user decision)
    - Do NOT override ToString (default, per user decision)
    - File-scoped namespace

    **Refactor `BaseAggregateRoot.cs`** to extend `Entity<TId>`:
    - Change from `BaseAggregateRoot<TId>(TId id) : IAggregateRoot` (primary constructor) to regular class `BaseAggregateRoot<TId> : Entity<TId>, IAggregateRoot`
    - Remove primary constructor syntax — use two explicit constructors instead:
      - `protected BaseAggregateRoot() : base() { }`
      - `protected BaseAggregateRoot(TId id) : base(id) { }`
    - Remove the `public TId Id { get; init; }` property (inherited from Entity now)
    - Remove the `?? throw new ArgumentNullException(nameof(id))` — Entity base handles defaults
    - Keep domain events: `_domainEvents` list, `AddDomainEvent`, `DomainEvents`, `ClearDomainEvents` unchanged
    - Keep `[NotMapped]` on DomainEvents
    - Keep existing `using` statements for `System.ComponentModel.DataAnnotations.Schema` and `MicroCommerce.BuildingBlocks.Common.Events`

    **IMPORTANT**: The refactored BaseAggregateRoot must be backward-compatible. All existing aggregates use `base(id)` constructor calls which will now chain to Entity<TId>.
  </action>
  <verify>
    Run `dotnet build src/BuildingBlocks/BuildingBlocks.Common/BuildingBlocks.Common.csproj` — must compile with zero errors and zero warnings.
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` — must compile since all aggregates call `base(id)` which chains correctly.
  </verify>
  <done>
    Entity<TId> abstract class exists with typed Id property using reference equality only. BaseAggregateRoot<TId> extends Entity<TId> and no longer declares its own Id property. All existing aggregate roots compile without changes because the constructor signature `base(id)` chains correctly through the hierarchy.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create IAuditable, IConcurrencyToken, ISoftDeletable interfaces and AuditableAggregateRoot</name>
  <files>
    src/BuildingBlocks/BuildingBlocks.Common/IAuditable.cs
    src/BuildingBlocks/BuildingBlocks.Common/AuditableAggregateRoot.cs
    src/BuildingBlocks/BuildingBlocks.Common/IConcurrencyToken.cs
    src/BuildingBlocks/BuildingBlocks.Common/ISoftDeletable.cs
  </files>
  <action>
    **Create `IAuditable.cs`**:
    - Interface `IAuditable` in namespace `MicroCommerce.BuildingBlocks.Common`
    - Properties: `DateTimeOffset CreatedAt { get; set; }` and `DateTimeOffset UpdatedAt { get; set; }`
    - Settable (not init-only) so interceptor can modify them
    - No CreatedBy/ModifiedBy yet (user discretion: timestamps only for now, future extensible)
    - File-scoped namespace

    **Create `AuditableAggregateRoot.cs`**:
    - Abstract class `AuditableAggregateRoot<TId> : BaseAggregateRoot<TId>, IAuditable`
    - Implements IAuditable: `public DateTimeOffset CreatedAt { get; set; }` and `public DateTimeOffset UpdatedAt { get; set; }`
    - Two protected constructors:
      - `protected AuditableAggregateRoot() : base() { }`
      - `protected AuditableAggregateRoot(TId id) : base(id) { }`
    - File-scoped namespace
    - Add `using` for namespace if needed

    **Create `IConcurrencyToken.cs`**:
    - Interface `IConcurrencyToken` in namespace `MicroCommerce.BuildingBlocks.Common`
    - Single property: `int Version { get; set; }`
    - Use int (not uint) per user discretion — portable, simple, human-readable
    - Settable so interceptor can auto-increment
    - File-scoped namespace

    **Create `ISoftDeletable.cs`**:
    - Interface `ISoftDeletable` in namespace `MicroCommerce.BuildingBlocks.Common`
    - Properties: `bool IsDeleted { get; set; }` and `DateTimeOffset? DeletedAt { get; set; }`
    - DeletedAt is nullable — only set when deleted
    - File-scoped namespace
  </action>
  <verify>
    Run `dotnet build src/BuildingBlocks/BuildingBlocks.Common/BuildingBlocks.Common.csproj` — must compile with zero errors.
    Verify all 4 new files exist and contain the correct interface/class definitions.
  </verify>
  <done>
    IAuditable interface exists with CreatedAt/UpdatedAt DateTimeOffset properties. IConcurrencyToken interface exists with int Version property. ISoftDeletable interface exists with IsDeleted bool and DeletedAt nullable DateTimeOffset. AuditableAggregateRoot<TId> exists extending BaseAggregateRoot<TId> and implementing IAuditable. All types are in the BuildingBlocks.Common namespace and project compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/BuildingBlocks/BuildingBlocks.Common/BuildingBlocks.Common.csproj` compiles with zero errors
2. `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` compiles with zero errors (backward compatibility)
3. Entity<TId> has Id property, two constructors, no custom equality
4. BaseAggregateRoot<TId> extends Entity<TId>, no duplicate Id property
5. IAuditable has CreatedAt + UpdatedAt (DateTimeOffset, settable)
6. IConcurrencyToken has Version (int, settable)
7. ISoftDeletable has IsDeleted (bool) + DeletedAt (DateTimeOffset?)
8. AuditableAggregateRoot<TId> extends BaseAggregateRoot<TId> + implements IAuditable
</verification>

<success_criteria>
- BuildingBlocks.Common compiles with 6 type definitions (Entity, BaseAggregateRoot, IAuditable, IConcurrencyToken, ISoftDeletable, AuditableAggregateRoot)
- ApiService compiles with zero regressions (all existing aggregates work unchanged)
- Type hierarchy: Entity -> BaseAggregateRoot -> AuditableAggregateRoot, with IAggregateRoot, IAuditable, IConcurrencyToken, ISoftDeletable as orthogonal interfaces
</success_criteria>

<output>
After completion, create `.planning/phases/15-foundation-entity-base-audit-infrastructure/15-01-SUMMARY.md`
</output>
