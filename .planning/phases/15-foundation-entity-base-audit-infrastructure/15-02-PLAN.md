---
phase: 15-foundation-entity-base-audit-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/MicroCommerce.ApiService/Common/Persistence/AuditInterceptor.cs
  - src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyInterceptor.cs
  - src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteInterceptor.cs
  - src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs
  - src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs
  - src/MicroCommerce.ApiService/Common/Exceptions/GlobalExceptionHandler.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "IAuditable entities get CreatedAt set on insert and UpdatedAt set on insert+update automatically via SaveChanges"
    - "IConcurrencyToken entities get Version set to 1 on insert and auto-incremented on update via SaveChanges"
    - "ISoftDeletable entities have hard deletes converted to soft deletes with IsDeleted=true and DeletedAt set"
    - "ISoftDeletable entities are automatically filtered from all queries via global query filter"
    - "DbUpdateConcurrencyException is caught globally and returns HTTP 409 Conflict with entity details"
    - "Interceptor order is SoftDelete then Concurrency then Audit then DomainEvent"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Common/Persistence/AuditInterceptor.cs"
      provides: "Auto-sets CreatedAt/UpdatedAt on IAuditable entities"
      contains: "class AuditInterceptor : SaveChangesInterceptor"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyInterceptor.cs"
      provides: "Auto-increments Version on IConcurrencyToken entities"
      contains: "class ConcurrencyInterceptor : SaveChangesInterceptor"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteInterceptor.cs"
      provides: "Converts hard deletes to soft deletes for ISoftDeletable"
      contains: "class SoftDeleteInterceptor : SaveChangesInterceptor"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs"
      provides: "Extension method to apply global query filter for ISoftDeletable"
      contains: "ApplySoftDeleteQueryFilters"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs"
      provides: "Extension method to configure Version as concurrency token"
      contains: "ApplyConcurrencyTokenConvention"
    - path: "src/MicroCommerce.ApiService/Program.cs"
      provides: "Interceptor DI registration"
      contains: "AddScoped<AuditInterceptor>"
  key_links:
    - from: "src/MicroCommerce.ApiService/Common/Persistence/AuditInterceptor.cs"
      to: "src/BuildingBlocks/BuildingBlocks.Common/IAuditable.cs"
      via: "ChangeTracker.Entries<IAuditable>()"
      pattern: "Entries<IAuditable>"
    - from: "src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyInterceptor.cs"
      to: "src/BuildingBlocks/BuildingBlocks.Common/IConcurrencyToken.cs"
      via: "ChangeTracker.Entries<IConcurrencyToken>()"
      pattern: "Entries<IConcurrencyToken>"
    - from: "src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteInterceptor.cs"
      to: "src/BuildingBlocks/BuildingBlocks.Common/ISoftDeletable.cs"
      via: "ChangeTracker.Entries<ISoftDeletable>()"
      pattern: "Entries<ISoftDeletable>"
    - from: "src/MicroCommerce.ApiService/Common/Exceptions/GlobalExceptionHandler.cs"
      to: "Microsoft.EntityFrameworkCore/DbUpdateConcurrencyException"
      via: "exception pattern match"
      pattern: "DbUpdateConcurrencyException"
---

<objective>
Create the three EF Core SaveChangesInterceptors (Audit, Concurrency, SoftDelete) that automatically manage IAuditable timestamps, IConcurrencyToken versioning, and ISoftDeletable deletion. Add convention extension methods for global query filters and concurrency token configuration. Register interceptors in DI and update GlobalExceptionHandler to catch DbUpdateConcurrencyException and return HTTP 409.

Purpose: Complete the infrastructure that makes the BuildingBlocks interfaces (Plan 01) operational. Entities implementing these interfaces will have their audit/concurrency/soft-delete behavior managed automatically without any manual code in domain entities or command handlers.
Output: 5 new infrastructure files, updated GlobalExceptionHandler and Program.cs with interceptor registration.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-foundation-entity-base-audit-infrastructure/15-01-SUMMARY.md
@src/MicroCommerce.ApiService/Common/Persistence/DomainEventInterceptor.cs
@src/MicroCommerce.ApiService/Common/Exceptions/GlobalExceptionHandler.cs
@src/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuditInterceptor, ConcurrencyInterceptor, and SoftDeleteInterceptor</name>
  <files>
    src/MicroCommerce.ApiService/Common/Persistence/AuditInterceptor.cs
    src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyInterceptor.cs
    src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteInterceptor.cs
  </files>
  <action>
    **Create `AuditInterceptor.cs`** in `Common/Persistence`:
    - Sealed class extending `SaveChangesInterceptor`
    - Override both `SavingChanges` and `SavingChangesAsync` (call shared helper)
    - Helper method `UpdateAuditFields(DbContext? context)`:
      - If context is null, return
      - Capture `DateTimeOffset now = DateTimeOffset.UtcNow` once
      - Iterate `context.ChangeTracker.Entries<IAuditable>()`
      - On `EntityState.Added`: set both `CreatedAt = now` and `UpdatedAt = now`
      - On `EntityState.Modified`: set `UpdatedAt = now` only
    - Use `MicroCommerce.BuildingBlocks.Common` for IAuditable
    - Use `Microsoft.EntityFrameworkCore` and `Microsoft.EntityFrameworkCore.Diagnostics`
    - Namespace: `MicroCommerce.ApiService.Common.Persistence`
    - File-scoped namespace

    **Create `ConcurrencyInterceptor.cs`** in `Common/Persistence`:
    - Sealed class extending `SaveChangesInterceptor`
    - Override both `SavingChanges` and `SavingChangesAsync` (call shared helper)
    - Helper method `IncrementVersions(DbContext? context)`:
      - If context is null, return
      - Iterate `context.ChangeTracker.Entries<IConcurrencyToken>()`
      - On `EntityState.Added`: set `Version = 1`
      - On `EntityState.Modified`: increment `Version++`
    - Use `MicroCommerce.BuildingBlocks.Common` for IConcurrencyToken
    - Namespace: `MicroCommerce.ApiService.Common.Persistence`
    - File-scoped namespace

    **Create `SoftDeleteInterceptor.cs`** in `Common/Persistence`:
    - Sealed class extending `SaveChangesInterceptor`
    - Override both `SavingChanges` and `SavingChangesAsync` (call shared helper)
    - Helper method `ConvertDeletesToSoftDeletes(DbContext? context)`:
      - If context is null, return
      - Capture `DateTimeOffset now = DateTimeOffset.UtcNow` once
      - Iterate `context.ChangeTracker.Entries<ISoftDeletable>()`
      - On `EntityState.Deleted`:
        - Change `entry.State = EntityState.Modified`
        - Set `entry.Entity.IsDeleted = true`
        - Set `entry.Entity.DeletedAt = now`
        - If entity also implements `IAuditable`, set `auditable.UpdatedAt = now` (user discretion: track deletion as modification)
    - Use `MicroCommerce.BuildingBlocks.Common` for ISoftDeletable, IAuditable
    - Namespace: `MicroCommerce.ApiService.Common.Persistence`
    - File-scoped namespace

    **IMPORTANT interceptor ordering note**: These interceptors will be registered in Program.cs in the correct order: SoftDelete first (changes Deleted to Modified), then Concurrency (increments version on Modified), then Audit (sets timestamps on Modified/Added), then DomainEvent (fires after save). SavingChanges interceptors run in registration order.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` — must compile with zero errors.
    All three interceptor files exist in `src/MicroCommerce.ApiService/Common/Persistence/`.
  </verify>
  <done>
    Three SaveChangesInterceptors created: AuditInterceptor (auto-timestamps), ConcurrencyInterceptor (auto-version), SoftDeleteInterceptor (delete-to-soft-delete conversion). Each overrides both sync and async SavingChanges methods. SoftDeleteInterceptor also updates IAuditable.UpdatedAt on soft delete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create convention helpers, register interceptors, and add DbUpdateConcurrencyException handling</name>
  <files>
    src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs
    src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs
    src/MicroCommerce.ApiService/Common/Exceptions/GlobalExceptionHandler.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    **Create `SoftDeleteQueryFilterConvention.cs`** in `Common/Persistence`:
    - Static class with extension method `ApplySoftDeleteQueryFilters(this ModelBuilder modelBuilder)`
    - Iterate `modelBuilder.Model.GetEntityTypes()`
    - For each entity type where `typeof(ISoftDeletable).IsAssignableFrom(entityType.ClrType)`:
      - Build expression filter: `e => !e.IsDeleted`
      - Use `System.Linq.Expressions`: `Expression.Parameter(entityType.ClrType, "e")`, `Expression.Property(..., nameof(ISoftDeletable.IsDeleted))`, `Expression.Not(...)`, `Expression.Lambda(...)`
      - Call `entityType.SetQueryFilter(filter)` (note: if an entity type already has a query filter from configuration, this may need to be combined — but for Phase 15 infrastructure-only, no entities implement ISoftDeletable yet so this is safe)
    - Namespace: `MicroCommerce.ApiService.Common.Persistence`
    - File-scoped namespace, `using System.Linq.Expressions;`, `using MicroCommerce.BuildingBlocks.Common;`, `using Microsoft.EntityFrameworkCore;`

    **Create `ConcurrencyTokenConvention.cs`** in `Common/Persistence`:
    - Static class with extension method `ApplyConcurrencyTokenConvention(this ModelBuilder modelBuilder)`
    - Iterate `modelBuilder.Model.GetEntityTypes()`
    - For each entity type where `typeof(IConcurrencyToken).IsAssignableFrom(entityType.ClrType)`:
      - Find property: `entityType.FindProperty(nameof(IConcurrencyToken.Version))`
      - If found, call `.IsConcurrencyToken = true` on the property
    - Namespace: `MicroCommerce.ApiService.Common.Persistence`
    - File-scoped namespace

    **Update `GlobalExceptionHandler.cs`**:
    - Add `using Microsoft.EntityFrameworkCore;` at the top
    - Add a new case to the switch expression in `TryHandleAsync`, BEFORE the generic `InvalidOperationException` case:
      ```
      DbUpdateConcurrencyException dbConcurrencyEx => (
          StatusCodes.Status409Conflict,
          "Concurrency Conflict",
          $"The resource was modified by another request. {FormatConcurrencyDetail(dbConcurrencyEx)}"),
      ```
    - Add private static helper method `FormatConcurrencyDetail(DbUpdateConcurrencyException ex)`:
      - Get the first entry: `ex.Entries.FirstOrDefault()`
      - If entry exists, return `$"Entity: {entry.Entity.GetType().Name}. Please refresh and retry."`
      - If no entry, return `"Please refresh and retry."`
    - This ensures DbUpdateConcurrencyException returns HTTP 409 with entity type info per user decision

    **Update `Program.cs`**:
    - Add using statements: `using MicroCommerce.ApiService.Common.Persistence;` (if not already present — check first)
    - Register new interceptors as scoped services, AFTER the existing `builder.Services.AddScoped<DomainEventInterceptor>();` line (line 144):
      ```csharp
      builder.Services.AddScoped<SoftDeleteInterceptor>();
      builder.Services.AddScoped<ConcurrencyInterceptor>();
      builder.Services.AddScoped<AuditInterceptor>();
      ```
    - Registration order for documentation: SoftDelete, Concurrency, Audit, DomainEvent (existing)
    - Note: The interceptors are registered in DI but NOT yet wired into DbContexts. The existing DomainEventInterceptor is also registered but not wired. Wiring all interceptors into DbContexts will happen in Phase 21 (full adoption) when entities actually implement these interfaces. For now, the interceptors exist and are ready.
    - DO NOT modify any DbContext files or add `AddInterceptors` calls — this phase is infrastructure-only per scope boundary
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` — must compile with zero errors and zero warnings.
    Run `dotnet test src/MicroCommerce.ApiService.Tests/ --no-restore` — all existing tests must pass (no regressions from GlobalExceptionHandler change).
  </verify>
  <done>
    SoftDeleteQueryFilterConvention extension method exists for applying global IsDeleted query filters. ConcurrencyTokenConvention extension method exists for marking Version as concurrency token. GlobalExceptionHandler catches DbUpdateConcurrencyException and returns HTTP 409 with entity type details. All 3 new interceptors registered as scoped services in Program.cs. All existing tests pass with no regressions.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` compiles with zero errors
2. `dotnet test src/MicroCommerce.ApiService.Tests/ --no-restore` passes all tests
3. AuditInterceptor iterates `Entries<IAuditable>()` and sets timestamps on Added/Modified
4. ConcurrencyInterceptor iterates `Entries<IConcurrencyToken>()` and sets Version=1 on Added, Version++ on Modified
5. SoftDeleteInterceptor iterates `Entries<ISoftDeletable>()` and converts Deleted to Modified with IsDeleted=true
6. SoftDeleteQueryFilterConvention builds expression-based query filter for ISoftDeletable entities
7. ConcurrencyTokenConvention marks Version property as concurrency token
8. GlobalExceptionHandler maps DbUpdateConcurrencyException to HTTP 409 with entity type detail
9. Program.cs registers SoftDeleteInterceptor, ConcurrencyInterceptor, AuditInterceptor as scoped services
</verification>

<success_criteria>
- All 3 interceptors implement SaveChangesInterceptor with both sync and async overrides
- Convention helpers provide ModelBuilder extension methods for query filters and concurrency tokens
- GlobalExceptionHandler returns HTTP 409 on DbUpdateConcurrencyException (not 500)
- All interceptors registered in DI in correct order: SoftDelete, Concurrency, Audit, DomainEvent
- All existing tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/15-foundation-entity-base-audit-infrastructure/15-02-SUMMARY.md`
</output>
