---
phase: 11-user-profiles-auth-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/UserProfileId.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/AddressId.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/Events/ProfileCreatedDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/Events/ProfileUpdatedDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/ProfilesDbContext.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/AvatarImageService.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "UserProfile aggregate root manages display name, avatar URL, and address collection"
    - "Address is an owned entity collection with default flag invariant"
    - "ProfilesDbContext persists to 'profiles' PostgreSQL schema"
    - "AvatarImageService crops images to square and resizes to 400x400 using ImageSharp"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs"
      provides: "Aggregate root with addresses, display name, avatar"
      contains: "BaseAggregateRoot"
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs"
      provides: "Address value object with IsDefault flag"
      contains: "ValueObject"
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/ProfilesDbContext.cs"
      provides: "Database context with 'profiles' schema"
      contains: "HasDefaultSchema"
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/AvatarImageService.cs"
      provides: "Image processing and blob storage upload"
      contains: "ImageSharp"
  key_links:
    - from: "UserProfile.cs"
      to: "Address.cs"
      via: "OwnsMany collection"
      pattern: "_addresses"
    - from: "ProfilesDbContext.cs"
      to: "Program.cs"
      via: "AddNpgsqlDbContext registration"
      pattern: "AddNpgsqlDbContext<ProfilesDbContext>"
---

<objective>
Create the Profiles backend feature module with domain model, infrastructure, and avatar processing.

Purpose: Establish the UserProfile aggregate root with address book support and avatar image processing — the foundation for all profile CQRS operations and frontend integration.
Output: Profiles domain model, ProfilesDbContext with migration, AvatarImageService with ImageSharp, DI registration in Program.cs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-user-profiles-auth-flow/11-RESEARCH.md

@src/MicroCommerce.ApiService/Program.cs
@src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs
@src/BuildingBlocks/BuildingBlocks.Common/StronglyTypedId.cs
@src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs
@src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDbContext.cs
@src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/ImageUploadService.cs
@src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/Cart.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Profiles domain model (aggregate, value objects, events)</name>
  <files>
    src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/UserProfileId.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/AddressId.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/Events/ProfileCreatedDomainEvent.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/Events/ProfileUpdatedDomainEvent.cs
  </files>
  <action>
    Create the Profiles domain model following the exact patterns from Cart and Catalog modules.

    **UserProfileId.cs:** `public sealed record UserProfileId(Guid Value) : StronglyTypedId<Guid>(Value)` with `public static UserProfileId New() => new(Guid.NewGuid());`

    **AddressId.cs:** `public sealed record AddressId(Guid Value) : StronglyTypedId<Guid>(Value)` with `public static AddressId New() => new(Guid.NewGuid());`

    **DisplayName.cs:** Value object class extending ValueObject. Create factory method `DisplayName.Create(string value)` that trims and validates: not null/empty, length 2-50. Store as single `string Value` property (private set). GetEqualityComponents yields Value.

    **Address.cs:** Class extending ValueObject. Properties: AddressId Id, string Name (label like "Home"), string Street, string City, string State, string ZipCode, string Country, bool IsDefault. Private constructor for EF. Factory method `Address.Create(name, street, city, state, zipCode, country)` that trims all inputs and generates new AddressId. Internal methods `SetAsDefault()` and `ClearDefault()` to toggle IsDefault. GetEqualityComponents yields Street, City, State, ZipCode, Country.

    **UserProfile.cs:** Aggregate root extending `BaseAggregateRoot<UserProfileId>`. Properties: `Guid UserId` (Keycloak sub claim, will have unique index), `DisplayName DisplayName`, `string? AvatarUrl`, `DateTimeOffset CreatedAt`, `DateTimeOffset UpdatedAt`, `[Timestamp] uint Version` (xmin concurrency). Private `List<Address> _addresses = []` with public `IReadOnlyCollection<Address> Addresses` property. Private EF constructor. Methods:
    - `static UserProfile Create(Guid userId, string displayName)` - factory, raises ProfileCreatedDomainEvent
    - `void UpdateDisplayName(string displayName)` - updates and touches
    - `void SetAvatar(string avatarUrl)` - sets URL and touches
    - `void RemoveAvatar()` - sets null and touches
    - `AddressId AddAddress(name, street, city, state, zipCode, country, bool setAsDefault = false)` - creates Address, if setAsDefault or first address clears others and sets default, adds to list, touches
    - `void UpdateAddress(AddressId, name, street, city, state, zipCode, country)` - finds address, creates new with same default flag, replaces in list, touches
    - `void DeleteAddress(AddressId)` - removes, if was default sets first remaining as default, touches
    - `void SetDefaultAddress(AddressId)` - clears all defaults, sets target, touches
    - Private `Touch()` sets UpdatedAt = UtcNow and raises ProfileUpdatedDomainEvent
    - Private `FindAddress(AddressId)` returns address or throws InvalidOperationException

    **ProfileCreatedDomainEvent.cs:** `public sealed record ProfileCreatedDomainEvent(UserProfileId ProfileId, Guid UserId) : DomainEvent;`

    **ProfileUpdatedDomainEvent.cs:** `public sealed record ProfileUpdatedDomainEvent(UserProfileId ProfileId, Guid UserId) : DomainEvent;`

    Use file-scoped namespaces: `MicroCommerce.ApiService.Features.Profiles.Domain.Entities`, `.ValueObjects`, `.Events`. Follow Cart.cs aggregate pattern exactly (private constructor, factory method, Touch pattern).
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService` compiles without errors. All domain files exist in Features/Profiles/Domain/.
  </verify>
  <done>
    UserProfile aggregate manages display name, avatar, and address collection with DDD invariants. Address supports default flag with single-default enforcement. Domain events raised on create and update.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProfilesDbContext, EF configurations, AvatarImageService, and register in Program.cs</name>
  <files>
    src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/ProfilesDbContext.cs
    src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
    src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/AvatarImageService.cs
    src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    **Install ImageSharp:**
    Run `dotnet add src/MicroCommerce.ApiService package SixLabors.ImageSharp --version 3.1.6`

    **ProfilesDbContext.cs:** Follow CatalogDbContext pattern exactly. Schema = "profiles". DbSet for UserProfile. ApplyConfigurationsFromAssembly filtered to `Features.Profiles` namespace.

    **UserProfileConfiguration.cs:** IEntityTypeConfiguration for UserProfile.
    - HasKey on Id with ValueGeneratedNever
    - Id property conversion: `HasConversion(id => id.Value, value => new UserProfileId(value))`
    - UserId: HasIndex with IsUnique (prevents duplicate profiles per user)
    - DisplayName: OwnsOne with RequiredColumn, MaxLength(50)
    - AvatarUrl: optional string, MaxLength(500)
    - Version: IsRowVersion()
    - Addresses: OwnsMany configuration. Address table in "profiles" schema. Configure:
      - AddressId conversion like UserProfileId
      - Name: Required, MaxLength(50)
      - Street: Required, MaxLength(200)
      - City: Required, MaxLength(100)
      - State: Required, MaxLength(50)
      - ZipCode: Required, MaxLength(20)
      - Country: Required, MaxLength(100)
      - IsDefault: Required, DefaultValue(false)
      - Navigation uses `_addresses` backing field via UsePropertyAccessMode(PropertyAccessMode.Field)

    **AvatarImageService.cs:** Interface `IAvatarImageService` with:
    - `Task<string> ProcessAndUploadAvatarAsync(Stream imageStream, string originalFileName, CancellationToken ct = default)`
    - `Task DeleteAvatarAsync(string avatarUrl, CancellationToken ct = default)`

    Implementation `AvatarImageService` with BlobServiceClient constructor injection. ContainerName = "avatars", AvatarSize = 400.
    - ProcessAndUploadAvatarAsync: Load image with `Image.LoadAsync`, crop to square from center (calculate min dimension, offset x/y), resize to 400x400, save as JPEG to MemoryStream, upload to blob with ContentType "image/jpeg", return blob URI.
    - DeleteAvatarAsync: If URL not empty, parse blob name from URI, delete from container.
    Follow ImageUploadService pattern for blob operations. Use `SixLabors.ImageSharp` and `SixLabors.ImageSharp.Processing` namespaces.

    **Program.cs updates:**
    1. Add `using MicroCommerce.ApiService.Features.Profiles.Infrastructure;` at top
    2. After the InventoryDbContext registration block, add:
    ```csharp
    builder.AddNpgsqlDbContext<ProfilesDbContext>("appdb", configureDbContextOptions: options =>
    {
        options.UseNpgsql(npgsql =>
            npgsql.MigrationsHistoryTable("__EFMigrationsHistory", "profiles"));
    });
    ```
    3. After the Messaging services comment block, add:
    ```csharp
    // Profile services
    builder.Services.AddScoped<IAvatarImageService, AvatarImageService>();
    ```

    **Generate EF migration:** Run `dotnet ef migrations add InitialProfiles --project src/MicroCommerce.ApiService --context ProfilesDbContext -- --environment Development` (if dotnet-ef is available). If not, skip migration — it will be auto-created on first run.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService` compiles without errors. ProfilesDbContext is registered. AvatarImageService DI is registered. ImageSharp package reference exists in .csproj.
  </verify>
  <done>
    ProfilesDbContext configured with 'profiles' schema and UserProfile + Address entity configurations. AvatarImageService processes images (crop to square, resize 400x400, upload to Azure Blob Storage). All services registered in Program.cs. EF migration generated (or ready to generate).
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService` compiles with zero errors
2. `grep -r "SixLabors.ImageSharp" src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` shows package reference
3. `grep "ProfilesDbContext" src/MicroCommerce.ApiService/Program.cs` shows registration
4. `grep "IAvatarImageService" src/MicroCommerce.ApiService/Program.cs` shows DI registration
5. All files in Features/Profiles/Domain/ and Features/Profiles/Infrastructure/ exist
</verification>

<success_criteria>
- UserProfile aggregate root with full DDD pattern (factory, domain events, invariants)
- Address owned entity collection with single-default enforcement
- ProfilesDbContext with schema isolation and entity configurations
- AvatarImageService with ImageSharp crop/resize/upload pipeline
- All registered in Program.cs DI container
- Project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-user-profiles-auth-flow/11-01-SUMMARY.md`
</output>
