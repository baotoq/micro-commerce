---
phase: 11-user-profiles-auth-flow
plan: 05
type: execute
wave: 3
depends_on: ["11-02", "11-03", "11-04"]
files_modified:
  - src/MicroCommerce.Web/src/app/(storefront)/account/addresses/page.tsx
  - src/MicroCommerce.Web/src/components/account/address-card.tsx
  - src/MicroCommerce.Web/src/components/account/address-form-dialog.tsx
  - src/MicroCommerce.Web/src/components/account/delete-address-dialog.tsx
  - src/MicroCommerce.Web/src/components/storefront/header.tsx
  - src/MicroCommerce.Web/src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "User can add a new address via modal dialog"
    - "User can edit an existing address via modal dialog"
    - "User can delete an address with confirmation prompt"
    - "User can set a default address via star icon on address card"
    - "Header has account icon linking to /account"
    - "Cart merges silently on login without redirecting"
  artifacts:
    - path: "src/MicroCommerce.Web/src/components/account/address-form-dialog.tsx"
      provides: "Add/edit address modal"
      contains: "Dialog"
    - path: "src/MicroCommerce.Web/src/components/account/address-card.tsx"
      provides: "Address display card with actions"
      contains: "Star"
    - path: "src/MicroCommerce.Web/src/components/account/delete-address-dialog.tsx"
      provides: "Delete confirmation dialog"
      contains: "AlertDialog"
    - path: "src/MicroCommerce.Web/src/components/storefront/header.tsx"
      provides: "Header with account icon"
      contains: "User"
  key_links:
    - from: "addresses/page.tsx"
      to: "address-form-dialog.tsx"
      via: "component render"
      pattern: "AddressFormDialog"
    - from: "address-card.tsx"
      to: "use-profile.ts"
      via: "useSetDefaultAddress, useDeleteAddress"
      pattern: "useSetDefaultAddress"
    - from: "header.tsx"
      to: "/account"
      via: "Link component"
      pattern: "href.*account"
---

<objective>
Complete the frontend with address book UI, header account navigation, and cart merge on login.

Purpose: Finish all remaining frontend work for Phase 11: full address book CRUD with modals and confirmation dialogs, header account icon for navigation, and cart merge triggered on login. This completes the user-facing profile experience.
Output: Address book page with CRUD dialogs, header account link, cart merge integration, route protection for account pages.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-user-profiles-auth-flow/11-RESEARCH.md
@.planning/phases/11-user-profiles-auth-flow/11-02-SUMMARY.md
@.planning/phases/11-user-profiles-auth-flow/11-04-SUMMARY.md

@src/MicroCommerce.Web/src/components/storefront/header.tsx
@src/MicroCommerce.Web/src/hooks/use-profile.ts
@src/MicroCommerce.Web/src/middleware.ts
@src/MicroCommerce.Web/src/auth.ts
@src/MicroCommerce.Web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build address book page with form dialog, card, and delete confirmation</name>
  <files>
    src/MicroCommerce.Web/src/app/(storefront)/account/addresses/page.tsx
    src/MicroCommerce.Web/src/components/account/address-form-dialog.tsx
    src/MicroCommerce.Web/src/components/account/address-card.tsx
    src/MicroCommerce.Web/src/components/account/delete-address-dialog.tsx
  </files>
  <action>
    **address-form-dialog.tsx:** "use client" component using Dialog from @/components/ui/dialog. Props: `{ address?: AddressDto; trigger: React.ReactNode; onClose?: () => void }`. Uses useState for open state. Uses useForm or local state for form fields (name, street, city, state, zipCode, country). isEdit mode determined by presence of address prop. On submit: if editing, call useUpdateAddress with { id: address.id, ...formData }; if adding, call useAddAddress with formData. Close dialog on success via onSuccess callback or mutation state. Form fields: Name (placeholder "Home, Work, etc."), Street, City, State, Zip Code (with alphanumeric validation hint), Country. All use Input + Label from shadcn/ui. Submit button shows "Add Address" or "Update Address". Use standard fixed fields per Claude's discretion (not country-adaptive). Display validation errors from form state.

    **address-card.tsx:** "use client" component. Props: `{ address: AddressDto }`. Renders a Card with: address Name as title, full address formatted on multiple lines (Street, City State ZipCode, Country). Actions row at bottom: Star icon button for set default (filled/outlined based on IsDefault), Edit button (opens AddressFormDialog with address data), Delete button (opens DeleteAddressDialog). Uses useSetDefaultAddress hook for star toggle. Star icon: if IsDefault, show filled Star with amber color and text "Default"; if not, show outline StarOff with "Set as default" tooltip. Per user decision: star icon / "Set as default" toggle on each card.

    **delete-address-dialog.tsx:** "use client" component using AlertDialog from @/components/ui/alert-dialog. Props: `{ addressId: string; addressName: string; trigger: React.ReactNode }`. Renders AlertDialog with title "Delete Address?", description "Are you sure you want to delete '{addressName}'? This action cannot be undone." Action button "Delete" (destructive variant) calls useDeleteAddress. Cancel button dismisses.

    **account/addresses/page.tsx:** Replace the placeholder. "use client" page. Uses useProfile hook to get addresses from profile data. Shows heading "Addresses" with "Add Address" button (Plus icon) that opens AddressFormDialog in add mode. Below: grid of AddressCard components (2 columns on lg, 1 on mobile). If no addresses, show empty state message "No addresses saved yet. Add your first address." Loading state shows skeleton cards. Each AddressCard gets the address data. The AddressFormDialog for adding wraps the "Add Address" button as its trigger.

    **Per user decisions:**
    - Modal/dialog form for adding AND editing (not inline editing)
    - No limit on number of saved addresses
    - Star icon / "Set as default" toggle on each card
    - Delete with confirmation prompt (AlertDialog)
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npx tsc --noEmit` type-checks. Address page renders cards from profile data. Dialog opens for add/edit. Delete shows confirmation.
  </verify>
  <done>
    Address book page shows all addresses as cards with star default toggle, edit via dialog, and delete with confirmation. Add Address button opens modal form. No address limit enforced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add account icon to header, protect account routes, and wire cart merge on login</name>
  <files>
    src/MicroCommerce.Web/src/components/storefront/header.tsx
    src/MicroCommerce.Web/src/middleware.ts
  </files>
  <action>
    **header.tsx - Add account icon and cart merge:**
    Add a User icon (from lucide-react) next to the existing Orders (ClipboardList) and Cart icons in the header. The icon should link to /account. Also import useSession from next-auth/react.

    For authenticated users: Show User icon linking to /account.
    For unauthenticated users: Show User icon that triggers signIn("keycloak") on click.

    Per user decision: "Login/register available via header account icon AND at checkout."

    Add cart merge on login detection. Import useSession, useEffect, useRef. When session becomes available and session.isNewLogin is true:
    1. Call mergeCart(session.accessToken) from api.ts
    2. Invalidate cart queries via queryClient

    Implementation:
    ```typescript
    const { data: session } = useSession();
    const queryClient = useQueryClient();
    const hasMerged = useRef(false);

    useEffect(() => {
      if (session?.isNewLogin && session?.accessToken && !hasMerged.current) {
        hasMerged.current = true;
        mergeCart(session.accessToken).then(() => {
          queryClient.invalidateQueries({ queryKey: ["cart"] });
          queryClient.invalidateQueries({ queryKey: ["cartItemCount"] });
        });
      }
    }, [session, queryClient]);
    ```

    Import mergeCart from @/lib/api, useQueryClient from @tanstack/react-query.

    Header icon layout (right side, in order): Account icon, Orders icon, Cart icon, Mobile menu toggle.

    The account icon on desktop:
    ```tsx
    {session ? (
      <Link
        href="/account"
        className="hidden text-zinc-500 transition-colors hover:text-zinc-900 sm:block"
        aria-label="My account"
      >
        <User className="h-4 w-4" />
      </Link>
    ) : (
      <button
        onClick={() => signIn("keycloak")}
        className="hidden text-zinc-500 transition-colors hover:text-zinc-900 sm:block"
        aria-label="Sign in"
      >
        <User className="h-4 w-4" />
      </button>
    )}
    ```

    Add account link to mobile menu too: "Account" or "Sign In" based on session state.

    Per user decision: "After login, user stays on the current page (no redirect)." This is already the default behavior with NextAuth's signIn â€” it redirects back to the current page after auth.

    **middleware.ts - Protect account routes:**
    Update the middleware to require authentication for /account/* routes:
    ```typescript
    export default auth((req) => {
      if (!req.auth && req.nextUrl.pathname.startsWith("/account")) {
        const signInUrl = new URL("/api/auth/signin", req.nextUrl.origin);
        signInUrl.searchParams.set("callbackUrl", req.nextUrl.pathname);
        return Response.redirect(signInUrl);
      }
    });
    ```

    This ensures unauthenticated users accessing /account are redirected to sign in, then returned to the account page after login.
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npx tsc --noEmit` type-checks. Header shows User icon. Middleware protects /account routes. Cart merge is triggered on login.
  </verify>
  <done>
    Header has account icon (links to /account when authed, triggers sign-in when not). Account routes protected by middleware (redirects to sign in). Cart merge fires silently on login via isNewLogin session flag. User stays on current page after login.
  </done>
</task>

</tasks>

<verification>
1. `cd src/MicroCommerce.Web && npx tsc --noEmit` passes
2. Address page shows cards with star/edit/delete actions
3. Add Address button opens dialog form
4. Delete shows AlertDialog confirmation
5. Header has User icon with auth-aware behavior
6. /account routes redirect to sign-in for unauthenticated users
7. Cart merge triggers on fresh login
</verification>

<success_criteria>
- Full address book CRUD: add via dialog, edit via dialog, delete with confirmation, set default via star
- Header account icon: links to /account (authed) or triggers sign-in (unauthed)
- Account routes protected by middleware
- Cart merge happens silently on login (no redirect, no user intervention)
- All TypeScript compiles
- Phase 11 success criteria met: profile, avatar, addresses, orders, cart merge
</success_criteria>

<output>
After completion, create `.planning/phases/11-user-profiles-auth-flow/11-05-SUMMARY.md`
</output>
