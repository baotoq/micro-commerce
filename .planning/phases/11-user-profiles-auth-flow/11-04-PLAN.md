---
phase: 11-user-profiles-auth-flow
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.Web/src/app/(storefront)/account/layout.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/account/page.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/account/profile/page.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/account/addresses/page.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/account/orders/page.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/account/security/page.tsx
  - src/MicroCommerce.Web/src/components/account/account-sidebar.tsx
  - src/MicroCommerce.Web/src/components/account/profile-form.tsx
  - src/MicroCommerce.Web/src/components/account/avatar-upload.tsx
  - src/MicroCommerce.Web/src/hooks/use-profile.ts
  - src/MicroCommerce.Web/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "My Account page has sidebar navigation with Profile, Addresses, Orders, Security sections"
    - "Profile section shows display name and avatar in view mode with Edit button"
    - "Clicking avatar circle triggers file upload"
    - "Remove avatar button reverts to silhouette placeholder"
    - "Security section links to Keycloak account management"
  artifacts:
    - path: "src/MicroCommerce.Web/src/app/(storefront)/account/layout.tsx"
      provides: "Account layout with sidebar"
      contains: "AccountSidebar"
    - path: "src/MicroCommerce.Web/src/components/account/avatar-upload.tsx"
      provides: "Click-to-upload avatar component"
      contains: "fileInputRef"
    - path: "src/MicroCommerce.Web/src/components/account/profile-form.tsx"
      provides: "View/edit profile form"
      contains: "Edit"
    - path: "src/MicroCommerce.Web/src/hooks/use-profile.ts"
      provides: "React Query hooks for profile"
      contains: "useProfile"
  key_links:
    - from: "account/layout.tsx"
      to: "account-sidebar.tsx"
      via: "component import"
      pattern: "AccountSidebar"
    - from: "use-profile.ts"
      to: "api.ts"
      via: "query/mutation functions"
      pattern: "getMyProfile"
    - from: "avatar-upload.tsx"
      to: "use-profile.ts"
      via: "useUploadAvatar hook"
      pattern: "useUploadAvatar"
---

<objective>
Build the My Account frontend layout with sidebar navigation, profile view/edit, and avatar upload.

Purpose: Users need a central place to manage their account. The sidebar layout provides navigation across Profile, Addresses, Orders, and Security sections. The profile page enables display name editing and avatar upload via clicking the avatar circle.
Output: Account layout with sidebar, profile page with view/edit toggle, avatar upload/remove component, profile React Query hooks, API functions.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-user-profiles-auth-flow/11-RESEARCH.md

@src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
@src/MicroCommerce.Web/src/components/storefront/header.tsx
@src/MicroCommerce.Web/src/hooks/use-cart.ts
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/auth.ts
@src/MicroCommerce.Web/src/components/auth/auth-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile/address API types and functions to api.ts, create profile hooks</name>
  <files>
    src/MicroCommerce.Web/src/lib/api.ts
    src/MicroCommerce.Web/src/hooks/use-profile.ts
  </files>
  <action>
    **api.ts - Add Profile types and functions after the Ordering section:**

    Types:
    ```typescript
    // Profile types
    export interface AddressDto {
      id: string;
      name: string;
      street: string;
      city: string;
      state: string;
      zipCode: string;
      country: string;
      isDefault: boolean;
    }

    export interface ProfileDto {
      id: string;
      userId: string;
      displayName: string;
      avatarUrl: string | null;
      addresses: AddressDto[];
      createdAt: string;
      updatedAt: string;
    }

    export interface UpdateProfileRequest {
      displayName: string;
    }

    export interface AddAddressRequest {
      name: string;
      street: string;
      city: string;
      state: string;
      zipCode: string;
      country: string;
      setAsDefault?: boolean;
    }

    export interface UpdateAddressRequest {
      name: string;
      street: string;
      city: string;
      state: string;
      zipCode: string;
      country: string;
    }
    ```

    Functions (all use `credentials: "include"` for cookies AND pass Authorization header when available):
    ```typescript
    // Profile API functions
    export async function getMyProfile(accessToken?: string): Promise<ProfileDto> {
      const headers: Record<string, string> = {};
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me`, {
        credentials: "include",
        cache: "no-store",
        headers,
      });

      if (!response.ok) {
        throw new Error("Failed to fetch profile");
      }

      return response.json();
    }

    export async function updateProfile(data: UpdateProfileRequest, accessToken?: string): Promise<void> {
      const headers: Record<string, string> = { "Content-Type": "application/json" };
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me`, {
        method: "PUT",
        headers,
        credentials: "include",
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "Failed to update profile");
      }
    }

    export async function uploadAvatar(file: File, accessToken?: string): Promise<string> {
      const formData = new FormData();
      formData.append("file", file);

      const headers: Record<string, string> = {};
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me/avatar`, {
        method: "POST",
        headers,
        credentials: "include",
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "Failed to upload avatar");
      }

      const result = await response.json();
      return result.avatarUrl;
    }

    export async function removeAvatar(accessToken?: string): Promise<void> {
      const headers: Record<string, string> = {};
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me/avatar`, {
        method: "DELETE",
        headers,
        credentials: "include",
      });

      if (!response.ok) {
        throw new Error("Failed to remove avatar");
      }
    }

    export async function addAddress(data: AddAddressRequest, accessToken?: string): Promise<{ id: string }> {
      const headers: Record<string, string> = { "Content-Type": "application/json" };
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me/addresses`, {
        method: "POST",
        headers,
        credentials: "include",
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "Failed to add address");
      }

      return response.json();
    }

    export async function updateAddress(addressId: string, data: UpdateAddressRequest, accessToken?: string): Promise<void> {
      const headers: Record<string, string> = { "Content-Type": "application/json" };
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me/addresses/${addressId}`, {
        method: "PUT",
        headers,
        credentials: "include",
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || "Failed to update address");
      }
    }

    export async function deleteAddress(addressId: string, accessToken?: string): Promise<void> {
      const headers: Record<string, string> = {};
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me/addresses/${addressId}`, {
        method: "DELETE",
        headers,
        credentials: "include",
      });

      if (!response.ok) {
        throw new Error("Failed to delete address");
      }
    }

    export async function setDefaultAddress(addressId: string, accessToken?: string): Promise<void> {
      const headers: Record<string, string> = {};
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const response = await fetch(`${API_BASE}/api/profiles/me/addresses/${addressId}/default`, {
        method: "PATCH",
        headers,
        credentials: "include",
      });

      if (!response.ok) {
        throw new Error("Failed to set default address");
      }
    }
    ```

    **use-profile.ts:**
    Create React Query hooks following the use-cart.ts pattern:

    ```typescript
    "use client";

    import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
    import { useSession } from "next-auth/react";
    import { toast } from "sonner";
    import {
      getMyProfile,
      updateProfile,
      uploadAvatar,
      removeAvatar,
      addAddress,
      updateAddress,
      deleteAddress,
      setDefaultAddress,
    } from "@/lib/api";
    import type { AddAddressRequest, UpdateAddressRequest, UpdateProfileRequest } from "@/lib/api";

    export function useProfile() {
      const { data: session } = useSession();

      return useQuery({
        queryKey: ["profile"],
        queryFn: () => getMyProfile(session?.accessToken),
        enabled: !!session?.accessToken,
      });
    }

    export function useUpdateProfile() {
      const queryClient = useQueryClient();
      const { data: session } = useSession();

      return useMutation({
        mutationFn: (data: UpdateProfileRequest) => updateProfile(data, session?.accessToken),
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ["profile"] });
          toast.success("Profile updated");
        },
        onError: (error: Error) => {
          toast.error(error.message || "Failed to update profile");
        },
      });
    }

    export function useUploadAvatar() {
      const queryClient = useQueryClient();
      const { data: session } = useSession();

      return useMutation({
        mutationFn: (file: File) => uploadAvatar(file, session?.accessToken),
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ["profile"] });
          toast.success("Avatar updated");
        },
        onError: (error: Error) => {
          toast.error(error.message || "Failed to upload avatar");
        },
      });
    }

    export function useRemoveAvatar() {
      const queryClient = useQueryClient();
      const { data: session } = useSession();

      return useMutation({
        mutationFn: () => removeAvatar(session?.accessToken),
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ["profile"] });
          toast.success("Avatar removed");
        },
        onError: () => {
          toast.error("Failed to remove avatar");
        },
      });
    }

    export function useAddAddress() {
      const queryClient = useQueryClient();
      const { data: session } = useSession();

      return useMutation({
        mutationFn: (data: AddAddressRequest) => addAddress(data, session?.accessToken),
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ["profile"] });
          toast.success("Address added");
        },
        onError: (error: Error) => {
          toast.error(error.message || "Failed to add address");
        },
      });
    }

    export function useUpdateAddress() {
      const queryClient = useQueryClient();
      const { data: session } = useSession();

      return useMutation({
        mutationFn: ({ id, ...data }: UpdateAddressRequest & { id: string }) =>
          updateAddress(id, data, session?.accessToken),
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ["profile"] });
          toast.success("Address updated");
        },
        onError: (error: Error) => {
          toast.error(error.message || "Failed to update address");
        },
      });
    }

    export function useDeleteAddress() {
      const queryClient = useQueryClient();
      const { data: session } = useSession();

      return useMutation({
        mutationFn: (addressId: string) => deleteAddress(addressId, session?.accessToken),
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ["profile"] });
          toast.success("Address deleted");
        },
        onError: () => {
          toast.error("Failed to delete address");
        },
      });
    }

    export function useSetDefaultAddress() {
      const queryClient = useQueryClient();
      const { data: session } = useSession();

      return useMutation({
        mutationFn: (addressId: string) => setDefaultAddress(addressId, session?.accessToken),
        onSuccess: () => {
          queryClient.invalidateQueries({ queryKey: ["profile"] });
          toast.success("Default address updated");
        },
        onError: () => {
          toast.error("Failed to set default address");
        },
      });
    }
    ```
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npx tsc --noEmit` type-checks without errors. use-profile.ts exports all hooks. api.ts has all profile/address functions.
  </verify>
  <done>
    API client has all profile and address functions with auth token support. React Query hooks provide profile fetch, update, avatar upload/remove, and full address CRUD with toast notifications and cache invalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create account layout, sidebar, profile page, and avatar upload components</name>
  <files>
    src/MicroCommerce.Web/src/components/account/account-sidebar.tsx
    src/MicroCommerce.Web/src/components/account/avatar-upload.tsx
    src/MicroCommerce.Web/src/components/account/profile-form.tsx
    src/MicroCommerce.Web/src/app/(storefront)/account/layout.tsx
    src/MicroCommerce.Web/src/app/(storefront)/account/page.tsx
    src/MicroCommerce.Web/src/app/(storefront)/account/profile/page.tsx
    src/MicroCommerce.Web/src/app/(storefront)/account/addresses/page.tsx
    src/MicroCommerce.Web/src/app/(storefront)/account/orders/page.tsx
    src/MicroCommerce.Web/src/app/(storefront)/account/security/page.tsx
  </files>
  <action>
    **account-sidebar.tsx:** "use client" component. Use usePathname to highlight active section. Four sections with lucide icons: Profile (User), Addresses (MapPin), Orders (Package), Security (Shield). Each is a Next.js Link to /account/{section}. Active state uses `bg-zinc-100 text-zinc-900` vs `text-zinc-500 hover:text-zinc-900`. Clean, minimal styling matching the existing storefront design language (zinc color palette, small text). Wrap in a `<nav>` with aria-label="Account navigation".

    **avatar-upload.tsx:** "use client" component. Props: `{ currentAvatarUrl?: string | null }`. Uses useRef for hidden file input. Uses useUploadAvatar and useRemoveAvatar hooks. Renders a button wrapping Avatar (from @/components/ui/avatar) at h-20 w-20. AvatarImage shows currentAvatarUrl if present, AvatarFallback shows `<User className="h-10 w-10" />` (generic silhouette, per user decision - NO initials). Hover overlay with Upload icon and bg-black/40. Click triggers fileInputRef.current?.click(). Hidden file input with accept="image/*". onChange validates: image/* type, <= 5MB size. Calls uploadMutation.mutate(file). Show loading spinner when isPending. Below the avatar, if currentAvatarUrl exists, render a small "Remove" text button that calls removeMutation.mutate().

    **profile-form.tsx:** "use client" component. Props: none (uses useProfile hook internally). Two states: view mode and edit mode (useState boolean). View mode shows: display name as text, "Edit" button. Edit mode shows: text input for display name, "Save" and "Cancel" buttons. Uses useUpdateProfile hook for save. On save success, switch back to view mode. Show loading skeleton when profile is loading. Show the AvatarUpload component above the form, passing profile.avatarUrl. Layout: avatar centered at top, then display name below, then email (from session, read-only display), then member since date. Use Card component for wrapping.

    **account/layout.tsx:** Server component layout. Renders a container (max-w-6xl mx-auto px-4 py-8). Grid layout: sidebar on left (w-56 on lg, hidden on mobile with hamburger or stacked on top), content on right (flex-1). On mobile (below lg breakpoint), sidebar renders as horizontal scroll or stacks above content. Import and render AccountSidebar. Render `{children}` for page content. Page title: "My Account" as h1.

    **account/page.tsx:** Simple redirect. Import `redirect` from "next/navigation". In the default export function, call `redirect("/account/profile")`. This ensures /account always goes to the profile section.

    **account/profile/page.tsx:** "use client" page. Imports and renders ProfileForm. Wrapped in SessionProvider if not already provided by parent layout (the storefront layout already has QueryProvider, but check if SessionProvider wraps it â€” if not, the account layout should wrap children in SessionProvider). Title: "Profile" as h2.

    **account/addresses/page.tsx:** Placeholder for now (Plan 05 will fill it). "use client". Shows heading "Addresses" and text "Address book coming soon." Import useProfile hook to show address count if available. This will be fully built in Plan 05.

    **account/orders/page.tsx:** Server component that redirects to the existing `/orders` page. Per research recommendation: `redirect("/orders")` to avoid duplicating existing order history UI. OR render the existing order history content inline. Simplest: `redirect("/orders")`.

    **account/security/page.tsx:** "use client" component. Shows heading "Security". Shows a card with text explaining the user can manage their password and security settings via Keycloak. Button "Manage Security Settings" that opens the Keycloak account management URL in a new tab. The Keycloak account URL follows the pattern: `{KEYCLOAK_ISSUER}/account`. Read the issuer from an env var or construct from session. For simplicity, use `process.env.NEXT_PUBLIC_KEYCLOAK_ACCOUNT_URL` env var, or hardcode the pattern with the existing KEYCLOAK_ISSUER. Since KEYCLOAK_ISSUER is server-only, use a `NEXT_PUBLIC_KEYCLOAK_ACCOUNT_URL` env var. Default to "#" if not set.

    **Important per user decisions:**
    - Profile info displayed in VIEW mode with "Edit" button to switch to editable form
    - Security section LINKS to Keycloak (no custom password form)
    - Avatar click triggers upload directly (no separate button)
    - Default placeholder: generic silhouette icon (User icon, NOT initials)

    **Styling:** Match existing storefront zinc palette. Use Card, Button, Input, Label from shadcn/ui. Use Separator for visual breaks. Keep typography clean (text-sm for body, text-lg for section headings).

    **SessionProvider:** Check if the storefront layout already wraps children in SessionProvider. If not, wrap the account layout children in it. The session is needed for useSession in profile hooks.
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npx tsc --noEmit` type-checks. All page files exist under account/. Components exist under components/account/. Navigate to /account redirects to /account/profile.
  </verify>
  <done>
    My Account page with sidebar navigation (Profile, Addresses, Orders, Security). Profile page shows avatar with click-to-upload, display name in view/edit mode. Security section links to Keycloak. Orders redirects to existing /orders page. Addresses has placeholder for Plan 05.
  </done>
</task>

</tasks>

<verification>
1. `cd src/MicroCommerce.Web && npx tsc --noEmit` passes
2. /account routes exist (layout, page, profile/page, addresses/page, orders/page, security/page)
3. Account sidebar renders four sections with correct icons and active state
4. Avatar upload triggers on click with file validation
5. Profile form has view/edit toggle
6. Security page has Keycloak link
</verification>

<success_criteria>
- Sidebar navigation highlights active section
- Profile page shows display name in view mode with Edit button to switch to form
- Clicking avatar triggers file upload with type/size validation
- Remove avatar button visible when avatar exists
- Security section links to Keycloak account management (not custom form)
- /account redirects to /account/profile
- /account/orders redirects to existing /orders page
- All TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/11-user-profiles-auth-flow/11-04-SUMMARY.md`
</output>
