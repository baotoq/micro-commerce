---
phase: 11-user-profiles-auth-flow
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/CreateProfile/CreateProfileCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateProfile/UpdateProfileCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateProfile/UpdateProfileCommandValidator.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UploadAvatar/UploadAvatarCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/RemoveAvatar/RemoveAvatarCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/AddAddress/AddAddressCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/AddAddress/AddAddressCommandValidator.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateAddress/UpdateAddressCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateAddress/UpdateAddressCommandValidator.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/DeleteAddress/DeleteAddressCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/SetDefaultAddress/SetDefaultAddressCommand.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Application/Queries/GetProfile/GetProfileQuery.cs
  - src/MicroCommerce.ApiService/Features/Profiles/ProfilesEndpoints.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "Authenticated user can get or auto-create their profile via GET /api/profiles/me"
    - "User can update display name via PUT /api/profiles/me"
    - "User can upload and remove avatar via POST/DELETE /api/profiles/me/avatar"
    - "User can add, update, delete addresses and set default"
    - "All profile endpoints require authorization"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Profiles/ProfilesEndpoints.cs"
      provides: "All profile API routes"
      contains: "MapProfilesEndpoints"
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Application/Queries/GetProfile/GetProfileQuery.cs"
      provides: "Profile read with auto-create"
      contains: "GetProfileQuery"
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/AddAddress/AddAddressCommand.cs"
      provides: "Address creation command"
      contains: "AddAddressCommand"
  key_links:
    - from: "ProfilesEndpoints.cs"
      to: "Program.cs"
      via: "MapProfilesEndpoints"
      pattern: "MapProfilesEndpoints"
    - from: "ProfilesEndpoints.cs"
      to: "GetProfileQuery.cs"
      via: "MediatR Send"
      pattern: "sender.Send"
    - from: "GetProfileQuery handler"
      to: "ProfilesDbContext"
      via: "EF Core query"
      pattern: "_context.UserProfiles"
---

<objective>
Create all CQRS handlers, validators, and API endpoints for the Profiles feature.

Purpose: Expose the Profiles domain model through a complete REST API with proper validation, auto-profile creation on first access, and avatar upload/remove operations.
Output: All commands, queries, validators, ProfilesEndpoints, endpoint registration in Program.cs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-user-profiles-auth-flow/11-RESEARCH.md
@.planning/phases/11-user-profiles-auth-flow/11-01-SUMMARY.md

@src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommandHandler.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CQRS commands, queries, and validators</name>
  <files>
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/CreateProfile/CreateProfileCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateProfile/UpdateProfileCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateProfile/UpdateProfileCommandValidator.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UploadAvatar/UploadAvatarCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/RemoveAvatar/RemoveAvatarCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/AddAddress/AddAddressCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/AddAddress/AddAddressCommandValidator.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateAddress/UpdateAddressCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateAddress/UpdateAddressCommandValidator.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/DeleteAddress/DeleteAddressCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/SetDefaultAddress/SetDefaultAddressCommand.cs
    src/MicroCommerce.ApiService/Features/Profiles/Application/Queries/GetProfile/GetProfileQuery.cs
  </files>
  <action>
    Create all CQRS handlers following the established pattern from Cart/Catalog modules. Each command/query file contains both the record and handler class (single file per operation, following existing codebase pattern).

    **GetProfileQuery.cs:**
    - Record: `GetProfileQuery(Guid UserId) : IRequest<ProfileDto?>`
    - DTO record: `ProfileDto(Guid Id, Guid UserId, string DisplayName, string? AvatarUrl, List<AddressDto> Addresses, DateTimeOffset CreatedAt, DateTimeOffset UpdatedAt)`
    - DTO record: `AddressDto(Guid Id, string Name, string Street, string City, string State, string ZipCode, string Country, bool IsDefault)`
    - Handler: Inject ProfilesDbContext. Query by UserId. If not found, auto-create profile with display name "User" (will be updated by user). Map to ProfileDto including addresses. Return null only if creation fails (shouldn't happen).
    - Auto-creation: If profile not found, create via `UserProfile.Create(userId, "User")`, add to context, SaveChanges, then return the DTO. This ensures profile always exists on first GET.

    **CreateProfileCommand.cs:**
    - Record: `CreateProfileCommand(Guid UserId, string DisplayName) : IRequest<Guid>`
    - Handler: Check if profile exists for UserId first (idempotent). If exists, return existing ID. If not, create via UserProfile.Create, save, return profile ID value.

    **UpdateProfileCommand.cs:**
    - Record: `UpdateProfileCommand(Guid UserId, string DisplayName) : IRequest`
    - Handler: Find profile by UserId (throw NotFoundException if missing). Call UpdateDisplayName. SaveChanges.

    **UpdateProfileCommandValidator.cs:**
    - Validate DisplayName: NotEmpty, MinimumLength(2), MaximumLength(50)

    **UploadAvatarCommand.cs:**
    - Record: `UploadAvatarCommand(Guid UserId, Stream ImageStream, string FileName) : IRequest<string>`
    - Handler: Inject ProfilesDbContext and IAvatarImageService. Find profile by UserId. If existing avatar, delete old via service. Process and upload new via service. Call profile.SetAvatar(newUrl). SaveChanges. Return new URL.

    **RemoveAvatarCommand.cs:**
    - Record: `RemoveAvatarCommand(Guid UserId) : IRequest`
    - Handler: Find profile by UserId. If AvatarUrl not null, delete via IAvatarImageService, call profile.RemoveAvatar(). SaveChanges.

    **AddAddressCommand.cs:**
    - Record: `AddAddressCommand(Guid UserId, string Name, string Street, string City, string State, string ZipCode, string Country, bool SetAsDefault) : IRequest<Guid>`
    - Handler: Find profile by UserId. Call profile.AddAddress(...). SaveChanges. Return address ID value.

    **AddAddressCommandValidator.cs:**
    - Validate: Name (NotEmpty, MaxLength 50), Street (NotEmpty, MaxLength 200), City (NotEmpty, MaxLength 100), State (NotEmpty, MaxLength 50), ZipCode (NotEmpty, MaxLength 20, Matches `^[0-9a-zA-Z\s\-]+$`), Country (NotEmpty, MaxLength 100).

    **UpdateAddressCommand.cs:**
    - Record: `UpdateAddressCommand(Guid UserId, Guid AddressId, string Name, string Street, string City, string State, string ZipCode, string Country) : IRequest`
    - Handler: Find profile by UserId. Call profile.UpdateAddress(new AddressId(AddressId), ...). SaveChanges.

    **UpdateAddressCommandValidator.cs:** Same validation rules as AddAddressCommandValidator.

    **DeleteAddressCommand.cs:**
    - Record: `DeleteAddressCommand(Guid UserId, Guid AddressId) : IRequest`
    - Handler: Find profile by UserId. Call profile.DeleteAddress(new AddressId(AddressId)). SaveChanges.

    **SetDefaultAddressCommand.cs:**
    - Record: `SetDefaultAddressCommand(Guid UserId, Guid AddressId) : IRequest`
    - Handler: Find profile by UserId. Call profile.SetDefaultAddress(new AddressId(AddressId)). SaveChanges.

    All handlers use ProfilesDbContext and follow the pattern: load aggregate with `.Include(p => p.Addresses)` where needed, call domain method, SaveChanges. Use `FirstOrDefaultAsync(p => p.UserId == request.UserId)` for lookup. Throw `NotFoundException` (from Common exceptions) when profile not found for mutation operations.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService` compiles. All command/query files exist under Features/Profiles/Application/.
  </verify>
  <done>
    Complete CQRS layer: GetProfile (with auto-create), CreateProfile (idempotent), UpdateProfile, UploadAvatar, RemoveAvatar, AddAddress, UpdateAddress, DeleteAddress, SetDefaultAddress. FluentValidation on profile and address inputs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProfilesEndpoints and register in Program.cs</name>
  <files>
    src/MicroCommerce.ApiService/Features/Profiles/ProfilesEndpoints.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    **ProfilesEndpoints.cs:**
    Follow CartEndpoints pattern exactly. Create static class with MapProfilesEndpoints extension method.

    Route group: `/api/profiles` with `.WithTags("Profiles")` and `.RequireAuthorization()` on the group.

    Endpoints:
    1. `GET /me` → GetMyProfile - calls GetProfileQuery(userId). Returns ProfileDto or auto-creates. Produces<ProfileDto>.
    2. `PUT /me` → UpdateProfile - accepts UpdateProfileRequest(string DisplayName). Calls UpdateProfileCommand. Returns 204 NoContent.
    3. `POST /me/avatar` → UploadAvatar - accepts IFormFile via `.DisableAntiforgery()`. Validates file exists, validates image/* content type, validates size <= 5MB. Calls UploadAvatarCommand. Returns `new { avatarUrl }`.
    4. `DELETE /me/avatar` → RemoveAvatar - calls RemoveAvatarCommand. Returns 204 NoContent.
    5. `POST /me/addresses` → AddAddress - accepts AddAddressRequest(Name, Street, City, State, ZipCode, Country, SetAsDefault). Calls AddAddressCommand. Returns 201 Created with `new { id }`.
    6. `PUT /me/addresses/{addressId:guid}` → UpdateAddress - accepts UpdateAddressRequest(Name, Street, City, State, ZipCode, Country). Calls UpdateAddressCommand. Returns 204 NoContent.
    7. `DELETE /me/addresses/{addressId:guid}` → DeleteAddress - calls DeleteAddressCommand. Returns 204 NoContent.
    8. `PATCH /me/addresses/{addressId:guid}/default` → SetDefaultAddress - calls SetDefaultAddressCommand. Returns 204 NoContent.

    Helper method: `private static Guid GetUserId(HttpContext context)` - reads "sub" or ClaimTypes.NameIdentifier from claims, parses to Guid. Throws UnauthorizedAccessException if not present.

    Request records at bottom of file:
    - `UpdateProfileRequest(string DisplayName)`
    - `AddAddressRequest(string Name, string Street, string City, string State, string ZipCode, string Country, bool SetAsDefault = false)`
    - `UpdateAddressRequest(string Name, string Street, string City, string State, string ZipCode, string Country)`
    - `UploadAvatarResult(string AvatarUrl)`

    For the avatar upload endpoint, use this pattern:
    ```csharp
    group.MapPost("/me/avatar", UploadAvatar)
        .WithName("UploadAvatar")
        .DisableAntiforgery()
        .Produces<UploadAvatarResult>();
    ```

    Avatar handler:
    ```csharp
    private static async Task<IResult> UploadAvatar(
        IFormFile file,
        HttpContext httpContext,
        ISender sender,
        CancellationToken ct)
    {
        if (file is null || file.Length == 0)
            return Results.BadRequest(new { detail = "No file provided" });

        if (!file.ContentType.StartsWith("image/"))
            return Results.BadRequest(new { detail = "File must be an image" });

        if (file.Length > 5 * 1024 * 1024)
            return Results.BadRequest(new { detail = "Image must be less than 5MB" });

        var userId = GetUserId(httpContext);
        using var stream = file.OpenReadStream();
        var avatarUrl = await sender.Send(new UploadAvatarCommand(userId, stream, file.FileName), ct);

        return Results.Ok(new UploadAvatarResult(avatarUrl));
    }
    ```

    **Program.cs:**
    Add `app.MapProfilesEndpoints();` after the other MapEndpoints calls (after `app.MapOrderingEndpoints();`).
    Add `using MicroCommerce.ApiService.Features.Profiles;` if needed.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService` compiles. `grep "MapProfilesEndpoints" src/MicroCommerce.ApiService/Program.cs` shows registration. ProfilesEndpoints.cs has all 8 endpoint registrations.
  </verify>
  <done>
    ProfilesEndpoints exposes full REST API: profile CRUD, avatar upload/remove, address CRUD with set-default. All endpoints require authorization. Registered in Program.cs. Request/response records defined.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService` compiles with zero errors
2. All 8 endpoints registered in ProfilesEndpoints
3. MapProfilesEndpoints called in Program.cs
4. FluentValidation validators exist for profile update and address add/update
5. GetProfile auto-creates profile if not found
</verification>

<success_criteria>
- GET /api/profiles/me returns profile with addresses (auto-creates on first access)
- PUT /api/profiles/me updates display name with validation
- POST/DELETE /api/profiles/me/avatar handle image upload and removal
- Address CRUD with set-default works through /api/profiles/me/addresses/*
- All endpoints require JWT authorization
- Project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-user-profiles-auth-flow/11-03-SUMMARY.md`
</output>
