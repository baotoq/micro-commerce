---
phase: 04-inventory-domain
plan: 05
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - code/MicroCommerce.Web/src/components/storefront/product-card.tsx
  - code/MicroCommerce.Web/src/components/storefront/product-detail.tsx
  - code/MicroCommerce.Web/src/components/storefront/product-grid.tsx
  - code/MicroCommerce.Web/src/app/(storefront)/page.tsx
  - code/MicroCommerce.Web/src/app/(storefront)/products/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Product card shows 'In Stock' badge when availableQuantity > 10"
    - "Product card shows 'Only X left!' badge when availableQuantity is 1-10"
    - "Product card shows 'Out of Stock' with visual treatment when availableQuantity is 0"
    - "Product detail page shows stock status prominently"
    - "Product detail page hides Add to Cart button when out of stock"
    - "Out-of-stock products in grid have subtle visual treatment (overlay or badge)"
  artifacts:
    - path: "code/MicroCommerce.Web/src/components/storefront/product-card.tsx"
      provides: "Product card with stock status badge"
      contains: "stockInfo"
    - path: "code/MicroCommerce.Web/src/components/storefront/product-detail.tsx"
      provides: "Product detail with stock status and conditional Add to Cart"
      contains: "isInStock"
  key_links:
    - from: "product-grid.tsx"
      to: "/api/inventory/stock"
      via: "batch stock fetch"
      pattern: "getStockLevels"
    - from: "product-detail.tsx"
      to: "/api/inventory/stock/{productId}"
      via: "individual stock fetch"
      pattern: "getStockByProductId"
---

<objective>
Add stock status display to the storefront product cards and product detail page.

Purpose: Customers see real-time stock availability -- "In Stock", "Only X left!", or "Out of Stock" -- enabling informed purchase decisions. Out-of-stock products hide the Add to Cart button (INV-01 requirement for stock level display).
Output: Updated storefront product cards and detail page with stock-aware UI.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-inventory-domain/04-CONTEXT.md
@.planning/phases/04-inventory-domain/04-RESEARCH.md
@.planning/phases/04-inventory-domain/04-02-SUMMARY.md

Key reference files:
@code/MicroCommerce.Web/src/components/storefront/product-card.tsx
@code/MicroCommerce.Web/src/components/storefront/product-detail.tsx
@code/MicroCommerce.Web/src/components/storefront/product-grid.tsx
@code/MicroCommerce.Web/src/app/(storefront)/page.tsx
@code/MicroCommerce.Web/src/app/(storefront)/products/[id]/page.tsx
@code/MicroCommerce.Web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Product Grid and Cards with Stock Badges</name>
  <files>
    code/MicroCommerce.Web/src/components/storefront/product-card.tsx
    code/MicroCommerce.Web/src/components/storefront/product-grid.tsx
    code/MicroCommerce.Web/src/app/(storefront)/page.tsx
  </files>
  <action>
    Update the storefront product grid to fetch stock levels and display stock badges on product cards.

    **product-grid.tsx changes:**
    - After products are loaded (or alongside product fetching), call `getStockLevels(productIds)` with all product IDs from the current page/batch.
    - Build a `Map<string, StockInfoDto>` from the results.
    - Pass individual `stockInfo` to each `ProductCard`.
    - If the grid uses infinite scroll (fetching more products), also fetch stock for newly loaded products and merge into the map.

    **product-card.tsx changes:**
    - Accept new optional prop: `stockInfo?: StockInfoDto`.
    - Display stock badge on the card:
      - `availableQuantity > 10`: Small green `Badge` or text "In Stock" -- subtle, not dominating the card.
      - `availableQuantity 1-10`: Amber/yellow `Badge` "Only {N} left!" -- slightly more prominent to create urgency.
      - `availableQuantity === 0`: "Out of Stock" badge in red/muted. Apply subtle visual treatment to the card -- use Claude's discretion matching Apple Store aesthetic. Options: reduce card opacity to 0.6, add a muted overlay, or grayscale the product image. The card should still be clickable (user can view details) but should visually communicate unavailability.
    - If no stockInfo prop (still loading): show nothing (no stock badge) -- cleaner than a loading skeleton for a small badge.
    - Position the stock badge at the top-right corner of the product image or below the price, matching the existing card layout aesthetics.

    **page.tsx (storefront home) changes:**
    - If the page server-side renders product data and passes to grid, ensure the grid component handles stock fetching client-side (stock is separate module, fetched via separate API call). This keeps the architecture clean -- Catalog SSR + Inventory client-side fetch.
    - If needed, make the stock-fetching portion a client component or use `useEffect`.
  </action>
  <verify>
    Storefront home page shows product cards with stock badges. Verify at least some cards show "In Stock", some show "Only X left!", and some show "Out of Stock" (assuming the seeder creates varied quantities). Out-of-stock cards have subtle visual treatment.
  </verify>
  <done>
    Product cards display stock status badges. Out-of-stock products have visual treatment. Grid fetches stock in batch (single API call for all visible products).
  </done>
</task>

<task type="auto">
  <name>Task 2: Product Detail Page Stock Display</name>
  <files>
    code/MicroCommerce.Web/src/components/storefront/product-detail.tsx
    code/MicroCommerce.Web/src/app/(storefront)/products/[id]/page.tsx
  </files>
  <action>
    Update the product detail page to show stock status prominently and conditionally show/hide Add to Cart.

    **product-detail.tsx changes:**
    - Accept new optional prop: `stockInfo?: StockInfoDto`.
    - Display stock status prominently near the price area:
      - `availableQuantity > 10`: Green text or badge "In Stock" with a checkmark icon.
      - `availableQuantity 1-10`: Amber text "Only {N} left!" -- creates urgency.
      - `availableQuantity === 0`: Red text or badge "Out of Stock".
    - Add to Cart button behavior (the button may not be fully functional yet -- Cart is Phase 6, but the button placeholder likely exists or should be added):
      - When `isInStock === true`: Show enabled "Add to Cart" button (even if it doesn't do anything yet -- Phase 6 will wire it).
      - When `isInStock === false` (out of stock): HIDE the Add to Cart button entirely. Instead show a prominent "Out of Stock" notice in its place. Match Apple Store aesthetic -- clean, not alarming.
    - Loading state: While stock info is being fetched, show a skeleton placeholder for the stock badge area.

    **products/[id]/page.tsx changes:**
    - Fetch stock info for this product: `getStockByProductId(productId)`.
    - This can be done client-side (useEffect + state) to keep Catalog data SSR and Inventory data client-side. Or, if the page is already a client component, fetch alongside product data.
    - Pass `stockInfo` to `ProductDetail` component.
    - Handle null stockInfo gracefully (product might not have a StockItem yet -- treat as out of stock or show loading).
  </action>
  <verify>
    Navigate to a product detail page. Verify stock status is displayed near the price. For an out-of-stock product (if any exist from seeder), verify Add to Cart is hidden and "Out of Stock" notice is shown. For in-stock products, verify badge shows correctly.
  </verify>
  <done>
    Product detail page shows stock status with correct threshold-based messaging. Add to Cart hidden when out of stock. Clean loading state while stock fetches.
  </done>
</task>

</tasks>

<verification>
- No TypeScript build errors
- Product cards in storefront grid show stock badges
- Out-of-stock cards have subtle visual treatment (reduced opacity, overlay, or grayscale)
- Product detail shows stock status near price
- Add to Cart hidden when product is out of stock
- Stock fetched via separate Inventory API (not embedded in Catalog response)
- Batch API used for grid, individual API used for detail page
</verification>

<success_criteria>
- INV-01 storefront display: Product pages show "In Stock", "Only X left!", or "Out of Stock"
- Out-of-stock products: Add to Cart hidden, "Out of Stock" notice shown
- Low stock (1-10): "Only X left!" urgency messaging
- Visual treatment for out-of-stock in product grid
- Clean module boundary: stock fetched via /api/inventory, not /api/catalog
</success_criteria>

<output>
After completion, create `.planning/phases/04-inventory-domain/04-05-SUMMARY.md`
</output>
