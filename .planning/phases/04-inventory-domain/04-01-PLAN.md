---
phase: 04-inventory-domain
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockItem.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockAdjustment.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/StockItemId.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/ReservationId.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/AdjustmentId.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/Quantity.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockReservedDomainEvent.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockReleasedDomainEvent.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockAdjustedDomainEvent.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockLowDomainEvent.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDbContext.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockItemConfiguration.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockReservationConfiguration.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockAdjustmentConfiguration.cs
autonomous: true

must_haves:
  truths:
    - "StockItem aggregate enforces non-negative stock invariant"
    - "Reservations reduce available quantity without changing quantity on hand"
    - "Stock adjustments create audit trail entries"
    - "Optimistic concurrency prevents lost stock updates"
    - "Domain events raised for stock adjusted, reserved, released, and low stock"
  artifacts:
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockItem.cs"
      provides: "Aggregate root with AdjustStock, Reserve, ReleaseReservation methods"
      min_lines: 60
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDbContext.cs"
      provides: "DbContext with StockItems, StockReservations, StockAdjustments DbSets"
      contains: "HasDefaultSchema(\"inventory\")"
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockItemConfiguration.cs"
      provides: "EF configuration with xmin concurrency token"
      contains: "IsRowVersion"
  key_links:
    - from: "StockItem.cs"
      to: "BaseAggregateRoot<StockItemId>"
      via: "inheritance"
      pattern: "BaseAggregateRoot<StockItemId>"
    - from: "StockItemConfiguration.cs"
      to: "StockItem.Version"
      via: "xmin concurrency"
      pattern: "IsRowVersion"
---

<objective>
Build the Inventory domain model with StockItem aggregate, StockReservation and StockAdjustment entities, strongly-typed IDs, value objects, domain events, EF Core configurations with xmin optimistic concurrency, and database migration.

Purpose: Establishes the domain foundation that all inventory operations (commands, queries, API) will build on.
Output: Complete domain model, DbContext with DbSets, EF configurations, and initial migration for the `inventory` schema.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-inventory-domain/04-CONTEXT.md
@.planning/phases/04-inventory-domain/04-RESEARCH.md

Key reference files (follow these patterns exactly):
@code/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
@code/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductId.cs
@code/MicroCommerce.ApiService/Features/Catalog/Domain/Events/ProductCreatedDomainEvent.cs
@code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDbContext.cs
@code/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs
@code/BuildingBlocks/BuildingBlocks.Common/StronglyTypedId.cs
@code/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs
@code/BuildingBlocks/BuildingBlocks.Common/Events/DomainEvent.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain Entities, Value Objects, and Events</name>
  <files>
    code/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockItem.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockAdjustment.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/StockItemId.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/ReservationId.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/AdjustmentId.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/Quantity.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockReservedDomainEvent.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockReleasedDomainEvent.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockAdjustedDomainEvent.cs
    code/MicroCommerce.ApiService/Features/Inventory/Domain/Events/StockLowDomainEvent.cs
  </files>
  <action>
    Create the Inventory domain model following the exact patterns from the Catalog module.

    **StockItem aggregate** (`BaseAggregateRoot<StockItemId>`):
    - Properties: `ProductId` (raw `Guid`, NOT a navigation property to Product -- cross-module boundary), `QuantityOnHand` (int), `Version` (uint, xmin concurrency token via `[Timestamp]` attribute), `Reservations` (private `List<StockReservation>`, exposed as `IReadOnlyCollection`).
    - Computed property: `AvailableQuantity` => `QuantityOnHand - _reservations.Where(r => r.ExpiresAt > DateTimeOffset.UtcNow).Sum(r => r.Quantity)`.
    - Factory method: `static StockItem Create(Guid productId)` -- initializes with `QuantityOnHand = 0`, no domain event on creation (created by consumer, not user action).
    - `AdjustStock(int adjustment, string? reason, string? adjustedBy)`: validates `QuantityOnHand + adjustment >= 0`, updates `QuantityOnHand`, raises `StockAdjustedDomainEvent`. If new quantity <= 10, also raises `StockLowDomainEvent`.
    - `Reserve(int quantity)`: validates `quantity > 0` and `AvailableQuantity >= quantity`, creates `StockReservation` with 15-min TTL, adds to `_reservations`, raises `StockReservedDomainEvent`, returns `ReservationId`.
    - `ReleaseReservation(ReservationId reservationId)`: finds and removes reservation, raises `StockReleasedDomainEvent`. No-op if reservation not found.
    - Private constructor for EF Core: `private StockItem(StockItemId id) : base(id) { }`

    **StockReservation entity** (NOT an aggregate, owned by StockItem):
    - Properties: `Id` (ReservationId), `StockItemId` (StockItemId), `Quantity` (int), `CreatedAt` (DateTimeOffset), `ExpiresAt` (DateTimeOffset).
    - Factory: `static StockReservation Create(StockItemId stockItemId, int quantity, TimeSpan ttl)`.
    - Computed: `bool IsExpired => ExpiresAt <= DateTimeOffset.UtcNow`.
    - Private parameterless constructor for EF Core.

    **StockAdjustment entity** (separate from aggregate -- audit record):
    - Properties: `Id` (AdjustmentId), `StockItemId` (StockItemId), `Adjustment` (int, e.g. +10 or -5), `QuantityAfter` (int), `Reason` (string?), `AdjustedBy` (string?), `CreatedAt` (DateTimeOffset).
    - Factory: `static StockAdjustment Create(StockItemId stockItemId, int adjustment, int quantityAfter, string? reason, string? adjustedBy)`.
    - Private parameterless constructor for EF Core.

    **Value objects** -- follow `StronglyTypedId<Guid>` pattern from Catalog:
    - `StockItemId`: `sealed record StockItemId : StronglyTypedId<Guid>` with `static StockItemId New() => new(Guid.NewGuid())`.
    - `ReservationId`: same pattern.
    - `AdjustmentId`: same pattern.
    - `Quantity`: `sealed class Quantity : ValueObject` wrapping non-negative int. Factory `From(int value)` throws if value < 0.

    **Domain events** -- follow `DomainEvent` base from BuildingBlocks, thin events with IDs only:
    - `StockAdjustedDomainEvent(Guid StockItemId, Guid ProductId, int Adjustment, int NewQuantity)`.
    - `StockReservedDomainEvent(Guid StockItemId, Guid ProductId, Guid ReservationId, int Quantity)`.
    - `StockReleasedDomainEvent(Guid StockItemId, Guid ProductId, Guid ReservationId, int Quantity)`.
    - `StockLowDomainEvent(Guid StockItemId, Guid ProductId, int CurrentQuantity)`.

    IMPORTANT: Use `Guid` for `ProductId` in Inventory module, NOT `ProductId` from Catalog. This respects module boundaries.
  </action>
  <verify>
    `dotnet build code/` compiles without errors. All entities, value objects, and events exist in the correct namespaces under `Features.Inventory.Domain`.
  </verify>
  <done>
    StockItem aggregate has AdjustStock, Reserve, ReleaseReservation methods with proper invariant enforcement. All value objects, entities, and domain events follow established Catalog patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: DbContext, EF Configurations, and Migration</name>
  <files>
    code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDbContext.cs
    code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockItemConfiguration.cs
    code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockReservationConfiguration.cs
    code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockAdjustmentConfiguration.cs
  </files>
  <action>
    Update the existing `InventoryDbContext` skeleton and create EF Core configurations.

    **InventoryDbContext** -- update the existing file:
    - Add DbSets: `DbSet<StockItem> StockItems`, `DbSet<StockReservation> StockReservations`, `DbSet<StockAdjustment> StockAdjustments`.
    - Keep existing schema isolation: `modelBuilder.HasDefaultSchema("inventory")`.
    - Keep existing namespace-filtered config discovery.
    - Remove the commented-out placeholder DbSets and the comment about Plan 04.

    **StockItemConfiguration** (`IEntityTypeConfiguration<StockItem>`):
    - Table: `"StockItems"`.
    - Primary key on `Id` with `HasConversion(id => id.Value, value => new StockItemId(value))`.
    - `ProductId` required, unique index (`HasIndex(s => s.ProductId).IsUnique()`).
    - `QuantityOnHand` required.
    - `Version` property: `builder.Property(s => s.Version).IsRowVersion()` -- this maps to PostgreSQL `xmin` automatically.
    - Reservations: `HasMany(s => s.Reservations).WithOne().HasForeignKey(r => r.StockItemId).OnDelete(DeleteBehavior.Cascade)`.
    - Access the private `_reservations` field via `builder.Navigation(s => s.Reservations).UsePropertyAccessMode(PropertyAccessMode.Field)` -- the backing field is `_reservations`.

    **StockReservationConfiguration** (`IEntityTypeConfiguration<StockReservation>`):
    - Table: `"StockReservations"`.
    - Primary key on `Id` with guid conversion.
    - `StockItemId` with conversion.
    - `Quantity`, `CreatedAt`, `ExpiresAt` all required.
    - Index on `ExpiresAt` for cleanup queries.

    **StockAdjustmentConfiguration** (`IEntityTypeConfiguration<StockAdjustment>`):
    - Table: `"StockAdjustments"`.
    - Primary key on `Id` with guid conversion.
    - `StockItemId` with conversion.
    - `Adjustment`, `QuantityAfter`, `CreatedAt` required.
    - `Reason` optional, max 500 chars.
    - `AdjustedBy` optional, max 200 chars.
    - Index on `StockItemId` for history queries.
    - Index on `CreatedAt` descending for chronological history.

    **Migration**: Run `dotnet ef migrations add InitialInventory --context InventoryDbContext --project code/MicroCommerce.ApiService --output-dir Features/Inventory/Infrastructure/Migrations` to generate the initial migration. Verify it creates tables in the `inventory` schema.
  </action>
  <verify>
    `dotnet build code/` succeeds. Migration file exists under `Features/Inventory/Infrastructure/Migrations/`. Run `dotnet ef migrations list --context InventoryDbContext --project code/MicroCommerce.ApiService` to confirm migration is listed.
  </verify>
  <done>
    InventoryDbContext has all three DbSets. EF configurations map all properties with correct conversions, indexes, and xmin concurrency. Initial migration exists and targets the `inventory` schema.
  </done>
</task>

</tasks>

<verification>
- `dotnet build code/` compiles cleanly
- Migration file exists in `Features/Inventory/Infrastructure/Migrations/`
- StockItem.AdjustStock throws when adjustment would make quantity negative
- StockItem.Reserve throws when available quantity is insufficient
- StockItem.Version property has `[Timestamp]` attribute or is configured with `IsRowVersion()`
- All domain events extend `DomainEvent` base class
</verification>

<success_criteria>
- Complete domain model with StockItem aggregate, StockReservation, StockAdjustment entities
- All strongly-typed IDs following established pattern
- Four domain events (Adjusted, Reserved, Released, Low)
- InventoryDbContext with 3 DbSets, inventory schema isolation
- EF configurations with xmin optimistic concurrency on StockItem
- Initial migration generated successfully
</success_criteria>

<output>
After completion, create `.planning/phases/04-inventory-domain/04-01-SUMMARY.md`
</output>
