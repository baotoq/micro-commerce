---
phase: 04-inventory-domain
plan: 04
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - code/MicroCommerce.Web/src/lib/api.ts
  - code/MicroCommerce.Web/src/app/admin/products/page.tsx
  - code/MicroCommerce.Web/src/components/admin/products-table.tsx
  - code/MicroCommerce.Web/src/components/admin/stock-adjust-dialog.tsx
  - code/MicroCommerce.Web/src/components/admin/adjustment-history-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Admin product table shows Stock column with current available quantity"
    - "Admin can click stock value to open adjustment dialog"
    - "Admin can enter relative adjustment (+10 or -5) with optional reason"
    - "After adjustment, stock value updates in the table"
    - "Admin can view adjustment history showing who, when, amount, reason"
    - "Low stock (<=10) shown with warning indicator"
    - "Out of stock (0) shown with red indicator"
  artifacts:
    - path: "code/MicroCommerce.Web/src/components/admin/stock-adjust-dialog.tsx"
      provides: "Dialog for adjusting stock with relative +/- input and optional reason"
      min_lines: 50
    - path: "code/MicroCommerce.Web/src/components/admin/adjustment-history-dialog.tsx"
      provides: "Dialog showing adjustment history log"
      min_lines: 40
    - path: "code/MicroCommerce.Web/src/lib/api.ts"
      provides: "Inventory API client functions"
      contains: "getStockByProductId"
  key_links:
    - from: "products-table.tsx"
      to: "/api/inventory/stock"
      via: "batch stock fetch"
      pattern: "getStockLevels"
    - from: "stock-adjust-dialog.tsx"
      to: "/api/inventory/stock/{productId}/adjust"
      via: "adjust API call"
      pattern: "adjustStock"
---

<objective>
Add inventory stock management to the admin product table: stock column, inline adjustment dialog, and adjustment history viewer.

Purpose: Enables admins to view and manage stock levels directly from the product management page (ADM-02 requirement). Provides accountability through adjustment history.
Output: Updated admin products table with stock column, stock adjustment dialog, and adjustment history dialog.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-inventory-domain/04-CONTEXT.md
@.planning/phases/04-inventory-domain/04-RESEARCH.md
@.planning/phases/04-inventory-domain/04-02-SUMMARY.md

Key reference files:
@code/MicroCommerce.Web/src/components/admin/products-table.tsx
@code/MicroCommerce.Web/src/app/admin/products/page.tsx
@code/MicroCommerce.Web/src/lib/api.ts
@code/MicroCommerce.Web/src/components/ui/dialog.tsx
@code/MicroCommerce.Web/src/components/ui/badge.tsx
@code/MicroCommerce.Web/src/components/ui/input.tsx
@code/MicroCommerce.Web/src/components/ui/table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inventory API Client Functions</name>
  <files>
    code/MicroCommerce.Web/src/lib/api.ts
  </files>
  <action>
    Add inventory-related TypeScript types and API functions to the existing `api.ts` file. Append after the existing storefront functions.

    **Types to add:**
    ```typescript
    // Inventory types
    export interface StockInfoDto {
      productId: string;
      quantityOnHand: number;
      availableQuantity: number;
      isInStock: boolean;
      isLowStock: boolean;
    }

    export interface AdjustmentDto {
      id: string;
      adjustment: number;
      quantityAfter: number;
      reason: string | null;
      adjustedBy: string | null;
      createdAt: string;
    }

    export interface AdjustStockRequest {
      adjustment: number;
      reason?: string;
    }
    ```

    **API functions to add:**
    - `getStockByProductId(productId: string): Promise<StockInfoDto | null>` -- GET `/api/inventory/stock/{productId}`. Return null on 404.
    - `getStockLevels(productIds: string[]): Promise<StockInfoDto[]>` -- GET `/api/inventory/stock?productIds={comma-separated}`. Return empty array if no productIds.
    - `adjustStock(productId: string, data: AdjustStockRequest): Promise<void>` -- POST `/api/inventory/stock/{productId}/adjust`. Throw on non-ok response with detail message.
    - `getAdjustmentHistory(productId: string): Promise<AdjustmentDto[]>` -- GET `/api/inventory/stock/{productId}/adjustments`.

    Follow the existing fetch pattern (no external HTTP library, same error handling style).
  </action>
  <verify>
    No TypeScript compilation errors. Types and functions are exported.
  </verify>
  <done>
    All inventory API client functions added to api.ts following existing patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin Products Table Stock Column and Dialogs</name>
  <files>
    code/MicroCommerce.Web/src/components/admin/products-table.tsx
    code/MicroCommerce.Web/src/components/admin/stock-adjust-dialog.tsx
    code/MicroCommerce.Web/src/components/admin/adjustment-history-dialog.tsx
    code/MicroCommerce.Web/src/app/admin/products/page.tsx
  </files>
  <action>
    Update the admin products table to show stock levels and add dialogs for adjustment and history.

    **products-table.tsx changes:**
    - Accept a new prop: `stockLevels: Map<string, StockInfoDto>` (or a record/object keyed by productId).
    - Add a "Stock" column after the existing columns (before the actions column).
    - Stock cell rendering:
      - If no stock info: show "-" (loading or not found).
      - If `availableQuantity === 0`: show `Badge` variant `destructive` with "Out of Stock".
      - If `isLowStock` (1-10): show `Badge` variant `outline` with yellow/amber styling and "Only {N} left".
      - Otherwise: show the `availableQuantity` number in a normal `Badge` variant `secondary` showing "In Stock ({N})".
    - Stock value should be clickable (cursor-pointer) to open the stock adjustment dialog.
    - Add a small history icon button next to the stock badge to open the adjustment history dialog.
    - Add callbacks: `onAdjustStock(productId: string)` and `onViewHistory(productId: string)`.

    **stock-adjust-dialog.tsx (new component):**
    - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `productId: string | null`, `productName: string`, `currentStock: number`, `onAdjusted: () => void`.
    - Uses shadcn `Dialog` component.
    - Title: "Adjust Stock - {productName}".
    - Shows current stock quantity.
    - Input field for adjustment: type number, placeholder "+10 or -5". Centered text.
    - Optional textarea for reason (placeholder "Reason for adjustment (optional)").
    - Preview: Show "New quantity: {currentStock + adjustment}" dynamically as user types. Show error text in red if result would be negative.
    - Submit button: "Adjust Stock". Disabled if adjustment is 0 or empty, or if result would be negative.
    - On submit: Call `adjustStock(productId, { adjustment, reason })`. On success: toast "Stock adjusted successfully", call `onAdjusted()`, close dialog. On error: toast error message.
    - Loading state on submit button.

    **adjustment-history-dialog.tsx (new component):**
    - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `productId: string | null`, `productName: string`.
    - Uses shadcn `Dialog` component (or Sheet for side panel -- Claude's discretion, matching the product drawer pattern may be nice).
    - Title: "Adjustment History - {productName}".
    - Fetches history on open: `getAdjustmentHistory(productId)`.
    - Shows a table with columns: Date, Adjustment (+/-), Quantity After, Reason, Adjusted By.
    - Adjustment column: show "+10" in green, "-5" in red.
    - Empty state: "No adjustments recorded."
    - Loading state with skeleton rows.

    **products/page.tsx changes:**
    - After loading products, fetch stock levels using `getStockLevels(productIds)` (batch call with all product IDs from current page).
    - Pass `stockLevels` map to `ProductsTable`.
    - Manage state for adjustment dialog and history dialog (which productId is selected, open/close).
    - After stock adjustment, refetch stock levels to update the table.
  </action>
  <verify>
    No TypeScript compilation errors. Run the Next.js dev server and verify admin products table shows Stock column. Click a stock badge to open the adjustment dialog. Enter a value and submit. Verify stock updates. Click history icon to view adjustment log.
  </verify>
  <done>
    Admin products table has Stock column with color-coded badges. Stock adjustment dialog allows relative adjustments with reason. Adjustment history dialog shows audit log. All connected to inventory API.
  </done>
</task>

</tasks>

<verification>
- `npm run build` (or Next.js build) succeeds without errors
- Admin products table shows Stock column with badges
- Clicking stock badge opens adjustment dialog
- Submitting adjustment updates stock via API
- History dialog shows chronological adjustment log
- Low stock and out-of-stock have distinct visual indicators
</verification>

<success_criteria>
- ADM-02 fulfilled: Admin can adjust inventory stock levels
- Stock column visible in admin product table
- Relative adjustment mode (+/- input) with preview of resulting quantity
- Optional reason field captured in audit trail
- Adjustment history viewable per product
- Visual indicators for low stock (amber) and out-of-stock (red)
</success_criteria>

<output>
After completion, create `.planning/phases/04-inventory-domain/04-04-SUMMARY.md`
</output>
