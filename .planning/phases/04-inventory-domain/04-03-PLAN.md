---
phase: 04-inventory-domain
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/ReservationCleanupService.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDataSeeder.cs
  - code/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "Expired reservations are automatically cleaned up every 1 minute"
    - "Existing products get StockItem records with randomized stock quantities on first run"
    - "Seeder is idempotent -- re-running does not duplicate stock records"
  artifacts:
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/ReservationCleanupService.cs"
      provides: "BackgroundService that removes expired reservations"
      contains: "BackgroundService"
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDataSeeder.cs"
      provides: "Hosted service to seed stock for existing products"
      contains: "BackgroundService"
  key_links:
    - from: "ReservationCleanupService.cs"
      to: "InventoryDbContext"
      via: "scoped service resolution"
      pattern: "IServiceScopeFactory"
    - from: "Program.cs"
      to: "ReservationCleanupService"
      via: "hosted service registration"
      pattern: "AddHostedService<ReservationCleanupService>"
---

<objective>
Build the reservation cleanup background service and stock data seeder for existing products.

Purpose: The cleanup service prevents expired reservations from accumulating and skewing available quantity calculations. The seeder ensures existing catalog products (created before the Inventory module existed) have StockItem records with realistic stock quantities for development/demo.
Output: Two BackgroundServices registered in Program.cs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-inventory-domain/04-CONTEXT.md
@.planning/phases/04-inventory-domain/04-RESEARCH.md
@.planning/phases/04-inventory-domain/04-01-SUMMARY.md
@.planning/phases/04-inventory-domain/04-02-SUMMARY.md

Key reference files:
@code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDataSeeder.cs
@code/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reservation Cleanup BackgroundService</name>
  <files>
    code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/ReservationCleanupService.cs
  </files>
  <action>
    Create a `BackgroundService` that periodically removes expired stock reservations.

    **ReservationCleanupService** (sealed class, extends `BackgroundService`):
    - Inject `IServiceScopeFactory` and `ILogger<ReservationCleanupService>`.
    - Interval: 1 minute (`TimeSpan.FromMinutes(1)`).
    - `ExecuteAsync` loop:
      1. `await Task.Delay(_interval, stoppingToken)` -- delay first, then clean.
      2. Create scope via `_scopeFactory.CreateScope()`.
      3. Resolve `InventoryDbContext` from scope.
      4. Query expired reservations: `context.StockReservations.Where(r => r.ExpiresAt <= DateTimeOffset.UtcNow).ToListAsync(stoppingToken)`.
      5. If any found: `context.StockReservations.RemoveRange(expired)`, `await context.SaveChangesAsync(stoppingToken)`.
      6. Log count of removed reservations at Information level.
    - Wrap body in try/catch -- log any exceptions at Error level but keep the loop running (do NOT rethrow, or the background service dies).
    - Use `stoppingToken.IsCancellationRequested` as while loop condition.
  </action>
  <verify>
    `dotnet build code/` compiles. File exists at the correct path.
  </verify>
  <done>
    ReservationCleanupService runs every 1 minute, removes expired reservations, handles errors gracefully without crashing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inventory Data Seeder and Program.cs Registration</name>
  <files>
    code/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDataSeeder.cs
    code/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    Create a `BackgroundService` that seeds StockItem records for existing products and register both services in Program.cs. Follow the CatalogDataSeeder pattern.

    **InventoryDataSeeder** (sealed class, extends `BackgroundService`):
    - Inject `IServiceScopeFactory`, `ILogger<InventoryDataSeeder>`, `IHostEnvironment`.
    - Only run in Development environment (`if (!_environment.IsDevelopment()) return;`).
    - `ExecuteAsync`:
      1. Small delay to let migrations run: `await Task.Delay(TimeSpan.FromSeconds(5), stoppingToken)`.
      2. Create scope, resolve `InventoryDbContext` and `CatalogDbContext`.
      3. Idempotency check: `if (await inventoryContext.StockItems.AnyAsync(stoppingToken)) return;` -- skip if already seeded.
      4. Load all product IDs from CatalogDbContext: `catalogContext.Products.Select(p => p.Id.Value).ToListAsync()`.
      5. For each product ID, create a `StockItem` with `StockItem.Create(productId)` then immediately adjust stock to a random quantity: use a seeded `Random(42)` for reproducibility, generate quantities between 0 and 100. Some products (roughly 10%) should get 0 stock to test out-of-stock display. Others should get a mix -- some in the 1-10 range (low stock) and the rest 20-100.
      6. For each StockItem, also create a `StockAdjustment` audit record: `StockAdjustment.Create(stockItem.Id, quantity, quantity, "Initial seed stock", "system")`.
      7. Add all to context, `SaveChangesAsync`.
      8. Log: "Seeded stock for {count} products".
    - Wrap in try/catch with error logging.

    **Program.cs updates:**
    - Add after the `builder.Services.AddHostedService<CatalogDataSeeder>();` line:
      ```csharp
      // Inventory services
      builder.Services.AddHostedService<ReservationCleanupService>();
      builder.Services.AddHostedService<InventoryDataSeeder>();
      ```
    - Add the required using statements for these two classes.
  </action>
  <verify>
    `dotnet build code/` compiles. Program.cs registers both hosted services. Run the app via `dotnet run --project code/MicroCommerce.AppHost` and verify via logs that "Seeded stock for N products" appears (or stock items already exist). Verify via `GET /api/inventory/stock?productIds=...` that stock data is returned.
  </verify>
  <done>
    InventoryDataSeeder creates StockItem records for all existing products with varied quantities (including some zero-stock). ReservationCleanupService and InventoryDataSeeder both registered as hosted services. Running app shows seeded stock data via API.
  </done>
</task>

</tasks>

<verification>
- `dotnet build code/` compiles cleanly
- Both BackgroundServices registered in Program.cs
- ReservationCleanupService has error handling in the loop (does not crash on exceptions)
- InventoryDataSeeder has idempotency check and development-only guard
- Stock data accessible via GET /api/inventory/stock endpoints after app starts
</verification>

<success_criteria>
- Expired reservations cleaned up automatically every 1 minute
- Existing catalog products seeded with stock quantities (mix of 0, low, and normal)
- Both services register and start without errors
- Seeder is idempotent
</success_criteria>

<output>
After completion, create `.planning/phases/04-inventory-domain/04-03-SUMMARY.md`
</output>
