---
phase: 04-inventory-domain
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommand.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommandHandler.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommandValidator.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommand.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommandHandler.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommandValidator.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReleaseReservation/ReleaseReservationCommand.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReleaseReservation/ReleaseReservationCommandHandler.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockByProductId/GetStockByProductIdQuery.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockByProductId/GetStockByProductIdQueryHandler.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockByProductId/StockInfoDto.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockLevels/GetStockLevelsQuery.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockLevels/GetStockLevelsQueryHandler.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetAdjustmentHistory/GetAdjustmentHistoryQuery.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetAdjustmentHistory/GetAdjustmentHistoryQueryHandler.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetAdjustmentHistory/AdjustmentDto.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Consumers/ProductCreatedConsumer.cs
  - code/MicroCommerce.ApiService/Features/Inventory/InventoryEndpoints.cs
  - code/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "Admin can adjust stock via POST /api/inventory/stock/{productId}/adjust"
    - "Stock can be reserved via POST /api/inventory/stock/{productId}/reserve"
    - "Reservations can be released via DELETE /api/inventory/reservations/{reservationId}"
    - "Stock info retrievable via GET /api/inventory/stock/{productId}"
    - "Batch stock levels retrievable via GET /api/inventory/stock?productIds=..."
    - "Adjustment history retrievable via GET /api/inventory/stock/{productId}/adjustments"
    - "StockItem auto-created when ProductCreatedDomainEvent consumed"
    - "Concurrent stock adjustments return 409 Conflict (not 500)"
  artifacts:
    - path: "code/MicroCommerce.ApiService/Features/Inventory/InventoryEndpoints.cs"
      provides: "All inventory API endpoints"
      exports: ["MapInventoryEndpoints"]
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Application/Consumers/ProductCreatedConsumer.cs"
      provides: "MassTransit consumer for auto-creating StockItem"
      contains: "IConsumer<ProductCreatedDomainEvent>"
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommandHandler.cs"
      provides: "Stock adjustment with concurrency handling"
      contains: "DbUpdateConcurrencyException"
  key_links:
    - from: "InventoryEndpoints.cs"
      to: "ISender"
      via: "MediatR dispatch"
      pattern: "sender\\.Send"
    - from: "AdjustStockCommandHandler.cs"
      to: "InventoryDbContext"
      via: "EF Core queries"
      pattern: "_context\\.StockItems"
    - from: "Program.cs"
      to: "InventoryEndpoints"
      via: "endpoint registration"
      pattern: "MapInventoryEndpoints"
    - from: "ProductCreatedConsumer.cs"
      to: "StockItem.Create"
      via: "auto-creation on event"
      pattern: "StockItem\\.Create"
---

<objective>
Build all CQRS commands, queries, and API endpoints for the Inventory module, plus the MassTransit consumer that auto-creates StockItems when products are created.

Purpose: Provides the full API surface for inventory operations -- stock adjustment, reservation, release, and querying. The ProductCreatedConsumer ensures every new product automatically gets a StockItem with quantity 0.
Output: Complete CQRS stack, Minimal API endpoints registered in Program.cs, and cross-module event consumer.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-inventory-domain/04-CONTEXT.md
@.planning/phases/04-inventory-domain/04-RESEARCH.md
@.planning/phases/04-inventory-domain/04-01-SUMMARY.md

Key reference files:
@code/MicroCommerce.ApiService/Features/Catalog/CatalogEndpoints.cs
@code/MicroCommerce.ApiService/Features/Catalog/Application/Commands/CreateProduct/CreateProductCommand.cs
@code/MicroCommerce.ApiService/Features/Catalog/Application/Commands/CreateProduct/CreateProductCommandHandler.cs
@code/MicroCommerce.ApiService/Features/Catalog/Application/Commands/CreateProduct/CreateProductCommandValidator.cs
@code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProductById/GetProductByIdQuery.cs
@code/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProductById/GetProductByIdQueryHandler.cs
@code/MicroCommerce.ApiService/Features/Catalog/Domain/Events/ProductCreatedDomainEvent.cs
@code/MicroCommerce.ApiService/Program.cs
@code/MicroCommerce.ApiService/Common/Exceptions/GlobalExceptionHandler.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commands, Queries, Consumer, and DTOs</name>
  <files>
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommand.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommandHandler.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommandValidator.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommand.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommandHandler.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommandValidator.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReleaseReservation/ReleaseReservationCommand.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReleaseReservation/ReleaseReservationCommandHandler.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockByProductId/GetStockByProductIdQuery.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockByProductId/GetStockByProductIdQueryHandler.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockByProductId/StockInfoDto.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockLevels/GetStockLevelsQuery.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockLevels/GetStockLevelsQueryHandler.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetAdjustmentHistory/GetAdjustmentHistoryQuery.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetAdjustmentHistory/GetAdjustmentHistoryQueryHandler.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetAdjustmentHistory/AdjustmentDto.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Consumers/ProductCreatedConsumer.cs
  </files>
  <action>
    Create all CQRS handlers following the exact Catalog module patterns (MediatR IRequest/IRequestHandler, FluentValidation validators).

    **AdjustStock command:**
    - `AdjustStockCommand(Guid ProductId, int Adjustment, string? Reason, string? AdjustedBy)` : `IRequest<Unit>`.
    - Handler: Load StockItem by ProductId with `.Include(s => s.Reservations)`, call `stockItem.AdjustStock(...)`, create `StockAdjustment` audit entity in same DbContext (using `StockAdjustment.Create(stockItem.Id, command.Adjustment, stockItem.QuantityOnHand, command.Reason, command.AdjustedBy)`), `SaveChangesAsync`. Wrap in try/catch for `DbUpdateConcurrencyException` -- throw `ConflictException("Stock was modified concurrently. Please retry.")` (the existing GlobalExceptionHandler maps ConflictException to 409).
    - Validator: `Adjustment` must not be 0. `ProductId` must not be empty.

    **ReserveStock command:**
    - `ReserveStockCommand(Guid ProductId, int Quantity)` : `IRequest<Guid>` (returns ReservationId).
    - Handler: Load StockItem with `.Include(s => s.Reservations.Where(r => r.ExpiresAt > DateTimeOffset.UtcNow))` (filtered include -- only active reservations). Call `stockItem.Reserve(quantity)`. `SaveChangesAsync`. Return `reservationId.Value`. Handle `DbUpdateConcurrencyException` same as AdjustStock.
    - Validator: `Quantity` must be > 0. `ProductId` must not be empty.

    **ReleaseReservation command:**
    - `ReleaseReservationCommand(Guid StockItemId, Guid ReservationId)` : `IRequest<Unit>`.
    - Handler: Load StockItem with reservations. Call `stockItem.ReleaseReservation(new ReservationId(command.ReservationId))`. `SaveChangesAsync`.
    - No validator needed (simple operation).

    **GetStockByProductId query:**
    - `GetStockByProductIdQuery(Guid ProductId)` : `IRequest<StockInfoDto?>`.
    - Handler: Load StockItem with active reservations. Return `StockInfoDto`.
    - `StockInfoDto`: `{ Guid ProductId, int QuantityOnHand, int AvailableQuantity, bool IsInStock, bool IsLowStock }`. `IsInStock = AvailableQuantity > 0`. `IsLowStock = AvailableQuantity > 0 && AvailableQuantity <= 10`.

    **GetStockLevels query (batch):**
    - `GetStockLevelsQuery(List<Guid> ProductIds)` : `IRequest<List<StockInfoDto>>`.
    - Handler: Load StockItems where ProductId is in the list, include active reservations. Map to `List<StockInfoDto>`. For product IDs with no StockItem, return entry with `QuantityOnHand = 0, AvailableQuantity = 0, IsInStock = false`.

    **GetAdjustmentHistory query:**
    - `GetAdjustmentHistoryQuery(Guid ProductId)` : `IRequest<List<AdjustmentDto>>`.
    - Handler: Find StockItem by ProductId, query StockAdjustments by StockItemId, ordered by CreatedAt descending.
    - `AdjustmentDto`: `{ Guid Id, int Adjustment, int QuantityAfter, string? Reason, string? AdjustedBy, DateTimeOffset CreatedAt }`.

    **ProductCreatedConsumer** (MassTransit `IConsumer<ProductCreatedDomainEvent>`):
    - Inject `InventoryDbContext`.
    - On consume: Check idempotency -- `AnyAsync(s => s.ProductId == productId)`. If exists, return (skip).
    - Create `StockItem.Create(productId)`, add to DbContext, `SaveChangesAsync`.
    - Reference the `ProductCreatedDomainEvent` from `MicroCommerce.ApiService.Features.Catalog.Domain.Events` (direct reference is fine within monolith).
  </action>
  <verify>
    `dotnet build code/` compiles without errors. All command/query/handler/validator/consumer files exist in correct directories.
  </verify>
  <done>
    All 3 commands with handlers + validators, 3 queries with handlers + DTOs, and ProductCreatedConsumer are implemented following CQRS patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inventory Endpoints and Program.cs Registration</name>
  <files>
    code/MicroCommerce.ApiService/Features/Inventory/InventoryEndpoints.cs
    code/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    Create Minimal API endpoints for Inventory module and register them in Program.cs. Follow the CatalogEndpoints pattern exactly.

    **InventoryEndpoints.cs:**
    - Extension method: `static IEndpointRouteBuilder MapInventoryEndpoints(this IEndpointRouteBuilder endpoints)`.
    - Route group: `/api/inventory` with tag `"Inventory"`.
    - Endpoints:
      1. `GET /stock/{productId:guid}` -> `GetStockByProductId`. Returns `StockInfoDto` or 404.
      2. `GET /stock` -> `GetStockLevels`. Accepts `[FromQuery] string? productIds` (comma-separated GUIDs). Parse into `List<Guid>`. Returns `List<StockInfoDto>`.
      3. `POST /stock/{productId:guid}/adjust` -> `AdjustStock`. Accepts `AdjustStockRequest { int Adjustment, string? Reason }`. Extract `AdjustedBy` from `ClaimsPrincipal` via `user.FindFirst("preferred_username")?.Value ?? "system"`. Returns 204 NoContent. Produces 409 Conflict.
      4. `POST /stock/{productId:guid}/reserve` -> `ReserveStock`. Accepts `ReserveStockRequest { int Quantity }`. Returns 201 Created with `{ Guid ReservationId }`.
      5. `DELETE /reservations/{reservationId:guid}` -> `ReleaseReservation`. Accepts `[FromQuery] Guid stockItemId`. Returns 204 NoContent.
      6. `GET /stock/{productId:guid}/adjustments` -> `GetAdjustmentHistory`. Returns `List<AdjustmentDto>`.

    - Request/response records at bottom of file (same pattern as CatalogEndpoints):
      - `AdjustStockRequest(int Adjustment, string? Reason)`
      - `ReserveStockRequest(int Quantity)`
      - `ReserveStockResponse(Guid ReservationId)`

    **Program.cs:**
    - Add `using MicroCommerce.ApiService.Features.Inventory;`
    - Add `app.MapInventoryEndpoints();` right after `app.MapCatalogEndpoints();` line.
  </action>
  <verify>
    `dotnet build code/` compiles. Program.cs has `app.MapInventoryEndpoints()`. InventoryEndpoints.cs has all 6 endpoint mappings. Run the app briefly with `dotnet run --project code/MicroCommerce.AppHost` and verify `/api/inventory/stock` endpoints appear in OpenAPI docs at `/openapi/v1.json`.
  </verify>
  <done>
    All 6 inventory endpoints are mapped and registered. Adjust endpoint extracts user identity for audit trail. OpenAPI docs show Inventory endpoints.
  </done>
</task>

</tasks>

<verification>
- `dotnet build code/` compiles cleanly
- All CQRS handlers follow MediatR IRequest/IRequestHandler pattern
- AdjustStockCommandHandler catches DbUpdateConcurrencyException and throws ConflictException
- ProductCreatedConsumer has idempotency check (AnyAsync)
- InventoryEndpoints registered in Program.cs
- All 6 endpoints mapped with correct HTTP methods and routes
</verification>

<success_criteria>
- 3 commands (AdjustStock, ReserveStock, ReleaseReservation) with handlers and validators
- 3 queries (GetStockByProductId, GetStockLevels, GetAdjustmentHistory) with handlers and DTOs
- ProductCreatedConsumer with idempotency
- 6 Minimal API endpoints registered at /api/inventory/*
- Concurrency conflict mapped to 409 via existing GlobalExceptionHandler
</success_criteria>

<output>
After completion, create `.planning/phases/04-inventory-domain/04-02-SUMMARY.md`
</output>
