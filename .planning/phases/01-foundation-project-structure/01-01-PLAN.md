---
phase: 01-foundation-project-structure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj
  - code/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj
  - code/MicroCommerce.AppHost/AppHost.cs
autonomous: true

must_haves:
  truths:
    - "ApiService can resolve MediatR, FluentValidation, MassTransit, and EF Core types"
    - "AppHost starts PostgreSQL and Azure Service Bus emulator containers"
    - "ApiService connects to PostgreSQL database and Service Bus"
  artifacts:
    - path: "code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj"
      provides: "Package references for MediatR, FluentValidation, MassTransit, EF Core"
      contains: "MassTransit.Azure.ServiceBus.Core"
    - path: "code/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj"
      provides: "Package references for Aspire PostgreSQL and Service Bus hosting"
      contains: "Aspire.Hosting.Azure.ServiceBus"
    - path: "code/MicroCommerce.AppHost/AppHost.cs"
      provides: "PostgreSQL and Service Bus resource configuration"
      contains: "AddPostgres"
  key_links:
    - from: "code/MicroCommerce.AppHost/AppHost.cs"
      to: "apiservice project reference"
      via: "WithReference for postgres and messaging"
      pattern: "WithReference\\(postgres\\)|WithReference\\(messaging\\)"
---

<objective>
Add all required NuGet packages for Phase 1 infrastructure and configure Aspire resources for PostgreSQL and Azure Service Bus.

Purpose: Establish the package dependencies and infrastructure resources that all subsequent plans depend on.
Output: Updated csproj files with packages, AppHost configured with PostgreSQL and Service Bus emulator.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-project-structure/01-CONTEXT.md
@.planning/phases/01-foundation-project-structure/01-RESEARCH.md
@code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj
@code/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj
@code/MicroCommerce.AppHost/AppHost.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NuGet packages to ApiService</name>
  <files>code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj</files>
  <action>
Add the following NuGet packages to MicroCommerce.ApiService.csproj:

**Core packages:**
- MediatR 13.1.0 (match existing BuildingBlocks version)
- FluentValidation 12.1.1
- FluentValidation.DependencyInjectionExtensions 12.1.1

**MassTransit for domain events:**
- MassTransit 9.0.0
- MassTransit.Azure.ServiceBus.Core 9.0.0
- MassTransit.EntityFrameworkCore 9.0.0

**EF Core for PostgreSQL:**
- Npgsql.EntityFrameworkCore.PostgreSQL 10.0.0
- Microsoft.EntityFrameworkCore.Design 10.0.0 (for migrations tooling)

**Aspire client integrations:**
- Aspire.Npgsql.EntityFrameworkCore.PostgreSQL 13.1.0
- Aspire.Azure.Messaging.ServiceBus 13.1.0

Also add ProjectReference to BuildingBlocks.Common so ApiService can use BaseAggregateRoot, ValueObject, etc.

Use dotnet add package commands or edit csproj directly.
  </action>
  <verify>
Run `dotnet restore code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` - should succeed with no errors.
Run `dotnet build code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` - should compile.
  </verify>
  <done>
ApiService.csproj contains all required package references and builds successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add NuGet packages to AppHost and configure Aspire resources</name>
  <files>
code/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj
code/MicroCommerce.AppHost/AppHost.cs
  </files>
  <action>
**Update AppHost.csproj:**
Add package references:
- Aspire.Hosting.PostgreSQL 13.1.0
- Aspire.Hosting.Azure.ServiceBus 13.1.0

**Update AppHost.cs:**
Add PostgreSQL and Azure Service Bus resources before the apiService declaration:

```csharp
// PostgreSQL with persistent data volume
var postgres = builder.AddPostgres("postgres")
    .WithDataVolume()
    .WithLifetime(ContainerLifetime.Persistent)
    .WithPgAdmin();  // Optional: pgAdmin for database management

// Create database for the application (shared connection, schema isolation per module)
var appDb = postgres.AddDatabase("appdb");

// Azure Service Bus emulator for domain events
var messaging = builder.AddAzureServiceBus("messaging")
    .RunAsEmulator();
```

Update apiservice registration to reference these resources:
```csharp
var apiService = builder.AddProject<Projects.MicroCommerce_ApiService>("apiservice")
    .WithReference(keycloak)
    .WithReference(appDb)
    .WithReference(messaging)
    .WithHttpHealthCheck("/health");
```

Keep existing keycloak and frontend configuration unchanged.
  </action>
  <verify>
Run `dotnet build code/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj` - should compile.
Run `dotnet run --project code/MicroCommerce.AppHost/MicroCommerce.AppHost.csproj` briefly and verify Aspire dashboard shows postgres and messaging resources (can Ctrl+C after verification).
  </verify>
  <done>
AppHost starts PostgreSQL container, Service Bus emulator, and passes connection references to apiservice.
  </done>
</task>

</tasks>

<verification>
1. `dotnet restore code/MicroCommerce.sln` - all packages restore
2. `dotnet build code/MicroCommerce.sln` - solution builds without errors
3. AppHost starts and Aspire dashboard shows: keycloak, postgres, appdb, messaging, apiservice, frontend
</verification>

<success_criteria>
- All NuGet packages installed and solution builds
- AppHost runs with PostgreSQL and Service Bus emulator containers
- ApiService can be injected with connection strings for database and messaging
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-project-structure/01-01-SUMMARY.md`
</output>
