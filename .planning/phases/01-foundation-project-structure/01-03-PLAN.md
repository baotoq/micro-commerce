---
phase: 01-foundation-project-structure
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - code/MicroCommerce.ApiService/Common/Behaviors/ValidationBehavior.cs
  - code/MicroCommerce.ApiService/Common/Exceptions/ValidationException.cs
  - code/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "MediatR requests with validators are validated before handlers execute"
    - "Validation errors throw ValidationException with structured error details"
    - "Validators are auto-discovered from assembly and registered in DI"
  artifacts:
    - path: "code/MicroCommerce.ApiService/Common/Behaviors/ValidationBehavior.cs"
      provides: "MediatR pipeline behavior that runs FluentValidation"
      contains: "IPipelineBehavior"
    - path: "code/MicroCommerce.ApiService/Common/Exceptions/ValidationException.cs"
      provides: "Structured validation exception with error dictionary"
      contains: "ValidationException"
    - path: "code/MicroCommerce.ApiService/Program.cs"
      provides: "MediatR and FluentValidation DI registration"
      contains: "AddMediatR"
  key_links:
    - from: "code/MicroCommerce.ApiService/Common/Behaviors/ValidationBehavior.cs"
      to: "FluentValidation IValidator<T>"
      via: "Constructor injection"
      pattern: "IEnumerable<IValidator<TRequest>>"
    - from: "code/MicroCommerce.ApiService/Program.cs"
      to: "ValidationBehavior registration"
      via: "MediatR AddOpenBehavior"
      pattern: "AddOpenBehavior.*ValidationBehavior"
---

<objective>
Implement MediatR validation pipeline using FluentValidation to ensure all requests are validated before reaching handlers.

Purpose: Establish consistent request validation across all CQRS operations, failing fast with clear error messages.
Output: ValidationBehavior, ValidationException, and DI registration in Program.cs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-project-structure/01-CONTEXT.md
@.planning/phases/01-foundation-project-structure/01-RESEARCH.md
@code/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ValidationBehavior and ValidationException</name>
  <files>
code/MicroCommerce.ApiService/Common/Behaviors/ValidationBehavior.cs
code/MicroCommerce.ApiService/Common/Exceptions/ValidationException.cs
  </files>
  <action>
Create the Common/ folder structure and implement validation components:

**ValidationException.cs:**
```csharp
using FluentValidation.Results;

namespace MicroCommerce.ApiService.Common.Exceptions;

public class ValidationException : Exception
{
    public ValidationException()
        : base("One or more validation failures have occurred.")
    {
        Errors = new Dictionary<string, string[]>();
    }

    public ValidationException(IEnumerable<ValidationFailure> failures)
        : this()
    {
        Errors = failures
            .GroupBy(e => e.PropertyName, e => e.ErrorMessage)
            .ToDictionary(g => g.Key, g => g.ToArray());
    }

    public IDictionary<string, string[]> Errors { get; }
}
```

**ValidationBehavior.cs:**
```csharp
using FluentValidation;
using MediatR;

namespace MicroCommerce.ApiService.Common.Behaviors;

public class ValidationBehavior<TRequest, TResponse> : IPipelineBehavior<TRequest, TResponse>
    where TRequest : notnull
{
    private readonly IEnumerable<IValidator<TRequest>> _validators;

    public ValidationBehavior(IEnumerable<IValidator<TRequest>> validators)
    {
        _validators = validators;
    }

    public async Task<TResponse> Handle(
        TRequest request,
        RequestHandlerDelegate<TResponse> next,
        CancellationToken cancellationToken)
    {
        if (!_validators.Any())
        {
            return await next();
        }

        var context = new ValidationContext<TRequest>(request);

        var validationResults = await Task.WhenAll(
            _validators.Select(v => v.ValidateAsync(context, cancellationToken)));

        var failures = validationResults
            .SelectMany(r => r.Errors)
            .Where(f => f != null)
            .ToList();

        if (failures.Count != 0)
        {
            throw new Exceptions.ValidationException(failures);
        }

        return await next();
    }
}
```

This pattern:
- Runs ALL validators (not short-circuit) to collect all errors
- Only throws if there are actual failures
- Passes through cleanly if no validators registered for a request type
  </action>
  <verify>
Run `dotnet build code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` - should compile.
  </verify>
  <done>
ValidationBehavior intercepts MediatR requests and runs FluentValidation validators.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register MediatR and FluentValidation in DI</name>
  <files>code/MicroCommerce.ApiService/Program.cs</files>
  <action>
Update Program.cs to register MediatR with ValidationBehavior and auto-discover validators.

Add these using statements at top:
```csharp
using FluentValidation;
using MicroCommerce.ApiService.Common.Behaviors;
```

Add MediatR and FluentValidation registration BEFORE `var app = builder.Build();`:

```csharp
// MediatR with validation pipeline
builder.Services.AddMediatR(cfg =>
{
    cfg.RegisterServicesFromAssemblyContaining<Program>();

    // Validation runs first - fail fast before handler executes
    cfg.AddOpenBehavior(typeof(ValidationBehavior<,>));
});

// FluentValidation - auto-discover validators
builder.Services.AddValidatorsFromAssemblyContaining<Program>();
```

**Important:**
- Register ValidationBehavior first so validation happens before any other behaviors
- AddValidatorsFromAssemblyContaining scans for all AbstractValidator<T> implementations
- Keep existing services (CORS, OpenApi, Auth) unchanged
  </action>
  <verify>
Run `dotnet build code/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` - should compile.
Verify Program.cs contains "AddMediatR" and "AddValidatorsFromAssemblyContaining".
  </verify>
  <done>
MediatR registered with ValidationBehavior pipeline, validators auto-discovered from assembly.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build code/MicroCommerce.ApiService/` compiles without errors
2. ValidationBehavior.cs contains `IPipelineBehavior<TRequest, TResponse>`
3. Program.cs contains `AddMediatR` with `AddOpenBehavior(typeof(ValidationBehavior<,>))`
4. Program.cs contains `AddValidatorsFromAssemblyContaining<Program>()`
</verification>

<success_criteria>
- ValidationBehavior intercepts all MediatR requests
- Validators are auto-discovered and registered
- Invalid requests throw ValidationException with structured errors
- Valid requests (or requests without validators) pass through to handlers
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-project-structure/01-03-SUMMARY.md`
</output>
