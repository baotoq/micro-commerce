# Phase 01-06: UAT Gap Fixes - Database Migration & Exception Handling

## Context

Two UAT failures identified:
1. **Blocker**: Database table missing - EF Core migration not created/applied for CatalogDbContext
2. **Major**: Validation exceptions return 500 instead of 400 - no IExceptionHandler to map ValidationException

## Tasks

### Task 1: Create and Apply EF Core Migration for Catalog Schema

**Objective**: Create initial migration for CatalogDbContext and apply it to the database.

**Steps**:

1. **Create the migration**:
   ```bash
   cd /Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService
   dotnet ef migrations add InitialCatalog \
     --context CatalogDbContext \
     --output-dir Features/Catalog/Infrastructure/Migrations
   ```

   This will generate:
   - `Features/Catalog/Infrastructure/Migrations/<timestamp>_InitialCatalog.cs` - The migration with Up/Down methods
   - `Features/Catalog/Infrastructure/Migrations/<timestamp>_InitialCatalog.Designer.cs` - Metadata
   - `Features/Catalog/Infrastructure/Migrations/CatalogDbContextModelSnapshot.cs` - Current model snapshot

2. **Verify migration creates correct schema**:
   - Review the generated migration file
   - Should create `catalog` schema
   - Should create `categories` table with columns: id, name, description, created_at, updated_at
   - Should create unique index `ix_categories_name`
   - Should use `__EFMigrationsHistory` table in `catalog` schema

3. **Apply the migration**:
   ```bash
   cd /Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService
   dotnet ef database update --context CatalogDbContext
   ```

   This will:
   - Create the `catalog` schema if it doesn't exist
   - Create the `categories` table
   - Create the unique index
   - Record migration in `catalog.__EFMigrationsHistory`

**Expected Files**:
- `/Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Migrations/<timestamp>_InitialCatalog.cs`
- `/Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Migrations/<timestamp>_InitialCatalog.Designer.cs`
- `/Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Migrations/CatalogDbContextModelSnapshot.cs`

**Verification**:
- Migration files exist in correct location
- Database has `catalog` schema
- Database has `catalog.categories` table with correct columns
- Database has `catalog.__EFMigrationsHistory` table with InitialCatalog entry

---

### Task 2: Implement GlobalExceptionHandler for Validation Errors

**Objective**: Create IExceptionHandler to map ValidationException to 400 Bad Request with ProblemDetails.

**Steps**:

1. **Create GlobalExceptionHandler.cs**:

   Create file: `/Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService/Common/Exceptions/GlobalExceptionHandler.cs`

   ```csharp
   using Microsoft.AspNetCore.Diagnostics;
   using Microsoft.AspNetCore.Mvc;

   namespace MicroCommerce.ApiService.Common.Exceptions;

   /// <summary>
   /// Global exception handler that maps domain exceptions to appropriate HTTP responses.
   /// Implements IExceptionHandler for .NET 8+ exception handling pipeline.
   /// </summary>
   public sealed class GlobalExceptionHandler : IExceptionHandler
   {
       private readonly ILogger<GlobalExceptionHandler> _logger;

       public GlobalExceptionHandler(ILogger<GlobalExceptionHandler> logger)
       {
           _logger = logger;
       }

       public async ValueTask<bool> TryHandleAsync(
           HttpContext httpContext,
           Exception exception,
           CancellationToken cancellationToken)
       {
           _logger.LogError(exception, "Exception occurred: {Message}", exception.Message);

           var problemDetails = exception switch
           {
               ValidationException validationException => new ValidationProblemDetails(validationException.Errors)
               {
                   Status = StatusCodes.Status400BadRequest,
                   Title = "Validation error",
                   Detail = "One or more validation errors occurred.",
                   Instance = httpContext.Request.Path
               },
               _ => null
           };

           if (problemDetails is null)
           {
               // Let the default exception handler deal with it
               return false;
           }

           httpContext.Response.StatusCode = problemDetails.Status!.Value;
           await httpContext.Response.WriteAsJsonAsync(problemDetails, cancellationToken);

           return true;
       }
   }
   ```

2. **Register GlobalExceptionHandler in Program.cs**:

   In `/Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService/Program.cs`, add BEFORE `builder.Services.AddProblemDetails()` (around line 72):

   ```csharp
   // Exception handling
   builder.Services.AddExceptionHandler<GlobalExceptionHandler>();
   ```

   The section should look like:
   ```csharp
   builder.Services.AddScoped<DomainEventInterceptor>();

   // Add services to the container.
   builder.Services.AddExceptionHandler<GlobalExceptionHandler>();
   builder.Services.AddProblemDetails();
   ```

   **Important**: Order matters! `AddExceptionHandler` must be called before `AddProblemDetails`.

3. **Add using statement** at top of Program.cs:
   ```csharp
   using MicroCommerce.ApiService.Common.Exceptions;
   ```

**Expected Files**:
- `/Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService/Common/Exceptions/GlobalExceptionHandler.cs` (new)

**Modified Files**:
- `/Users/baotoq/Work/micro-commerce/code/MicroCommerce.ApiService/Program.cs` (add registration and using)

**Verification**:
- GlobalExceptionHandler class exists
- Implements IExceptionHandler interface
- Maps ValidationException to 400 Bad Request
- Returns ValidationProblemDetails with structured error dictionary
- Registered in DI container before AddProblemDetails()
- UseExceptionHandler() middleware already in pipeline (line 123)

---

## Success Criteria

### Task 1 - Migration
- [ ] Migration files created in `Features/Catalog/Infrastructure/Migrations/`
- [ ] Migration creates `catalog` schema
- [ ] Migration creates `categories` table with all columns
- [ ] Migration creates unique index on name
- [ ] Migration applied successfully to database
- [ ] `catalog.__EFMigrationsHistory` table contains InitialCatalog entry
- [ ] UAT Test 3 passes: POST /api/catalog/categories creates category and returns 201

### Task 2 - Exception Handler
- [ ] GlobalExceptionHandler.cs created in Common/Exceptions/
- [ ] Implements IExceptionHandler with TryHandleAsync method
- [ ] Maps ValidationException to 400 Bad Request
- [ ] Returns ValidationProblemDetails with Errors dictionary
- [ ] Registered in Program.cs before AddProblemDetails()
- [ ] Using statement added to Program.cs
- [ ] UAT Test 4 passes: POST /api/catalog/categories with empty name returns 400

### Integration
- [ ] Both fixes work together - valid requests create categories, invalid requests return 400
- [ ] No breaking changes to existing functionality
- [ ] Application starts without errors
- [ ] All existing tests still pass

## Notes

### Why Order Matters in Program.cs
The exception handler registration must come before `AddProblemDetails()` to ensure the problem details services are available when the exception handler needs to serialize ValidationProblemDetails.

### Why Return false for Unhandled Exceptions
Returning `false` from `TryHandleAsync` for non-ValidationException cases allows the default exception handler to process them (e.g., 500 Internal Server Error for unexpected exceptions).

### Migration Strategy
We're using database-per-module pattern with schema isolation. Each module (Catalog, Cart, Ordering, Inventory) has:
- Own DbContext
- Own schema in PostgreSQL
- Own migrations folder
- Own `__EFMigrationsHistory` table in its schema

This enables gradual extraction to microservices later.

## References

- [IExceptionHandler in .NET 8+](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/error-handling)
- [EF Core Migrations](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
- [Problem Details RFC 7807](https://www.rfc-editor.org/rfc/rfc7807)
- CLAUDE.md: Database-per-Module pattern
- 01-RESEARCH.md: EF Core migration strategy
