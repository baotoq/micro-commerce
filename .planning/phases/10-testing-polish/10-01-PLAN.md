---
phase: 10-testing-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService.Tests/MicroCommerce.ApiService.Tests.csproj
  - src/MicroCommerce.ApiService.Tests/coverlet.runsettings
  - src/MicroCommerce.ApiService.Tests/Unit/Ordering/Aggregates/OrderTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Ordering/ValueObjects/OrderNumberTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Ordering/ValueObjects/ShippingAddressTests.cs
autonomous: true

must_haves:
  truths:
    - "Order aggregate Create factory creates order with Submitted status and raises OrderSubmittedDomainEvent"
    - "Order status transitions enforce guard clauses (MarkAsPaid only from Submitted/StockReserved, Ship only from Confirmed, etc.)"
    - "Invalid status transitions throw InvalidOperationException with descriptive message"
    - "Order calculates subtotal, tax (8%), flat shipping ($5.99), and total correctly"
    - "Order with zero items throws InvalidOperationException"
    - "OrderNumber generates MC-XXXXXX format with unambiguous characters"
    - "ShippingAddress rejects null/whitespace fields"
  artifacts:
    - path: "src/MicroCommerce.ApiService.Tests/MicroCommerce.ApiService.Tests.csproj"
      provides: "Test project with xUnit, FluentAssertions, Testcontainers, MassTransit.TestFramework"
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Ordering/Aggregates/OrderTests.cs"
      provides: "Unit tests for Order aggregate (factory, status transitions, calculations, invariants)"
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Ordering/ValueObjects/OrderNumberTests.cs"
      provides: "Unit tests for OrderNumber value object"
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Ordering/ValueObjects/ShippingAddressTests.cs"
      provides: "Unit tests for ShippingAddress value object"
  key_links:
    - from: "src/MicroCommerce.ApiService.Tests/MicroCommerce.ApiService.Tests.csproj"
      to: "src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj"
      via: "ProjectReference"
      pattern: "ProjectReference.*MicroCommerce\\.ApiService"
---

<objective>
Create the test project infrastructure and write comprehensive unit tests for the Ordering domain - the highest complexity/risk module in MicroCommerce. This establishes the test project that all subsequent plans depend on, plus covers the most critical domain logic.

Purpose: Ordering is the most complex domain with state machine transitions, calculation logic, and multiple invariants. Testing it first provides the highest confidence return. The test project setup enables all subsequent test plans.
Output: Working xUnit test project with passing unit tests for Order aggregate, OrderNumber, and ShippingAddress.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderNumber.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/ShippingAddress.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderSubmittedDomainEvent.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderPaidDomainEvent.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderFailedDomainEvent.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create xUnit test project with all required dependencies</name>
  <files>
    src/MicroCommerce.ApiService.Tests/MicroCommerce.ApiService.Tests.csproj
    src/MicroCommerce.ApiService.Tests/coverlet.runsettings
  </files>
  <action>
    Create the test project at `src/MicroCommerce.ApiService.Tests/`:

    1. Run `dotnet new xunit -n MicroCommerce.ApiService.Tests -o src/MicroCommerce.ApiService.Tests -f net10.0`
    2. Add required NuGet packages:
       - `Microsoft.AspNetCore.Mvc.Testing` (for WebApplicationFactory in later plans)
       - `Testcontainers.PostgreSql` version 4.10.0 (for real DB integration tests)
       - `FluentAssertions` version 7.* (readable assertions)
       - `MassTransit.TestFramework` version 9.0.0 (saga/consumer testing)
    3. Add project reference to `../MicroCommerce.ApiService/MicroCommerce.ApiService.csproj`
    4. Delete the auto-generated `UnitTest1.cs` file
    5. Create `coverlet.runsettings` excluding migrations and generated files:
       ```xml
       <?xml version="1.0" encoding="utf-8" ?>
       <RunSettings>
         <DataCollectionRunSettings>
           <DataCollectors>
             <DataCollector friendlyName="XPlat Code Coverage">
               <Configuration>
                 <Format>cobertura</Format>
                 <Exclude>[*]*.Migrations.*,[*]*.Designer</Exclude>
                 <ExcludeByFile>**/Migrations/**/*.cs</ExcludeByFile>
                 <IncludeTestAssembly>false</IncludeTestAssembly>
               </Configuration>
             </DataCollector>
           </DataCollectors>
         </DataCollectionRunSettings>
       </RunSettings>
       ```
    6. Verify the project builds: `dotnet build src/MicroCommerce.ApiService.Tests/`

    IMPORTANT: The test project targets net10.0 to match the main project. Use `<IsPackable>false</IsPackable>` and `<IsTestProject>true</IsTestProject>` in the csproj.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService.Tests/` succeeds with no errors.
    The .csproj contains ProjectReference to MicroCommerce.ApiService and all 4 NuGet packages.
  </verify>
  <done>
    Test project builds successfully with xUnit, FluentAssertions, Testcontainers.PostgreSql, MassTransit.TestFramework, and Microsoft.AspNetCore.Mvc.Testing as dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive unit tests for Order aggregate and value objects</name>
  <files>
    src/MicroCommerce.ApiService.Tests/Unit/Ordering/Aggregates/OrderTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Ordering/ValueObjects/OrderNumberTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Ordering/ValueObjects/ShippingAddressTests.cs
  </files>
  <action>
    Create unit tests following the project naming convention `{Method}_{Scenario}_{Expected}`:

    **OrderTests.cs** - Test Order aggregate public API:
    - `Create_ValidData_ReturnsOrderWithSubmittedStatus` - Verify factory sets Status=Submitted, generates OrderNumber, calculates totals
    - `Create_ValidData_RaisesOrderSubmittedDomainEvent` - Check DomainEvents contains exactly one OrderSubmittedDomainEvent
    - `Create_ValidData_CalculatesSubtotalCorrectly` - Multiple items, verify sum of (quantity * price) per item
    - `Create_ValidData_CalculatesTaxAt8Percent` - Verify Tax = Round(Subtotal * 0.08, 2)
    - `Create_ValidData_CalculatesShippingAt599` - Verify ShippingCost = 5.99
    - `Create_ValidData_CalculatesTotalCorrectly` - Verify Total = Subtotal + Shipping + Tax
    - `Create_EmptyItems_ThrowsInvalidOperationException` - Empty items enumerable
    - `Create_NullEmail_ThrowsArgumentException` - Null/whitespace email
    - `Create_NullAddress_ThrowsArgumentNullException` - Null address
    - `MarkAsPaid_WhenSubmitted_TransitionsToPaid` - Valid transition
    - `MarkAsPaid_WhenStockReserved_TransitionsToPaid` - Valid transition
    - `MarkAsPaid_WhenSubmitted_SetsPaidAt` - PaidAt is not null
    - `MarkAsPaid_WhenSubmitted_RaisesOrderPaidDomainEvent` - Check event
    - `MarkAsPaid_WhenPaid_ThrowsInvalidOperationException` - Invalid: already Paid
    - `MarkAsPaid_WhenShipped_ThrowsInvalidOperationException` - Invalid: Shipped
    - `MarkAsFailed_WhenSubmitted_TransitionsToFailed` - Valid transition
    - `MarkAsFailed_WhenSubmitted_SetsFailureReason` - Check reason stored
    - `MarkAsFailed_WhenSubmitted_RaisesOrderFailedDomainEvent` - Check event
    - `MarkAsFailed_WhenConfirmed_ThrowsInvalidOperationException` - Guard: Confirmed
    - `MarkAsFailed_WhenShipped_ThrowsInvalidOperationException` - Guard: Shipped
    - `MarkAsFailed_WhenDelivered_ThrowsInvalidOperationException` - Guard: Delivered
    - `MarkAsFailed_NullReason_ThrowsArgumentException` - Null reason
    - `Confirm_WhenPaid_TransitionsToConfirmed` - Valid transition
    - `Confirm_WhenSubmitted_ThrowsInvalidOperationException` - Invalid: not Paid
    - `Ship_WhenConfirmed_TransitionsToShipped` - Valid transition
    - `Ship_WhenPaid_ThrowsInvalidOperationException` - Invalid: not Confirmed
    - `Deliver_WhenShipped_TransitionsToDelivered` - Valid transition
    - `Deliver_WhenConfirmed_ThrowsInvalidOperationException` - Invalid: not Shipped
    - `MarkStockReserved_WhenSubmitted_TransitionsToStockReserved` - Valid transition
    - `MarkStockReserved_WhenPaid_ThrowsInvalidOperationException` - Invalid: not Submitted

    Helper method: `CreateValidOrder()` that creates an order with test data (1 item, valid address, valid email).
    Helper method: `CreateOrderInStatus(OrderStatus target)` that walks the order to a specific status for transition testing.

    **OrderNumberTests.cs** - Test OrderNumber value object:
    - `Generate_ReturnsValueStartingWithMC` - Format MC-XXXXXX
    - `Generate_ReturnsValueWithCorrectLength` - Total length = 9 (MC- + 6 chars)
    - `Generate_TwoCallsReturnDifferentValues` - Uniqueness (probabilistic but practically always true)
    - `Generate_UsesOnlyUnambiguousCharacters` - No 0/O/1/I/L in the code portion
    - `From_ValidValue_ReturnsOrderNumber` - Roundtrip
    - `ToString_ReturnsValue` - String representation

    **ShippingAddressTests.cs** - Test ShippingAddress value object:
    - `Constructor_ValidData_CreatesAddress` - All fields set
    - `Constructor_NullName_ThrowsArgumentException`
    - `Constructor_EmptyEmail_ThrowsArgumentException`
    - `Constructor_WhitespaceStreet_ThrowsArgumentException`
    - `Constructor_NullCity_ThrowsArgumentException`
    - `Constructor_EmptyState_ThrowsArgumentException`
    - `Constructor_WhitespaceZipCode_ThrowsArgumentException`

    Use FluentAssertions throughout. Use `[Trait("Category", "Unit")]` on all test classes.
    Use file-scoped namespaces.
    Namespace: `MicroCommerce.ApiService.Tests.Unit.Ordering.Aggregates` / `.ValueObjects`.

    NOTE: Since Order has a private EF constructor and internal state transitions, you will need to use the factory method `Order.Create(...)` to create instances and then chain methods like `MarkAsPaid()`, `Confirm()`, etc. to reach intermediate states for testing further transitions.

    For OrderItem, it is created internally by Order.Create, so test it through Order's Items collection.
  </action>
  <verify>
    `dotnet test src/MicroCommerce.ApiService.Tests/ --filter "Category=Unit&FullyQualifiedName~Ordering" --verbosity normal` - All tests pass.
    At least 30 test methods across the 3 test files.
  </verify>
  <done>
    All Order aggregate unit tests pass covering: factory creation, all 7 status transitions (valid + invalid), calculation logic (subtotal, tax, shipping, total), domain events, and invariant enforcement. OrderNumber and ShippingAddress value objects tested for validation and formatting.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService.Tests/` compiles without errors or warnings
2. `dotnet test src/MicroCommerce.ApiService.Tests/ --filter "Category=Unit&FullyQualifiedName~Ordering"` - All tests pass (30+ tests)
3. Test project references MicroCommerce.ApiService and includes all required NuGet packages
4. coverlet.runsettings exists and excludes migrations
</verification>

<success_criteria>
- Test project created at src/MicroCommerce.ApiService.Tests/ with all dependencies
- 30+ unit tests for Order aggregate, OrderNumber, and ShippingAddress
- All tests pass with `dotnet test`
- Order status transition guard clauses verified for every valid and invalid combination
- Calculation logic verified (subtotal, 8% tax, $5.99 shipping, total)
- Domain events verified for Create, MarkAsPaid, MarkAsFailed
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-polish/10-01-SUMMARY.md`
</output>
