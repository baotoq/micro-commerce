---
phase: 10-testing-polish
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/MicroCommerce.ApiService.Tests/Unit/Catalog/Aggregates/ProductTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Catalog/ValueObjects/MoneyTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Catalog/ValueObjects/ProductNameTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Cart/Aggregates/CartTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Inventory/Aggregates/StockItemTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Validators/SubmitOrderCommandValidatorTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Validators/CreateProductCommandValidatorTests.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Validators/AdjustStockCommandValidatorTests.cs
autonomous: true

must_haves:
  truths:
    - "Product aggregate Create factory sets Draft status and raises ProductCreatedDomainEvent"
    - "Product status transitions work correctly (Publish, Unpublish, Archive)"
    - "Money value object rejects negative amounts and normalizes currency to uppercase"
    - "ProductName value object enforces 2-200 character length constraint"
    - "Cart aggregate AddItem adds new items and increments existing items, capped at 99"
    - "Cart aggregate UpdateItemQuantity validates range 1-99 and throws for missing items"
    - "StockItem aggregate AdjustStock rejects negative-result quantities and raises events"
    - "StockItem Reserve validates available quantity and creates time-limited reservation"
    - "SubmitOrderCommandValidator rejects empty email, missing address fields, and invalid items"
    - "CreateProductCommandValidator rejects empty name, too-long description, negative price"
    - "AdjustStockCommandValidator rejects empty ProductId and zero adjustment"
  artifacts:
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Catalog/Aggregates/ProductTests.cs"
      provides: "Unit tests for Product aggregate lifecycle"
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Catalog/ValueObjects/MoneyTests.cs"
      provides: "Unit tests for Money value object"
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Cart/Aggregates/CartTests.cs"
      provides: "Unit tests for Cart aggregate"
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Inventory/Aggregates/StockItemTests.cs"
      provides: "Unit tests for StockItem aggregate"
    - path: "src/MicroCommerce.ApiService.Tests/Unit/Validators/SubmitOrderCommandValidatorTests.cs"
      provides: "Validator tests for SubmitOrderCommand"
  key_links:
    - from: "Test files"
      to: "Domain entities"
      via: "Direct instantiation via factory methods"
      pattern: "Product\\.Create|Cart\\.Create|StockItem\\.Create"
---

<objective>
Write unit tests for Catalog, Cart, and Inventory domain aggregates plus FluentValidation validator tests for the three most important validators. This completes the domain unit test coverage across all modules.

Purpose: Ensures all four domain modules have test coverage for their aggregate invariants. Validators get dedicated test classes as specified in CONTEXT.md to verify input validation rules independently.
Output: 8 test files covering Product, Money, ProductName, Cart, StockItem aggregates and 3 validator test classes.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/Money.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductName.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductStatus.cs
@src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/Cart.cs
@src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs
@src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockItem.cs
@src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs
@src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandValidator.cs
@src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/CreateProduct/CreateProductCommandValidator.cs
@src/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommandValidator.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write unit tests for Catalog and Cart aggregates and value objects</name>
  <files>
    src/MicroCommerce.ApiService.Tests/Unit/Catalog/Aggregates/ProductTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Catalog/ValueObjects/MoneyTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Catalog/ValueObjects/ProductNameTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Cart/Aggregates/CartTests.cs
  </files>
  <action>
    **ProductTests.cs** - Test Product aggregate public API:
    - `Create_ValidData_ReturnsProductWithDraftStatus` - Factory creates in Draft
    - `Create_ValidData_RaisesProductCreatedDomainEvent` - Event in DomainEvents
    - `Create_ValidData_SetsAllProperties` - Name, Description, Price, CategoryId, CreatedAt
    - `Update_ValidData_UpdatesProperties` - All fields change
    - `Update_ValidData_RaisesProductUpdatedDomainEvent` - Event raised
    - `Update_ValidData_SetsUpdatedAt` - UpdatedAt populated
    - `Publish_WhenDraft_ChangesToPublished` - Status transition
    - `Publish_WhenAlreadyPublished_NoOp` - Idempotent
    - `Publish_SetsUpdatedAt` - Timestamp update
    - `Unpublish_WhenPublished_ChangesToDraft` - Status transition
    - `Unpublish_WhenDraft_NoOp` - Idempotent
    - `Archive_WhenPublished_ChangesToArchived` - Status transition
    - `Archive_WhenDraft_ChangesToArchived` - Also works from Draft
    - `Archive_WhenArchived_NoOp` - Idempotent
    - `Archive_RaisesProductArchivedDomainEvent` - Event raised

    **MoneyTests.cs** - Test Money value object:
    - `Create_ValidAmount_ReturnsMoney` - Standard case
    - `Create_ZeroAmount_ReturnsMoney` - Zero is valid
    - `Create_NegativeAmount_ThrowsException` - Guard: negative
    - `Create_NullCurrency_ThrowsException` - Guard: null currency
    - `Create_LowercaseCurrency_NormalizesToUppercase` - "usd" -> "USD"
    - `Equality_SameAmountAndCurrency_AreEqual` - Value equality
    - `Equality_DifferentAmount_AreNotEqual` - Inequality
    - `ToString_ReturnsFormattedString` - "USD 99.99" format
    - `Format_ReturnsCurrencyFormat` - "$99.99" format

    **ProductNameTests.cs** - Test ProductName value object:
    - `Create_ValidName_ReturnsProductName` - Standard case
    - `Create_TrimsWhitespace` - " name " -> "name"
    - `Create_MinLength_Succeeds` - 2-char name
    - `Create_MaxLength_Succeeds` - 200-char name
    - `Create_TooShort_ThrowsException` - 1-char name
    - `Create_TooLong_ThrowsException` - 201-char name
    - `Create_NullOrWhitespace_ThrowsException` - Null/empty
    - `ImplicitConversion_ReturnsStringValue` - Implicit string cast

    **CartTests.cs** - Test Cart aggregate public API:
    - `Create_ValidBuyerId_ReturnsCartWithEmptyItems` - Factory
    - `Create_SetsExpiresAt30DaysFromNow` - TTL verified
    - `AddItem_NewProduct_AddsToItems` - New item
    - `AddItem_ExistingProduct_IncrementsQuantity` - Same product adds quantity
    - `AddItem_QuantityExceeds99_CappedAt99` - Max quantity enforcement for new items
    - `AddItem_ZeroQuantity_ThrowsArgumentOutOfRangeException` - Guard: min 1
    - `AddItem_UpdatesLastModifiedAt` - Touch() called
    - `AddItem_ResetsExpiresAt` - TTL reset
    - `UpdateItemQuantity_ValidQuantity_UpdatesItem` - Standard update
    - `UpdateItemQuantity_Exceeds99_ThrowsArgumentOutOfRangeException` - Guard: max 99
    - `UpdateItemQuantity_Zero_ThrowsArgumentOutOfRangeException` - Guard: min 1
    - `UpdateItemQuantity_InvalidItemId_ThrowsInvalidOperationException` - Missing item
    - `RemoveItem_ExistingItem_RemovesFromCollection` - Removal
    - `RemoveItem_NonExistentItem_NoOp` - Idempotent

    Use FluentAssertions, `[Trait("Category", "Unit")]`, file-scoped namespaces.
  </action>
  <verify>
    `dotnet test src/MicroCommerce.ApiService.Tests/ --filter "Category=Unit&FullyQualifiedName~Catalog" --verbosity normal` - All Catalog tests pass.
    `dotnet test src/MicroCommerce.ApiService.Tests/ --filter "Category=Unit&FullyQualifiedName~Cart" --verbosity normal` - All Cart tests pass.
  </verify>
  <done>
    Product aggregate tests cover lifecycle (create, update, publish, unpublish, archive) with event verification. Money and ProductName value objects validated for constraints. Cart aggregate tests cover all item operations with invariant enforcement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for StockItem aggregate and FluentValidation validators</name>
  <files>
    src/MicroCommerce.ApiService.Tests/Unit/Inventory/Aggregates/StockItemTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Validators/SubmitOrderCommandValidatorTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Validators/CreateProductCommandValidatorTests.cs
    src/MicroCommerce.ApiService.Tests/Unit/Validators/AdjustStockCommandValidatorTests.cs
  </files>
  <action>
    **StockItemTests.cs** - Test StockItem aggregate:
    - `Create_ValidProductId_ReturnsStockItemWithZeroQuantity` - Factory
    - `AdjustStock_PositiveAdjustment_IncreasesQuantity` - Restock
    - `AdjustStock_NegativeAdjustment_DecreasesQuantity` - Removal
    - `AdjustStock_WouldGoNegative_ThrowsInvalidOperationException` - Guard
    - `AdjustStock_RaisesStockAdjustedDomainEvent` - Event raised
    - `AdjustStock_ResultBelow10_RaisesStockLowDomainEvent` - Low stock alert
    - `AdjustStock_ResultAbove10_DoesNotRaiseStockLowEvent` - No alert above threshold
    - `Reserve_SufficientStock_ReturnsReservationId` - Happy path
    - `Reserve_InsufficientStock_ThrowsInvalidOperationException` - Guard
    - `Reserve_ZeroQuantity_ThrowsArgumentException` - Guard: positive only
    - `Reserve_NegativeQuantity_ThrowsArgumentException` - Guard: positive only
    - `Reserve_AccountsForExistingReservations` - AvailableQuantity calculation
    - `ReleaseReservation_ExistingReservation_RemovesFromCollection` - Release
    - `ReleaseReservation_NonExistent_NoOp` - Idempotent (no throw)
    - `AvailableQuantity_NoReservations_EqualsQuantityOnHand` - Calculation
    - `AvailableQuantity_WithReservations_SubtractsReservedQuantity` - Calculation

    **SubmitOrderCommandValidatorTests.cs** - Use FluentValidation `TestValidate`:
    - `Validate_ValidCommand_ShouldNotHaveErrors` - Happy path
    - `Validate_EmptyEmail_ShouldHaveErrorForEmail` - Required
    - `Validate_InvalidEmail_ShouldHaveErrorForEmail` - Format
    - `Validate_NullShippingAddress_ShouldHaveError` - Required
    - `Validate_EmptyShippingName_ShouldHaveError` - Nested validation
    - `Validate_EmptyShippingStreet_ShouldHaveError`
    - `Validate_EmptyShippingCity_ShouldHaveError`
    - `Validate_EmptyShippingState_ShouldHaveError`
    - `Validate_EmptyShippingZipCode_ShouldHaveError`
    - `Validate_ZipCodeTooLong_ShouldHaveError` - Max 10 chars
    - `Validate_EmptyItems_ShouldHaveError` - At least one item
    - `Validate_ItemWithZeroQuantity_ShouldHaveError` - 1-99 range
    - `Validate_ItemWithNegativePrice_ShouldHaveError` - > 0
    - `Validate_ItemWithEmptyProductId_ShouldHaveError`

    **CreateProductCommandValidatorTests.cs** - Use FluentValidation `TestValidate`:
    - `Validate_ValidCommand_ShouldNotHaveErrors`
    - `Validate_EmptyName_ShouldHaveError`
    - `Validate_NameTooShort_ShouldHaveError` - Min 2
    - `Validate_NameTooLong_ShouldHaveError` - Max 200
    - `Validate_EmptyDescription_ShouldHaveError`
    - `Validate_NegativePrice_ShouldHaveError`
    - `Validate_EmptyCategoryId_ShouldHaveError`
    - `Validate_InvalidImageUrl_ShouldHaveError`
    - `Validate_ValidImageUrl_ShouldNotHaveError`
    - `Validate_NullImageUrl_ShouldNotHaveError` - Optional field

    **AdjustStockCommandValidatorTests.cs** - Use FluentValidation `TestValidate`:
    - `Validate_ValidCommand_ShouldNotHaveErrors`
    - `Validate_EmptyProductId_ShouldHaveError`
    - `Validate_ZeroAdjustment_ShouldHaveError`
    - `Validate_PositiveAdjustment_ShouldNotHaveError`
    - `Validate_NegativeAdjustment_ShouldNotHaveError` - Negative is valid (reduction)

    Use `[Trait("Category", "Unit")]` on all test classes. Instantiate validators directly (no DI needed). Use TestValidate for clear assertion syntax.
  </action>
  <verify>
    `dotnet test src/MicroCommerce.ApiService.Tests/ --filter "Category=Unit&FullyQualifiedName~Inventory" --verbosity normal` - All Inventory tests pass.
    `dotnet test src/MicroCommerce.ApiService.Tests/ --filter "Category=Unit&FullyQualifiedName~Validators" --verbosity normal` - All Validator tests pass.
  </verify>
  <done>
    StockItem aggregate tested for stock adjustment, reservation, release, and available quantity calculation. Three FluentValidation validators have dedicated test classes verifying all rules with TestValidate helper.
  </done>
</task>

</tasks>

<verification>
1. `dotnet test src/MicroCommerce.ApiService.Tests/ --filter "Category=Unit"` - All unit tests pass
2. At least 70 unit tests across all 8 test files
3. No test uses database or external services (pure unit tests)
4. FluentAssertions used consistently
5. Validators tested via TestValidate with ShouldHaveValidationErrorFor / ShouldNotHaveAnyValidationErrors
</verification>

<success_criteria>
- Product, Cart, StockItem aggregates have comprehensive unit tests for all public methods
- Money and ProductName value objects tested for validation, equality, and formatting
- SubmitOrderCommandValidator, CreateProductCommandValidator, AdjustStockCommandValidator each have 5+ tests
- All tests pass when run together
- Test classes use [Trait("Category", "Unit")] for filtering
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-polish/10-02-SUMMARY.md`
</output>
