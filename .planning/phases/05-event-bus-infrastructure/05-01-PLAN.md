---
phase: 05-event-bus-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - code/MicroCommerce.ApiService/Program.cs
  - code/MicroCommerce.ApiService/Common/Messaging/Exceptions/PermanentException.cs
  - code/MicroCommerce.ServiceDefaults/Extensions.cs
  - code/MicroCommerce.ApiService/Features/Inventory/Application/Consumers/ProductCreatedConsumer.cs
autonomous: true

must_haves:
  truths:
    - "Duplicate messages are deduplicated by MassTransit inbox (not manual AnyAsync)"
    - "Failed messages retry 3 times with exponential backoff before faulting"
    - "Circuit breaker stops consuming after sustained failure rate"
    - "Permanent exceptions skip retries and go straight to error/DLQ"
    - "MassTransit publish/consume spans appear in Aspire distributed traces"
    - "Consumer log entries include CorrelationId and MessageId"
  artifacts:
    - path: "code/MicroCommerce.ApiService/Program.cs"
      provides: "Global MassTransit middleware configuration"
      contains: "UseCircuitBreaker|UseMessageRetry|UseEntityFrameworkOutbox|DuplicateDetectionWindow|AddConfigureEndpointsCallback"
    - path: "code/MicroCommerce.ApiService/Common/Messaging/Exceptions/PermanentException.cs"
      provides: "Marker exception for non-retryable errors"
      exports: ["PermanentException"]
    - path: "code/MicroCommerce.ServiceDefaults/Extensions.cs"
      provides: "MassTransit ActivitySource for OpenTelemetry tracing"
      contains: "DiagnosticHeaders.DefaultListenerName"
    - path: "code/MicroCommerce.ApiService/Features/Inventory/Application/Consumers/ProductCreatedConsumer.cs"
      provides: "Retrofitted consumer with structured correlation logging"
      contains: "CorrelationId|BeginScope"
  key_links:
    - from: "Program.cs AddConfigureEndpointsCallback"
      to: "All consumer endpoints"
      via: "MassTransit middleware pipeline"
      pattern: "AddConfigureEndpointsCallback"
    - from: "Extensions.cs tracing config"
      to: "Aspire dashboard traces"
      via: "OpenTelemetry ActivitySource"
      pattern: "DiagnosticHeaders\\.DefaultListenerName"
    - from: "UseMessageRetry r.Ignore"
      to: "PermanentException"
      via: "Exception filter"
      pattern: "Ignore<PermanentException>"
---

<objective>
Configure MassTransit global consumer middleware with inbox-based idempotency, exponential retry, circuit breaker, and DLQ routing. Add MassTransit OpenTelemetry tracing to Aspire. Retrofit existing ProductCreatedConsumer with structured correlation logging.

Purpose: Make the existing messaging infrastructure production-ready with resilience patterns applied globally to all consumers.
Output: Updated Program.cs with full middleware pipeline, PermanentException marker class, OpenTelemetry tracing integration, and retrofitted consumer.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-event-bus-infrastructure/05-RESEARCH.md
@.planning/phases/05-event-bus-infrastructure/05-CONTEXT.md
@code/MicroCommerce.ApiService/Program.cs
@code/MicroCommerce.ApiService/Common/Persistence/OutboxDbContext.cs
@code/MicroCommerce.ServiceDefaults/Extensions.cs
@code/MicroCommerce.ApiService/Features/Inventory/Application/Consumers/ProductCreatedConsumer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Global MassTransit middleware and PermanentException</name>
  <files>
    code/MicroCommerce.ApiService/Program.cs
    code/MicroCommerce.ApiService/Common/Messaging/Exceptions/PermanentException.cs
  </files>
  <action>
1. Create `Common/Messaging/Exceptions/PermanentException.cs`:
   - Base exception class for non-retryable errors
   - Two constructors: `(string message)` and `(string message, Exception inner)`
   - Namespace: `MicroCommerce.ApiService.Common.Messaging.Exceptions`

2. Update MassTransit configuration in `Program.cs`. Modify the existing `AddMassTransit` block:

   a. Add `DuplicateDetectionWindow = TimeSpan.FromMinutes(5)` to the existing `AddEntityFrameworkOutbox<OutboxDbContext>` call.

   b. Add `AddConfigureEndpointsCallback` with middleware in this EXACT order (outermost to innermost):
      - `UseCircuitBreaker`: TrackingPeriod=1min, TripThreshold=15, ActiveThreshold=10, ResetInterval=5min
      - `UseMessageRetry`: `r.Intervals(TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(25))` with `r.Ignore<PermanentException>()`
      - `UseEntityFrameworkOutbox<OutboxDbContext>(context)` for inbox deduplication on consumer side

   c. Inside `UsingAzureServiceBus`, add DLQ routing via `AddConfigureEndpointsCallback` or inside the endpoint configuration. Cast to `IServiceBusReceiveEndpointConfigurator` and call `ConfigureDeadLetterQueueErrorTransport()`. Use the callback approach:
      ```
      x.AddConfigureEndpointsCallback((context, name, cfg) =>
      {
          if (cfg is IServiceBusReceiveEndpointConfigurator sb)
          {
              sb.ConfigureDeadLetterQueueErrorTransport();
          }
          // ... circuit breaker, retry, outbox
      });
      ```

   IMPORTANT: The DLQ transport configuration and the middleware (circuit breaker, retry, outbox) should all be in the SAME `AddConfigureEndpointsCallback`. The DLQ config check should come FIRST since it's transport-specific.

   d. Add required using: `using MicroCommerce.ApiService.Common.Messaging.Exceptions;`

   NOTE on middleware ordering: In `AddConfigureEndpointsCallback`, filters added first are outermost. So the order of calls should be: circuit breaker, then retry, then outbox. This means circuit breaker wraps retry which wraps outbox which wraps the consumer.
  </action>
  <verify>
    `dotnet build code/` succeeds with no errors.
  </verify>
  <done>
    Program.cs has global middleware pipeline (circuit breaker -> retry -> inbox outbox) applied to all consumer endpoints. PermanentException class exists. DuplicateDetectionWindow is set to 5 minutes. DLQ routing configured for Azure Service Bus endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 2: OpenTelemetry tracing and consumer retrofit</name>
  <files>
    code/MicroCommerce.ServiceDefaults/Extensions.cs
    code/MicroCommerce.ApiService/Features/Inventory/Application/Consumers/ProductCreatedConsumer.cs
  </files>
  <action>
1. In `Extensions.cs`, add MassTransit's ActivitySource to the `.WithTracing()` configuration:
   - Add `.AddSource(MassTransit.Logging.DiagnosticHeaders.DefaultListenerName)` after the existing `.AddSource(builder.Environment.ApplicationName)` line
   - Add required using: `using MassTransit.Logging;` (or use the fully qualified name inline)
   - This ensures MassTransit publish/consume operations appear as spans in the Aspire distributed traces dashboard

2. Retrofit `ProductCreatedConsumer.cs` with structured correlation logging:
   - Add `using var scope = _logger.BeginScope(...)` at the start of the Consume method with a Dictionary containing:
     - `"CorrelationId"` = `context.CorrelationId?.ToString() ?? "none"`
     - `"MessageId"` = `context.MessageId?.ToString() ?? "none"`
     - `"ConversationId"` = `context.ConversationId?.ToString() ?? "none"`
   - Keep the existing manual idempotency check (AnyAsync). It is redundant with inbox deduplication but harmless as a defense-in-depth measure. Add a comment noting it's supplementary to inbox deduplication.
   - Update existing log messages to use the scope (they already use structured logging, so the scope properties will be auto-included).
  </action>
  <verify>
    `dotnet build code/` succeeds with no errors.
  </verify>
  <done>
    MassTransit ActivitySource is registered in OpenTelemetry tracing config. ProductCreatedConsumer logs include CorrelationId, MessageId, ConversationId via logging scope on every log entry.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build code/` compiles without errors
2. Grep for `UseCircuitBreaker` in Program.cs confirms circuit breaker is configured
3. Grep for `UseMessageRetry` in Program.cs confirms retry is configured
4. Grep for `UseEntityFrameworkOutbox` in Program.cs confirms inbox deduplication
5. Grep for `DuplicateDetectionWindow` in Program.cs confirms detection window
6. Grep for `DiagnosticHeaders.DefaultListenerName` in Extensions.cs confirms tracing
7. Grep for `CorrelationId` in ProductCreatedConsumer.cs confirms structured logging
8. Grep for `PermanentException` in both the exception class and Program.cs
</verification>

<success_criteria>
- Solution builds cleanly
- MassTransit middleware pipeline configured globally: circuit breaker (outermost) -> retry -> inbox outbox (innermost)
- PermanentException excluded from retries
- DuplicateDetectionWindow set to 5 minutes
- Azure Service Bus DLQ routing configured
- MassTransit spans visible in OpenTelemetry config
- ProductCreatedConsumer has structured correlation logging
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-bus-infrastructure/05-01-SUMMARY.md`
</output>
