---
phase: 05-event-bus-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - code/MicroCommerce.Web/src/app/admin/dead-letters/page.tsx
  - code/MicroCommerce.Web/src/lib/api.ts
  - code/MicroCommerce.Web/src/app/admin/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to dead-letter queue page from admin nav"
    - "Admin sees a table of dead-lettered messages with type, error, correlation ID, timestamp"
    - "Admin can filter messages by queue name"
    - "Admin can retry a single dead-lettered message"
    - "Admin can purge all dead-lettered messages from a queue"
    - "Page auto-refreshes every 30 seconds"
  artifacts:
    - path: "code/MicroCommerce.Web/src/app/admin/dead-letters/page.tsx"
      provides: "Admin DLQ management page"
      min_lines: 100
    - path: "code/MicroCommerce.Web/src/lib/api.ts"
      provides: "API client functions for DLQ endpoints"
      contains: "deadLetter|dead-letters"
    - path: "code/MicroCommerce.Web/src/app/admin/layout.tsx"
      provides: "Admin nav with dead-letters link"
      contains: "dead-letters"
  key_links:
    - from: "dead-letters/page.tsx"
      to: "/api/messaging/dead-letters"
      via: "fetch in api.ts functions"
      pattern: "dead-letters"
    - from: "admin/layout.tsx nav"
      to: "dead-letters/page.tsx"
      via: "Next.js Link"
      pattern: "dead-letters"
---

<objective>
Build the admin DLQ management page with table view, queue filter, retry/purge actions, and auto-refresh. Follow existing admin page patterns (Categories page structure).

Purpose: Give admins visibility into failed messages and tools to retry or purge them.
Output: Dead-letter queue admin page accessible at /admin/dead-letters.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-event-bus-infrastructure/05-CONTEXT.md
@.planning/phases/05-event-bus-infrastructure/05-02-SUMMARY.md
@code/MicroCommerce.Web/src/app/admin/layout.tsx
@code/MicroCommerce.Web/src/app/admin/categories/page.tsx
@code/MicroCommerce.Web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: API client functions for DLQ</name>
  <files>
    code/MicroCommerce.Web/src/lib/api.ts
  </files>
  <action>
Add DLQ API client functions to the existing api.ts file:

1. Add TypeScript types:
   ```typescript
   export interface DeadLetterMessageDto {
     sequenceNumber: number;
     messageType: string;
     errorDescription: string;
     correlationId: string | null;
     enqueuedTime: string;
     queueName: string;
   }

   export interface DeadLetterMessagesResponse {
     messages: DeadLetterMessageDto[];
     queueNames: string[];
   }
   ```

2. Add API functions following existing patterns in the file:
   - `getDeadLetterMessages(queueName?: string, maxMessages?: number): Promise<DeadLetterMessagesResponse>` -- GET /api/messaging/dead-letters with optional query params
   - `retryDeadLetterMessage(queueName: string, sequenceNumber: number): Promise<void>` -- POST /api/messaging/dead-letters/retry
   - `purgeDeadLetterMessages(queueName: string): Promise<number>` -- POST /api/messaging/dead-letters/purge

Use the same fetch pattern and base URL as existing API functions in the file.
  </action>
  <verify>
    No TypeScript errors in the file (check with existing build command or tsc if available).
  </verify>
  <done>
    Three API functions and TypeScript types for DLQ operations added to api.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin DLQ page and nav link</name>
  <files>
    code/MicroCommerce.Web/src/app/admin/dead-letters/page.tsx
    code/MicroCommerce.Web/src/app/admin/layout.tsx
  </files>
  <action>
1. Create `dead-letters/page.tsx` following the Categories page pattern:
   - `'use client'` directive
   - State: `messages` (DeadLetterMessageDto[]), `queueNames` (string[]), `loading` (boolean), `selectedQueue` (string | null)
   - Fetch messages on mount and when selectedQueue changes
   - Auto-refresh every 30 seconds using `setInterval` in a `useEffect` (clear on unmount)
   - Layout structure (matching existing admin pages):

   Header section:
   - Title: "Dead Letter Queue"
   - Subtitle: "Messages that failed processing after retries"
   - Right side: Queue filter dropdown (select from queueNames, option for "All Queues") and "Purge All" button (for selected queue, disabled when no queue selected or showing all)

   Table (use shadcn/ui Table components matching Categories page):
   - Columns: Message Type, Error Details (truncated to ~100 chars with title tooltip for full text), Correlation ID (monospace font), Enqueued Time (formatted date), Queue Name, Actions
   - Actions column: "Retry" button per row (use Button variant="outline" size="sm")
   - On Retry click: call `retryDeadLetterMessage`, show toast on success ("Message re-queued for processing"), refresh the list
   - On Purge click: confirm with window.confirm, call `purgeDeadLetterMessages`, show toast with count ("Purged N messages"), refresh the list

   Empty state (when no messages):
   - Icon: use `AlertTriangle` or `Inbox` from lucide-react
   - Message: "No dead-lettered messages"
   - Subtitle: "All messages are being processed successfully"

   Loading state: Skeleton rows matching Categories page pattern

   Error handling: try/catch on all API calls, console.error + toast on failure

2. Update `layout.tsx`:
   - Add a nav link for "Dead Letters" in the `<nav>` section, after Categories
   - Use `AlertTriangle` icon from lucide-react (or `MailWarning` if available)
   - Link to `/admin/dead-letters`
   - Follow the exact same Link pattern as existing nav items (className, icon sizing, etc.)
  </action>
  <verify>
    Page renders without errors when navigating to /admin/dead-letters (verify via `npm run build` in the Web project if possible, or check for TypeScript/JSX errors).
  </verify>
  <done>
    Admin DLQ page exists at /admin/dead-letters with table, queue filter, retry/purge actions, 30-second auto-refresh, and nav link in admin layout. UI matches existing admin page patterns.
  </done>
</task>

</tasks>

<verification>
1. Frontend builds without errors
2. Admin layout has "Dead Letters" nav link
3. Dead letters page has table with required columns
4. Retry and purge actions call correct API endpoints
5. Auto-refresh interval is set to 30 seconds
6. Queue filter dropdown populated from API response
</verification>

<success_criteria>
- Admin can navigate to /admin/dead-letters from the nav bar
- Page shows dead-lettered messages in a table with type, error, correlation ID, timestamp, queue name
- Queue filter dropdown works to narrow results
- Retry button re-queues individual messages
- Purge button clears all messages from selected queue
- Page auto-refreshes every 30 seconds
- Empty state shown when no dead-lettered messages exist
- UI style matches existing admin pages (Categories pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/05-event-bus-infrastructure/05-03-SUMMARY.md`
</output>
