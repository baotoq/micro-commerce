---
phase: 13-wishlists-saved-items
plan: 03
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - src/MicroCommerce.Web/src/lib/api.ts
  - src/MicroCommerce.Web/src/hooks/use-wishlist.ts
  - src/MicroCommerce.Web/src/components/wishlist/wishlist-toggle-button.tsx
  - src/MicroCommerce.Web/src/components/wishlist/wishlist-item-card.tsx
  - src/MicroCommerce.Web/src/components/wishlist/wishlist-grid.tsx
  - src/MicroCommerce.Web/src/components/wishlist/wishlist-empty-state.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/wishlist/page.tsx
  - src/MicroCommerce.Web/src/components/storefront/header.tsx
  - src/MicroCommerce.Web/src/components/storefront/product-card.tsx
  - src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
  - src/MicroCommerce.Web/src/components/account/account-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle heart icon on product cards and detail page to add/remove from wishlist"
    - "Heart icon is outlined when not in wishlist, filled red when in wishlist"
    - "Clicking heart as guest redirects to login"
    - "Header shows heart icon with count badge next to cart icon"
    - "Wishlist page shows product grid with add-to-cart buttons and out-of-stock handling"
    - "Empty wishlist shows 'Your wishlist is empty' with Browse products CTA"
    - "Wishlist is accessible from header heart icon and account sidebar"
    - "Out-of-stock items are dimmed with disabled add-to-cart button"
    - "Adding to cart from wishlist shows toast notification"
  artifacts:
    - path: "src/MicroCommerce.Web/src/hooks/use-wishlist.ts"
      provides: "TanStack Query hooks with optimistic UI for wishlist operations"
      contains: "useToggleWishlist"
    - path: "src/MicroCommerce.Web/src/components/wishlist/wishlist-toggle-button.tsx"
      provides: "Heart icon toggle button with optimistic updates"
      contains: "WishlistToggleButton"
    - path: "src/MicroCommerce.Web/src/app/(storefront)/wishlist/page.tsx"
      provides: "Wishlist page route"
      contains: "wishlist"
    - path: "src/MicroCommerce.Web/src/components/wishlist/wishlist-grid.tsx"
      provides: "Grid of wishlist item cards"
      contains: "WishlistGrid"
  key_links:
    - from: "src/MicroCommerce.Web/src/hooks/use-wishlist.ts"
      to: "/api/wishlist"
      via: "API functions from api.ts"
      pattern: "wishlist"
    - from: "src/MicroCommerce.Web/src/components/storefront/product-card.tsx"
      to: "src/MicroCommerce.Web/src/components/wishlist/wishlist-toggle-button.tsx"
      via: "Heart icon overlay on product image"
      pattern: "WishlistToggleButton"
    - from: "src/MicroCommerce.Web/src/components/storefront/header.tsx"
      to: "/wishlist"
      via: "Heart icon link with count badge"
      pattern: "wishlistCount"
---

<objective>
Build frontend wishlist components, hooks, API layer, and integrate into product cards, product detail, header, and account sidebar.

Purpose: Delivers the complete user-facing wishlist experience — heart icon toggle on products, wishlist page with add-to-cart, header count badge, and account sidebar link. Implements optimistic UI for instant heart icon feedback.
Output: Wishlist API functions, TanStack Query hooks, 4 wishlist components, wishlist page route, and integration into header, product cards, product detail, and account sidebar.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-wishlists-saved-items/13-RESEARCH.md
@.planning/phases/13-wishlists-saved-items/13-02-SUMMARY.md

# Reference patterns from existing frontend
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/hooks/use-cart.ts
@src/MicroCommerce.Web/src/hooks/use-reviews.ts
@src/MicroCommerce.Web/src/components/storefront/header.tsx
@src/MicroCommerce.Web/src/components/storefront/product-card.tsx
@src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
@src/MicroCommerce.Web/src/components/account/account-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wishlist API functions, hooks, and components</name>
  <files>
    src/MicroCommerce.Web/src/lib/api.ts
    src/MicroCommerce.Web/src/hooks/use-wishlist.ts
    src/MicroCommerce.Web/src/components/wishlist/wishlist-toggle-button.tsx
    src/MicroCommerce.Web/src/components/wishlist/wishlist-item-card.tsx
    src/MicroCommerce.Web/src/components/wishlist/wishlist-grid.tsx
    src/MicroCommerce.Web/src/components/wishlist/wishlist-empty-state.tsx
    src/MicroCommerce.Web/src/app/(storefront)/wishlist/page.tsx
  </files>
  <action>
**api.ts — Add wishlist types and API functions:**

Types to add:
```typescript
export interface WishlistItemDto {
  id: string;
  productId: string;
  productName: string;
  price: number;
  currency: string;
  imageUrl: string | null;
  averageRating: number | null;
  reviewCount: number;
  availableQuantity: number;
  addedAt: string;
}
```

API functions to add (follow existing authenticated fetch patterns):
- `getUserWishlist(token: string): Promise<WishlistItemDto[]>` — GET /api/wishlist with Authorization header
- `getWishlistCount(token: string): Promise<number>` — GET /api/wishlist/count
- `getWishlistProductIds(token: string): Promise<string[]>` — GET /api/wishlist/product-ids
- `addToWishlist(token: string, productId: string): Promise<{ id: string }>` — POST /api/wishlist/{productId}
- `removeFromWishlist(token: string, productId: string): Promise<void>` — DELETE /api/wishlist/{productId}

All authenticated endpoints must pass `Authorization: Bearer ${token}` header. Follow the same fetch pattern used by review and profile API functions in api.ts.

**use-wishlist.ts — TanStack Query hooks:**
- `useWishlistProductIds()` — Query that returns Set<string> of wishlisted product IDs. Enabled only when session exists. Query key: `["wishlist", "product-ids"]`. Fetches via `getWishlistProductIds(session.accessToken)`.
- `useWishlistCount()` — Query returning count. Enabled only when session exists. Query key: `["wishlist", "count"]`.
- `useUserWishlist()` — Query returning `WishlistItemDto[]`. Enabled only when session exists. Query key: `["wishlist"]`.
- `useToggleWishlist(productId: string)` — Returns `{ toggle, isInWishlist, isPending }`:
  - Uses `useWishlistProductIds()` to check if productId is in the Set
  - `addMutation` with optimistic update: in `onMutate`, cancel queries, snapshot previous product-ids, optimistically add productId to the cached Set, return snapshot for rollback. `onError` restores snapshot. `onSettled` invalidates `["wishlist"]` queries (product-ids, count, list).
  - `removeMutation` with same optimistic pattern: optimistically remove productId from cached Set
  - `toggle()` function: if isInWishlist, call removeMutation.mutate(), else addMutation.mutate()
  - `isPending`: addMutation.isPending || removeMutation.isPending
- Follow use-cart.ts pattern for session access and mutation structure

**wishlist-toggle-button.tsx:**
- "use client" component
- Props: `{ productId: string; className?: string }`
- Uses `useSession()` from next-auth/react and `useRouter()` from next/navigation
- Uses `useToggleWishlist(productId)` hook
- `handleClick(e: React.MouseEvent)`:
  - `e.preventDefault()` and `e.stopPropagation()` (prevent navigation on product cards)
  - If no session: `signIn("keycloak")` — redirect to login per locked decision
  - Otherwise: call `toggle()`
- Render: `<button>` with `aria-label` ("Remove from wishlist" or "Add to wishlist")
- Heart icon from lucide-react: `<Heart className={isInWishlist ? "fill-red-500 text-red-500" : "text-zinc-400 hover:text-red-500"} />`
- Size: `size-5` for the Heart icon
- Disabled while `isPending`
- Outlined heart → filled red heart per locked decision. No animation per locked decision.

**wishlist-item-card.tsx:**
- "use client" component
- Props: `{ item: WishlistItemDto }`
- Uses `useAddToCart()` hook from use-cart.ts (or import the mutation directly)
- Determine `isOutOfStock = item.availableQuantity === 0`
- Layout: Card with product image (aspect-square), product name, price, rating, and Add to Cart button
- Heart icon at top-right of image via WishlistToggleButton (clicking filled heart removes from wishlist — consistent toggle pattern per locked decision)
- Out-of-stock handling per locked decisions:
  - Dimmed/grayed out: `opacity-60` on wrapper, `grayscale` on image
  - "Out of Stock" Badge (use shadcn Badge variant="destructive" with text "Out of Stock") positioned over image
  - "Add to Cart" button text changes to "Out of Stock" and is disabled
- In-stock: "Add to Cart" button at bottom, calls `addToCart.mutate({ productId: item.productId, quantity: 1 })` — always adds quantity 1 per locked decision
- Toast notification after adding to cart: use existing sonner toast pattern `toast.success("Added to cart")` per locked decision
- Product name links to `/products/${item.productId}`
- Format price with `Intl.NumberFormat` (same as product-card.tsx pattern)
- Show StarRatingDisplay if reviewCount > 0

**wishlist-grid.tsx:**
- "use client" component
- Props: `{ items: WishlistItemDto[] }`
- Renders grid: `grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4` — same responsive grid as product grid
- Maps items to WishlistItemCard components
- Loading skeleton variant: `WishlistGridSkeleton` showing 4 skeleton cards

**wishlist-empty-state.tsx:**
- Simple component (can be server or client)
- Shows centered message: "Your wishlist is empty" as heading
- Subtitle: "Save items you love to find them later"
- "Browse Products" Button (shadcn Button) linking to "/" (home/catalog)
- Heart icon (lucide-react) above the heading for visual context

**wishlist/page.tsx:**
- "use client" page component
- Uses `useUserWishlist()` hook
- Uses `useSession()` — if no session, show login prompt or redirect
- Page title: "My Wishlist" as h1
- Conditional rendering:
  - Loading: show WishlistGridSkeleton
  - Empty (items.length === 0): show WishlistEmptyState
  - Has items: show WishlistGrid with items
- Item count subtitle: "X items" below the heading
  </action>
  <verify>
TypeScript compiles: `cd src/MicroCommerce.Web && npx tsc --noEmit` (or `npm run build`). All component files exist. api.ts has wishlist types and functions. use-wishlist.ts has hooks with optimistic updates.
  </verify>
  <done>Wishlist API functions, TanStack Query hooks with optimistic UI, 4 wishlist components (toggle button, item card, grid, empty state), and wishlist page route all exist. Heart icon toggles between outlined and filled red. Add-to-cart from wishlist adds quantity 1 with toast.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate wishlist into header, product cards, product detail, and account sidebar</name>
  <files>
    src/MicroCommerce.Web/src/components/storefront/header.tsx
    src/MicroCommerce.Web/src/components/storefront/product-card.tsx
    src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
    src/MicroCommerce.Web/src/components/account/account-sidebar.tsx
  </files>
  <action>
**header.tsx — Add wishlist heart icon with count badge:**
- Import `Heart` from lucide-react
- Import `useWishlistCount` from `@/hooks/use-wishlist`
- Add `const { data: wishlistCount = 0 } = useWishlistCount();` alongside existing cartCount
- Add heart icon link BETWEEN the orders icon and the cart icon in the desktop nav:
  ```tsx
  <Link
    href="/wishlist"
    className="hidden text-zinc-500 transition-colors hover:text-zinc-900 sm:block relative"
    aria-label="Wishlist"
  >
    <Heart className="h-4 w-4" />
    {wishlistCount > 0 && (
      <span className="absolute -right-1.5 -top-1.5 flex h-3.5 w-3.5 items-center justify-center rounded-full bg-zinc-900 text-[9px] font-medium text-white">
        {wishlistCount > 99 ? '99+' : wishlistCount}
      </span>
    )}
  </Link>
  ```
- Mirror the badge styling exactly from the cart count badge (bg-zinc-900, text-white, text-[9px], rounded-full)
- Also add Wishlist link to the mobile menu section (between Account and Orders links):
  ```tsx
  <Link
    href="/wishlist"
    className="block text-sm font-medium text-zinc-500 transition-colors hover:text-zinc-900"
    onClick={() => setMobileMenuOpen(false)}
  >
    Wishlist
  </Link>
  ```

**product-card.tsx — Add heart icon overlay on product image:**
- Import `WishlistToggleButton` from `@/components/wishlist/wishlist-toggle-button`
- Add heart icon at top-left of the product image area (stock badge is already at top-right):
  ```tsx
  {/* Wishlist heart - top left of image */}
  <div className="absolute left-2 top-2 z-10">
    <WishlistToggleButton productId={product.id} />
  </div>
  ```
- Place this inside the image area div, alongside the existing StockBadge (which is at right-2 top-2)
- The z-10 ensures it's above the image but below any modals
- Note: Using top-LEFT since stock badge already occupies top-RIGHT. This avoids overlap and gives both icons space.

**product-detail.tsx — Add heart icon to product detail page:**
- Import `WishlistToggleButton` from `@/components/wishlist/wishlist-toggle-button`
- Add the heart toggle button near the product name or near the Add to Cart button in the product info section
- Position it next to the product name as a row: product name on the left, heart icon on the right
- Use a slightly larger style for the detail page: wrap in a container with `p-2 rounded-full hover:bg-zinc-100` for a subtle hover background
- This ensures the heart icon is accessible from both product cards AND product detail page per locked decision

**account-sidebar.tsx — Add Wishlist link:**
- Import `Heart` from lucide-react
- Add Wishlist entry to the sections array:
  ```typescript
  {
    name: "Wishlist",
    href: "/account/wishlist",
    icon: Heart,
  },
  ```
- Position it after "Orders" and before "Security" in the sections array
- Note: The /account/wishlist route should redirect to /wishlist. Create a simple redirect page at `src/MicroCommerce.Web/src/app/(storefront)/account/wishlist/page.tsx` that uses `redirect("/wishlist")` from next/navigation. OR simply use `/wishlist` as the href directly. Use `/wishlist` directly since it's simpler and the account sidebar links don't need to be under /account/* — the Orders link already points to `/account/orders` which is a different route. Use `/wishlist` as href for simplicity.
  </action>
  <verify>
TypeScript compiles: `cd src/MicroCommerce.Web && npx tsc --noEmit` (or `npm run build`). Header shows Heart import and wishlistCount usage. Product card has WishlistToggleButton in image area. Product detail has WishlistToggleButton. Account sidebar has Wishlist entry.
  </verify>
  <done>Heart icon with count badge in header nav (desktop + mobile). Heart toggle button on all product cards (top-left of image). Heart toggle on product detail page. Wishlist link in account sidebar. Complete user-facing wishlist experience integrated across storefront.</done>
</task>

</tasks>

<verification>
- TypeScript compilation succeeds with no errors
- api.ts has WishlistItemDto type and 5 API functions
- use-wishlist.ts has hooks: useWishlistProductIds, useWishlistCount, useUserWishlist, useToggleWishlist
- useToggleWishlist implements optimistic UI (onMutate pattern)
- wishlist-toggle-button.tsx renders Heart icon, redirects guests to login
- wishlist-item-card.tsx handles out-of-stock (dimmed, disabled button)
- wishlist/page.tsx renders grid, empty state, and loading skeleton
- header.tsx has Heart icon with count badge
- product-card.tsx has WishlistToggleButton at top-left of image
- product-detail.tsx has WishlistToggleButton
- account-sidebar.tsx has Wishlist link
</verification>

<success_criteria>
Frontend builds cleanly. Heart icon toggles on product cards and detail page. Header shows wishlist count badge. Wishlist page shows saved products with add-to-cart and out-of-stock handling. Empty state displays when wishlist is empty. Account sidebar links to wishlist. All 5 phase success criteria are achievable.
</success_criteria>

<output>
After completion, create `.planning/phases/13-wishlists-saved-items/13-03-SUMMARY.md`
</output>
