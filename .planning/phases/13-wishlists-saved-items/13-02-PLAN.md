---
phase: 13-wishlists-saved-items
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Wishlists/Application/Commands/AddToWishlist/AddToWishlistCommand.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Application/Commands/RemoveFromWishlist/RemoveFromWishlistCommand.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetUserWishlist/GetUserWishlistQuery.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetWishlistCount/GetWishlistCountQuery.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetWishlistProductIds/GetWishlistProductIdsQuery.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/WishlistsEndpoints.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "User can add a product to their wishlist via POST endpoint"
    - "User can remove a product from their wishlist via DELETE endpoint"
    - "User can get full wishlist with product details and stock info via GET endpoint"
    - "User can get wishlist count via GET /count endpoint"
    - "User can get list of wishlisted product IDs for heart icon state via GET /product-ids endpoint"
    - "All wishlist endpoints require authentication"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Application/Commands/AddToWishlist/AddToWishlistCommand.cs"
      provides: "Add to wishlist command with idempotent upsert"
      contains: "AddToWishlistCommand"
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Application/Commands/RemoveFromWishlist/RemoveFromWishlistCommand.cs"
      provides: "Remove from wishlist command (idempotent)"
      contains: "RemoveFromWishlistCommand"
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetUserWishlist/GetUserWishlistQuery.cs"
      provides: "Full wishlist query with product details and stock"
      contains: "WishlistItemDto"
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetWishlistProductIds/GetWishlistProductIdsQuery.cs"
      provides: "Returns list of product IDs for heart icon state"
      contains: "GetWishlistProductIdsQuery"
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/WishlistsEndpoints.cs"
      provides: "5 REST API endpoints for wishlist operations"
      contains: "RequireAuthorization"
  key_links:
    - from: "WishlistsEndpoints.cs"
      to: "Program.cs"
      via: "MapWishlistsEndpoints()"
      pattern: "MapWishlistsEndpoints"
    - from: "GetUserWishlistQuery"
      to: "CatalogDbContext"
      via: "Batch product lookup"
      pattern: "CatalogDbContext"
    - from: "GetUserWishlistQuery"
      to: "InventoryDbContext"
      via: "Batch stock lookup"
      pattern: "InventoryDbContext"
---

<objective>
Create CQRS commands, queries, and REST API endpoints for wishlist operations.

Purpose: Implements the application layer — add/remove commands, full wishlist query (with product details and stock info via cross-context batch lookups), count query, product IDs query (for heart icon state), and 5 REST endpoints all requiring authentication.
Output: Complete wishlist API with 2 commands, 3 queries, and 5 endpoints registered in Program.cs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-wishlists-saved-items/13-RESEARCH.md
@.planning/phases/13-wishlists-saved-items/13-01-SUMMARY.md

# Reference patterns from existing Reviews and Cart features
@src/MicroCommerce.ApiService/Features/Reviews/ReviewsEndpoints.cs
@src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/CreateReview/CreateReviewCommand.cs
@src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/GetReviewsByProduct/GetReviewsByProductQuery.cs
@src/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CQRS commands and queries for wishlist operations</name>
  <files>
    src/MicroCommerce.ApiService/Features/Wishlists/Application/Commands/AddToWishlist/AddToWishlistCommand.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Application/Commands/RemoveFromWishlist/RemoveFromWishlistCommand.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetUserWishlist/GetUserWishlistQuery.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetWishlistCount/GetWishlistCountQuery.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Application/Queries/GetWishlistProductIds/GetWishlistProductIdsQuery.cs
  </files>
  <action>
Create all CQRS handlers following existing MediatR patterns. No FluentValidation validators needed — inputs are just UserId (from JWT) and ProductId (from route).

**AddToWishlistCommand.cs** (command + handler in one file):
- `public sealed record AddToWishlistCommand(Guid UserId, Guid ProductId) : IRequest<Guid>;`
- Handler injects WishlistsDbContext
- Check if already in wishlist: `FirstOrDefaultAsync(w => w.UserId == request.UserId && w.ProductId == request.ProductId)`
- If exists, return existing Id.Value (idempotent — no error on duplicate)
- If not, create via `WishlistItem.Create(request.UserId, request.ProductId)`, add to DbSet, SaveChangesAsync, return item.Id.Value

**RemoveFromWishlistCommand.cs** (command + handler in one file):
- `public sealed record RemoveFromWishlistCommand(Guid UserId, Guid ProductId) : IRequest;`
- Handler injects WishlistsDbContext
- Find item: `FirstOrDefaultAsync(w => w.UserId == request.UserId && w.ProductId == request.ProductId)`
- If null, return (idempotent — no error if already removed)
- If found, remove from DbSet, SaveChangesAsync

**GetUserWishlistQuery.cs** (query + handler + DTO in one file):
- `public sealed record GetUserWishlistQuery(Guid UserId) : IRequest<List<WishlistItemDto>>;`
- `public sealed record WishlistItemDto(Guid Id, Guid ProductId, string ProductName, decimal Price, string Currency, string? ImageUrl, decimal? AverageRating, int ReviewCount, int AvailableQuantity, DateTimeOffset AddedAt);`
- Handler injects WishlistsDbContext, CatalogDbContext, InventoryDbContext
- Step 1: Query wishlist items for user, ordered by AddedAt descending (most recent first)
- Step 2: If empty, return empty list
- Step 3: Collect all ProductIds
- Step 4: Batch lookup products from CatalogDbContext: `.Where(p => productIds.Contains(p.Id.Value)).ToDictionaryAsync(p => p.Id.Value)`
- Step 5: Batch lookup stocks from InventoryDbContext: `.Where(s => productIds.Contains(s.ProductId)).ToDictionaryAsync(s => s.ProductId)`
- Step 6: Map to WishlistItemDto, filtering out items where product is null (deleted products). Use `product?.Name.Value ?? "Unknown"` for safety.
- Reference: Follow exact same cross-context batch query pattern as GetReviewsByProductQuery

**GetWishlistCountQuery.cs** (query + handler in one file):
- `public sealed record GetWishlistCountQuery(Guid UserId) : IRequest<int>;`
- Handler injects WishlistsDbContext
- Return `CountAsync(w => w.UserId == request.UserId)`

**GetWishlistProductIdsQuery.cs** (query + handler in one file):
- `public sealed record GetWishlistProductIdsQuery(Guid UserId) : IRequest<List<Guid>>;`
- Handler injects WishlistsDbContext
- Return `Where(w => w.UserId == request.UserId).Select(w => w.ProductId).ToListAsync()`
- This endpoint is critical for heart icon state — frontend loads all wishlisted product IDs once, checks membership in a Set to avoid N+1 API calls per product
  </action>
  <verify>
`dotnet build src/MicroCommerce.ApiService` compiles with 0 errors. All 5 handler files exist in the correct directories.
  </verify>
  <done>AddToWishlistCommand (idempotent upsert), RemoveFromWishlistCommand (idempotent delete), GetUserWishlistQuery (cross-context batch lookups for product details and stock), GetWishlistCountQuery, and GetWishlistProductIdsQuery all exist with handlers.</done>
</task>

<task type="auto">
  <name>Task 2: Create WishlistsEndpoints and register in Program.cs</name>
  <files>
    src/MicroCommerce.ApiService/Features/Wishlists/WishlistsEndpoints.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
Create REST API endpoints following ReviewsEndpoints pattern exactly.

**WishlistsEndpoints.cs:**
- Namespace: `MicroCommerce.ApiService.Features.Wishlists`
- Static class with `MapWishlistsEndpoints` extension method on `IEndpointRouteBuilder`
- Route group: `/api/wishlist` with `.WithTags("Wishlist").RequireAuthorization()` — ALL endpoints require auth
- Use same GetUserId helper pattern as ReviewsEndpoints (extract from ClaimTypes.NameIdentifier or "sub" claim)

5 endpoints:

1. **GET /api/wishlist** → GetUserWishlist
   - `WithName("GetUserWishlist").WithSummary("Get current user's wishlist with product details")`
   - `.Produces<List<WishlistItemDto>>()`
   - Extract UserId from claims, send GetUserWishlistQuery, return Ok(result)

2. **GET /api/wishlist/count** → GetWishlistCount
   - `WithName("GetWishlistCount").WithSummary("Get wishlist item count")`
   - `.Produces<int>()`
   - Extract UserId, send GetWishlistCountQuery, return Ok(count)

3. **GET /api/wishlist/product-ids** → GetWishlistProductIds
   - `WithName("GetWishlistProductIds").WithSummary("Get list of wishlisted product IDs")`
   - `.Produces<List<Guid>>()`
   - Extract UserId, send GetWishlistProductIdsQuery, return Ok(productIds)

4. **POST /api/wishlist/{productId:guid}** → AddToWishlist
   - `WithName("AddToWishlist").WithSummary("Add product to wishlist")`
   - `.Produces(StatusCodes.Status201Created)`
   - Extract UserId, send AddToWishlistCommand, return Results.Created($"/api/wishlist", new { id })

5. **DELETE /api/wishlist/{productId:guid}** → RemoveFromWishlist
   - `WithName("RemoveFromWishlist").WithSummary("Remove product from wishlist")`
   - `.Produces(StatusCodes.Status204NoContent)`
   - Extract UserId, send RemoveFromWishlistCommand, return Results.NoContent()

Each endpoint method is a private static async method taking HttpContext and ISender (MediatR).

**Program.cs:**
- Add `using MicroCommerce.ApiService.Features.Wishlists;` if not already present
- Add `app.MapWishlistsEndpoints();` after the existing `app.MapReviewsEndpoints();` line
  </action>
  <verify>
`dotnet build src/MicroCommerce.ApiService` compiles with 0 errors. WishlistsEndpoints.cs has 5 endpoint mappings (count `group.Map` occurrences). Program.cs contains `MapWishlistsEndpoints()`.
  </verify>
  <done>5 REST API endpoints registered at /api/wishlist, all requiring authentication. Program.cs calls MapWishlistsEndpoints(). Endpoints cover: list with product details, count, product IDs, add, and remove.</done>
</task>

</tasks>

<verification>
- `dotnet build src/MicroCommerce.ApiService` compiles with 0 errors
- AddToWishlistCommand handles duplicate gracefully (returns existing ID)
- RemoveFromWishlistCommand handles already-removed gracefully (no error)
- GetUserWishlistQuery batch-loads product details from CatalogDbContext and stock from InventoryDbContext
- GetWishlistProductIdsQuery returns just product IDs for efficient heart icon state
- All 5 endpoints require authentication via RequireAuthorization()
- MapWishlistsEndpoints() is called in Program.cs
</verification>

<success_criteria>
Backend builds cleanly. All 5 wishlist endpoints functional with proper authentication. Cross-context batch queries prevent N+1 problems. Commands are idempotent. Ready for frontend integration in Plan 13-03.
</success_criteria>

<output>
After completion, create `.planning/phases/13-wishlists-saved-items/13-02-SUMMARY.md`
</output>
