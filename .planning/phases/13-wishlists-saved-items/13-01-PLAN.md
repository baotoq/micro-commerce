---
phase: 13-wishlists-saved-items
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Wishlists/Domain/Entities/WishlistItem.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Domain/ValueObjects/WishlistItemId.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/WishlistsDbContext.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/Configurations/WishlistItemConfiguration.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "WishlistItem entity stores UserId, ProductId, and AddedAt with composite unique constraint"
    - "WishlistsDbContext is registered with dedicated 'wishlists' schema"
    - "Migration creates WishlistItems table with proper indexes"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Domain/Entities/WishlistItem.cs"
      provides: "WishlistItem entity with factory method"
      contains: "WishlistItem.Create"
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Domain/ValueObjects/WishlistItemId.cs"
      provides: "Strongly-typed ID"
      contains: "WishlistItemId"
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/WishlistsDbContext.cs"
      provides: "Dedicated DbContext with wishlists schema"
      contains: "wishlists"
    - path: "src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/Configurations/WishlistItemConfiguration.cs"
      provides: "EF Core configuration with unique composite index"
      contains: "IsUnique"
  key_links:
    - from: "src/MicroCommerce.ApiService/Program.cs"
      to: "WishlistsDbContext"
      via: "AddNpgsqlDbContext registration"
      pattern: "WishlistsDbContext"
---

<objective>
Create the Wishlists backend domain model and database infrastructure.

Purpose: Establishes the data foundation for the wishlist feature — entity, DbContext, migration, and registration — so CQRS handlers and endpoints can be built on top.
Output: WishlistItem entity, WishlistsDbContext with 'wishlists' schema, EF Core migration, Program.cs registration.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-wishlists-saved-items/13-RESEARCH.md

# Reference patterns from existing Reviews feature
@src/MicroCommerce.ApiService/Features/Reviews/Domain/Entities/Review.cs
@src/MicroCommerce.ApiService/Features/Reviews/Domain/ValueObjects/ReviewId.cs
@src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/ReviewsDbContext.cs
@src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/Configurations/ReviewConfiguration.cs
@src/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WishlistItem entity and WishlistItemId value object</name>
  <files>
    src/MicroCommerce.ApiService/Features/Wishlists/Domain/Entities/WishlistItem.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Domain/ValueObjects/WishlistItemId.cs
  </files>
  <action>
Create the Wishlists domain model. This is simpler than Reviews — WishlistItem is a plain entity (NOT an aggregate root) with no domain events.

**WishlistItemId.cs** — Strongly-typed ID following existing ReviewId pattern:
- `public sealed record WishlistItemId(Guid Value) : StronglyTypedId<Guid>(Value);`
- Add static `New()` factory method returning `new WishlistItemId(Guid.NewGuid())`
- Namespace: `MicroCommerce.ApiService.Features.Wishlists.Domain.ValueObjects`

**WishlistItem.cs** — Simple entity (NOT BaseAggregateRoot):
- Namespace: `MicroCommerce.ApiService.Features.Wishlists.Domain.Entities`
- Properties:
  - `WishlistItemId Id { get; private set; }` (initialized to null!)
  - `Guid UserId { get; private set; }`
  - `Guid ProductId { get; private set; }`
  - `DateTimeOffset AddedAt { get; private set; }`
  - `uint Version { get; private set; }` with `[Timestamp]` attribute for xmin concurrency
- Private parameterless constructor for EF Core
- Static factory method: `public static WishlistItem Create(Guid userId, Guid productId)` that returns new instance with `Id = WishlistItemId.New()`, `AddedAt = DateTimeOffset.UtcNow`

Do NOT inherit from BaseAggregateRoot — WishlistItem does not need domain events or complex business logic.
  </action>
  <verify>
`dotnet build src/MicroCommerce.ApiService` compiles with 0 errors. WishlistItem.cs has Create factory method. WishlistItemId.cs has New() method.
  </verify>
  <done>WishlistItem entity with UserId, ProductId, AddedAt properties and factory method exists. WishlistItemId strongly-typed ID exists.</done>
</task>

<task type="auto">
  <name>Task 2: Create WishlistsDbContext, configuration, migration, and register in Program.cs</name>
  <files>
    src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/WishlistsDbContext.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/Configurations/WishlistItemConfiguration.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
Create the database infrastructure following ReviewsDbContext pattern exactly.

**WishlistsDbContext.cs:**
- Namespace: `MicroCommerce.ApiService.Features.Wishlists.Infrastructure`
- Inherits from `DbContext`
- `DbSet<WishlistItem> WishlistItems { get; set; }`
- Override `OnModelCreating`: set `HasDefaultSchema("wishlists")` and apply configurations from assembly filtered by namespace containing "Wishlists.Infrastructure"
- Follow exact same pattern as ReviewsDbContext (constructor takes `DbContextOptions<WishlistsDbContext>`)

**WishlistItemConfiguration.cs:**
- Namespace: `MicroCommerce.ApiService.Features.Wishlists.Infrastructure.Configurations`
- Implements `IEntityTypeConfiguration<WishlistItem>`
- Table name: `"WishlistItems"`
- HasKey on Id
- Id property: HasConversion from WishlistItemId to Guid and back, ValueGeneratedNever
- **Composite unique index:** `HasIndex(w => new { w.UserId, w.ProductId }).IsUnique()` — enforces one wishlist entry per user per product
- Index on UserId for listing user's wishlist
- Index on AddedAt descending for chronological sort (`.IsDescending()`)
- UserId and ProductId: IsRequired
- AddedAt: IsRequired
- Version: IsRowVersion (PostgreSQL xmin)

**Program.cs:**
- Add `using MicroCommerce.ApiService.Features.Wishlists.Infrastructure;` with other using statements
- Register WishlistsDbContext following the exact same pattern as ReviewsDbContext registration:
  ```csharp
  builder.AddNpgsqlDbContext<WishlistsDbContext>("postgresdb", configureDbContextOptions: options =>
  {
      options.UseNpgsql(npgsqlOptions =>
          npgsqlOptions.MigrationsHistoryTable("__EFMigrationsHistory", "wishlists"));
  });
  ```

**Generate migration:**
- Run: `dotnet ef migrations add InitialWishlists --project src/MicroCommerce.ApiService --context WishlistsDbContext --output-dir Features/Wishlists/Infrastructure/Migrations`
- If dotnet-ef tool is not installed, run `dotnet tool install --global dotnet-ef` first
  </action>
  <verify>
`dotnet build src/MicroCommerce.ApiService` compiles with 0 errors. Migration file exists in Features/Wishlists/Infrastructure/Migrations/. WishlistsDbContext is registered in Program.cs. Grep for "WishlistsDbContext" in Program.cs confirms registration.
  </verify>
  <done>WishlistsDbContext with 'wishlists' schema registered in Program.cs. WishlistItemConfiguration has composite unique index on (UserId, ProductId). Migration file generated.</done>
</task>

</tasks>

<verification>
- `dotnet build src/MicroCommerce.ApiService` compiles with 0 errors
- WishlistItem.cs exists with Create factory method, UserId, ProductId, AddedAt properties
- WishlistItemId.cs exists as strongly-typed ID
- WishlistsDbContext.cs uses 'wishlists' schema
- WishlistItemConfiguration.cs has composite unique index on (UserId, ProductId)
- Migration file exists in Features/Wishlists/Infrastructure/Migrations/
- Program.cs registers WishlistsDbContext with separate migration history table
</verification>

<success_criteria>
Backend builds cleanly. WishlistItem entity and WishlistsDbContext exist with proper schema isolation and composite unique index. Migration is generated. Ready for CQRS handlers in Plan 13-02.
</success_criteria>

<output>
After completion, create `.planning/phases/13-wishlists-saved-items/13-01-SUMMARY.md`
</output>
