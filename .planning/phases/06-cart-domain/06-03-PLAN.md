---
phase: 06-cart-domain
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - src/MicroCommerce.Web/package.json
  - src/MicroCommerce.Web/src/components/providers/query-provider.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
  - src/MicroCommerce.Web/src/lib/api.ts
  - src/MicroCommerce.Web/src/hooks/use-cart.ts
autonomous: true

must_haves:
  truths:
    - "React Query is installed and QueryClientProvider wraps the storefront layout"
    - "Cart API functions send cookies with credentials: include"
    - "useCart hook returns cart data from server"
    - "useCartItemCount derives count from cached cart query"
    - "useAddToCart, useUpdateCartItem, useRemoveCartItem perform optimistic mutations"
  artifacts:
    - path: "src/MicroCommerce.Web/src/components/providers/query-provider.tsx"
      provides: "QueryClientProvider wrapper component"
      contains: "QueryClientProvider"
    - path: "src/MicroCommerce.Web/src/hooks/use-cart.ts"
      provides: "Cart React Query hooks"
      contains: "useCart"
    - path: "src/MicroCommerce.Web/src/lib/api.ts"
      provides: "Cart API functions with credentials"
      contains: "getCart"
  key_links:
    - from: "layout.tsx"
      to: "query-provider.tsx"
      via: "QueryProvider wrapping children"
      pattern: "QueryProvider"
    - from: "use-cart.ts"
      to: "api.ts"
      via: "queryFn and mutationFn calling cart API functions"
      pattern: "queryKey.*cart"
    - from: "api.ts"
      to: "/api/cart"
      via: "fetch with credentials: include"
      pattern: "credentials.*include"
---

<objective>
Install React Query, create the QueryProvider, add cart API functions to api.ts, and build all cart React Query hooks with optimistic mutations.

Purpose: This plan sets up the client-side data layer for cart operations. React Query provides cache management, optimistic updates, and automatic invalidation. The hooks encapsulate all cart server-state management.
Output: @tanstack/react-query installed, QueryProvider wrapping storefront, cart API functions in api.ts, and 5 cart hooks in use-cart.ts.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cart-domain/06-CONTEXT.md
@.planning/phases/06-cart-domain/06-RESEARCH.md

Key reference files:
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
@src/MicroCommerce.Web/src/hooks/use-intersection-observer.ts
@src/MicroCommerce.Web/src/components/providers/session-provider.tsx
@src/MicroCommerce.Web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Query and create QueryProvider</name>
  <files>
    src/MicroCommerce.Web/package.json
    src/MicroCommerce.Web/src/components/providers/query-provider.tsx
    src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
  </files>
  <action>
    Install React Query dependencies:
    ```bash
    cd src/MicroCommerce.Web && npm install @tanstack/react-query @tanstack/react-query-devtools
    ```

    Create QueryProvider component (src/components/providers/query-provider.tsx):
    - "use client" directive
    - Create QueryClient inside useState(() => new QueryClient({...})) to avoid SSR state leakage
    - Default options: queries.staleTime = 60_000 (1 min), queries.retry = 1
    - Wrap children with QueryClientProvider
    - Include ReactQueryDevtools with initialIsOpen={false}
    - Export as named export `QueryProvider`
    - Follow same pattern as existing session-provider.tsx

    Update storefront layout.tsx:
    - Import QueryProvider from components/providers/query-provider
    - Wrap the existing content (Header + main + Footer + Toaster) with QueryProvider
    - QueryProvider should be the outermost wrapper inside the root div
    - This makes React Query available to all storefront pages including the header (for cart badge)
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npm run build` succeeds. package.json contains @tanstack/react-query. layout.tsx imports and uses QueryProvider.
  </verify>
  <done>React Query v5 installed, QueryProvider created with useState pattern, storefront layout wraps all children with QueryProvider. DevTools available in development.</done>
</task>

<task type="auto">
  <name>Task 2: Cart API functions and React Query hooks</name>
  <files>
    src/MicroCommerce.Web/src/lib/api.ts
    src/MicroCommerce.Web/src/hooks/use-cart.ts
  </files>
  <action>
    Add cart types and API functions to api.ts (append to existing file):

    **Types:**
    - CartItemDto: id (string), productId (string), productName (string), unitPrice (number), imageUrl (string | null), quantity (number), lineTotal (number)
    - CartDto: id (string), items (CartItemDto[]), totalPrice (number), totalItems (number)
    - AddToCartRequest: productId (string), productName (string), unitPrice (number), imageUrl (string | null), quantity (number)
    - AddToCartResponse: isUpdate (boolean)
    - UpdateCartItemRequest: quantity (number)

    **API functions (ALL must use `credentials: "include"` to send buyer_id cookie):**
    - `getCart(): Promise<CartDto | null>` - GET /api/cart, returns null on 404
    - `addToCart(data: AddToCartRequest): Promise<AddToCartResponse>` - POST /api/cart/items
    - `updateCartItemQuantity(itemId: string, quantity: number): Promise<void>` - PUT /api/cart/items/{itemId}
    - `removeCartItem(itemId: string): Promise<void>` - DELETE /api/cart/items/{itemId}
    - `getCartItemCount(): Promise<number>` - GET /api/cart/count (but we'll derive from cached cart instead)

    Create use-cart.ts hooks file:

    **useCart():** useQuery with queryKey ["cart"], queryFn getCart. Returns full cart data.

    **useCartItemCount():** useQuery with SAME queryKey ["cart"], queryFn getCart, `select: (data) => data?.items.reduce((sum, item) => sum + item.quantity, 0) ?? 0`. This shares the cache with useCart() so badge updates when cart changes.

    **useAddToCart():** useMutation with mutationFn addToCart. onSuccess: invalidate ["cart"] query, show toast "Added to cart" or "Updated quantity" based on response.isUpdate. onError: toast.error("Failed to add to cart").

    **useUpdateCartItem():** useMutation with optimistic update pattern:
    - onMutate: cancelQueries(["cart"]), snapshot previousCart, optimistically update quantity in cache via setQueryData
    - onError: rollback to previousCart snapshot, toast.error("Failed to update quantity")
    - onSettled: invalidateQueries(["cart"]) to sync with server
    - mutationFn: ({ itemId, quantity }) => updateCartItemQuantity(itemId, quantity)

    **useRemoveCartItem():** useMutation with optimistic update pattern:
    - onMutate: cancelQueries(["cart"]), snapshot previousCart, optimistically remove item from cache
    - onError: rollback to previousCart, toast.error("Failed to remove item")
    - onSettled: invalidateQueries(["cart"])
    - mutationFn: (itemId) => removeCartItem(itemId)

    Import toast from "sonner" for all toast calls.
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npx tsc --noEmit` type-checks without errors. use-cart.ts exports useCart, useCartItemCount, useAddToCart, useUpdateCartItem, useRemoveCartItem. api.ts exports getCart, addToCart, updateCartItemQuantity, removeCartItem with credentials: "include".
  </verify>
  <done>Cart API functions in api.ts all use credentials: "include". Five React Query hooks in use-cart.ts provide: cart data, item count (derived from cache), add-to-cart with toast, update with optimistic UI + rollback, remove with optimistic UI + rollback.</done>
</task>

</tasks>

<verification>
1. `cd src/MicroCommerce.Web && npm run build` succeeds
2. package.json contains @tanstack/react-query and @tanstack/react-query-devtools
3. QueryProvider wraps storefront layout children
4. All cart API functions include `credentials: "include"`
5. useCartItemCount shares ["cart"] query key with useCart
6. useUpdateCartItem and useRemoveCartItem implement optimistic mutation pattern
7. Toast notifications on success and error for all mutations
</verification>

<success_criteria>
- React Query installed and working with Next.js (no SSR state leakage)
- QueryProvider in storefront layout makes hooks available everywhere
- Cart hooks use single ["cart"] query key for cache consistency
- Optimistic mutations snapshot -> update -> rollback on error -> invalidate on settle
- All fetch calls include credentials for cookie-based buyer identity
</success_criteria>

<output>
After completion, create `.planning/phases/06-cart-domain/06-03-SUMMARY.md`
</output>
