---
phase: 06-cart-domain
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/MicroCommerce.Web/src/app/(storefront)/cart/page.tsx
  - src/MicroCommerce.Web/src/components/storefront/cart-page.tsx
  - src/MicroCommerce.Web/src/components/storefront/cart-item-row.tsx
  - src/MicroCommerce.Web/src/components/storefront/cart-summary.tsx
  - src/MicroCommerce.Web/src/components/storefront/header.tsx
  - src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
autonomous: false

must_haves:
  truths:
    - "User can view cart page at /cart with item list and order summary"
    - "User can update item quantity with stepper (+/-) and see instant UI update"
    - "User sees confirmation dialog before removing an item"
    - "Empty cart shows 'Your cart is empty' with 'Continue shopping' link"
    - "Header badge shows live cart item count with bounce animation on change"
    - "Add to cart button on product detail page sends request and shows toast"
    - "Cart page persists across page refresh (cookie-based identity)"
  artifacts:
    - path: "src/MicroCommerce.Web/src/app/(storefront)/cart/page.tsx"
      provides: "/cart route page"
      contains: "CartPage"
    - path: "src/MicroCommerce.Web/src/components/storefront/cart-page.tsx"
      provides: "Cart page component with item list and summary"
      contains: "CartPage"
    - path: "src/MicroCommerce.Web/src/components/storefront/cart-item-row.tsx"
      provides: "Individual cart item row with quantity stepper and remove"
      contains: "CartItemRow"
    - path: "src/MicroCommerce.Web/src/components/storefront/cart-summary.tsx"
      provides: "Order summary with totals"
      contains: "CartSummary"
    - path: "src/MicroCommerce.Web/src/components/storefront/header.tsx"
      provides: "Updated header with live cart badge"
      contains: "useCartItemCount"
  key_links:
    - from: "cart-page.tsx"
      to: "use-cart.ts"
      via: "useCart hook for data, useUpdateCartItem and useRemoveCartItem for mutations"
      pattern: "useCart|useUpdateCartItem|useRemoveCartItem"
    - from: "header.tsx"
      to: "use-cart.ts"
      via: "useCartItemCount hook for badge"
      pattern: "useCartItemCount"
    - from: "product-detail.tsx"
      to: "use-cart.ts"
      via: "useAddToCart hook on Add to Cart button"
      pattern: "useAddToCart"
---

<objective>
Build the cart page UI, wire up the header badge with live count, and integrate add-to-cart on the product detail page.

Purpose: This is the user-facing plan that brings together the backend (Plan 02) and data layer (Plan 03) into a complete cart experience. All four requirements (CART-01 through CART-04) are satisfied here.
Output: /cart page with item list + order summary, header badge with live count + bounce animation, add-to-cart on product detail page with toast feedback.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cart-domain/06-CONTEXT.md
@.planning/phases/06-cart-domain/06-RESEARCH.md
@.planning/phases/06-cart-domain/06-01-SUMMARY.md
@.planning/phases/06-cart-domain/06-02-SUMMARY.md
@.planning/phases/06-cart-domain/06-03-SUMMARY.md

Key reference files:
@src/MicroCommerce.Web/src/components/storefront/header.tsx
@src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
@src/MicroCommerce.Web/src/components/storefront/product-card.tsx
@src/MicroCommerce.Web/src/hooks/use-cart.ts
@src/MicroCommerce.Web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cart page components (cart-page, cart-item-row, cart-summary)</name>
  <files>
    src/MicroCommerce.Web/src/app/(storefront)/cart/page.tsx
    src/MicroCommerce.Web/src/components/storefront/cart-page.tsx
    src/MicroCommerce.Web/src/components/storefront/cart-item-row.tsx
    src/MicroCommerce.Web/src/components/storefront/cart-summary.tsx
  </files>
  <action>
    **cart/page.tsx** (Next.js route):
    - Simple server component that renders CartPage client component
    - Add metadata: title "Cart | MicroCommerce"

    **cart-page.tsx** (main cart component):
    - "use client" directive
    - Uses useCart() hook for data, useUpdateCartItem() and useRemoveCartItem() for mutations
    - Loading state: show skeleton rows (3-4 skeleton cards)
    - Empty state: centered "Your cart is empty" message with ShoppingCart icon, "Continue shopping" Button linking to "/"
    - Cart expired detection: if cart query returns null but we had items before (or cookie exists), show toast.info("Your cart has expired")
    - Layout: Apple Store aesthetic (zinc palette, generous whitespace)
      - Page title "Cart" at top
      - Responsive layout: items list on left (full width on mobile), order summary on right sidebar (lg: grid-cols-3, items take 2 cols, summary takes 1)
    - Maps cart.items to CartItemRow components
    - Passes mutation hooks down to CartItemRow

    **cart-item-row.tsx** (individual item):
    - Compact row: small thumbnail (64x64 with aspect-square, rounded), product name (link to /products/{productId}), unit price, quantity stepper, line total, remove button
    - Quantity stepper: Minus button (-), quantity display, Plus button (+)
      - Minus disabled when quantity is 1
      - Plus disabled when quantity is 99
      - Both disabled during mutation (isPending)
      - Calls useUpdateCartItem with new quantity on click
    - Remove button: Trash2 icon, on click shows AlertDialog confirmation ("Remove item?" / "This will remove {productName} from your cart." / Cancel + Remove buttons)
      - On confirm: calls useRemoveCartItem
    - Responsive: stack vertically on mobile, row on desktop
    - Use formatPrice helper for currency formatting (consistent with product detail page)

    **cart-summary.tsx** (order summary sidebar):
    - Card component with "Order Summary" heading
    - Subtotal (sum of line totals)
    - Item count display ("X items")
    - Separator line
    - Total (same as subtotal for now - shipping/tax in Phase 7)
    - "Proceed to Checkout" Button (disabled, links nowhere - Phase 7)
    - Sticky on desktop (sticky top-20)
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npm run build` succeeds. All 4 files exist. cart-page.tsx imports useCart, useUpdateCartItem, useRemoveCartItem. cart-item-row.tsx uses AlertDialog for remove confirmation.
  </verify>
  <done>Cart page renders item list with quantity steppers, remove with confirmation dialog, order summary sidebar, empty state, and loading skeletons. Follows Apple Store aesthetic with zinc palette.</done>
</task>

<task type="auto">
  <name>Task 2: Header badge and add-to-cart on product detail</name>
  <files>
    src/MicroCommerce.Web/src/components/storefront/header.tsx
    src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
  </files>
  <action>
    **header.tsx updates:**
    - Import useCartItemCount from hooks/use-cart
    - Replace hardcoded "0" badge with live count from useCartItemCount()
    - Make cart icon a Link to /cart
    - Add bounce animation on count change:
      - Use useEffect watching count value, set an "animate" state to true, setTimeout to remove after 300ms
      - CSS: when animate is true, add a scale bounce class (e.g., `animate-bounce` or custom `transition-transform scale-110` then back)
      - Or use a simpler approach: CSS keyframe animation triggered by key prop change
    - Hide badge when count is 0 (don't show "0")
    - Keep existing mobile menu and search bar unchanged

    **product-detail.tsx updates:**
    - Import useAddToCart from hooks/use-cart
    - Replace the existing placeholder toast("Cart coming soon!") with actual add-to-cart logic
    - On "Add to Cart" button click:
      - Call addToCart mutation with: productId (from props), productName (product.name), unitPrice (product.price), imageUrl (product.imageUrl), quantity: 1
      - Disable button during mutation (isPending)
      - Show loading spinner or "Adding..." text during mutation
    - The toast is handled by useAddToCart hook (onSuccess/onError), so remove any existing toast call
    - Keep button disabled when out of stock (existing behavior)
  </action>
  <verify>
    `cd src/MicroCommerce.Web && npm run build` succeeds. header.tsx imports useCartItemCount and links to /cart. product-detail.tsx imports useAddToCart and calls mutation on button click.
  </verify>
  <done>Header badge shows live cart count (hidden when 0) with bounce animation on change, links to /cart. Product detail "Add to Cart" button triggers real mutation with loading state and toast feedback.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete cart experience: /cart page with items, quantity steppers, remove with confirmation, order summary, header badge with live count, and add-to-cart on product detail page.</what-built>
  <how-to-verify>
    1. Start the app (Aspire or direct). Navigate to a product detail page.
    2. Click "Add to Cart" - verify toast "Added to cart" appears, header badge updates from hidden to "1".
    3. Add the same product again - verify toast "Updated quantity" appears, badge updates to "2".
    4. Add a different product - verify badge updates to "3".
    5. Click the cart icon in header - verify /cart page loads with both items.
    6. Use quantity stepper (+/-) on an item - verify quantity and line total update instantly (optimistic).
    7. Click remove (trash icon) on an item - verify confirmation dialog appears. Click "Remove" - item disappears.
    8. Refresh the page - verify cart persists (cookie-based identity).
    9. Remove all items - verify empty state "Your cart is empty" with "Continue shopping" button.
    10. Click "Continue shopping" - verify it navigates to homepage.
  </how-to-verify>
  <resume-signal>Type "approved" if cart works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `cd src/MicroCommerce.Web && npm run build` succeeds
2. /cart route renders CartPage component
3. CartItemRow has quantity stepper with min 1 / max 99
4. Remove uses AlertDialog confirmation dialog
5. Empty state shows "Your cart is empty" with Continue shopping link
6. Header badge shows live count, hidden when 0, bounces on change
7. Product detail Add to Cart triggers real API call
8. Cart persists across page refresh
9. Optimistic updates: quantity changes are instant, rollback on error
</verification>

<success_criteria>
- CART-01: User can view cart, update quantities, and remove items (with confirmation)
- CART-02: Cart persists across page refreshes (cookie-based buyer ID)
- CART-03: User sees "Added to cart" / "Updated quantity" toast, header badge updates
- CART-04: Quantity updates feel instant (optimistic UI with rollback)
- Empty state, loading skeletons, and error toasts all working
- Apple Store aesthetic maintained (zinc palette, whitespace)
</success_criteria>

<output>
After completion, create `.planning/phases/06-cart-domain/06-04-SUMMARY.md`
</output>
