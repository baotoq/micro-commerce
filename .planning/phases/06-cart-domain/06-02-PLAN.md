---
phase: 06-cart-domain
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs
  - src/MicroCommerce.ApiService/Features/Cart/Application/Commands/UpdateCartItem/UpdateCartItemCommand.cs
  - src/MicroCommerce.ApiService/Features/Cart/Application/Commands/RemoveCartItem/RemoveCartItemCommand.cs
  - src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCart/GetCartQuery.cs
  - src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCartItemCount/GetCartItemCountQuery.cs
  - src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
  - src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartExpirationService.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "GET /api/cart returns cart with items for the buyer (via cookie)"
    - "POST /api/cart/items adds item to cart (creates cart if needed)"
    - "PUT /api/cart/items/{itemId} updates item quantity"
    - "DELETE /api/cart/items/{itemId} removes item from cart"
    - "GET /api/cart/count returns total item count for header badge"
    - "Expired carts are cleaned up by background service"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs"
      provides: "Cart API routes"
      contains: "MapCartEndpoints"
    - path: "src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs"
      provides: "Add to cart handler with upsert logic"
      contains: "AddToCartCommand"
    - path: "src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartExpirationService.cs"
      provides: "Background service for 30-day cart TTL cleanup"
      contains: "CartExpirationService"
  key_links:
    - from: "CartEndpoints.cs"
      to: "BuyerIdentity.cs"
      via: "GetOrCreateBuyerId call in each endpoint"
      pattern: "BuyerIdentity.GetOrCreateBuyerId"
    - from: "Program.cs"
      to: "CartEndpoints.cs"
      via: "app.MapCartEndpoints()"
      pattern: "MapCartEndpoints"
    - from: "Program.cs"
      to: "CartExpirationService.cs"
      via: "AddHostedService"
      pattern: "AddHostedService<CartExpirationService>"
---

<objective>
Create CQRS command/query handlers for all cart operations, minimal API endpoints, and the cart expiration background service.

Purpose: This plan wires up the complete cart backend - handlers that manipulate the Cart aggregate, endpoints that expose them via HTTP, and the cleanup service that enforces 30-day TTL. After this plan, all cart APIs are functional.
Output: 5 CQRS handlers (AddToCart, UpdateCartItem, RemoveCartItem, GetCart, GetCartItemCount), CartEndpoints mapped in Program.cs, CartExpirationService registered as hosted service.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cart-domain/06-CONTEXT.md
@.planning/phases/06-cart-domain/06-RESEARCH.md
@.planning/phases/06-cart-domain/06-01-SUMMARY.md

Key reference files:
@src/MicroCommerce.ApiService/Features/Inventory/InventoryEndpoints.cs
@src/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/
@src/MicroCommerce.ApiService/Features/Inventory/Application/Queries/GetStockByProductId/
@src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/ReservationCleanupService.cs
@src/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cart CQRS handlers (commands and queries)</name>
  <files>
    src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartValidator.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Commands/UpdateCartItem/UpdateCartItemCommand.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Commands/RemoveCartItem/RemoveCartItemCommand.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCart/GetCartQuery.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCart/CartDto.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCartItemCount/GetCartItemCountQuery.cs
  </files>
  <action>
    Follow the existing CQRS patterns from Inventory module (command record + handler in same file).

    **AddToCartCommand(Guid BuyerId, Guid ProductId, string ProductName, decimal UnitPrice, string? ImageUrl, int Quantity = 1):**
    - Handler: Load cart by BuyerId (FirstOrDefaultAsync where BuyerId == command.BuyerId, include Items). If null, create new cart via Cart.Create(buyerId). Call cart.AddItem(). SaveChangesAsync. Return a result indicating whether item was new or quantity updated (bool IsUpdate).
    - Validator: ProductId not empty, ProductName not empty, UnitPrice > 0, Quantity 1-99.

    **UpdateCartItemCommand(Guid BuyerId, Guid ItemId, int Quantity):**
    - Handler: Load cart by BuyerId (include Items). If null, return not-found result. Call cart.UpdateItemQuantity(CartItemId.From(itemId), quantity). SaveChangesAsync.
    - No validator needed (quantity validated in aggregate).

    **RemoveCartItemCommand(Guid BuyerId, Guid ItemId):**
    - Handler: Load cart by BuyerId (include Items). Call cart.RemoveItem(CartItemId.From(itemId)). SaveChangesAsync.

    **GetCartQuery(Guid BuyerId):**
    - Handler: Load cart by BuyerId with Items, project to CartDto. Return null if no cart found.
    - CartDto record: Id (Guid), Items (List<CartItemDto>), TotalPrice (decimal), TotalItems (int).
    - CartItemDto record: Id (Guid), ProductId (Guid), ProductName (string), UnitPrice (decimal), ImageUrl (string?), Quantity (int), LineTotal (decimal = UnitPrice * Quantity).

    **GetCartItemCountQuery(Guid BuyerId):**
    - Handler: Query cart by BuyerId, return sum of item quantities (int). Return 0 if no cart.
    - Use a lightweight query (no Include needed, just project Items.Sum(i => i.Quantity)).

    Error handling: Use InvalidOperationException for not-found (consistent with existing pattern). DbUpdateConcurrencyException will bubble up naturally for optimistic concurrency conflicts.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` compiles. All 5 handler files exist with correct command/handler pairs.
  </verify>
  <done>All cart CQRS handlers compile and follow existing patterns. AddToCart creates cart on first use, UpdateCartItem and RemoveCartItem load by BuyerId, GetCart returns CartDto with line totals, GetCartItemCount returns integer sum.</done>
</task>

<task type="auto">
  <name>Task 2: Cart endpoints, expiration service, and Program.cs registration</name>
  <files>
    src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
    src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartExpirationService.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    **CartEndpoints.cs** following InventoryEndpoints.cs pattern exactly:
    - Extension method `MapCartEndpoints(this IEndpointRouteBuilder endpoints)`
    - Route group: `/api/cart` with tag "Cart"
    - `GET /` -> GetCart: calls BuyerIdentity.GetOrCreateBuyerId(httpContext), sends GetCartQuery, returns Ok(result)
    - `POST /items` -> AddToCart: reads AddToCartRequest body (productId, productName, unitPrice, imageUrl, quantity), gets buyerId, sends AddToCartCommand, returns Ok with isUpdate flag
    - `PUT /items/{itemId:guid}` -> UpdateCartItem: reads UpdateCartItemRequest body (quantity), gets buyerId, sends UpdateCartItemCommand, returns NoContent
    - `DELETE /items/{itemId:guid}` -> RemoveCartItem: gets buyerId, sends RemoveCartItemCommand, returns NoContent
    - `GET /count` -> GetCartItemCount: gets buyerId, sends GetCartItemCountQuery, returns Ok(count)
    - NO RequireAuthorization - cart works for guests
    - Request records: AddToCartRequest(Guid ProductId, string ProductName, decimal UnitPrice, string? ImageUrl, int Quantity), UpdateCartItemRequest(int Quantity)

    **CartExpirationService.cs** following ReservationCleanupService.cs exactly:
    - BackgroundService with 1-hour interval
    - Uses IServiceScopeFactory to create scope, resolves CartDbContext
    - ExecuteDeleteAsync on Carts where ExpiresAt <= DateTimeOffset.UtcNow
    - Logs count of deleted carts
    - OperationCanceledException handling for graceful shutdown
    - General exception catch with error logging

    **Program.cs updates:**
    - Add `app.MapCartEndpoints();` after the existing `app.MapInventoryEndpoints();` line
    - Add `builder.Services.AddHostedService<CartExpirationService>();` after the existing AddHostedService lines
    - Add the necessary using statement for Cart namespace
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` succeeds. Program.cs contains MapCartEndpoints and AddHostedService<CartExpirationService>. CartEndpoints.cs has all 5 routes.
  </verify>
  <done>Cart API endpoints are registered and reachable. CartExpirationService is registered as hosted service. All endpoints use BuyerIdentity for cookie-based buyer identification. No authentication required for cart operations.</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/` succeeds
2. Program.cs contains `app.MapCartEndpoints()` and `AddHostedService<CartExpirationService>()`
3. CartEndpoints.cs maps GET /, POST /items, PUT /items/{itemId}, DELETE /items/{itemId}, GET /count
4. All handlers follow existing CQRS patterns with ISender
5. CartExpirationService follows ReservationCleanupService pattern
6. AddToCartValidator validates ProductId, ProductName, UnitPrice, Quantity
</verification>

<success_criteria>
- All 5 cart API endpoints are mapped and compile
- Handlers create cart on first AddToCart (upsert pattern)
- GetCart returns CartDto with line totals and total price
- GetCartItemCount returns integer for badge display
- CartExpirationService runs hourly and deletes expired carts
- BuyerIdentity.GetOrCreateBuyerId used in every endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/06-cart-domain/06-02-SUMMARY.md`
</output>
