---
phase: 06-cart-domain
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/Cart.cs
  - src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs
  - src/MicroCommerce.ApiService/Features/Cart/Domain/ValueObjects/CartId.cs
  - src/MicroCommerce.ApiService/Features/Cart/Domain/ValueObjects/CartItemId.cs
  - src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartDbContext.cs
  - src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartItemConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Cart/BuyerIdentity.cs
autonomous: true

must_haves:
  truths:
    - "Cart aggregate enforces invariants (max quantity 99, non-negative quantities)"
    - "CartItem tracks product info (productId, name, price, imageUrl, quantity)"
    - "Cart has BuyerId for guest/authenticated identity"
    - "Cart has 30-day TTL that resets on every modification"
    - "EF migration creates cart schema tables successfully"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/Cart.cs"
      provides: "Cart aggregate root with AddItem, UpdateItemQuantity, RemoveItem, Touch"
      contains: "class Cart : BaseAggregateRoot<CartId>"
    - path: "src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs"
      provides: "CartItem entity owned by Cart"
      contains: "class CartItem"
    - path: "src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartDbContext.cs"
      provides: "Cart module DbContext with DbSet<Cart>"
      contains: "DbSet<Cart> Carts"
    - path: "src/MicroCommerce.ApiService/Features/Cart/BuyerIdentity.cs"
      provides: "Cookie-based buyer identity helper"
      contains: "GetOrCreateBuyerId"
  key_links:
    - from: "CartConfiguration.cs"
      to: "Cart.cs"
      via: "EF Core IEntityTypeConfiguration"
      pattern: "IEntityTypeConfiguration<Cart>"
    - from: "CartDbContext.cs"
      to: "Cart schema"
      via: "HasDefaultSchema"
      pattern: "HasDefaultSchema.*cart"
---

<objective>
Create the Cart domain model following established DDD patterns, EF Core persistence with schema isolation, and the buyer identity helper.

Purpose: Foundation for all cart operations - the aggregate, value objects, EF configurations, and database migration must exist before any CQRS handlers or UI can be built.
Output: Cart and CartItem entities, strongly-typed IDs, EF configurations, updated CartDbContext with DbSets, initial migration, and BuyerIdentity helper.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cart-domain/06-CONTEXT.md
@.planning/phases/06-cart-domain/06-RESEARCH.md

Key reference files (follow these patterns exactly):
@src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockItem.cs
@src/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/StockItemId.cs
@src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDbContext.cs
@src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/
@src/BuildingBlocks/BuildingBlocks.Common/BaseAggregateRoot.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cart domain model and value objects</name>
  <files>
    src/MicroCommerce.ApiService/Features/Cart/Domain/ValueObjects/CartId.cs
    src/MicroCommerce.ApiService/Features/Cart/Domain/ValueObjects/CartItemId.cs
    src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/Cart.cs
    src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs
    src/MicroCommerce.ApiService/Features/Cart/BuyerIdentity.cs
  </files>
  <action>
    Create CartId and CartItemId as strongly-typed IDs following StockItemId pattern exactly:
    - `sealed record CartId(Guid Value) : StronglyTypedId<Guid>(Value)` with New() and From() static methods
    - Same for CartItemId

    Create Cart aggregate root following StockItem pattern:
    - Extends `BaseAggregateRoot<CartId>` with private constructor for EF Core
    - Properties: BuyerId (raw Guid, like ProductId in StockItem), CreatedAt (DateTimeOffset), LastModifiedAt (DateTimeOffset), ExpiresAt (DateTimeOffset), Version (uint with [Timestamp] for xmin concurrency)
    - Private `List<CartItem> _items` backing field with `IReadOnlyCollection<CartItem> Items` public property
    - Factory method `static Cart Create(Guid buyerId)` that sets CreatedAt/LastModifiedAt to UtcNow, ExpiresAt to UtcNow.AddDays(30)
    - `AddItem(Guid productId, string productName, decimal unitPrice, string? imageUrl, int quantity = 1)`: finds existing item by productId, increments if found, creates new CartItem if not. Calls Touch().
    - `UpdateItemQuantity(CartItemId itemId, int newQuantity)`: validates newQuantity is 1-99, finds item by id, throws InvalidOperationException if not found, calls item.SetQuantity(). Calls Touch().
    - `RemoveItem(CartItemId itemId)`: finds and removes item. Calls Touch().
    - Private `Touch()` method: updates LastModifiedAt and resets ExpiresAt to UtcNow.AddDays(30).
    - Max quantity constant: `private const int MaxQuantity = 99;` - enforce in AddItem (cap at 99 after increment) and UpdateItemQuantity.

    Create CartItem entity:
    - NOT an aggregate root - just a regular class with CartItemId Id property
    - Properties: CartId (CartId, foreign key back to Cart), ProductId (Guid), ProductName (string), UnitPrice (decimal), ImageUrl (string?), Quantity (int)
    - Private constructor for EF Core
    - Factory method `static CartItem Create(CartId cartId, Guid productId, string productName, decimal unitPrice, string? imageUrl, int quantity)`
    - `IncrementQuantity(int amount)`: adds amount, caps at 99
    - `SetQuantity(int newQuantity)`: validates 1-99, sets quantity

    Create BuyerIdentity static helper class:
    - `static Guid GetOrCreateBuyerId(HttpContext context)`: checks authenticated user first (sub claim), then reads buyer_id cookie, then generates new GUID and sets cookie with HttpOnly, Secure, SameSite=Lax, MaxAge=7 days, Path="/"
    - Place in Features/Cart/ namespace root
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` compiles without errors. Verify Cart.cs has AddItem, UpdateItemQuantity, RemoveItem, Touch methods. Verify max quantity cap of 99.
  </verify>
  <done>Cart aggregate with CartItem entity, strongly-typed IDs, and BuyerIdentity helper all compile. Aggregate enforces max quantity 99, has factory methods, and follows StockItem patterns.</done>
</task>

<task type="auto">
  <name>Task 2: EF Core configurations, CartDbContext update, and migration</name>
  <files>
    src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartConfiguration.cs
    src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartItemConfiguration.cs
    src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartDbContext.cs
  </files>
  <action>
    Update CartDbContext (already exists with schema isolation):
    - Uncomment/add `DbSet<Cart> Carts => Set<Cart>();` and `DbSet<CartItem> CartItems => Set<CartItem>();`
    - Remove the placeholder comments
    - Keep existing schema isolation and assembly config scanning
    - Add DomainEventInterceptor registration if the pattern exists in other DbContexts (check InventoryDbContext)

    Create CartConfiguration (IEntityTypeConfiguration<Cart>):
    - Follow the existing Inventory/Catalog configuration pattern
    - Map CartId as primary key with value converter (Id.Value <-> CartId.From())
    - Map BuyerId, CreatedAt, LastModifiedAt, ExpiresAt as required columns
    - Map Version as IsRowVersion() for xmin concurrency token (same as StockItem)
    - Configure _items navigation: HasMany(c => c.Items).WithOne().HasForeignKey(i => i.CartId)
    - Add index on BuyerId for fast lookups
    - Add index on ExpiresAt for expiration cleanup queries

    Create CartItemConfiguration (IEntityTypeConfiguration<CartItem>):
    - Map CartItemId as primary key with value converter
    - Map CartId foreign key with value converter
    - Map ProductId, ProductName (maxlength 200), UnitPrice (precision 18,2), ImageUrl (nullable), Quantity as required columns

    Generate EF migration:
    ```
    dotnet ef migrations add InitialCart --project src/MicroCommerce.ApiService --context CartDbContext --output-dir Features/Cart/Infrastructure/Migrations
    ```
  </action>
  <verify>
    Migration generates without errors. `dotnet build src/MicroCommerce.ApiService/` succeeds. Migration file exists in Features/Cart/Infrastructure/Migrations/.
  </verify>
  <done>CartDbContext has DbSets, configurations map all properties correctly with value converters, indexes on BuyerId and ExpiresAt, and migration is generated.</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/` succeeds
2. Cart.cs contains Create, AddItem, UpdateItemQuantity, RemoveItem methods
3. CartItem.cs contains Create, IncrementQuantity, SetQuantity methods
4. BuyerIdentity.cs contains GetOrCreateBuyerId with cookie handling
5. Migration file exists in Features/Cart/Infrastructure/Migrations/
6. CartDbContext has DbSet<Cart> and DbSet<CartItem>
</verification>

<success_criteria>
- Cart aggregate enforces max quantity 99 invariant
- Cart tracks BuyerId, timestamps, and 30-day TTL
- CartItem stores product snapshot (name, price, imageUrl)
- EF migration creates cart.Carts and cart.CartItems tables
- BuyerIdentity reads authenticated user sub claim or cookie-based GUID
- All code follows existing Inventory module patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-cart-domain/06-01-SUMMARY.md`
</output>
