---
phase: 12-product-reviews-ratings
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/MicroCommerce.Web/src/lib/api.ts
  - src/MicroCommerce.Web/src/hooks/use-reviews.ts
  - src/MicroCommerce.Web/src/components/reviews/star-rating-display.tsx
  - src/MicroCommerce.Web/src/components/reviews/star-rating-input.tsx
  - src/MicroCommerce.Web/src/components/reviews/verified-badge.tsx
  - src/MicroCommerce.Web/src/components/reviews/review-item.tsx
  - src/MicroCommerce.Web/src/components/reviews/review-list.tsx
  - src/MicroCommerce.Web/src/components/reviews/review-form-dialog.tsx
  - src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
  - src/MicroCommerce.Web/src/components/storefront/product-card.tsx
  - src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Product detail page shows review list with star ratings, display names, dates, and verified purchase badges"
    - "Product detail page shows aggregate rating (stars + number + count) in product info section"
    - "Authenticated user who purchased product sees 'Write a Review' button that opens modal dialog"
    - "Non-purchasers see 'Purchase this product to leave a review' message"
    - "User can edit or delete their own review from the review list"
    - "Product cards on browse pages show aggregate star rating and count"
    - "Order detail page shows 'Write a Review' links for purchased items"
    - "Load more button fetches next batch of 5 reviews"
    - "Star rating input supports hover preview and click selection"
    - "Review text shows character counter (X/1000)"
  artifacts:
    - path: "src/MicroCommerce.Web/src/components/reviews/star-rating-display.tsx"
      provides: "Read-only star display with filled yellow/gray pattern"
      contains: "StarRatingDisplay"
    - path: "src/MicroCommerce.Web/src/components/reviews/review-form-dialog.tsx"
      provides: "Modal dialog for create/edit reviews"
      contains: "ReviewFormDialog"
    - path: "src/MicroCommerce.Web/src/components/reviews/review-list.tsx"
      provides: "Paginated review list with load more"
      contains: "ReviewList"
    - path: "src/MicroCommerce.Web/src/hooks/use-reviews.ts"
      provides: "TanStack Query hooks for review operations"
      contains: "useReviews"
    - path: "src/MicroCommerce.Web/src/lib/api.ts"
      provides: "Review API client functions"
      contains: "getProductReviews"
  key_links:
    - from: "product-detail.tsx"
      to: "review-list.tsx"
      via: "Component composition"
      pattern: "ReviewList"
    - from: "product-card.tsx"
      to: "star-rating-display.tsx"
      via: "Aggregate rating display"
      pattern: "StarRatingDisplay"
    - from: "use-reviews.ts"
      to: "api.ts"
      via: "API functions"
      pattern: "getProductReviews"
    - from: "review-form-dialog.tsx"
      to: "use-reviews.ts"
      via: "Mutation hooks"
      pattern: "useCreateReview"
---

<objective>
Build all frontend review components, hooks, and API functions, then integrate them into the product detail page (review list + submission), product cards (aggregate ratings), and order detail page (review links).

Purpose: Complete the user-facing review experience so users can see ratings, read reviews, and submit their own reviews through an accessible modal interface.
Output: Review component library, TanStack Query hooks, API functions, and full integration across storefront pages.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-product-reviews-ratings/12-RESEARCH.md
@.planning/phases/12-product-reviews-ratings/12-02-SUMMARY.md

Key reference files:
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/hooks/use-profile.ts
@src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
@src/MicroCommerce.Web/src/components/storefront/product-card.tsx
@src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
@src/MicroCommerce.Web/src/components/account/address-form-dialog.tsx (if exists — pattern for modal forms)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review API functions, hooks, and reusable components</name>
  <files>
    src/MicroCommerce.Web/src/lib/api.ts
    src/MicroCommerce.Web/src/hooks/use-reviews.ts
    src/MicroCommerce.Web/src/components/reviews/star-rating-display.tsx
    src/MicroCommerce.Web/src/components/reviews/star-rating-input.tsx
    src/MicroCommerce.Web/src/components/reviews/verified-badge.tsx
    src/MicroCommerce.Web/src/components/reviews/review-item.tsx
    src/MicroCommerce.Web/src/components/reviews/review-list.tsx
    src/MicroCommerce.Web/src/components/reviews/review-form-dialog.tsx
  </files>
  <action>
    **api.ts** — Add review types and API functions at the end of the existing file:

    Types:
    ```typescript
    export interface ReviewDto {
      id: string;
      userId: string;
      displayName: string;
      rating: number;
      text: string;
      createdAt: string;
      isVerifiedPurchase: boolean;
    }

    export interface ReviewListDto {
      items: ReviewDto[];
      totalCount: number;
      page: number;
      pageSize: number;
    }

    export interface CanReviewDto {
      hasPurchased: boolean;
      hasReviewed: boolean;
    }

    export interface CreateReviewRequest {
      rating: number;
      text: string;
    }

    export interface UpdateReviewRequest {
      rating: number;
      text: string;
    }
    ```

    Also update the existing ProductDto interface to include:
    ```typescript
    averageRating: number | null;
    reviewCount: number;
    ```

    API functions (follow existing auth token pattern from getMyProfile etc.):
    - `getProductReviews(productId: string, page = 1, pageSize = 5)` — GET /api/reviews/products/{productId}?page=X&pageSize=Y (public, no token)
    - `getMyReview(productId: string, token?: string)` — GET /api/reviews/products/{productId}/mine (auth)
    - `canReview(productId: string, token?: string)` — GET /api/reviews/products/{productId}/can-review (auth)
    - `createReview(productId: string, data: CreateReviewRequest, token?: string)` — POST /api/reviews/products/{productId} (auth)
    - `updateReview(reviewId: string, data: UpdateReviewRequest, token?: string)` — PUT /api/reviews/{reviewId} (auth)
    - `deleteReview(reviewId: string, token?: string)` — DELETE /api/reviews/{reviewId} (auth)

    **use-reviews.ts** — TanStack Query hooks following use-profile.ts pattern:
    - `useProductReviews(productId: string, page: number)` — useQuery with key ["reviews", productId, page], queryFn calls getProductReviews
    - `useMyReview(productId: string)` — useQuery with key ["my-review", productId], enabled when session exists, queryFn calls getMyReview
    - `useCanReview(productId: string)` — useQuery with key ["can-review", productId], enabled when session exists, queryFn calls canReview
    - `useCreateReview(productId: string)` — useMutation, on success invalidate ["reviews", productId], ["my-review", productId], ["can-review", productId], toast.success("Review submitted")
    - `useUpdateReview(productId: string)` — useMutation, on success invalidate same keys, toast.success("Review updated")
    - `useDeleteReview(productId: string)` — useMutation, on success invalidate same keys, toast.success("Review deleted")
    All auth hooks use `useSession()` to get accessToken.

    **star-rating-display.tsx** — Read-only star display:
    - Props: `rating: number, count?: number, showCount?: boolean, size?: "sm" | "md"`
    - Render 5 stars using Lucide `Star` icon
    - Stars filled: `fill-yellow-400 text-yellow-400` for full stars, `text-zinc-300` for empty
    - Half-star support: if rating % 1 >= 0.5, that star gets partial fill (use `fill-yellow-200 text-yellow-400` as approximation per research)
    - Per user decision: "Classic filled yellow/gold stars with gray empty ones"
    - When showCount is true and count provided: show "4.2 (47 reviews)" text after stars
    - sm size: `size-3.5`, md size: `size-4`

    **star-rating-input.tsx** — Interactive star input:
    - Props: `value: number, onChange: (rating: number) => void, max?: number (default 5)`
    - Render clickable star buttons with hover preview state
    - On hover: fill stars up to hover position (yellow), on mouse leave: revert to value
    - On click: call onChange with star number
    - Each button has aria-label: "Rate {n} out of {max} stars"
    - Stars use `size-8` for larger click target in form context
    - Hidden input with name="rating" for form context
    - Use `focus:outline-none focus:ring-2 focus:ring-offset-2` for keyboard focus

    **verified-badge.tsx** — Verified purchase badge:
    - Per user decision: checkmark icon + "Verified Purchase" text
    - Use Lucide `CheckCircle` icon (size-3.5)
    - Text: "Verified Purchase" in `text-xs text-emerald-600` with `flex items-center gap-1`

    **review-item.tsx** — Single review display:
    - Per user decision: compact list layout with minimal dividers, NOT bordered cards
    - Display: display name, star rating (StarRatingDisplay), date, review text, verified badge
    - Per user decision: No avatar, no helpful count
    - Owner actions (edit/delete) shown as text links when isOwner is true
    - Layout: `border-b border-zinc-200 py-4 first:pt-0 last:border-0`
    - Display name as `font-medium text-zinc-900`, date as `text-xs text-zinc-500`
    - Review text as `whitespace-pre-line text-sm text-zinc-700`

    **review-list.tsx** — Review list with pagination:
    - Props: `productId: string, session: any`
    - Uses useProductReviews hook with page state starting at 1
    - Shows first 5 reviews, then "Load more" button to increment page
    - Actually accumulate reviews across pages (store all loaded reviews in state, append on load more)
    - At top of list: aggregate rating summary (StarRatingDisplay with count)
    - Per user decision: sorted by most recent first (API handles this)
    - Shows "Write a Review" button when user has purchased and hasn't reviewed yet (use useCanReview)
    - Shows "Purchase this product to leave a review" message for non-purchasers or unauthenticated
    - For review owner: show edit/delete buttons that trigger ReviewFormDialog (edit) or delete mutation
    - Empty state: "No reviews yet. Be the first to review this product."
    - Loading state: skeleton placeholders

    **review-form-dialog.tsx** — Modal dialog for create/edit:
    - Per user decision: "Write a Review" button opens modal dialog form
    - Uses shadcn-ui Dialog component (follow address-form-dialog.tsx pattern)
    - Props: `productId: string, existingReview?: ReviewDto, trigger: React.ReactNode, onSuccess?: () => void`
    - Controlled open state with useState
    - Form fields: StarRatingInput for rating, Textarea for review text
    - Per user decision: both star rating and text required
    - Per user decision: no review title field — just star rating + review text
    - Character counter: show "{text.length}/1000 characters" below textarea
    - Client-side validation: rating must be > 0, text 10-1000 characters
    - Error display: red text below each field
    - Submit uses useCreateReview or useUpdateReview depending on existingReview
    - On success: close dialog, reset form state
    - Button label: "Submit Review" for create, "Update Review" for edit
    - Loading state: button shows "Saving..." and is disabled during mutation
    - Dialog title: "Write a Review" for create, "Edit Review" for edit
  </action>
  <verify>
    1. `cd src/MicroCommerce.Web && npx tsc --noEmit` — 0 type errors
    2. All component files exist in src/MicroCommerce.Web/src/components/reviews/
    3. API functions exist in api.ts
    4. Hooks exist in use-reviews.ts
  </verify>
  <done>Review component library complete with star rating display/input, review items, paginated list with load more, modal form dialog with validation and character counter. All API functions and TanStack Query hooks created. ProductDto interface includes averageRating and reviewCount.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate reviews into product detail, product cards, and order detail</name>
  <files>
    src/MicroCommerce.Web/src/components/storefront/product-detail.tsx
    src/MicroCommerce.Web/src/components/storefront/product-card.tsx
    src/MicroCommerce.Web/src/components/storefront/order-detail.tsx
  </files>
  <action>
    **product-detail.tsx** — Add reviews section:
    - Import ReviewList and StarRatingDisplay components
    - In the product info section (right column), add aggregate rating display below the product name:
      - If product has reviews (reviewCount > 0): Show `<StarRatingDisplay rating={product.averageRating} count={product.reviewCount} />`
      - If no reviews: show "No reviews yet" in muted text
    - Below the existing product content (after RelatedProducts), add a Reviews section:
      - Section heading: "Customer Reviews" as `text-xl font-semibold`
      - Render `<ReviewList productId={productId} />` component
      - The ReviewList handles all review logic (display, pagination, submission button, form dialog)
    - Note: ProductDto already has averageRating and reviewCount from Task 1's api.ts update. Verify the product state uses the updated type.

    **product-card.tsx** — Add aggregate rating display:
    - Import StarRatingDisplay component
    - Per user decision: "Product cards on browse/listing pages also show stars + count below product name"
    - Below the product name link, conditionally render:
      - If `product.reviewCount > 0`: `<StarRatingDisplay rating={product.averageRating} count={product.reviewCount} size="sm" />`
      - If no reviews: nothing (clean card)
    - Use compact layout — small stars (size="sm") with minimal vertical spacing
    - Note: ProductDto needs averageRating and reviewCount. These were added to the interface in api.ts in Task 1. Verify the product data from API now includes these fields.

    **order-detail.tsx** — Add review links per purchased item:
    - Per user decision: review accessible from "order history (review link per purchased item)"
    - For each order item in the order detail view, add a "Write a Review" link
    - The link navigates to `/products/{productId}#reviews` (anchor to reviews section on product detail page)
    - Only show the link if order status is Paid, Confirmed, Shipped, or Delivered (not for Failed/Submitted orders)
    - Use Lucide `Star` or `MessageSquare` icon + "Write a Review" text link in `text-sm text-blue-600 hover:underline`
    - Style: add the link inline with or below each order item's info
  </action>
  <verify>
    1. `cd src/MicroCommerce.Web && npx tsc --noEmit` — 0 type errors
    2. product-detail.tsx imports and renders ReviewList and StarRatingDisplay
    3. product-card.tsx imports and conditionally renders StarRatingDisplay
    4. order-detail.tsx has review links per order item
  </verify>
  <done>Product detail page shows aggregate rating in header and full review section with list, pagination, and submission. Product cards show stars and count below product name. Order detail page has "Write a Review" links for purchased items. All TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `cd src/MicroCommerce.Web && npx tsc --noEmit` — 0 type errors
2. Product detail page shows aggregate stars + count in product info area
3. Product detail page has "Customer Reviews" section with ReviewList
4. ReviewList shows reviews with display name, stars, date, text, verified badge
5. "Load more" button appears when more than 5 reviews exist
6. "Write a Review" button appears for authenticated purchasers, opens modal
7. Modal has star input with hover, textarea with character counter, validation
8. User can edit/delete own review from review list
9. Non-purchasers see "Purchase this product to leave a review"
10. Product cards show aggregate rating below product name
11. Order detail page shows review links per item
</verification>

<success_criteria>
- Complete review UI following all locked user decisions (compact list, yellow stars, modal form, verified badge, character counter)
- All review operations accessible through frontend: create, edit, delete, browse
- Aggregate ratings visible on both product detail and product card views
- Review links accessible from order history
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-product-reviews-ratings/12-03-SUMMARY.md`
</output>
