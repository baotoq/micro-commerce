---
phase: 12-product-reviews-ratings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Reviews/Domain/Entities/Review.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Domain/ValueObjects/ReviewId.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Domain/ValueObjects/Rating.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Domain/ValueObjects/ReviewText.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Domain/Events/ReviewCreatedDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Domain/Events/ReviewUpdatedDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Domain/Events/ReviewDeletedDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/ReviewsDbContext.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/Configurations/ReviewConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "Review entity exists as aggregate root with Rating (1-5) and ReviewText (10-1000 chars)"
    - "ReviewsDbContext with 'reviews' schema isolation is registered and migrations applied"
    - "Composite unique index on (UserId, ProductId) prevents duplicate reviews"
    - "Product entity has AverageRating and ReviewCount properties for denormalized aggregates"
    - "Domain events exist for review create, update, and delete"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Reviews/Domain/Entities/Review.cs"
      provides: "Review aggregate root"
      contains: "BaseAggregateRoot"
    - path: "src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/ReviewsDbContext.cs"
      provides: "Reviews database context"
      contains: "reviews"
    - path: "src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/Configurations/ReviewConfiguration.cs"
      provides: "EF Core entity configuration with unique constraint"
      contains: "IsUnique"
    - path: "src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs"
      provides: "Product with aggregate rating fields"
      contains: "AverageRating"
  key_links:
    - from: "ReviewsDbContext"
      to: "Program.cs"
      via: "AddNpgsqlDbContext registration"
      pattern: "ReviewsDbContext"
    - from: "ReviewConfiguration"
      to: "Review entity"
      via: "EF Core configuration"
      pattern: "UserId.*ProductId.*IsUnique"
---

<objective>
Create the Reviews backend foundation: domain model (Review aggregate root, value objects, domain events), infrastructure (ReviewsDbContext, EF configurations, migration), and extend the Product entity with denormalized AverageRating and ReviewCount fields.

Purpose: Establish the data layer and domain model that all review operations depend on. Without this foundation, no review CRUD or display is possible.
Output: Review domain model, ReviewsDbContext with migration, Product entity extended with rating fields.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-product-reviews-ratings/12-RESEARCH.md

Key reference files for following existing patterns:
@src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs
@src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/ProfilesDbContext.cs
@src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
@src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
@src/MicroCommerce.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reviews domain model (aggregate root, value objects, domain events)</name>
  <files>
    src/MicroCommerce.ApiService/Features/Reviews/Domain/Entities/Review.cs
    src/MicroCommerce.ApiService/Features/Reviews/Domain/ValueObjects/ReviewId.cs
    src/MicroCommerce.ApiService/Features/Reviews/Domain/ValueObjects/Rating.cs
    src/MicroCommerce.ApiService/Features/Reviews/Domain/ValueObjects/ReviewText.cs
    src/MicroCommerce.ApiService/Features/Reviews/Domain/Events/ReviewCreatedDomainEvent.cs
    src/MicroCommerce.ApiService/Features/Reviews/Domain/Events/ReviewUpdatedDomainEvent.cs
    src/MicroCommerce.ApiService/Features/Reviews/Domain/Events/ReviewDeletedDomainEvent.cs
    src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
    src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
  </files>
  <action>
    Create the Reviews feature domain model following existing DDD patterns (see UserProfile.cs, Product.cs):

    **ReviewId.cs** — Strongly-typed ID:
    ```csharp
    public sealed record ReviewId(Guid Value) : StronglyTypedId<Guid>(Value)
    {
        public static ReviewId New() => new(Guid.NewGuid());
    }
    ```

    **Rating.cs** — Value object with validation (1-5):
    ```csharp
    public sealed record Rating
    {
        public int Value { get; }
        private Rating(int value) => Value = value;
        public static Rating Create(int value)
        {
            if (value < 1 || value > 5)
                throw new ArgumentOutOfRangeException(nameof(value), "Rating must be between 1 and 5.");
            return new Rating(value);
        }
    }
    ```

    **ReviewText.cs** — Value object with validation (10-1000 chars):
    ```csharp
    public sealed record ReviewText
    {
        public string Value { get; }
        private ReviewText(string value) => Value = value;
        public static ReviewText Create(string value)
        {
            ArgumentException.ThrowIfNullOrWhiteSpace(value);
            var trimmed = value.Trim();
            if (trimmed.Length < 10)
                throw new ArgumentException("Review text must be at least 10 characters.", nameof(value));
            if (trimmed.Length > 1000)
                throw new ArgumentException("Review text must not exceed 1000 characters.", nameof(value));
            return new ReviewText(trimmed);
        }
    }
    ```

    **Review.cs** — Aggregate root following existing BaseAggregateRoot pattern:
    - Properties: ProductId (Guid), UserId (Guid), Rating (Rating VO), Text (ReviewText VO), CreatedAt, UpdatedAt
    - PostgreSQL xmin concurrency token ([Timestamp] public uint Version)
    - Private constructor for EF Core
    - Factory method: `Review.Create(Guid productId, Guid userId, int rating, string text)` — creates Review, raises ReviewCreatedDomainEvent
    - `Update(int rating, string text)` method — updates Rating and Text, sets UpdatedAt, raises ReviewUpdatedDomainEvent
    - `MarkDeleted()` method — raises ReviewDeletedDomainEvent (or raise event in handler before delete)
    - NOTE: The domain events should carry ProductId so consumers can recalculate aggregates. Use thin events: `record ReviewCreatedDomainEvent(Guid ReviewId, Guid ProductId)`

    **Domain Events** — Three thin domain events:
    - ReviewCreatedDomainEvent(Guid ReviewId, Guid ProductId)
    - ReviewUpdatedDomainEvent(Guid ReviewId, Guid ProductId)
    - ReviewDeletedDomainEvent(Guid ReviewId, Guid ProductId)
    All implement IDomainEvent (from BuildingBlocks.Common).

    **Product.cs** — Add two new properties to the existing Product aggregate:
    ```csharp
    public decimal? AverageRating { get; private set; }
    public int ReviewCount { get; private set; }

    public void UpdateReviewStats(decimal? averageRating, int reviewCount)
    {
        AverageRating = averageRating;
        ReviewCount = reviewCount;
    }
    ```

    **ProductConfiguration.cs** — Add column mappings for the new properties:
    ```csharp
    builder.Property(p => p.AverageRating)
        .HasPrecision(3, 2);  // e.g., 4.25

    builder.Property(p => p.ReviewCount)
        .HasDefaultValue(0);
    ```
  </action>
  <verify>Run `dotnet build src/MicroCommerce.ApiService` — must compile with 0 errors.</verify>
  <done>Review aggregate root exists with Rating/ReviewText value objects, domain events, and Product entity has AverageRating/ReviewCount properties. Project compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create ReviewsDbContext, EF configuration, and database migrations</name>
  <files>
    src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/ReviewsDbContext.cs
    src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/Configurations/ReviewConfiguration.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    Create Reviews infrastructure following existing patterns (see ProfilesDbContext.cs, OrderingDbContext.cs):

    **ReviewsDbContext.cs** — Dedicated DbContext with 'reviews' schema:
    ```csharp
    public class ReviewsDbContext : DbContext
    {
        public ReviewsDbContext(DbContextOptions<ReviewsDbContext> options) : base(options) { }
        public DbSet<Review> Reviews => Set<Review>();
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            modelBuilder.HasDefaultSchema("reviews");
            modelBuilder.ApplyConfigurationsFromAssembly(
                typeof(ReviewsDbContext).Assembly,
                t => t.Namespace?.Contains("Features.Reviews") == true);
        }
    }
    ```

    **ReviewConfiguration.cs** — EF Core entity configuration:
    - HasKey on Id with ReviewId conversion (id => id.Value, value => new ReviewId(value)), ValueGeneratedNever
    - **Composite unique index**: `builder.HasIndex(r => new { r.UserId, r.ProductId }).IsUnique()` — enforces one review per user per product at DB level
    - Index on ProductId (for listing reviews by product)
    - Index on CreatedAt descending (for chronological sort: `.IsDescending()`)
    - OwnsOne for Rating value object: `rating.Property(r => r.Value).HasColumnName("Rating").IsRequired()`
    - OwnsOne for ReviewText (Text property): `text.Property(t => t.Value).HasColumnName("ReviewText").HasMaxLength(1000).IsRequired()`
    - Property Version mapped to xmin row version: `builder.Property(r => r.Version).IsRowVersion()`
    - Ignore DomainEvents: `builder.Ignore(r => r.DomainEvents)`
    - CreatedAt and UpdatedAt as required

    **Program.cs** — Add ReviewsDbContext registration after ProfilesDbContext:
    ```csharp
    builder.AddNpgsqlDbContext<ReviewsDbContext>("appdb", configureDbContextOptions: options =>
    {
        options.UseNpgsql(npgsql =>
            npgsql.MigrationsHistoryTable("__EFMigrationsHistory", "reviews"));
    });
    ```
    Add the `using MicroCommerce.ApiService.Features.Reviews.Infrastructure;` import.

    **Generate migrations:**
    1. Reviews migration: `dotnet ef migrations add InitialReviews --project src/MicroCommerce.ApiService --context ReviewsDbContext --output-dir Features/Reviews/Infrastructure/Migrations`
    2. Catalog migration for AverageRating/ReviewCount: `dotnet ef migrations add AddProductReviewStats --project src/MicroCommerce.ApiService --context CatalogDbContext --output-dir Features/Catalog/Infrastructure/Migrations`
  </action>
  <verify>
    1. `dotnet build src/MicroCommerce.ApiService` — 0 errors
    2. Verify migration files exist in Features/Reviews/Infrastructure/Migrations/ and Features/Catalog/Infrastructure/Migrations/
    3. Verify ReviewsDbContext is registered in Program.cs
  </verify>
  <done>ReviewsDbContext registered with 'reviews' schema isolation, ReviewConfiguration has composite unique index on (UserId, ProductId), both migrations generated successfully, project compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService` compiles with 0 errors
2. Review.cs extends BaseAggregateRoot with factory method and Update method
3. Rating value object validates 1-5 range
4. ReviewText value object validates 10-1000 character range
5. ReviewConfiguration has composite unique index on (UserId, ProductId)
6. Product.cs has AverageRating (decimal?) and ReviewCount (int) properties
7. ReviewsDbContext is registered in Program.cs with 'reviews' schema
8. Migration files exist for both Reviews and Catalog changes
</verification>

<success_criteria>
- Review domain model fully implements DDD aggregate pattern with value objects
- Database schema supports one-review-per-user-per-product constraint
- Product entity extended with denormalized rating fields
- All migrations generated and project compiles
</success_criteria>

<output>
After completion, create `.planning/phases/12-product-reviews-ratings/12-01-SUMMARY.md`
</output>
