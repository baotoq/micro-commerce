---
phase: 12-product-reviews-ratings
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/CreateReview/CreateReviewCommand.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/CreateReview/CreateReviewCommandValidator.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/UpdateReview/UpdateReviewCommand.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/UpdateReview/UpdateReviewCommandValidator.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/DeleteReview/DeleteReviewCommand.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/GetReviewsByProduct/GetReviewsByProductQuery.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/GetUserReviewForProduct/GetUserReviewForProductQuery.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/CheckUserPurchased/CheckUserPurchasedQuery.cs
  - src/MicroCommerce.ApiService/Features/Reviews/ReviewsEndpoints.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/ProductDto.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProductById/GetProductByIdQueryHandler.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "Authenticated user can create a review for a product they purchased"
    - "Review creation is blocked if user has not purchased the product"
    - "One review per product per user is enforced (duplicate returns conflict)"
    - "User can update their own review's rating and text"
    - "User can delete their own review"
    - "Reviews are returned paginated (5 per page) sorted by newest first"
    - "Product aggregate ratings are recalculated after create/update/delete"
    - "ProductDto includes averageRating and reviewCount fields"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Reviews/ReviewsEndpoints.cs"
      provides: "REST API for reviews"
      contains: "MapReviewsEndpoints"
    - path: "src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/CreateReview/CreateReviewCommand.cs"
      provides: "Create review with purchase verification"
      contains: "CreateReviewCommand"
    - path: "src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/GetReviewsByProduct/GetReviewsByProductQuery.cs"
      provides: "Paginated review listing"
      contains: "GetReviewsByProductQuery"
  key_links:
    - from: "ReviewsEndpoints"
      to: "Program.cs"
      via: "MapReviewsEndpoints registration"
      pattern: "MapReviewsEndpoints"
    - from: "CreateReviewCommandHandler"
      to: "OrderingDbContext"
      via: "Purchase verification query"
      pattern: "OrderingDbContext"
    - from: "CreateReviewCommandHandler"
      to: "CatalogDbContext"
      via: "Aggregate rating recalculation"
      pattern: "UpdateReviewStats"
---

<objective>
Create the complete Reviews CQRS application layer: commands (create, update, delete), queries (list by product, get user review, check purchase), validators, API endpoints, aggregate rating recalculation, and extend Catalog ProductDto to include rating data.

Purpose: Expose the review system through REST API endpoints so the frontend can perform all review operations. This is the business logic layer connecting domain to HTTP.
Output: Full CQRS handlers with validators, REST endpoints, purchase verification, aggregate rating updates, and extended ProductDto.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-product-reviews-ratings/12-RESEARCH.md
@.planning/phases/12-product-reviews-ratings/12-01-SUMMARY.md

Key reference files:
@src/MicroCommerce.ApiService/Features/Profiles/ProfilesEndpoints.cs
@src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateProfile/UpdateProfileCommand.cs
@src/MicroCommerce.ApiService/Features/Profiles/Application/Commands/UpdateProfile/UpdateProfileCommandValidator.cs
@src/MicroCommerce.ApiService/Features/Profiles/Application/Queries/GetProfile/GetProfileQuery.cs
@src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs
@src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/ProductDto.cs
@src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs
@src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProductById/GetProductByIdQueryHandler.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CQRS commands, queries, validators, and aggregate rating recalculation</name>
  <files>
    src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/CreateReview/CreateReviewCommand.cs
    src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/CreateReview/CreateReviewCommandValidator.cs
    src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/UpdateReview/UpdateReviewCommand.cs
    src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/UpdateReview/UpdateReviewCommandValidator.cs
    src/MicroCommerce.ApiService/Features/Reviews/Application/Commands/DeleteReview/DeleteReviewCommand.cs
    src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/GetReviewsByProduct/GetReviewsByProductQuery.cs
    src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/GetUserReviewForProduct/GetUserReviewForProductQuery.cs
    src/MicroCommerce.ApiService/Features/Reviews/Application/Queries/CheckUserPurchased/CheckUserPurchasedQuery.cs
    src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/ProductDto.cs
    src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs
    src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProductById/GetProductByIdQueryHandler.cs
  </files>
  <action>
    Create all CQRS handlers following existing MediatR patterns (see Profiles commands/queries):

    **CreateReviewCommand.cs** — Command + handler in same file:
    - Record: `CreateReviewCommand(Guid UserId, Guid ProductId, int Rating, string Text) : IRequest<Guid>`
    - Handler injects ReviewsDbContext, OrderingDbContext, CatalogDbContext
    - Step 1: Verify purchase — query OrderingDbContext.Orders where BuyerId == UserId, Status is Paid/Confirmed/Shipped/Delivered, and any OrderItem has ProductId matching. If no match, throw InvalidOperationException("You must purchase this product before leaving a review.")
    - Step 2: Create Review via factory method `Review.Create(productId, userId, rating, text)`
    - Step 3: Add to ReviewsDbContext.Reviews, try SaveChangesAsync. Catch DbUpdateException with unique constraint violation → throw ConflictException or InvalidOperationException("You have already reviewed this product.")
    - Step 4: Recalculate aggregate ratings — query ReviewsDbContext.Reviews where ProductId matches, compute AVG(Rating.Value) and COUNT. Load Product from CatalogDbContext, call product.UpdateReviewStats(avg, count), save CatalogDbContext.
    - Return review.Id.Value

    **CreateReviewCommandValidator.cs** — FluentValidation:
    - Rating: InclusiveBetween(1, 5) with message "Rating must be between 1 and 5 stars."
    - Text: NotEmpty, MinimumLength(10) with message "Review must be at least 10 characters.", MaximumLength(1000) with message "Review must not exceed 1000 characters."
    - ProductId: NotEmpty
    - UserId: NotEmpty

    **UpdateReviewCommand.cs** — Command + handler:
    - Record: `UpdateReviewCommand(Guid UserId, Guid ReviewId, int Rating, string Text) : IRequest`
    - Handler: Load review by ReviewId from ReviewsDbContext, verify review.UserId == UserId (throw UnauthorizedAccessException if not owner), call review.Update(rating, text), save.
    - Recalculate aggregates same as Create (query reviews for ProductId, update Product).

    **UpdateReviewCommandValidator.cs** — Same validation as Create (Rating 1-5, Text 10-1000).

    **DeleteReviewCommand.cs** — Command + handler:
    - Record: `DeleteReviewCommand(Guid UserId, Guid ReviewId) : IRequest`
    - Handler: Load review by ReviewId, verify ownership. Store ProductId before delete. Remove from DbSet, SaveChanges.
    - Recalculate aggregates: if no reviews remain for product, set AverageRating to null and ReviewCount to 0.

    **GetReviewsByProductQuery.cs** — Query + handler + DTOs (all in one file):
    - Record: `GetReviewsByProductQuery(Guid ProductId, int Page = 1, int PageSize = 5) : IRequest<ReviewListDto>`
    - ReviewDto record: Id (Guid), UserId (Guid), DisplayName (string), Rating (int), Text (string), CreatedAt (DateTimeOffset), IsVerifiedPurchase (bool)
    - ReviewListDto record: Items (List<ReviewDto>), TotalCount (int), Page (int), PageSize (int)
    - Handler injects ReviewsDbContext, ProfilesDbContext, OrderingDbContext
    - Query reviews where ProductId matches, OrderByDescending CreatedAt, paginate with Skip/Take
    - For each review: look up display name from ProfilesDbContext (or use "User" default), determine IsVerifiedPurchase by checking OrderingDbContext
    - Optimization: batch the display name and verification lookups using .Where(x => userIds.Contains(x.UserId)) to avoid N+1
    - Return ReviewListDto with items, totalCount, page, pageSize

    **GetUserReviewForProductQuery.cs** — Query + handler:
    - Record: `GetUserReviewForProductQuery(Guid UserId, Guid ProductId) : IRequest<ReviewDto?>`
    - Handler: Query ReviewsDbContext for review where UserId and ProductId match
    - Return ReviewDto or null if no review exists

    **CheckUserPurchasedQuery.cs** — Query + handler:
    - Record: `CheckUserPurchasedQuery(Guid UserId, Guid ProductId) : IRequest<bool>`
    - Handler: Query OrderingDbContext.Orders where BuyerId == UserId, Status in (Paid, Confirmed, Shipped, Delivered), SelectMany Items, AnyAsync where ProductId matches

    **ProductDto.cs** — Extend the existing record:
    - Add two new parameters at the end: `decimal? AverageRating` and `int ReviewCount`
    - This is the existing `ProductDto` in `Features/Catalog/Application/Queries/GetProducts/ProductDto.cs`

    **GetProductsQueryHandler.cs** — Update Select projection:
    - Add `p.AverageRating` and `p.ReviewCount` to the ProductDto constructor call

    **GetProductByIdQueryHandler.cs** — Update Select projection:
    - Add `p.AverageRating` and `p.ReviewCount` to the ProductDto constructor call
  </action>
  <verify>Run `dotnet build src/MicroCommerce.ApiService` — must compile with 0 errors.</verify>
  <done>All CQRS handlers exist with purchase verification, one-review-per-user enforcement, aggregate recalculation, and ProductDto includes rating fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create ReviewsEndpoints and register in Program.cs</name>
  <files>
    src/MicroCommerce.ApiService/Features/Reviews/ReviewsEndpoints.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    Create ReviewsEndpoints following existing pattern (see ProfilesEndpoints.cs):

    **ReviewsEndpoints.cs** — Minimal API endpoints:
    ```csharp
    public static class ReviewsEndpoints
    {
        public static IEndpointRouteBuilder MapReviewsEndpoints(this IEndpointRouteBuilder endpoints)
        {
            var group = endpoints.MapGroup("/api/reviews").WithTags("Reviews");
            // Public endpoints (no auth required for reading)
            // Authenticated endpoints require authorization

            // GET /api/reviews/products/{productId} — Get reviews for a product (public)
            // Returns ReviewListDto with pagination (page, pageSize query params, default 5)
            group.MapGet("/products/{productId:guid}", GetProductReviews)
                .WithName("GetProductReviews")
                .WithSummary("Get reviews for a product")
                .Produces<ReviewListDto>();

            // GET /api/reviews/products/{productId}/mine — Get current user's review for a product (authenticated)
            group.MapGet("/products/{productId:guid}/mine", GetMyReview)
                .WithName("GetMyReview")
                .WithSummary("Get current user's review for a product")
                .RequireAuthorization()
                .Produces<ReviewDto>()
                .Produces(StatusCodes.Status404NotFound);

            // GET /api/reviews/products/{productId}/can-review — Check if user can review (authenticated)
            group.MapGet("/products/{productId:guid}/can-review", CanReview)
                .WithName("CanReview")
                .WithSummary("Check if user can review a product")
                .RequireAuthorization()
                .Produces<CanReviewDto>();

            // POST /api/reviews/products/{productId} — Create a review (authenticated)
            group.MapPost("/products/{productId:guid}", CreateReview)
                .WithName("CreateReview")
                .WithSummary("Submit a review for a purchased product")
                .RequireAuthorization()
                .Produces<CreateReviewResult>(StatusCodes.Status201Created)
                .ProducesValidationProblem()
                .ProducesProblem(StatusCodes.Status409Conflict);

            // PUT /api/reviews/{reviewId} — Update own review (authenticated)
            group.MapPut("/{reviewId:guid}", UpdateReview)
                .WithName("UpdateReview")
                .WithSummary("Update your review")
                .RequireAuthorization()
                .Produces(StatusCodes.Status204NoContent)
                .ProducesValidationProblem()
                .ProducesProblem(StatusCodes.Status404NotFound);

            // DELETE /api/reviews/{reviewId} — Delete own review (authenticated)
            group.MapDelete("/{reviewId:guid}", DeleteReview)
                .WithName("DeleteReview")
                .WithSummary("Delete your review")
                .RequireAuthorization()
                .Produces(StatusCodes.Status204NoContent)
                .ProducesProblem(StatusCodes.Status404NotFound);

            return endpoints;
        }
    }
    ```

    Endpoint handlers:
    - GetProductReviews: Extract productId from route, page/pageSize from query (defaults: page=1, pageSize=5). Send GetReviewsByProductQuery. Return Ok(result).
    - GetMyReview: Extract userId from JWT + productId from route. Send GetUserReviewForProductQuery. Return Ok(result) or NotFound if null.
    - CanReview: Extract userId + productId. Send CheckUserPurchasedQuery for hasPurchased. Also send GetUserReviewForProductQuery for hasReviewed. Return `CanReviewDto(hasPurchased, hasReviewed: existingReview != null)`.
    - CreateReview: Extract userId + productId. Send CreateReviewCommand. Return Created with review ID.
    - UpdateReview: Extract userId + reviewId. Send UpdateReviewCommand. Return NoContent.
    - DeleteReview: Extract userId + reviewId. Send DeleteReviewCommand. Return NoContent.

    Include GetUserId helper (same pattern as ProfilesEndpoints — extract from ClaimTypes.NameIdentifier or "sub" claim).

    Request/response records in same file:
    - `CreateReviewRequest(int Rating, string Text)`
    - `UpdateReviewRequest(int Rating, string Text)`
    - `CreateReviewResult(Guid Id)`
    - `CanReviewDto(bool HasPurchased, bool HasReviewed)`

    **Program.cs** — Add:
    - `using MicroCommerce.ApiService.Features.Reviews;`
    - `app.MapReviewsEndpoints();` after MapProfilesEndpoints()
  </action>
  <verify>
    1. `dotnet build src/MicroCommerce.ApiService` — 0 errors
    2. Verify MapReviewsEndpoints() is called in Program.cs
    3. Verify all 6 endpoints are defined in ReviewsEndpoints.cs
  </verify>
  <done>ReviewsEndpoints registered with 6 REST API endpoints (list, get-mine, can-review, create, update, delete). GetUserId helper extracts JWT claims. Purchase verification gates review creation. Aggregate ratings recalculated on CUD operations. ProductDto includes averageRating and reviewCount.</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService` compiles with 0 errors
2. GET /api/reviews/products/{id} returns paginated reviews sorted newest first
3. POST /api/reviews/products/{id} requires auth and purchase verification
4. PUT /api/reviews/{id} requires auth and ownership check
5. DELETE /api/reviews/{id} requires auth and ownership check
6. GET /api/reviews/products/{id}/can-review returns purchase and review status
7. GET /api/reviews/products/{id}/mine returns user's review or 404
8. ProductDto record includes AverageRating and ReviewCount parameters
9. GetProductsQueryHandler and GetProductByIdQueryHandler project AverageRating and ReviewCount
</verification>

<success_criteria>
- All review CQRS operations work through MediatR pipeline with FluentValidation
- Purchase verification prevents non-purchasers from submitting reviews
- Unique constraint prevents duplicate reviews (one per user per product)
- Aggregate ratings recalculated synchronously after each CUD operation
- ProductDto extended with rating fields for frontend consumption
</success_criteria>

<output>
After completion, create `.planning/phases/12-product-reviews-ratings/12-02-SUMMARY.md`
</output>
