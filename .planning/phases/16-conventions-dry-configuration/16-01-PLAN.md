---
phase: 16-conventions-dry-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Common/Persistence/Conventions/StronglyTypedIdConvention.cs
  - src/MicroCommerce.ApiService/Common/Persistence/Conventions/AuditableConvention.cs
  - src/MicroCommerce.ApiService/Common/Persistence/Conventions/ConcurrencyTokenConvention.cs
  - src/MicroCommerce.ApiService/Common/Persistence/Conventions/SoftDeletableConvention.cs
  - src/MicroCommerce.ApiService/Common/Persistence/BaseDbContext.cs
  - src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs
  - src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs
  - src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj
  - src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDbContext.cs
  - src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartDbContext.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
  - src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDbContext.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/ProfilesDbContext.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/ReviewsDbContext.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/WishlistsDbContext.cs
  - src/MicroCommerce.ApiService/Common/Persistence/OutboxDbContext.cs
autonomous: true

must_haves:
  truths:
    - "All 8 DbContexts inherit from BaseDbContext and automatically get all conventions"
    - "StronglyTypedId properties are automatically detected and configured with value converters without manual HasConversion"
    - "IConcurrencyToken entities automatically get IsConcurrencyToken on Version property"
    - "ISoftDeletable entities automatically get query filter excluding deleted records"
    - "IAuditable entities automatically get timestamp with time zone column type configuration"
    - "snake_case naming convention applies to all tables and columns via EFCore.NamingConventions"
    - "Phase 15 static convention helpers (ConcurrencyTokenConvention.cs, SoftDeleteQueryFilterConvention.cs) are replaced by IModelFinalizingConvention implementations"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Common/Persistence/Conventions/StronglyTypedIdConvention.cs"
      provides: "Auto value converter for all StronglyTypedId<T> properties"
      contains: "IModelFinalizingConvention"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/Conventions/AuditableConvention.cs"
      provides: "Auto column type for IAuditable timestamps"
      contains: "IModelFinalizingConvention"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/Conventions/ConcurrencyTokenConvention.cs"
      provides: "Auto concurrency token marking for IConcurrencyToken"
      contains: "IModelFinalizingConvention"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/Conventions/SoftDeletableConvention.cs"
      provides: "Auto query filter for ISoftDeletable"
      contains: "IModelFinalizingConvention"
    - path: "src/MicroCommerce.ApiService/Common/Persistence/BaseDbContext.cs"
      provides: "Shared base class registering all conventions and snake_case naming"
      contains: "abstract class BaseDbContext"
  key_links:
    - from: "src/MicroCommerce.ApiService/Common/Persistence/BaseDbContext.cs"
      to: "Conventions/*.cs"
      via: "ConfigureConventions registration"
      pattern: "configurationBuilder\\.Conventions\\.Add"
    - from: "src/MicroCommerce.ApiService/Features/*/Infrastructure/*DbContext.cs"
      to: "BaseDbContext"
      via: "class inheritance"
      pattern: ": BaseDbContext"
    - from: "src/MicroCommerce.ApiService/Common/Persistence/BaseDbContext.cs"
      to: "EFCore.NamingConventions"
      via: "UseSnakeCaseNamingConvention in OnConfiguring"
      pattern: "UseSnakeCaseNamingConvention"
---

<objective>
Create EF Core model conventions and a shared BaseDbContext that all feature DbContexts inherit, eliminating repetitive configuration boilerplate.

Purpose: This is the foundation for Phase 16 - conventions must exist and be registered before configuration cleanup can happen in Plan 02. Converts Phase 15's static convention helpers into proper IModelFinalizingConvention implementations and adds new conventions for StronglyTypedId and IAuditable.

Output: 4 convention classes in Conventions/ folder, BaseDbContext with convention registration and snake_case naming, all 8 DbContexts migrated to inherit BaseDbContext, Phase 15 static helpers deleted.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-conventions-dry-configuration/16-CONTEXT.md
@.planning/phases/16-conventions-dry-configuration/16-RESEARCH.md
@.planning/phases/15-foundation-entity-base-audit-infrastructure/15-01-SUMMARY.md
@.planning/phases/15-foundation-entity-base-audit-infrastructure/15-02-SUMMARY.md

@src/BuildingBlocks/BuildingBlocks.Common/StronglyTypedId.cs
@src/BuildingBlocks/BuildingBlocks.Common/IAuditable.cs
@src/BuildingBlocks/BuildingBlocks.Common/IConcurrencyToken.cs
@src/BuildingBlocks/BuildingBlocks.Common/ISoftDeletable.cs
@src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs
@src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs
@src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IModelFinalizingConvention implementations and BaseDbContext</name>
  <files>
    src/MicroCommerce.ApiService/Common/Persistence/Conventions/StronglyTypedIdConvention.cs
    src/MicroCommerce.ApiService/Common/Persistence/Conventions/AuditableConvention.cs
    src/MicroCommerce.ApiService/Common/Persistence/Conventions/ConcurrencyTokenConvention.cs
    src/MicroCommerce.ApiService/Common/Persistence/Conventions/SoftDeletableConvention.cs
    src/MicroCommerce.ApiService/Common/Persistence/BaseDbContext.cs
    src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj
  </files>
  <action>
    Install EFCore.NamingConventions package:
    ```
    dotnet add src/MicroCommerce.ApiService package EFCore.NamingConventions
    ```

    Create directory `src/MicroCommerce.ApiService/Common/Persistence/Conventions/`.

    **Create `StronglyTypedIdConvention.cs`** implementing `IModelFinalizingConvention`:
    - In `ProcessModelFinalizing`, iterate all entity types and their properties
    - For each property, check if `property.ClrType` inherits from `StronglyTypedId<T>` (use reflection: check if type's base type is generic and its generic type definition equals `typeof(StronglyTypedId<>)`)
    - If yes, extract the underlying type `T` from the generic argument
    - Create a `ValueConverter` dynamically using `Expression.Lambda`:
      - `toProvider`: `id => id.Value` (access the Value property)
      - `fromProvider`: `value => new ConcreteIdType(value)` (call the constructor)
    - Apply converter via `property.Builder.HasConversion(converter)`
    - Use `System.Linq.Expressions` for the expression tree building
    - IMPORTANT: StronglyTypedId<T> is abstract record, NOT a generic type itself on properties. Properties are concrete types like ProductId which inherit StronglyTypedId<Guid>. Detection must walk the base type chain.
    - Namespace: `MicroCommerce.ApiService.Common.Persistence.Conventions`
    - Follow codebase conventions: file-scoped namespace, explicit types (no var), sealed class

    **Create `AuditableConvention.cs`** implementing `IModelFinalizingConvention`:
    - Check if entity's ClrType implements `IAuditable` via `typeof(IAuditable).IsAssignableFrom(entityType.ClrType)`
    - Find `CreatedAt` and `UpdatedAt` properties via `entityType.FindProperty()`
    - For each, call `.Builder.HasColumnType("timestamp with time zone")` and `.IsRequired(true)`
    - Sealed class, file-scoped namespace

    **Create `ConcurrencyTokenConvention.cs`** (NEW, replaces the Phase 15 static helper):
    - Implements `IModelFinalizingConvention` (NOT a static extension method)
    - Check if entity implements `IConcurrencyToken`
    - Find `Version` property, set `versionProperty.Builder.IsConcurrencyToken(true)`
    - Sealed class, file-scoped namespace
    - Note: This replaces `src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs` (the static helper from Phase 15). The NEW convention goes in the Conventions/ subfolder.

    **Create `SoftDeletableConvention.cs`** (NEW, replaces the Phase 15 static helper):
    - Implements `IModelFinalizingConvention`
    - Check if entity implements `ISoftDeletable`
    - Skip entities with `entityType.BaseType != null` (avoid duplicate filters in inheritance)
    - Use reflection to call a generic helper method `SetSoftDeleteFilter<TEntity>` that creates `Expression<Func<TEntity, bool>> filter = e => !e.IsDeleted` and calls `entityType.SetQueryFilter(filter)`
    - Sealed class, file-scoped namespace

    **Create `BaseDbContext.cs`**:
    - Abstract class inheriting `DbContext` in namespace `MicroCommerce.ApiService.Common.Persistence`
    - Constructor: `protected BaseDbContext(DbContextOptions options) : base(options) { }`
    - Override `ConfigureConventions(ModelConfigurationBuilder configurationBuilder)`:
      - Call `base.ConfigureConventions(configurationBuilder)` first
      - Register conventions in order (property-level first, entity-level last):
        1. `configurationBuilder.Conventions.Add(_ => new StronglyTypedIdConvention());`
        2. `configurationBuilder.Conventions.Add(_ => new AuditableConvention());`
        3. `configurationBuilder.Conventions.Add(_ => new ConcurrencyTokenConvention());`
        4. `configurationBuilder.Conventions.Add(_ => new SoftDeletableConvention());`
    - Override `OnConfiguring(DbContextOptionsBuilder optionsBuilder)`:
      - Call `base.OnConfiguring(optionsBuilder)` first
      - Call `optionsBuilder.UseSnakeCaseNamingConvention()` (from EFCore.NamingConventions package)
    - Use `using EFCore.NamingConventions` (or appropriate namespace from the package)
    - File-scoped namespace, explicit types
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService` and confirm zero errors.
    Verify all 5 new files exist:
    - `ls src/MicroCommerce.ApiService/Common/Persistence/Conventions/`
    - `ls src/MicroCommerce.ApiService/Common/Persistence/BaseDbContext.cs`
    Confirm EFCore.NamingConventions appears in csproj:
    - `grep NamingConventions src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj`
  </verify>
  <done>
    4 convention classes created implementing IModelFinalizingConvention. BaseDbContext created with all conventions registered and snake_case naming enabled. EFCore.NamingConventions package installed. Solution builds with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all DbContexts to inherit BaseDbContext and remove Phase 15 static helpers</name>
  <files>
    src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/CatalogDbContext.cs
    src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartDbContext.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
    src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDbContext.cs
    src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/ProfilesDbContext.cs
    src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/ReviewsDbContext.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/WishlistsDbContext.cs
    src/MicroCommerce.ApiService/Common/Persistence/OutboxDbContext.cs
    src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs
    src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs
  </files>
  <action>
    **Migrate all 8 DbContexts** from `: DbContext` to `: BaseDbContext`:

    For each DbContext (CatalogDbContext, CartDbContext, OrderingDbContext, InventoryDbContext, ProfilesDbContext, ReviewsDbContext, WishlistsDbContext, OutboxDbContext):
    1. Change `public class XxxDbContext : DbContext` to `public class XxxDbContext : BaseDbContext`
    2. Add `using MicroCommerce.ApiService.Common.Persistence;` if not present
    3. Keep constructor as-is: `public XxxDbContext(DbContextOptions<XxxDbContext> options) : base(options) { }`
    4. Keep existing `OnModelCreating` override with `base.OnModelCreating(modelBuilder)`, schema setting, and `ApplyConfigurationsFromAssembly` -- do NOT change these
    5. Do NOT add any convention calls to individual DbContexts -- BaseDbContext handles everything

    **Delete Phase 15 static convention helpers** (replaced by IModelFinalizingConvention in Conventions/ folder):
    - Delete `src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs` (the static extension method version)
    - Delete `src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs` (the static extension method version)
    - These are NOT called anywhere in the codebase currently (confirmed by grep), so deletion is safe

    **Verify no remaining references** to the deleted helpers:
    - Search for `ApplyConcurrencyTokenConvention` and `ApplySoftDeleteQueryFilters` -- should have zero matches after deletion

    IMPORTANT: The `AddNpgsqlDbContext` registrations in Program.cs use `DbContextOptions` which works with base class constructors. No changes to Program.cs needed for this task.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService` and confirm zero errors.
    Verify all 8 DbContexts inherit BaseDbContext:
    - `grep -r ": BaseDbContext" src/MicroCommerce.ApiService/ --include="*.cs"`
    Verify Phase 15 static helpers are deleted:
    - Confirm `src/MicroCommerce.ApiService/Common/Persistence/ConcurrencyTokenConvention.cs` does NOT exist
    - Confirm `src/MicroCommerce.ApiService/Common/Persistence/SoftDeleteQueryFilterConvention.cs` does NOT exist
    Run unit tests: `dotnet test src/MicroCommerce.ApiService.Tests --filter FullyQualifiedName~Unit` -- all should pass
  </verify>
  <done>
    All 8 DbContexts inherit BaseDbContext and automatically receive StronglyTypedId, IAuditable, IConcurrencyToken, ISoftDeletable conventions and snake_case naming. Phase 15 static convention helpers deleted. Build passes with zero errors. All unit tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService` -- zero errors
2. `grep -r ": BaseDbContext" src/MicroCommerce.ApiService/ --include="*.cs"` -- returns 8 DbContexts
3. `ls src/MicroCommerce.ApiService/Common/Persistence/Conventions/` -- shows 4 convention files
4. `dotnet test src/MicroCommerce.ApiService.Tests --filter FullyQualifiedName~Unit` -- all pass
5. Phase 15 static helpers no longer exist
</verification>

<success_criteria>
- All 8 DbContexts inherit from BaseDbContext
- 4 IModelFinalizingConvention classes exist in Conventions/ folder
- EFCore.NamingConventions package installed and enabled
- Phase 15 static convention helpers deleted (replaced by proper conventions)
- Solution builds with zero errors
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-conventions-dry-configuration/16-01-SUMMARY.md`
</output>
