---
phase: 16-conventions-dry-configuration
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/CategoryConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartItemConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderItemConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/CheckoutStateConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockItemConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockReservationConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockAdjustmentConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/Configurations/ReviewConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/Configurations/WishlistItemConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
  - src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs
autonomous: true

must_haves:
  truths:
    - "No entity configuration file contains manual HasConversion for StronglyTypedId properties (convention handles it)"
    - "No entity configuration file contains .IsRowVersion() or .IsConcurrencyToken() for Version property (convention handles it)"
    - "No entity configuration file contains .ToTable() with PascalCase table name (snake_case convention handles naming)"
    - "ValueObject base class is deleted from BuildingBlocks.Common with zero remaining references in codebase"
    - "EF Core migrations generated for all affected DbContexts reflecting convention changes"
    - "Entity configuration files that became empty/near-empty after cleanup are deleted"
    - "Build compiles with zero errors and all unit tests pass after all changes"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs"
      provides: "Catalog product config with only domain-specific config (relationships, indexes, value objects)"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs"
      provides: "Ordering config with only domain-specific config (owned types, relationships, indexes)"
  key_links:
    - from: "Entity configuration files"
      to: "BaseDbContext conventions"
      via: "Convention auto-applies, explicit config removed"
      pattern: "No HasConversion.*StronglyTypedId"
    - from: "src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs"
      to: "nowhere"
      via: "File deleted"
      pattern: "ValueObject"
---

<objective>
Clean up all 13 entity configuration files by removing redundant manual configuration that conventions now handle, delete the obsolete ValueObject base class, and generate EF Core migrations.

Purpose: Conventions from Plan 01 now automatically handle StronglyTypedId conversions, IConcurrencyToken marking, ISoftDeletable query filters, IAuditable column types, and snake_case naming. This plan removes all the manual configuration that those conventions replaced, achieving the DRY goal. Also removes the obsolete ValueObject class per user decision.

Output: Simplified entity configuration files with only domain-specific config remaining, ValueObject.cs deleted, EF Core migrations generated for all affected DbContexts.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-conventions-dry-configuration/16-CONTEXT.md
@.planning/phases/16-conventions-dry-configuration/16-RESEARCH.md
@.planning/phases/16-conventions-dry-configuration/16-01-SUMMARY.md

@src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
@src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartConfiguration.cs
@src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
@src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockItemConfiguration.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove redundant manual configuration from all 13 entity configuration files</name>
  <files>
    src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
    src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/CategoryConfiguration.cs
    src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartConfiguration.cs
    src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartItemConfiguration.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderItemConfiguration.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/CheckoutStateConfiguration.cs
    src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockItemConfiguration.cs
    src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockReservationConfiguration.cs
    src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/Configurations/StockAdjustmentConfiguration.cs
    src/MicroCommerce.ApiService/Features/Reviews/Infrastructure/Configurations/ReviewConfiguration.cs
    src/MicroCommerce.ApiService/Features/Wishlists/Infrastructure/Configurations/WishlistItemConfiguration.cs
    src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
  </files>
  <action>
    For ALL 13 entity configuration files, remove the following types of redundant configuration that conventions now handle:

    **1. Remove StronglyTypedId HasConversion calls.** These follow the pattern:
    ```csharp
    builder.Property(x => x.Id)
        .HasConversion(
            id => id.Value,
            value => new XxxId(value));
    ```
    Remove for ALL properties that use StronglyTypedId types: ProductId, CategoryId, CartId, CartItemId, OrderId, OrderItemId, StockItemId, AdjustmentId, ReservationId, ReviewId, WishlistItemId, UserProfileId, AddressId.
    The StronglyTypedIdConvention from Plan 01 handles all of these automatically.

    IMPORTANT: Do NOT remove HasConversion for non-StronglyTypedId types. Keep:
    - ProductName HasConversion (readonly record struct, not StronglyTypedId)
    - OrderNumber HasConversion (readonly record struct with .From() factory)
    - Status HasConversion<string>() (enum to string)
    - Money ComplexProperty (complex type, not conversion)
    - DisplayName HasConversion (readonly record struct)
    - Any other value object conversions that are NOT StronglyTypedId types

    **2. Remove .IsRowVersion() calls** on Version properties. The ConcurrencyTokenConvention now handles this. Remove lines like:
    ```csharp
    builder.Property(x => x.Version)
        .IsRowVersion();
    ```
    Found in: CartConfiguration, OrderConfiguration, StockItemConfiguration, ReviewConfiguration, WishlistItemConfiguration, UserProfileConfiguration, CheckoutStateConfiguration.
    Also remove any `// xmin optimistic concurrency token` comments above these lines.

    **3. Remove .ToTable("XxxName") calls** with explicit PascalCase table names. The snake_case naming convention now handles table names automatically (EF Core will infer from DbSet name). Remove lines like:
    ```csharp
    builder.ToTable("Products");
    builder.ToTable("Carts");
    builder.ToTable("Orders");
    ```
    The convention will automatically name tables based on the entity type in snake_case format.

    **4. Keep all other configuration** that conventions do NOT handle:
    - HasKey (though EF Core infers Id, keep for clarity)
    - HasMaxLength, HasPrecision, IsRequired for non-interface properties
    - Relationships (HasMany, HasOne, WithMany, HasForeignKey, OnDelete)
    - Navigation configuration (UsePropertyAccessMode)
    - Indexes (HasIndex, IsUnique, HasFilter, IsDescending)
    - OwnsOne / ComplexProperty configurations
    - HasDefaultValue
    - Ignore() calls
    - Non-StronglyTypedId value object conversions

    **5. Delete configuration files that become empty** after cleanup. A file is "empty" if it only contains:
    - `builder.HasKey(x => x.Id)` (EF Core infers this)
    - No other meaningful configuration
    Check each file after cleanup. If a configuration file has ONLY HasKey and nothing else substantive, delete it. If it retains any relationships, indexes, or domain-specific config, keep it.

    **6. Clean up unused using directives** after removing code. Remove `using` statements for ValueObjects namespace if no longer needed in the file.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService` -- zero errors.
    Verify no StronglyTypedId HasConversion remains:
    - Search for `HasConversion` in configuration files -- remaining matches should only be non-StronglyTypedId types (ProductName, OrderNumber, Status, DisplayName, etc.)
    Verify no .IsRowVersion() remains in configuration files:
    - `grep -r "IsRowVersion" src/MicroCommerce.ApiService/Features/ --include="*Configuration.cs"` -- zero matches
    Verify no explicit .ToTable() with PascalCase names remains:
    - `grep -r "\.ToTable(" src/MicroCommerce.ApiService/Features/ --include="*Configuration.cs"` -- zero matches
  </verify>
  <done>
    All 13 entity configuration files cleaned up. StronglyTypedId HasConversion calls removed (convention handles them). IsRowVersion calls removed (convention handles them). ToTable calls removed (snake_case convention handles naming). Non-StronglyTypedId conversions preserved. Empty configuration files deleted. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete ValueObject base class and generate EF Core migrations for all DbContexts</name>
  <files>
    src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs
  </files>
  <action>
    **Part A: Delete ValueObject base class**

    1. Delete `src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs`
    2. Verify zero inheritors exist (confirmed during research -- v1.1 migrated all to readonly record structs)
    3. Verify zero compilation errors after deletion -- ValueObject is marked [Obsolete] and has no inheritors
    4. Search entire codebase for remaining references:
       - `grep -r "ValueObject" src/ --include="*.cs"` -- should only find:
         - Domain/ValueObjects/ folder names (these are just folder names, not references to the base class)
         - Test files that test value object behavior (these test readonly record structs, not the base class)
         - The files should NOT contain `using` or `extends` or `: ValueObject`
    5. If any file still references the ValueObject CLASS (not just the word "ValueObject" in folder paths or comments), fix it

    **Part B: Generate EF Core migrations for all affected DbContexts**

    The convention changes (snake_case naming, removed ToTable, StronglyTypedId converters) will change the EF Core model. Generate new migrations for each DbContext.

    For EACH of the 8 DbContexts, generate a migration:
    ```bash
    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context CatalogDbContext

    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context CartDbContext

    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context OrderingDbContext

    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context InventoryDbContext

    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context ProfilesDbContext

    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context ReviewsDbContext

    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context WishlistsDbContext

    dotnet ef migrations add ConventionsDryConfiguration \
      --project src/MicroCommerce.ApiService \
      --context OutboxDbContext
    ```

    NOTE: The snake_case convention will generate migrations with RenameTable and RenameColumn operations (e.g., "Products" -> "products", "ProductId" -> "product_id"). This is expected and acceptable for this development/showcase project per research recommendation.

    If any migration generates an EMPTY migration (no changes detected for a particular DbContext), remove it:
    ```bash
    dotnet ef migrations remove --project src/MicroCommerce.ApiService --context XxxDbContext
    ```

    **Part C: Final verification**

    1. `dotnet build` the entire solution -- zero errors
    2. `dotnet test src/MicroCommerce.ApiService.Tests --filter FullyQualifiedName~Unit` -- all unit tests pass
    3. Confirm ValueObject.cs no longer exists
    4. Confirm no `: ValueObject` references remain in source code
  </action>
  <verify>
    Run `dotnet build` on entire solution -- zero errors.
    Run `dotnet test src/MicroCommerce.ApiService.Tests --filter FullyQualifiedName~Unit` -- all pass.
    Confirm ValueObject.cs deleted: `ls src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs` should fail.
    Confirm no class references: `grep -r ": ValueObject" src/ --include="*.cs"` -- zero matches.
    Confirm migrations exist: `ls src/MicroCommerce.ApiService/Features/*/Infrastructure/Migrations/*ConventionsDryConfiguration*` shows migration files.
  </verify>
  <done>
    ValueObject base class deleted with zero remaining inheritors or class references. EF Core migrations generated for all affected DbContexts with snake_case table/column renames. Full solution builds with zero errors. All unit tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` -- zero errors across entire solution
2. `dotnet test src/MicroCommerce.ApiService.Tests --filter FullyQualifiedName~Unit` -- all pass
3. `grep -r "IsRowVersion" src/MicroCommerce.ApiService/Features/ --include="*Configuration.cs"` -- zero matches
4. `grep -r "\.ToTable(" src/MicroCommerce.ApiService/Features/ --include="*Configuration.cs"` -- zero matches
5. `grep -r ": ValueObject" src/ --include="*.cs"` -- zero matches
6. Remaining HasConversion calls are ONLY for non-StronglyTypedId types (ProductName, OrderNumber, Status, etc.)
7. Migration files exist for affected DbContexts
</verification>

<success_criteria>
- Entity configuration files contain only domain-specific configuration (relationships, indexes, value objects, string lengths)
- All StronglyTypedId manual HasConversion calls removed (14+ instances across 13 files)
- All IsRowVersion calls removed (7 instances across 7 files)
- All ToTable calls with PascalCase names removed
- ValueObject.cs deleted from BuildingBlocks.Common
- EF Core migrations generated for snake_case and other convention changes
- Full solution builds with zero errors
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-conventions-dry-configuration/16-02-SUMMARY.md`
</output>
