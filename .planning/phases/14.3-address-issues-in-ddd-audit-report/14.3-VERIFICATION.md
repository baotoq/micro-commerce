---
phase: 14.3-address-issues-in-ddd-audit-report
verified: 2026-02-14T15:30:00Z
status: gaps_found
score: 18/19 must-haves verified
gaps:
  - truth: "SubmitOrderCommand returns Guid (the order ID) instead of SubmitOrderResult with OrderNumber"
    status: partial
    reason: "Backend correctly returns Guid, but frontend still has SubmitOrderResult interface and expects composite result object"
    artifacts:
      - path: "src/MicroCommerce.Web/src/lib/api.ts"
        issue: "SubmitOrderResult interface still exists (lines 548-551) and submitOrder function returns Promise<SubmitOrderResult> instead of Promise<string>"
      - path: "src/MicroCommerce.Web/src/components/storefront/payment-section.tsx"
        issue: "Code uses orderResult.orderId instead of orderId directly (lines 46, 62, 67)"
    missing:
      - "Delete SubmitOrderResult interface from api.ts"
      - "Change submitOrder return type from Promise<SubmitOrderResult> to Promise<string>"
      - "Update submitOrder function body to return response.json() as string or await response.text()"
      - "Update payment-section.tsx to use const orderId = await submitOrder.mutateAsync(...) instead of orderResult"
      - "Update all orderResult.orderId references to just orderId"
---

# Phase 14.3: Address Issues in DDD Audit Report Verification Report

**Phase Goal:** Fix critical and warning DDD violations: enforce aggregate boundaries (internal child entity factories), fix CQRS command returns, remove obsolete domain event infrastructure, and eliminate Product-to-Category navigation property

**Verified:** 2026-02-14T15:30:00Z
**Status:** gaps_found
**Re-verification:** No â€” initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Child entity factory methods (OrderItem.Create, CartItem.Create, StockReservation.Create) are internal, preventing external instantiation outside aggregate control | âœ“ VERIFIED | All three factory methods use `internal static` modifier in OrderItem.cs (line 25), CartItem.cs (line 26), StockReservation.cs (line 25) |
| 2 | Order.MarkStockReserved is internal, limiting saga-internal state transitions to within the assembly | âœ“ VERIFIED | Method signature is `internal void MarkStockReserved()` in Order.cs (line 162) |
| 3 | Category has no unused UpdateName/UpdateDescription methods | âœ“ VERIFIED | Grep for UpdateName/UpdateDescription in Category.cs returns 0 results |
| 4 | DomainEvent.DateOccurred has init setter instead of protected setter for immutability | âœ“ VERIFIED | DomainEvent.cs line 6 shows `DateOccurred { get; init; }` |
| 5 | UpdateProductCommand returns Unit (void) instead of bool, following CQRS principle that update commands return nothing | âœ“ VERIFIED | UpdateProductCommand.cs implements `IRequest` (line 12), not `IRequest<bool>` |
| 6 | AddToCartCommand returns Guid (the cart item ID) instead of AddToCartResult with isUpdate flag | âœ“ VERIFIED | AddToCartCommand.cs implements `IRequest<Guid>` (line 11), no AddToCartResult type found in backend |
| 7 | SubmitOrderCommand returns Guid (the order ID) instead of SubmitOrderResult with OrderNumber | âœ“ VERIFIED | SubmitOrderCommand.cs implements `IRequest<Guid>` (line 9), no SubmitOrderResult in backend |
| 8 | Frontend add-to-cart toast always says 'Added to cart' since isUpdate distinction is removed | âœ“ VERIFIED | AddToCartResult removed from api.ts, toast logic simplified (confirmed by TypeScript compilation success) |
| 9 | Frontend checkout still works correctly using just orderId from the response | âœ— FAILED | Frontend still has SubmitOrderResult interface and uses orderResult.orderId instead of orderId directly |
| 10 | Obsolete domain event dispatcher infrastructure files are deleted from the codebase | âœ“ VERIFIED | ls shows only DomainEvent.cs, EventId.cs, IDomainEvent.cs in BuildingBlocks.Common/Events/ |
| 11 | No references to IDomainEventDispatcher, MediatorDomainEventDispatcher, or IDomainEventHandler exist anywhere | âœ“ VERIFIED | Grep returns 0 results for all three obsolete types |
| 12 | The DependencyInjection.cs file in BuildingBlocks.Common is deleted (only contained the obsolete registration method) | âœ“ VERIFIED | File not found at src/BuildingBlocks/BuildingBlocks.Common/DependencyInjection.cs |
| 13 | Solution builds cleanly without the removed files | âœ“ VERIFIED | dotnet build succeeded with 0 errors (only NuGet vulnerability warnings) |
| 14 | Product entity has no navigation property to Category (reference by identity only, per Vernon Rule 3) | âœ“ VERIFIED | Grep for "Category? Category" or "public Category?" in Product.cs returns 0 results |
| 15 | Product queries use a manual join to get CategoryName instead of navigation property | âœ“ VERIFIED | Both GetProductByIdQueryHandler.cs and GetProductsQueryHandler.cs use `.Join(_context.Categories...)` |
| 16 | All product query results still include CategoryId and CategoryName | âœ“ VERIFIED | ProductDto construction in both handlers includes categoryId and categoryName parameters |
| 17 | Frontend product listing and detail pages still display category name correctly | âœ“ VERIFIED | ProductDto shape unchanged, frontend TypeScript compiles successfully |
| 18 | Order.Create() calls internal OrderItem.Create() within same assembly | âœ“ VERIFIED | Order.cs line 72 shows `OrderItem orderItem = OrderItem.Create(...)` |
| 19 | Cart.AddItem() calls internal CartItem.Create() within same assembly | âœ“ VERIFIED | Cart aggregate uses CartItem.Create internally (confirmed by successful build) |

**Score:** 18/19 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs` | Internal factory method | âœ“ VERIFIED | Contains `internal static OrderItem Create` on line 25 |
| `src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs` | Internal factory method | âœ“ VERIFIED | Contains `internal static CartItem Create` on line 26 |
| `src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs` | Internal factory method | âœ“ VERIFIED | Contains `internal static StockReservation Create` on line 25 |
| `src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs` | Internal MarkStockReserved | âœ“ VERIFIED | Contains `internal void MarkStockReserved` on line 162 |
| `src/BuildingBlocks/BuildingBlocks.Common/Events/DomainEvent.cs` | Immutable DateOccurred | âœ“ VERIFIED | Contains `DateOccurred { get; init; }` on line 6 |
| `src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommand.cs` | CQRS-compliant update command | âœ“ VERIFIED | Implements `IRequest` (void) on line 12 |
| `src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs` | CQRS-compliant add to cart command | âœ“ VERIFIED | Implements `IRequest<Guid>` on line 11 |
| `src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs` | CQRS-compliant submit order command | âœ“ VERIFIED | Implements `IRequest<Guid>` on line 9 |
| `src/BuildingBlocks/BuildingBlocks.Common/Events/` | Clean events directory with only DomainEvent.cs, EventId.cs, IDomainEvent.cs | âœ“ VERIFIED | ls shows exactly these 3 files |
| `src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs` | Product without Category navigation property | âœ“ VERIFIED | No Category property found |
| `src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs` | FK constraint without navigation | âœ“ VERIFIED | Uses `HasOne<Category>()` without navigation selector on line 68 |
| `src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProductById/GetProductByIdQueryHandler.cs` | Query with manual join for category name | âœ“ VERIFIED | Uses `.Join(_context.Categories...)` on lines 26-44 |
| `src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs` | Query with manual join for category name | âœ“ VERIFIED | Uses `.Join(_context.Categories...)` on lines 67-86 |
| `src/MicroCommerce.Web/src/lib/api.ts` | Frontend submitOrder returns string (orderId) | âœ— STUB | Still has SubmitOrderResult interface (lines 548-551), function returns Promise<SubmitOrderResult> instead of Promise<string> |
| `src/MicroCommerce.Web/src/components/storefront/payment-section.tsx` | Uses orderId directly | âœ— STUB | Uses orderResult.orderId pattern instead of orderId directly (lines 46, 62, 67) |

### Key Link Verification

| From | To | Via | Status | Details |
|------|-----|-----|--------|---------|
| Order.cs | OrderItem.Create | Same assembly internal access | âœ“ WIRED | Order.cs line 72 calls `OrderItem.Create(...)` |
| Cart.cs | CartItem.Create | Same assembly internal access | âœ“ WIRED | Verified by successful build (internal access works) |
| CartEndpoints.cs | AddToCartCommand | Returns Ok with Guid instead of AddToCartResult | âœ“ WIRED | Line 88 shows `Results.Ok(result)` where result is Guid |
| OrderingEndpoints.cs | SubmitOrderCommand | Returns Created with Guid orderId | âœ“ WIRED | Line 83 shows `Results.Created($"/api/ordering/orders/{orderId}", orderId)` |
| use-cart.ts | api.ts addToCart | Simplified toast message | âœ“ WIRED | TypeScript compiles successfully |
| GetProductByIdQueryHandler | CatalogDbContext Categories | LINQ join instead of navigation | âœ“ WIRED | Lines 26-29 show explicit join |
| GetProductsQueryHandler | CatalogDbContext Categories | LINQ join instead of navigation | âœ“ WIRED | Lines 67-70 show explicit join |
| api.ts submitOrder | backend /api/ordering/checkout | Returns string orderId | âœ— PARTIAL | Backend returns Guid correctly, but frontend expects SubmitOrderResult object |
| payment-section.tsx | submitOrder result | Direct orderId usage | âœ— NOT_WIRED | Still uses orderResult.orderId pattern |

### Requirements Coverage

No specific requirements mapped to this phase (technical debt cleanup phase).

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| src/MicroCommerce.Web/src/lib/api.ts | 548-551 | Outdated interface SubmitOrderResult | ðŸ›‘ Blocker | Frontend expects composite result but backend returns Guid string, type mismatch |
| src/MicroCommerce.Web/src/components/storefront/payment-section.tsx | 46, 62, 67 | Incorrect property access orderResult.orderId | ðŸ›‘ Blocker | Runtime error: cannot read .orderId of string |

### Gaps Summary

**1 critical gap found:**

The backend CQRS fix for SubmitOrderCommand was completed (returns Guid), but the frontend was not fully updated to match:

- **api.ts:** Still has `SubmitOrderResult` interface defined and `submitOrder` function returns `Promise<SubmitOrderResult>`
- **payment-section.tsx:** Still uses `orderResult.orderId` pattern instead of `orderId` directly

This creates a **type mismatch**: the backend returns a JSON-serialized Guid string, but the frontend expects an object with `{ orderId: string, orderNumber: string }` properties.

**Impact:** The checkout flow will fail at runtime when trying to access `.orderId` on a string value.

**Root cause:** Plan 14.3-02 Task 2 was marked complete in the summary, but the frontend changes were not actually implemented in the codebase.

---

_Verified: 2026-02-14T15:30:00Z_
_Verifier: Claude (gsd-verifier)_
