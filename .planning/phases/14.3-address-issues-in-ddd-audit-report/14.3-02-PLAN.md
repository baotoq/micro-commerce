---
phase: 14.3-address-issues-in-ddd-audit-report
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommand.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommandHandler.cs
  - src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs
  - src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommandHandler.cs
  - src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
  - src/MicroCommerce.Web/src/lib/api.ts
  - src/MicroCommerce.Web/src/hooks/use-cart.ts
  - src/MicroCommerce.Web/src/components/storefront/payment-section.tsx
autonomous: true

must_haves:
  truths:
    - "UpdateProductCommand returns Unit (void) instead of bool, following CQRS principle that update commands return nothing"
    - "AddToCartCommand returns Guid (the cart item ID) instead of AddToCartResult with isUpdate flag"
    - "SubmitOrderCommand returns Guid (the order ID) instead of SubmitOrderResult with OrderNumber"
    - "Frontend add-to-cart toast always says 'Added to cart' since isUpdate distinction is removed"
    - "Frontend checkout still works correctly using just orderId from the response"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommand.cs"
      provides: "CQRS-compliant update command"
      contains: "IRequest<Unit>"
    - path: "src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs"
      provides: "CQRS-compliant add to cart command"
      contains: "IRequest<Guid>"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs"
      provides: "CQRS-compliant submit order command"
      contains: "IRequest<Guid>"
  key_links:
    - from: "src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs"
      to: "AddToCartCommand"
      via: "Returns Ok with Guid instead of AddToCartResult"
      pattern: "Results\\.Ok"
    - from: "src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs"
      to: "SubmitOrderCommand"
      via: "Returns Created with Guid orderId"
      pattern: "Results\\.Created"
    - from: "src/MicroCommerce.Web/src/hooks/use-cart.ts"
      to: "api.ts addToCart"
      via: "Simplified toast message"
      pattern: "toast\\.success"
---

<objective>
Fix CQRS command return violations across three commands: UpdateProduct (returns bool), AddToCart (returns AddToCartResult with isUpdate), and SubmitOrder (returns SubmitOrderResult with OrderNumber).

Purpose: CQRS principle dictates that commands should return void (Unit) for updates, or only the created entity's ID for creation commands. Returning extra data (booleans, composite results) conflates command and query responsibilities. These fixes align the codebase with standard CQRS patterns.

Output: All three commands return proper CQRS-compliant types; endpoints and frontend updated accordingly.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommand.cs
@src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommandHandler.cs
@src/MicroCommerce.ApiService/Features/Catalog/CatalogEndpoints.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommandHandler.cs
@src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
@src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs
@src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandHandler.cs
@src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/hooks/use-cart.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UpdateProductCommand to return Unit and AddToCartCommand to return Guid</name>
  <files>
    src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommand.cs
    src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommandHandler.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs
    src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommandHandler.cs
    src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
  </files>
  <action>
    **UpdateProduct — return Unit instead of bool:**

    1. In UpdateProductCommand.cs: Change `IRequest<bool>` to `IRequest` (MediatR's IRequest without type param returns Unit). The record signature becomes: `public sealed record UpdateProductCommand(...) : IRequest;`

    2. In UpdateProductCommandHandler.cs: Change `IRequestHandler<UpdateProductCommand, bool>` to `IRequestHandler<UpdateProductCommand>`. Change return type from `Task<bool>` to `Task`. Remove `return true;` at the end. The handler already throws NotFoundException if the product doesn't exist, so the void return is correct.

    Note: CatalogEndpoints.cs already discards the result (`await sender.Send(command, cancellationToken);` then returns `Results.NoContent()`), so no endpoint change is needed.

    **AddToCart — return Guid instead of AddToCartResult:**

    1. In AddToCartCommand.cs: Change `IRequest<AddToCartResult>` to `IRequest<Guid>`. Delete the `AddToCartResult` record entirely.

    2. In AddToCartCommandHandler.cs: Change `IRequestHandler<AddToCartCommand, AddToCartResult>` to `IRequestHandler<AddToCartCommand, Guid>`. Change return type from `Task<AddToCartResult>` to `Task<Guid>`. Remove the `isUpdate` variable and logic. At the end, return the cart ID: `return cart.Id.Value;` (returning the cart's GUID is appropriate for a creation-like command).

    3. In CartEndpoints.cs: Change `.Produces<AddToCartResult>()` to `.Produces<Guid>()`. Update the `AddToCart` handler: instead of `var result = await sender.Send(command, cancellationToken); return Results.Ok(result);`, keep `var result = await sender.Send(command, cancellationToken); return Results.Ok(result);` but note the type is now Guid.

    **Frontend update for AddToCart:**

    4. In `src/MicroCommerce.Web/src/lib/api.ts`: Change `AddToCartResponse` interface from `{ isUpdate: boolean }` to just remove it. Change the `addToCart` function return type: Instead of `Promise<AddToCartResponse>`, return `Promise<void>` and don't parse the response body (or parse as string/Guid but we don't need it). Simplest: change to `Promise<void>`, remove `return response.json()` and just check `response.ok`.

    5. In `src/MicroCommerce.Web/src/hooks/use-cart.ts`: In `useAddToCart`, the `onSuccess` callback currently uses `response.isUpdate`. Change the toast to always show `toast.success("Added to cart")` and remove the conditional. Change `mutationFn` to match the new void return: `mutationFn: (data: AddToCartRequest) => addToCart(data)`.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService` — must compile without errors.
    Run `cd src/MicroCommerce.Web && npx tsc --noEmit` — TypeScript must compile without errors.
  </verify>
  <done>
    UpdateProductCommand implements IRequest (void). AddToCartCommand returns Guid. AddToCartResult record is deleted. Frontend addToCart returns void and toast always says "Added to cart". Both backend and frontend compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix SubmitOrderCommand to return Guid instead of SubmitOrderResult</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandHandler.cs
    src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
    src/MicroCommerce.Web/src/lib/api.ts
  </files>
  <action>
    **SubmitOrder — return Guid (orderId) only:**

    1. In SubmitOrderCommand.cs: Change `IRequest<SubmitOrderResult>` to `IRequest<Guid>`. Delete the `SubmitOrderResult` record. Keep `ShippingAddressRequest` and `OrderItemRequest` records as-is (they are input DTOs, not command results).

    2. In SubmitOrderCommandHandler.cs: Change `IRequestHandler<SubmitOrderCommand, SubmitOrderResult>` to `IRequestHandler<SubmitOrderCommand, Guid>`. Change return type from `Task<SubmitOrderResult>` to `Task<Guid>`. Change `return new SubmitOrderResult(order.Id.Value, order.OrderNumber.Value);` to `return order.Id.Value;`. The CQRS pattern says creation commands may return the created ID. OrderNumber can be fetched via a subsequent query if needed.

    3. In OrderingEndpoints.cs: Change `.Produces<SubmitOrderResult>(StatusCodes.Status201Created)` to `.Produces<Guid>(StatusCodes.Status201Created)`. In the Checkout handler: change `SubmitOrderResult result` to `Guid orderId`. Change `Results.Created($"/api/ordering/orders/{result.OrderId}", result)` to `Results.Created($"/api/ordering/orders/{orderId}", orderId)`.

    4. In `src/MicroCommerce.Web/src/lib/api.ts`: Find the `SubmitOrderResult` interface and delete it. Change the `submitOrder` function return type from `Promise<SubmitOrderResult>` to `Promise<string>` (the orderId as string). In the function body, parse the response as text/string: `return response.text()` then strip quotes if JSON-encoded, or use `const data = await response.json(); return data as string;` — the .NET API returns a JSON-serialized Guid string.

    Actually, check how the frontend consumes this. The `payment-section.tsx` does:
    ```
    const orderResult = await submitOrder.mutateAsync({...});
    // Then uses: orderResult.orderId and orderResult.orderId
    ```
    Since we're now returning just a Guid string, update the consumer. The `submitOrder` function should return `Promise<string>`. Then in payment-section.tsx, the usage becomes:
    ```
    const orderId = await submitOrder.mutateAsync({...});
    // Use orderId directly
    ```

    5. In `src/MicroCommerce.Web/src/components/storefront/payment-section.tsx`: Change `const orderResult = await submitOrder.mutateAsync({...})` to `const orderId = await submitOrder.mutateAsync({...})`. Change `orderResult.orderId` references to just `orderId`. Change `onSuccess(orderResult.orderId)` to `onSuccess(orderId)`.

    6. In `src/MicroCommerce.Web/src/lib/api.ts`: Also find the `OrderDto` or similar interface that uses `orderNumber` — keep that as-is since orderNumber comes from GET queries, not from the submit command. Only remove `SubmitOrderResult`.

    Important: The Guid is returned as a JSON value (e.g., `"3fa85f64-5717-4562-b3fc-2c963f66afa6"`) by ASP.NET Core. The `response.json()` call will return the string directly in JavaScript.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService` — must compile without errors.
    Run `cd src/MicroCommerce.Web && npx tsc --noEmit` — TypeScript must compile without errors.
    Grep for `SubmitOrderResult` in both backend and frontend — should find 0 results.
  </verify>
  <done>
    SubmitOrderCommand returns Guid. SubmitOrderResult record is deleted. Endpoint returns Created with Guid. Frontend submitOrder returns string (orderId). payment-section.tsx uses orderId directly. Both backend and frontend compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` at solution root succeeds with zero errors
2. `cd src/MicroCommerce.Web && npx tsc --noEmit` succeeds
3. Grep for `AddToCartResult` in backend — 0 results
4. Grep for `SubmitOrderResult` in backend — 0 results
5. Grep for `IRequest<bool>` in UpdateProductCommand.cs — 0 results
6. `dotnet test src/MicroCommerce.ApiService.Tests` — all tests pass
</verification>

<success_criteria>
All three CQRS command return violations are fixed. UpdateProduct returns void/Unit. AddToCart returns Guid. SubmitOrder returns Guid. Frontend is updated to match. No breaking changes in API behavior (same HTTP status codes, endpoint URLs unchanged).
</success_criteria>

<output>
After completion, create `.planning/phases/14.3-address-issues-in-ddd-audit-report/14.3-02-SUMMARY.md`
</output>
