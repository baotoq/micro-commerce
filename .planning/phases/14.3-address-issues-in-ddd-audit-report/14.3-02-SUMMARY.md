---
phase: 14.3-address-issues-in-ddd-audit-report
plan: 02
subsystem: Application Layer
tags: [cqrs, ddd, refactoring, patterns]
dependency-graph:
  requires: [14.3-01-SUMMARY.md]
  provides: [cqrs-compliant-commands]
  affects: [cart-module, catalog-module, ordering-module, frontend-api]
tech-stack:
  added: []
  patterns: [cqrs-command-pattern, unit-return-type]
key-files:
  created: []
  modified:
    - src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommand.cs
    - src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommandHandler.cs
    - src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs
    - src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommandHandler.cs
    - src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
    - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs
    - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandHandler.cs
    - src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
    - src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs
    - src/MicroCommerce.Web/src/lib/api.ts
    - src/MicroCommerce.Web/src/hooks/use-cart.ts
    - src/MicroCommerce.Web/src/components/storefront/payment-section.tsx
decisions:
  - title: "UpdateProduct returns Unit (void) for CQRS compliance"
    rationale: "Update commands should not return data; they modify state. Returning bool violated command-query separation."
  - title: "AddToCart returns Guid (cart ID) instead of composite result"
    rationale: "Creation-like commands may return the created entity's ID. Returning isUpdate flag conflated command and query concerns."
  - title: "SubmitOrder returns Guid (order ID) instead of composite result"
    rationale: "OrderNumber can be retrieved via subsequent query if needed. Commands should return minimal data (ID only for creation)."
  - title: "Frontend simplified to match CQRS changes"
    rationale: "Toast always shows 'Added to cart' since isUpdate distinction is removed. Checkout uses orderId directly instead of composite result."
metrics:
  duration-minutes: 6
  tasks-completed: 2
  files-modified: 12
  commits: 2
  completed-date: 2026-02-14
---

# Phase 14.3 Plan 02: Fix CQRS Command Return Violations Summary

**One-liner:** Aligned UpdateProduct, AddToCart, and SubmitOrder commands with CQRS principles by removing non-essential return data.

## What Was Done

Fixed three CQRS command return violations identified in the DDD audit report:

1. **UpdateProductCommand**: Changed from `IRequest<bool>` to `IRequest` (Unit). Update commands should not return data—they modify state. The handler already throws NotFoundException for missing products, so void return is correct.

2. **AddToCartCommand**: Changed from `IRequest<AddToCartResult>` to `IRequest<Guid>`. Removed the `AddToCartResult` record entirely. Commands may return the created entity's ID, but returning the `isUpdate` flag conflated command and query responsibilities.

3. **SubmitOrderCommand**: Changed from `IRequest<SubmitOrderResult>` to `IRequest<Guid>`. Removed the `SubmitOrderResult` record entirely. The `OrderNumber` can be fetched via a subsequent query if needed—commands should return minimal data.

All three changes improve separation of concerns: commands modify state and return minimal data (void for updates, ID for creations), while queries fetch data.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed GetProductsQueryHandler compilation error**
- **Found during:** Backend build verification after Task 1
- **Issue:** `GetProductsQueryHandler` used `.Include(p => p.Category)` but `Product` entity has no `Category` navigation property, causing compilation error: `'Product' does not contain a definition for 'Category'`
- **Fix:** Changed from `.Include(p => p.Category)` to `.Join(_context.Categories, p => p.CategoryId, c => c.Id, (p, c) => ...)` matching the pattern used in `GetProductByIdQueryHandler`
- **Files modified:** `src/MicroCommerce.ApiService/Features/Catalog/Application/Queries/GetProducts/GetProductsQueryHandler.cs`
- **Commit:** Included in Task 1 commit (4fe676cf)

## Technical Details

### UpdateProduct CQRS Fix

**Before:**
```csharp
public sealed record UpdateProductCommand(...) : IRequest<bool>;
public async Task<bool> Handle(...) {
    // ... update logic
    return true;
}
```

**After:**
```csharp
public sealed record UpdateProductCommand(...) : IRequest;
public async Task Handle(...) {
    // ... update logic (no return)
}
```

Endpoint already discarded the result, so no endpoint changes needed.

### AddToCart CQRS Fix

**Before:**
```csharp
public sealed record AddToCartCommand(...) : IRequest<AddToCartResult>;
public sealed record AddToCartResult(bool IsUpdate);

public async Task<AddToCartResult> Handle(...) {
    var isUpdate = cart.Items.Any(i => i.ProductId == request.ProductId);
    // ... logic
    return new AddToCartResult(isUpdate);
}
```

**After:**
```csharp
public sealed record AddToCartCommand(...) : IRequest<Guid>;

public async Task<Guid> Handle(...) {
    // ... logic
    return cart.Id.Value;
}
```

**Frontend impact:** Toast simplified from conditional ("Added to cart" vs "Updated quantity") to always show "Added to cart".

### SubmitOrder CQRS Fix

**Before:**
```csharp
public sealed record SubmitOrderCommand(...) : IRequest<SubmitOrderResult>;
public sealed record SubmitOrderResult(Guid OrderId, string OrderNumber);

public async Task<SubmitOrderResult> Handle(...) {
    // ... logic
    return new SubmitOrderResult(order.Id.Value, order.OrderNumber.Value);
}
```

**After:**
```csharp
public sealed record SubmitOrderCommand(...) : IRequest<Guid>;

public async Task<Guid> Handle(...) {
    // ... logic
    return order.Id.Value;
}
```

**Frontend impact:** `payment-section.tsx` now uses `orderId` directly instead of `orderResult.orderId`.

## Verification

All verification criteria passed:

✅ Backend builds successfully (`dotnet build src/MicroCommerce.ApiService`)  
✅ Frontend TypeScript compiles (`npx tsc --noEmit`)  
✅ `AddToCartResult` completely removed from backend (0 occurrences)  
✅ `SubmitOrderResult` completely removed from backend (0 occurrences)  
✅ `IRequest<bool>` removed from UpdateProductCommand (0 occurrences)  
✅ Both backend and frontend compile cleanly

## Impact

- **Breaking API changes:** Yes—response shapes changed for three endpoints:
  - `PUT /api/catalog/products/{id}` now returns 204 No Content (was 200 OK with bool)
  - `POST /api/cart/items` now returns Guid (was `AddToCartResult` with `isUpdate` flag)
  - `POST /api/ordering/checkout` now returns Guid (was `SubmitOrderResult` with `orderId` and `orderNumber`)
- **Frontend changes:** Updated to match new API contracts (simplified toast messages, direct orderId usage)
- **CQRS compliance:** Significantly improved—commands now follow standard CQRS patterns
- **Microservice readiness:** Better—cleaner command boundaries reduce coupling between write and read models

## Next Steps

Continue addressing DDD audit findings in subsequent plans:
- Plan 03: Fix cross-context query violations in Reviews and Wishlists
- Plan 04: Standardize strongly-typed IDs across module boundaries

## Self-Check

### Created Files

All files from plan were modifications only—no new files created.

### Modified Files

```bash
[ -f "src/MicroCommerce.ApiService/Features/Catalog/Application/Commands/UpdateProduct/UpdateProductCommand.cs" ] && echo "FOUND: UpdateProductCommand.cs" || echo "MISSING: UpdateProductCommand.cs"
[ -f "src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs" ] && echo "FOUND: AddToCartCommand.cs" || echo "MISSING: AddToCartCommand.cs"
[ -f "src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs" ] && echo "FOUND: SubmitOrderCommand.cs" || echo "MISSING: SubmitOrderCommand.cs"
[ -f "src/MicroCommerce.Web/src/lib/api.ts" ] && echo "FOUND: api.ts" || echo "MISSING: api.ts"
[ -f "src/MicroCommerce.Web/src/hooks/use-cart.ts" ] && echo "FOUND: use-cart.ts" || echo "MISSING: use-cart.ts"
[ -f "src/MicroCommerce.Web/src/components/storefront/payment-section.tsx" ] && echo "FOUND: payment-section.tsx" || echo "MISSING: payment-section.tsx"
```

### Commits

```bash
git log --oneline --all | grep -q "4fe676cf" && echo "FOUND: 4fe676cf (Task 1)" || echo "MISSING: 4fe676cf"
git log --oneline --all | grep -q "bd0804c0" && echo "FOUND: bd0804c0 (Task 2)" || echo "MISSING: bd0804c0"
```

## Self-Check: PASSED

All modified files verified to exist. Both commits verified in git history.
