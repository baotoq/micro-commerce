---
phase: 14.3-address-issues-in-ddd-audit-report
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs
  - src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs
  - src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
  - src/BuildingBlocks/BuildingBlocks.Common/Events/DomainEvent.cs
  - src/MicroCommerce.ApiService.Tests/Unit/Ordering/Aggregates/OrderTests.cs
autonomous: true

must_haves:
  truths:
    - "Child entity factory methods (OrderItem.Create, CartItem.Create, StockReservation.Create) are internal, preventing external instantiation outside aggregate control"
    - "Order.MarkStockReserved is internal, limiting saga-internal state transitions to within the assembly"
    - "Category has no unused UpdateName/UpdateDescription methods"
    - "DomainEvent.DateOccurred has init setter instead of protected setter for immutability"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs"
      provides: "Internal factory method"
      contains: "internal static OrderItem Create"
    - path: "src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs"
      provides: "Internal factory method"
      contains: "internal static CartItem Create"
    - path: "src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs"
      provides: "Internal factory method"
      contains: "internal static StockReservation Create"
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs"
      provides: "Internal MarkStockReserved"
      contains: "internal void MarkStockReserved"
    - path: "src/BuildingBlocks/BuildingBlocks.Common/Events/DomainEvent.cs"
      provides: "Immutable DateOccurred"
      contains: "DateOccurred { get; init }"
  key_links:
    - from: "src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs"
      to: "OrderItem.Create"
      via: "Same assembly internal access"
      pattern: "OrderItem\\.Create"
    - from: "src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/Cart.cs"
      to: "CartItem.Create"
      via: "Same assembly internal access"
      pattern: "CartItem\\.Create"
---

<objective>
Enforce DDD aggregate boundaries by restricting child entity factory methods to internal access, remove unused Category methods, fix DomainEvent immutability, and restrict Order.MarkStockReserved to internal.

Purpose: Child entities (OrderItem, CartItem, StockReservation) should only be created through their owning aggregate root, not directly by external consumers. Order.MarkStockReserved is a saga-internal transition that should not be publicly accessible. Category has redundant UpdateName/UpdateDescription methods that are never called. DomainEvent.DateOccurred should be immutable after construction.

Output: Properly encapsulated aggregate boundaries across Ordering, Cart, and Inventory domains.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs
@src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs
@src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs
@src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
@src/BuildingBlocks/BuildingBlocks.Common/Events/DomainEvent.cs
@src/MicroCommerce.ApiService.Tests/Unit/Ordering/Aggregates/OrderTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make child entity factory methods internal and restrict Order.MarkStockReserved</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs
    src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/CartItem.cs
    src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockReservation.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
  </files>
  <action>
    1. In OrderItem.cs: Change `public static OrderItem Create(...)` to `internal static OrderItem Create(...)`. This is safe because Order.Create() in the same assembly is the only caller.

    2. In CartItem.cs: Change `public static CartItem Create(...)` to `internal static CartItem Create(...)`. The Cart aggregate's AddItem() method in the same assembly is the only caller.

    3. In StockReservation.cs: Change `public static StockReservation Create(...)` to `internal static StockReservation Create(...)`. The StockItem aggregate's Reserve() method in the same assembly is the only caller.

    4. In Order.cs: Change `public void MarkStockReserved()` to `internal void MarkStockReserved()`. This method is only called by saga consumers (OrderSubmittedConsumer/ReserveStockForOrderConsumer) which are in the same assembly. Also update the XML doc to note it is assembly-internal.

    Note: The test project references the ApiService assembly. Since tests call MarkStockReserved() directly, add `[assembly: InternalsVisibleTo("MicroCommerce.ApiService.Tests")]` to the ApiService project. Check if such an attribute already exists; if not, add it to a new file `src/MicroCommerce.ApiService/Properties/AssemblyInfo.cs` or to an existing one.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService` and `dotnet build src/MicroCommerce.ApiService.Tests` — both must compile without errors.
    Run `dotnet test src/MicroCommerce.ApiService.Tests` — all existing tests must pass (MarkStockReserved tests still work via InternalsVisibleTo).
  </verify>
  <done>
    OrderItem.Create, CartItem.Create, StockReservation.Create are all `internal static`. Order.MarkStockReserved is `internal void`. Both ApiService and Tests projects build and all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove redundant Category methods and fix DomainEvent immutability</name>
  <files>
    src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
    src/BuildingBlocks/BuildingBlocks.Common/Events/DomainEvent.cs
  </files>
  <action>
    1. In Category.cs: Remove the `UpdateName(CategoryName name)` and `UpdateDescription(string? description)` methods entirely. These are never called anywhere in the codebase (grep confirms 0 callers). The existing `Update(CategoryName name, string? description)` method covers both operations. Remove their XML doc comments too.

    2. In DomainEvent.cs: Change `DateOccurred { get; protected set; }` to `DateOccurred { get; init; }`. The `init` accessor enforces immutability — DateOccurred is set once during construction (via the initializer `= DateTimeOffset.UtcNow`) and can never be changed afterward. This is the correct DDD pattern: domain events are immutable facts.

    Important: Since DomainEvent is a `record` type, `init` is the natural accessor. The `protected set` was a holdover from when this might have been a class. No derived types override or set DateOccurred after construction, so this is a safe change.
  </action>
  <verify>
    Run `dotnet build` at solution root — must compile without errors or warnings related to these changes.
    Grep for `UpdateName` and `UpdateDescription` in the ApiService project — should only appear in git history, not in current code.
  </verify>
  <done>
    Category entity has only the single `Update()` method (no redundant UpdateName/UpdateDescription). DomainEvent.DateOccurred uses `init` accessor for proper immutability. Solution builds cleanly.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` at solution root succeeds with zero errors
2. `dotnet test src/MicroCommerce.ApiService.Tests` — all tests pass
3. Grep for `public static OrderItem Create` returns 0 results
4. Grep for `public static CartItem Create` returns 0 results
5. Grep for `public static StockReservation Create` returns 0 results
6. Grep for `public void MarkStockReserved` returns 0 results
7. Grep for `UpdateName\(` in Category.cs returns 0 results
8. Grep for `protected set` in DomainEvent.cs returns 0 results
</verification>

<success_criteria>
All child entity factory methods are internal. Order.MarkStockReserved is internal. Category has no redundant methods. DomainEvent.DateOccurred is immutable via init. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/14.3-address-issues-in-ddd-audit-report/14.3-01-SUMMARY.md`
</output>
