---
phase: 07-ordering-checkout
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - src/MicroCommerce.Web/src/lib/api.ts
  - src/MicroCommerce.Web/src/hooks/use-checkout.ts
  - src/MicroCommerce.Web/src/app/(storefront)/checkout/page.tsx
  - src/MicroCommerce.Web/src/components/storefront/checkout-page.tsx
  - src/MicroCommerce.Web/src/components/storefront/checkout-accordion.tsx
  - src/MicroCommerce.Web/src/components/storefront/shipping-section.tsx
  - src/MicroCommerce.Web/src/components/storefront/payment-section.tsx
  - src/MicroCommerce.Web/src/components/storefront/order-sidebar.tsx
  - src/MicroCommerce.Web/src/components/storefront/checkout-login-gate.tsx
  - src/MicroCommerce.Web/src/app/(storefront)/order-confirmation/[id]/page.tsx
  - src/MicroCommerce.Web/src/components/storefront/order-confirmation.tsx
  - src/MicroCommerce.Web/src/components/storefront/cart-summary.tsx
autonomous: false

must_haves:
  truths:
    - "User navigates from cart to checkout page and sees accordion with Shipping and Payment sections"
    - "Guest user sees login gate: 'Continue as Guest' or 'Sign In' before checkout form"
    - "User fills shipping info (name, email, address), advances to payment section"
    - "User clicks 'Pay Now' with toggle for simulating success/failure, sees processing spinner"
    - "On success: redirected to order confirmation page showing order number, items, shipping, total breakdown"
    - "On failure: error banner shown in payment section, user can retry"
    - "Order summary sidebar shows cart items and total throughout checkout"
  artifacts:
    - path: "src/MicroCommerce.Web/src/hooks/use-checkout.ts"
      provides: "useSubmitOrder and useSimulatePayment mutations, useOrder query"
      min_lines: 30
    - path: "src/MicroCommerce.Web/src/components/storefront/checkout-accordion.tsx"
      provides: "Radix Accordion with Shipping and Payment sections"
      min_lines: 30
    - path: "src/MicroCommerce.Web/src/components/storefront/order-confirmation.tsx"
      provides: "Full order summary with items, shipping, totals"
      min_lines: 40
  key_links:
    - from: "checkout-page.tsx"
      to: "use-checkout.ts"
      via: "useSubmitOrder and useSimulatePayment hooks"
      pattern: "useSubmitOrder|useSimulatePayment"
    - from: "use-checkout.ts"
      to: "api.ts"
      via: "submitOrder, simulatePayment, getOrderById API functions"
      pattern: "submitOrder|simulatePayment|getOrderById"
    - from: "checkout-page.tsx"
      to: "order-confirmation/[id]/page.tsx"
      via: "router.push after successful payment"
      pattern: "router\\.push.*order-confirmation"
---

<objective>
Build the complete checkout frontend: API functions, React Query hooks, checkout page with Radix Accordion (shipping + payment sections), login gate, order sidebar, and order confirmation page.

Purpose: This is the user-facing checkout experience -- the single-page accordion flow where users enter shipping info, simulate payment, and see their order confirmation. Addresses requirements CHK-01 through CHK-04.
Output: Working checkout page at /checkout and order confirmation page at /order-confirmation/[id].
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-ordering-checkout/07-RESEARCH.md
@.planning/phases/07-ordering-checkout/07-CONTEXT.md
@.planning/phases/07-ordering-checkout/07-02-SUMMARY.md

# Existing patterns to follow
@src/MicroCommerce.Web/src/lib/api.ts
@src/MicroCommerce.Web/src/hooks/use-cart.ts
@src/MicroCommerce.Web/src/components/storefront/cart-page.tsx
@src/MicroCommerce.Web/src/components/storefront/cart-summary.tsx
@src/MicroCommerce.Web/src/components/storefront/header.tsx
@src/MicroCommerce.Web/src/app/(storefront)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ordering API functions, TypeScript types, and checkout hooks</name>
  <files>
    src/MicroCommerce.Web/src/lib/api.ts
    src/MicroCommerce.Web/src/hooks/use-checkout.ts
  </files>
  <action>
    Add ordering types and API functions to api.ts, then create checkout React Query hooks.

    **api.ts additions (append after Cart section):**

    Types:
    - `OrderItemDto { id: string, productId: string, productName: string, unitPrice: number, imageUrl: string | null, quantity: number, lineTotal: number }`
    - `ShippingAddressDto { name: string, email: string, street: string, city: string, state: string, zipCode: string }`
    - `OrderDto { id: string, orderNumber: string, buyerEmail: string, status: string, shippingAddress: ShippingAddressDto, items: OrderItemDto[], subtotal: number, shippingCost: number, tax: number, total: number, createdAt: string, paidAt: string | null, failureReason: string | null }`
    - `SubmitOrderRequest { email: string, shippingAddress: ShippingAddressDto, items: { productId: string, productName: string, unitPrice: number, imageUrl: string | null, quantity: number }[] }`
    - `SubmitOrderResult { orderId: string, orderNumber: string }`
    - `SimulatePaymentRequest { shouldSucceed: boolean }`
    - `SimulatePaymentResult { success: boolean, failureReason: string | null }`

    Functions:
    - `submitOrder(data: SubmitOrderRequest): Promise<SubmitOrderResult>` — POST `/api/ordering/checkout` with credentials: "include".
    - `simulatePayment(orderId: string, data: SimulatePaymentRequest): Promise<SimulatePaymentResult>` — POST `/api/ordering/orders/${orderId}/pay` with credentials: "include".
    - `getOrderById(orderId: string): Promise<OrderDto>` — GET `/api/ordering/orders/${orderId}` with credentials: "include".

    **use-checkout.ts:**
    Follow `use-cart.ts` pattern with React Query.

    - `useSubmitOrder()` — `useMutation` calling `submitOrder`. On success: invalidate cart query (cart will be cleared by saga). On error: `toast.error("Failed to submit order")`.
    - `useSimulatePayment()` — `useMutation` calling `simulatePayment`. No automatic side effects (caller handles redirect on success).
    - `useOrder(orderId: string)` — `useQuery` with key `["order", orderId]` calling `getOrderById`. Enabled only when orderId is truthy.
  </action>
  <verify>
    `npm run build --prefix src/MicroCommerce.Web` or `npx tsc --noEmit` in the Web project — TypeScript compiles without errors.
  </verify>
  <done>
    Ordering API functions added to api.ts, checkout hooks (useSubmitOrder, useSimulatePayment, useOrder) created with proper React Query patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Checkout page with accordion, shipping, payment, sidebar, and login gate</name>
  <files>
    src/MicroCommerce.Web/src/app/(storefront)/checkout/page.tsx
    src/MicroCommerce.Web/src/components/storefront/checkout-page.tsx
    src/MicroCommerce.Web/src/components/storefront/checkout-accordion.tsx
    src/MicroCommerce.Web/src/components/storefront/shipping-section.tsx
    src/MicroCommerce.Web/src/components/storefront/payment-section.tsx
    src/MicroCommerce.Web/src/components/storefront/order-sidebar.tsx
    src/MicroCommerce.Web/src/components/storefront/checkout-login-gate.tsx
    src/MicroCommerce.Web/src/components/storefront/cart-summary.tsx
  </files>
  <action>
    Build the checkout UI following CONTEXT.md decisions: single-page accordion, Shopify-style.

    **checkout/page.tsx (Next.js route):**
    - Simple page component rendering `<CheckoutPage />`. Title: "Checkout".

    **checkout-login-gate.tsx:**
    - Shows before checkout form. Two options: "Continue as Guest" (proceeds to checkout) and "Sign In" (redirects to auth).
    - Uses `useSession` from next-auth to detect if already logged in. If authenticated, skip gate.
    - Simple card with two buttons, centered.

    **checkout-page.tsx (orchestrator):**
    - State: `checkoutStarted` (past login gate?), `activeSection` ("shipping" | "payment"), `shippingData` (stored after shipping form submit), `orderId` (after submit).
    - If cart is empty (useCart returns null/empty): show "Your cart is empty" with link to products.
    - If not past login gate: show `<CheckoutLoginGate />`.
    - Otherwise: two-column layout — left: `<CheckoutAccordion />`, right: `<OrderSidebar />`.
    - On shipping complete: stores shipping data, advances accordion to "payment".
    - On payment success: `router.push(/order-confirmation/${orderId})`.

    **checkout-accordion.tsx:**
    - Radix `Accordion.Root type="single" value={activeSection}` with `onValueChange` controlled.
    - Two `Accordion.Item`s: "shipping" and "payment".
    - Each has styled trigger with step number and title. Completed sections show checkmark.
    - Shipping section disabled when payment is active (progression only forward — can go back by clicking).
    - Payment section disabled until shipping is complete.

    **shipping-section.tsx:**
    - Form with fields: Name, Email, Street Address, City, State (text input), ZIP Code.
    - Client-side validation: all required, email format.
    - "Continue to Payment" button at bottom.
    - On submit: calls `onComplete(shippingData)` prop.
    - If user is authenticated, pre-fill email from session.

    **payment-section.tsx:**
    - Shows order total prominently.
    - "Simulate Payment Outcome" toggle/switch: Success (default) or Failure. Clearly labeled as demo feature.
    - "Pay Now — $XX.XX" button.
    - On click: calls `useSubmitOrder` to create order (passing cart items + shipping data), then `useSimulatePayment` with the returned orderId.
    - During processing: 1-2 second `await new Promise(r => setTimeout(r, 1500))` with spinner overlay and "Processing payment..." text.
    - On payment success: call `onSuccess(orderId)`.
    - On payment failure: show error banner at top of section with retry option. User does NOT need to re-enter shipping.

    **order-sidebar.tsx:**
    - Sticky sidebar (desktop) showing cart items summary: product images, names, quantities, line totals.
    - Subtotal, shipping ($5.99), estimated tax (8%), total.
    - Responsive: collapses into expandable summary on mobile.
    - Uses `useCart()` hook to get current cart data.

    **cart-summary.tsx update:**
    - Add a "Proceed to Checkout" button to the existing cart summary that links to `/checkout`. This may already exist — check and update if needed.
  </action>
  <verify>
    `npm run build --prefix src/MicroCommerce.Web` compiles. Navigate to `/checkout` — page renders without errors (manual verification in checkpoint).
  </verify>
  <done>
    Checkout page renders accordion with shipping and payment sections, login gate shown for guests, order sidebar displays cart contents, payment simulation works with success/failure toggle.
  </done>
</task>

<task type="auto">
  <name>Task 3: Order confirmation page</name>
  <files>
    src/MicroCommerce.Web/src/app/(storefront)/order-confirmation/[id]/page.tsx
    src/MicroCommerce.Web/src/components/storefront/order-confirmation.tsx
  </files>
  <action>
    Build the order confirmation page that users see after successful checkout.

    **order-confirmation/[id]/page.tsx (Next.js route):**
    - Dynamic route with `params.id` as orderId.
    - Renders `<OrderConfirmation orderId={params.id} />`.
    - Title: "Order Confirmation".

    **order-confirmation.tsx:**
    - Uses `useOrder(orderId)` hook to fetch order details.
    - Loading state: skeleton placeholder.
    - Error state: "Order not found" with link back to shop.
    - Success state layout:
      - Green checkmark icon + "Order Confirmed!" heading.
      - Order number (MC-XXXXXX) prominently displayed.
      - "A confirmation will be sent to {email}" text.
      - **Order Items section:** List of items with image thumbnails, product name, quantity, unit price, line total.
      - **Shipping Address section:** Full address formatted nicely.
      - **Order Summary section:** Subtotal, Shipping ($5.99), Tax, Total. Total in bold.
      - "Continue Shopping" primary button linking to `/` (homepage/products).
    - Clean, celebratory design. Use existing Tailwind/shadcn patterns.
  </action>
  <verify>
    `npm run build --prefix src/MicroCommerce.Web` compiles. Navigate to `/order-confirmation/[valid-id]` — page renders with order details.
  </verify>
  <done>
    Order confirmation page displays full order summary: order number, items with images, shipping address, and total breakdown (subtotal, shipping, tax, total). "Continue Shopping" button links back to store.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete checkout flow: cart -> login gate -> shipping form -> payment simulation -> order confirmation page. Includes accordion UI, mock payment toggle, error handling, and order summary sidebar.
  </what-built>
  <how-to-verify>
    1. Start the application (Aspire or individual services)
    2. Add items to cart from the storefront
    3. Navigate to /checkout
    4. Verify login gate appears (if not authenticated): click "Continue as Guest"
    5. Fill shipping form: name, email, address fields. Click "Continue to Payment"
    6. Verify accordion advances to Payment section, shipping section shows checkmark
    7. Verify order sidebar shows cart items with correct totals
    8. Toggle payment simulation to "Success", click "Pay Now"
    9. Verify processing spinner appears for ~1.5 seconds
    10. Verify redirect to /order-confirmation/{id} with: order number (MC-XXXXXX), items, shipping address, subtotal, shipping ($5.99), tax (8%), total
    11. Go back to cart — verify it's empty (cleared by saga)
    12. Repeat checkout with payment set to "Failure" — verify error banner and retry option
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build --prefix src/MicroCommerce.Web` — compiles without errors
2. Checkout page renders at /checkout with accordion layout
3. Login gate shows for unauthenticated users with "Continue as Guest" option
4. Shipping form validates required fields and advances to payment
5. Payment section shows total, has success/failure toggle, processes with delay
6. Success redirects to /order-confirmation/[id] with full order details
7. Failure shows error banner with retry option
8. Order sidebar shows cart items throughout checkout
9. Cart cleared after successful checkout
</verification>

<success_criteria>
- Full checkout flow works end-to-end: cart -> checkout -> shipping -> payment -> confirmation
- Guest checkout supported via login gate
- Mock payment with visible success/failure toggle
- Processing delay makes payment feel realistic
- Order confirmation shows: order number, items with images, shipping address, subtotal/shipping/tax/total
- Cart cleared on success, preserved on failure
- Responsive layout: sidebar on desktop, collapsible on mobile
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-ordering-checkout/07-04-SUMMARY.md`
</output>
