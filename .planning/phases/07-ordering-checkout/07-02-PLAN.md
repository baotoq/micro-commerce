---
phase: 07-ordering-checkout
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandValidator.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SimulatePayment/SimulatePaymentCommand.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SimulatePayment/SimulatePaymentCommandHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/GetOrderByIdQuery.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/GetOrderByIdQueryHandler.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/OrderDto.cs
  - src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
autonomous: true

must_haves:
  truths:
    - "POST /api/ordering/checkout creates an Order from cart items and returns orderId + orderNumber"
    - "POST /api/ordering/orders/{id}/pay simulates payment (success or failure based on shouldSucceed flag)"
    - "GET /api/ordering/orders/{id} returns full order details with items, shipping, and totals"
    - "Validation rejects empty items, missing email, missing shipping fields"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandHandler.cs"
      provides: "Creates Order aggregate, persists via OrderingDbContext"
      min_lines: 25
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SimulatePayment/SimulatePaymentCommandHandler.cs"
      provides: "Loads order, calls MarkAsPaid or MarkAsFailed, publishes saga events"
      min_lines: 20
    - path: "src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs"
      provides: "API route group /api/ordering with checkout, pay, and get-order endpoints"
      min_lines: 30
  key_links:
    - from: "SubmitOrderCommandHandler.cs"
      to: "OrderingDbContext"
      via: "DbContext.Orders.Add + SaveChangesAsync"
      pattern: "Orders\\.Add.*SaveChanges"
    - from: "OrderingEndpoints.cs"
      to: "ISender"
      via: "MediatR Send for all endpoints"
      pattern: "sender\\.Send"
    - from: "SimulatePaymentCommandHandler.cs"
      to: "Order.MarkAsPaid/MarkAsFailed"
      via: "Domain method calls based on shouldSucceed"
      pattern: "MarkAsPaid|MarkAsFailed"
---

<objective>
Create CQRS command/query handlers for order submission, payment simulation, and order retrieval, plus the OrderingEndpoints API route group.

Purpose: Provides the API layer that the checkout UI calls -- submit order, simulate payment, and retrieve order details for the confirmation page.
Output: Three working API endpoints under /api/ordering with full MediatR CQRS stack.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-ordering-checkout/07-RESEARCH.md
@.planning/phases/07-ordering-checkout/07-CONTEXT.md
@.planning/phases/07-ordering-checkout/07-01-SUMMARY.md

# Existing patterns to follow
@src/MicroCommerce.ApiService/Features/Cart/CartEndpoints.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommand.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartCommandHandler.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Commands/AddToCart/AddToCartValidator.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCart/GetCartQuery.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCart/GetCartQueryHandler.cs
@src/MicroCommerce.ApiService/Features/Cart/Application/Queries/GetCart/CartDto.cs
@src/MicroCommerce.ApiService/Features/Cart/BuyerIdentity.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: SubmitOrder command with validation and SimulatePayment command</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommand.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandHandler.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SubmitOrder/SubmitOrderCommandValidator.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SimulatePayment/SimulatePaymentCommand.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Commands/SimulatePayment/SimulatePaymentCommandHandler.cs
  </files>
  <action>
    Create CQRS commands following existing Cart/Inventory command patterns.

    **SubmitOrderCommand:**
    - Record: `SubmitOrderCommand(Guid BuyerId, string Email, ShippingAddressRequest ShippingAddress, List<OrderItemRequest> Items) : IRequest<SubmitOrderResult>`
    - Nested records: `ShippingAddressRequest(string Name, string Email, string Street, string City, string State, string ZipCode)` and `OrderItemRequest(Guid ProductId, string ProductName, decimal UnitPrice, string? ImageUrl, int Quantity)`.
    - `SubmitOrderResult(Guid OrderId, string OrderNumber)` — returned to frontend for redirect.

    **SubmitOrderCommandHandler:**
    - Inject `OrderingDbContext`.
    - Map `ShippingAddressRequest` to `ShippingAddress` value object.
    - Map `OrderItemRequest` list to the tuple format `Order.Create()` expects.
    - Call `Order.Create(...)`, add to context, `SaveChangesAsync`.
    - Return `SubmitOrderResult(order.Id.Value, order.OrderNumber.Value)`.
    - The `SaveChangesAsync` triggers domain event dispatch via existing `DomainEventInterceptor` (OrderSubmittedDomainEvent -> saga starts).

    **SubmitOrderCommandValidator (FluentValidation):**
    - `Email` — NotEmpty, valid email format.
    - `ShippingAddress` — all fields NotEmpty. ZipCode max 10 chars.
    - `Items` — NotEmpty (at least 1 item). Each item: ProductId not empty, ProductName not empty, UnitPrice > 0, Quantity 1-99.

    **SimulatePaymentCommand:**
    - Record: `SimulatePaymentCommand(Guid OrderId, bool ShouldSucceed) : IRequest<SimulatePaymentResult>`
    - `SimulatePaymentResult(bool Success, string? FailureReason)`.

    **SimulatePaymentCommandHandler:**
    - Inject `OrderingDbContext` and `IPublishEndpoint` (MassTransit).
    - Load order by ID, throw if not found.
    - If `ShouldSucceed`: call `order.MarkAsPaid()`, save. Publish `PaymentCompleted { OrderId }` message for saga.
    - If not: call `order.MarkAsFailed("Payment declined (simulated)")`, save. Publish `PaymentFailed { OrderId, Reason }` message for saga.
    - Return result.

    Remove `.gitkeep` from Application/ if still present.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` compiles. All command/handler/validator types resolve.
  </verify>
  <done>
    SubmitOrderCommand creates orders from cart items with full validation; SimulatePaymentCommand marks orders paid/failed and publishes saga events.
  </done>
</task>

<task type="auto">
  <name>Task 2: GetOrderById query and OrderingEndpoints</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/GetOrderByIdQuery.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/GetOrderByIdQueryHandler.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Queries/GetOrderById/OrderDto.cs
    src/MicroCommerce.ApiService/Features/Ordering/OrderingEndpoints.cs
  </files>
  <action>
    Create the order query and API endpoints following Cart/Inventory endpoint patterns.

    **OrderDto:**
    - Record: `OrderDto(Guid Id, string OrderNumber, string BuyerEmail, OrderStatus Status, ShippingAddressDto ShippingAddress, List<OrderItemDto> Items, decimal Subtotal, decimal ShippingCost, decimal Tax, decimal Total, DateTimeOffset CreatedAt, DateTimeOffset? PaidAt, string? FailureReason)`.
    - `ShippingAddressDto(string Name, string Email, string Street, string City, string State, string ZipCode)`.
    - `OrderItemDto(Guid Id, Guid ProductId, string ProductName, decimal UnitPrice, string? ImageUrl, int Quantity, decimal LineTotal)`.

    **GetOrderByIdQuery:**
    - Record: `GetOrderByIdQuery(Guid OrderId) : IRequest<OrderDto?>`.

    **GetOrderByIdQueryHandler:**
    - Inject `OrderingDbContext`.
    - Query `Orders.Include(o => o.Items).FirstOrDefaultAsync(o => o.Id == OrderId.From(query.OrderId))`.
    - Map to `OrderDto` or return null if not found.

    **OrderingEndpoints:**
    - Static class following `CartEndpoints` pattern.
    - Route group: `/api/ordering`.
    - `POST /checkout` — reads `BuyerId` from `BuyerIdentity.GetOrCreateBuyerId(httpContext)`, deserializes `CheckoutRequest` body (email, shipping, items from cart), creates `SubmitOrderCommand`, sends via MediatR, returns `Created` with orderId and orderNumber.
    - `POST /orders/{id:guid}/pay` — deserializes `PaymentRequest { ShouldSucceed }`, creates `SimulatePaymentCommand`, sends via MediatR, returns Ok with result.
    - `GET /orders/{id:guid}` — creates `GetOrderByIdQuery`, sends via MediatR, returns Ok or NotFound.
    - Register in Program.cs via `app.MapOrderingEndpoints()` extension method (follow existing `MapCartEndpoints` pattern).

    **CheckoutRequest DTO (in endpoints file or separate):**
    - `record CheckoutRequest(string Email, ShippingAddressRequest ShippingAddress, List<OrderItemRequest> Items)` — the Items come from the cart contents that the frontend sends.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` succeeds. `grep -r "MapOrderingEndpoints" src/MicroCommerce.ApiService/` shows registration in Program.cs and endpoint definition.
  </verify>
  <done>
    GET /api/ordering/orders/{id} returns full order DTO with items and totals. POST /api/ordering/checkout creates orders. POST /api/ordering/orders/{id}/pay simulates payment. All endpoints registered in Program.cs.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/` — zero errors
2. OrderingEndpoints registers 3 routes: POST /checkout, POST /orders/{id}/pay, GET /orders/{id}
3. SubmitOrderCommandValidator rejects: empty items, missing email, invalid shipping fields
4. SimulatePaymentCommandHandler publishes PaymentCompleted or PaymentFailed messages for saga consumption
5. GetOrderByIdQueryHandler returns OrderDto with all items, shipping address, and calculated totals
</verification>

<success_criteria>
- Three API endpoints under /api/ordering functional and registered
- Order submission creates persisted order with calculated totals
- Payment simulation publishes saga-compatible events
- Order query returns full DTO including items and shipping address
- FluentValidation rejects invalid checkout requests with proper error messages
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-ordering-checkout/07-02-SUMMARY.md`
</output>
