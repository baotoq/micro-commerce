---
phase: 07-ordering-checkout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderId.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderItemId.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderNumber.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/ShippingAddress.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderSubmittedDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderPaidDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderFailedDomainEvent.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderItemConfiguration.cs
autonomous: true

must_haves:
  truths:
    - "Order aggregate enforces invariants: items non-empty, totals calculated, status transitions valid"
    - "OrderNumber generates MC-XXXXXX format random alphanumeric codes"
    - "ShippingAddress captures name, email, street, city, state, zip as required value object"
    - "EF migration creates ordering.Orders and ordering.OrderItems tables"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs"
      provides: "Order aggregate root with Create factory, MarkAsPaid, MarkAsFailed, Confirm"
      min_lines: 60
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs"
      provides: "OrderItem entity with productId, name, price, quantity, lineTotal"
      min_lines: 20
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs"
      provides: "EF Core configuration for Order entity in ordering schema"
      min_lines: 20
  key_links:
    - from: "Order.cs"
      to: "OrderSubmittedDomainEvent"
      via: "AddDomainEvent in Create factory"
      pattern: "AddDomainEvent.*OrderSubmitted"
    - from: "OrderConfiguration.cs"
      to: "OrderingDbContext.cs"
      via: "ApplyConfigurationsFromAssembly with Features.Ordering namespace filter"
      pattern: "ApplyConfigurationsFromAssembly"
---

<objective>
Create the Order aggregate root with OrderItem entities, all value objects (OrderId, OrderItemId, OrderNumber, OrderStatus, ShippingAddress), domain events, EF Core configurations, and the initial migration for the ordering schema.

Purpose: Establishes the domain model foundation that all subsequent ordering plans depend on -- CQRS handlers, saga, and API endpoints all require these entities and database tables.
Output: Order domain model with EF persistence in ordering schema, ready for CQRS and saga integration.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ordering-checkout/07-RESEARCH.md
@.planning/phases/07-ordering-checkout/07-CONTEXT.md

# Existing patterns to follow
@src/MicroCommerce.ApiService/Features/Cart/Domain/Entities/Cart.cs
@src/MicroCommerce.ApiService/Features/Cart/Domain/ValueObjects/CartId.cs
@src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartDbContext.cs
@src/MicroCommerce.ApiService/Features/Cart/Infrastructure/Configurations/CartConfiguration.cs
@src/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/StockItemId.cs
@src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Order domain model, value objects, and domain events</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderId.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderItemId.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderNumber.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/OrderStatus.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/ValueObjects/ShippingAddress.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderSubmittedDomainEvent.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderPaidDomainEvent.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Events/OrderFailedDomainEvent.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/Order.cs
    src/MicroCommerce.ApiService/Features/Ordering/Domain/Entities/OrderItem.cs
  </files>
  <action>
    Create the Order domain model following existing aggregate patterns (Cart, Product, StockItem).

    **Value Objects:**
    - `OrderId` — StronglyTypedId<Guid> following CartId/StockItemId pattern with `New()` and `From(Guid)` factory methods.
    - `OrderItemId` — Same StronglyTypedId<Guid> pattern.
    - `OrderNumber` — sealed record with `string Value`. Static `Generate()` creates "MC-XXXXXX" using chars `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` (no ambiguous 0/O/1/I/L). `From(string)` for rehydration.
    - `OrderStatus` — enum: `Submitted`, `StockReserved`, `Paid`, `Confirmed`, `Failed`, `Cancelled`.
    - `ShippingAddress` — sealed record with `Name`, `Email`, `Street`, `City`, `State`, `ZipCode` (all required strings).

    **Domain Events (thin, ID-only per project convention):**
    - `OrderSubmittedDomainEvent(Guid OrderId)` — record implementing `IDomainEvent`.
    - `OrderPaidDomainEvent(Guid OrderId)` — same pattern.
    - `OrderFailedDomainEvent(Guid OrderId)` — same pattern.

    **OrderItem entity:**
    - Properties: `OrderItemId Id`, `OrderId OrderId`, `Guid ProductId`, `string ProductName`, `decimal UnitPrice`, `string? ImageUrl`, `int Quantity`, `decimal LineTotal` (computed: UnitPrice * Quantity).
    - Static factory: `Create(OrderId orderId, Guid productId, string productName, decimal unitPrice, string? imageUrl, int quantity)`.
    - Private constructor for EF.

    **Order aggregate root:**
    - Extends `BaseAggregateRoot<OrderId>`.
    - Properties: `OrderNumber`, `Guid BuyerId`, `string BuyerEmail`, `ShippingAddress`, `OrderStatus Status`, `decimal Subtotal`, `decimal ShippingCost`, `decimal Tax`, `decimal Total`, `DateTimeOffset CreatedAt`, `DateTimeOffset? PaidAt`, `string? FailureReason`, `[Timestamp] uint Version`, `IReadOnlyCollection<OrderItem> Items`.
    - Private `List<OrderItem> _items = []` backing field.
    - Factory: `Create(Guid buyerId, string buyerEmail, ShippingAddress address, IEnumerable<(Guid productId, string productName, decimal unitPrice, string? imageUrl, int quantity)> items)` — creates order, adds items, calculates Subtotal (sum of line totals), ShippingCost = 5.99m flat rate, Tax = Round(Subtotal * 0.08m, 2), Total = Subtotal + ShippingCost + Tax. Raises `OrderSubmittedDomainEvent`.
    - `MarkAsPaid()` — sets Status=Paid, PaidAt=UtcNow, raises `OrderPaidDomainEvent`.
    - `MarkAsFailed(string reason)` — sets Status=Failed, FailureReason=reason, raises `OrderFailedDomainEvent`.
    - `Confirm()` — sets Status=Confirmed (no event needed, saga handles downstream).
    - `MarkStockReserved()` — sets Status=StockReserved (no event, saga internal transition).

    Remove `.gitkeep` files from Domain/ and Application/ directories.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` compiles without errors. All domain types resolve correctly.
  </verify>
  <done>
    Order aggregate with factory method creates orders with calculated totals, OrderNumber generates MC-XXXXXX format, all value objects and domain events exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: EF Core configurations, DbContext update, and migration</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderConfiguration.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/OrderItemConfiguration.cs
  </files>
  <action>
    Create EF Core configurations and update OrderingDbContext following Cart/Inventory patterns.

    **OrderConfiguration:**
    - Table name "Orders" in ordering schema (inherited from DbContext default schema).
    - `HasKey(x => x.Id)` with `HasConversion` for OrderId (value converter: `v => v.Value`, `v => OrderId.From(v)`).
    - `OrderNumber` — owned or converted. Use `HasConversion(v => v.Value, v => OrderNumber.From(v))` with `HasMaxLength(10)` and unique index.
    - `BuyerId` — required, indexed.
    - `BuyerEmail` — required, max 256.
    - `ShippingAddress` — use `OwnsOne` for the value object (maps to columns: ShippingAddress_Name, ShippingAddress_Email, etc.) or use `ComplexProperty`. Follow whichever pattern is simpler. `OwnsOne` with column name overrides is preferred for clarity.
    - `Status` — store as string with `HasConversion<string>()`, max 32.
    - `Subtotal`, `ShippingCost`, `Tax`, `Total` — `HasPrecision(18, 2)`.
    - `Version` — `IsRowVersion()` for PostgreSQL xmin concurrency.
    - `HasMany(x => x.Items)` with `WithOne()` using `HasForeignKey(x => x.OrderId)` and cascade delete.
    - Index on `BuyerId` for order history lookups.
    - Index on `CreatedAt` descending for recent orders.

    **OrderItemConfiguration:**
    - Table name "OrderItems".
    - `HasKey(x => x.Id)` with OrderItemId conversion.
    - `OrderId` — conversion, required.
    - `ProductId` — required (raw Guid, no conversion — cross-module boundary).
    - `ProductName` — max 200, required.
    - `UnitPrice` — precision 18,2.
    - `ImageUrl` — max 2048, nullable.
    - `LineTotal` — precision 18,2.

    **OrderingDbContext update:**
    - Add `DbSet<Order> Orders => Set<Order>();`
    - Add `DbSet<OrderItem> OrderItems => Set<OrderItem>();`
    - Remove placeholder comments.
    - Keep existing schema and namespace-filtered configuration.
    - Do NOT add saga configuration yet (that's Plan 03).

    **Migration:**
    Run `dotnet ef migrations add InitialOrdering --project src/MicroCommerce.ApiService --context OrderingDbContext --output-dir Features/Ordering/Infrastructure/Migrations` to generate the migration.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` succeeds. Migration file exists in Features/Ordering/Infrastructure/Migrations/. `dotnet ef migrations list --project src/MicroCommerce.ApiService --context OrderingDbContext` shows InitialOrdering migration.
  </verify>
  <done>
    OrderingDbContext has Order and OrderItem DbSets, EF configurations map all properties with proper types and indexes, migration creates ordering.Orders and ordering.OrderItems tables.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/` — zero errors
2. Migration file exists at `Features/Ordering/Infrastructure/Migrations/*_InitialOrdering.cs`
3. Order.Create() produces an order with: OrderNumber (MC-XXXXXX), calculated Subtotal/Tax/ShippingCost/Total, OrderSubmittedDomainEvent raised
4. All value objects (OrderId, OrderItemId, OrderNumber, OrderStatus, ShippingAddress) have correct factories/conversions
</verification>

<success_criteria>
- Order aggregate creates orders with auto-calculated totals (subtotal + $5.99 shipping + 8% tax)
- OrderNumber generates unique MC-XXXXXX alphanumeric codes
- EF migration creates ordering.Orders and ordering.OrderItems with proper columns, indexes, and constraints
- Domain events follow thin ID-only pattern consistent with existing codebase
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-ordering-checkout/07-01-SUMMARY.md`
</output>
