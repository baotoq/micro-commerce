---
phase: 07-ordering-checkout
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Saga/CheckoutState.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Saga/CheckoutStateMachine.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Saga/Contracts.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/CheckoutStateConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ReserveStockForOrderConsumer.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/DeductStockConsumer.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ReleaseStockReservationsConsumer.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ConfirmOrderConsumer.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/OrderFailedConsumer.cs
  - src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ClearCartConsumer.cs
  - src/MicroCommerce.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "CheckoutStateMachine transitions: Initial -> Submitted -> StockReserved -> Confirmed/Failed"
    - "Failed payment releases stock reservations (compensation)"
    - "Failed stock reservation marks order as Failed"
    - "Successful payment deducts stock and confirms order"
    - "Cart is cleared after successful order confirmation"
    - "Saga state persisted in OrderingDbContext with optimistic concurrency"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Saga/CheckoutStateMachine.cs"
      provides: "MassTransit state machine with states, events, transitions, and compensation"
      min_lines: 50
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ReserveStockForOrderConsumer.cs"
      provides: "Consumer that reserves stock via Inventory module and publishes result"
      min_lines: 25
    - path: "src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/CheckoutStateConfiguration.cs"
      provides: "EF Core config for saga state table"
      min_lines: 15
  key_links:
    - from: "CheckoutStateMachine.cs"
      to: "ReserveStockForOrder"
      via: "PublishAsync on CheckoutStarted event"
      pattern: "Init<ReserveStockForOrder>"
    - from: "CheckoutStateMachine.cs"
      to: "ReleaseStockReservations"
      via: "PublishAsync on PaymentFailed compensation"
      pattern: "Init<ReleaseStockReservations>"
    - from: "Program.cs"
      to: "CheckoutStateMachine"
      via: "AddSagaStateMachine registration"
      pattern: "AddSagaStateMachine.*CheckoutStateMachine"
---

<objective>
Build the MassTransit CheckoutStateMachine saga that orchestrates the checkout flow (reserve stock -> payment -> confirm/fail), saga event contracts, EF Core saga persistence, and all integration consumers for stock reservation, deduction, release, order confirmation, and cart clearing.

Purpose: The saga is the heart of the checkout flow -- it coordinates stock reservation across the Inventory module, handles payment outcomes, ensures compensation on failures (release reservations), and clears the cart on success. Without it, checkout is a fragile chain of direct calls.
Output: Working saga state machine with all consumers, registered in MassTransit, with EF Core persistence in ordering schema.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/07-ordering-checkout/07-RESEARCH.md
@.planning/phases/07-ordering-checkout/07-CONTEXT.md
@.planning/phases/07-ordering-checkout/07-01-SUMMARY.md

# Existing patterns to follow
@src/MicroCommerce.ApiService/Program.cs
@src/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommand.cs
@src/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReserveStock/ReserveStockCommandHandler.cs
@src/MicroCommerce.ApiService/Features/Inventory/Application/Commands/ReleaseReservation/ReleaseReservationCommand.cs
@src/MicroCommerce.ApiService/Features/Inventory/Application/Commands/AdjustStock/AdjustStockCommand.cs
@src/MicroCommerce.ApiService/Features/Inventory/Domain/Entities/StockItem.cs
@src/MicroCommerce.ApiService/Features/Inventory/Infrastructure/InventoryDbContext.cs
@src/MicroCommerce.ApiService/Features/Cart/Infrastructure/CartDbContext.cs
@src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Saga state, state machine, event contracts, and EF configuration</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Application/Saga/CheckoutState.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Saga/CheckoutStateMachine.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Saga/Contracts.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/Configurations/CheckoutStateConfiguration.cs
    src/MicroCommerce.ApiService/Features/Ordering/Infrastructure/OrderingDbContext.cs
    src/MicroCommerce.ApiService/Program.cs
  </files>
  <action>
    Create the MassTransit saga state machine following patterns from 07-RESEARCH.md.

    **Contracts.cs (all saga message contracts in one file):**
    All records with `Guid OrderId` for saga correlation:
    - `CheckoutStarted { Guid OrderId, Guid BuyerId, string BuyerEmail, List<CheckoutItem> Items }` where `CheckoutItem { Guid ProductId, int Quantity }`.
    - `ReserveStockForOrder { Guid OrderId, List<CheckoutItem> Items }` — command to inventory.
    - `StockReservationCompleted { Guid OrderId, string ReservationIdsJson }` — Dict<productId, reservationId> serialized.
    - `StockReservationFailed { Guid OrderId, string Reason }`.
    - `PaymentCompleted { Guid OrderId }` — published by SimulatePaymentCommandHandler.
    - `PaymentFailed { Guid OrderId, string Reason }` — published by SimulatePaymentCommandHandler.
    - `ConfirmOrder { Guid OrderId }` — saga -> consumer to set order status Confirmed.
    - `OrderFailed { Guid OrderId, string Reason }` — saga -> consumer to set order status Failed.
    - `DeductStock { Guid OrderId, string ReservationIdsJson }` — saga -> consumer to permanently deduct stock.
    - `ReleaseStockReservations { Guid OrderId, string ReservationIdsJson }` — compensation: release all reservations.
    - `ClearCart { Guid BuyerId }` — saga -> consumer to delete cart.

    **CheckoutState (SagaStateMachineInstance):**
    - `Guid CorrelationId` (= OrderId), `string CurrentState`, `Guid OrderId`, `Guid BuyerId`, `string? BuyerEmail`, `DateTimeOffset? SubmittedAt`, `string? FailureReason`, `string? ReservationIdsJson`, `uint RowVersion`.

    **CheckoutStateMachine (MassTransitStateMachine<CheckoutState>):**
    Follow the exact pattern from 07-RESEARCH.md Pattern 2:
    - States: `Submitted`, `StockReserved`, `Failed`, `Confirmed`.
    - Events: `CheckoutStarted`, `StockReservationCompleted`, `StockReservationFailed`, `PaymentCompleted`, `PaymentFailed`. All correlated by `ctx.Message.OrderId`.
    - Flow:
      - `Initially` -> `When(CheckoutStarted)` -> store saga fields, publish `ReserveStockForOrder`, transition to `Submitted`.
      - `During(Submitted)` -> `When(StockReservationCompleted)` -> store ReservationIdsJson, transition to `StockReserved`.
      - `During(Submitted)` -> `When(StockReservationFailed)` -> store FailureReason, publish `OrderFailed`, transition to `Failed`, finalize.
      - `During(StockReserved)` -> `When(PaymentCompleted)` -> publish `ConfirmOrder`, publish `DeductStock`, publish `ClearCart { BuyerId }`, transition to `Confirmed`, finalize.
      - `During(StockReserved)` -> `When(PaymentFailed)` -> store FailureReason, publish `ReleaseStockReservations` (compensation), publish `OrderFailed`, transition to `Failed`, finalize.
    - `SetCompletedWhenFinalized()`.

    **CheckoutStateConfiguration:**
    - Table "CheckoutSagas" in ordering schema (inherited from DbContext default).
    - HasKey CorrelationId. CurrentState max 64. BuyerEmail max 256. FailureReason max 1024. ReservationIdsJson max 4096. RowVersion as IsRowVersion().

    **OrderingDbContext update:**
    - Add `DbSet<CheckoutState> CheckoutSagas => Set<CheckoutState>();`
    - The existing ApplyConfigurationsFromAssembly with Features.Ordering namespace filter will auto-pick up CheckoutStateConfiguration.

    **Program.cs update:**
    - In the `AddMassTransit(x => { ... })` block, after `x.AddConsumers(...)`, add:
      ```
      x.AddSagaStateMachine<CheckoutStateMachine, CheckoutState>()
          .EntityFrameworkRepository(r =>
          {
              r.ConcurrencyMode = ConcurrencyMode.Optimistic;
              r.ExistingDbContext<OrderingDbContext>();
              r.UsePostgres();
          });
      ```

    **Migration:**
    After updating DbContext, add a migration: `dotnet ef migrations add AddCheckoutSaga --project src/MicroCommerce.ApiService --context OrderingDbContext --output-dir Features/Ordering/Infrastructure/Migrations`.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` compiles. Migration file for CheckoutSaga exists. `grep -r "AddSagaStateMachine" src/MicroCommerce.ApiService/Program.cs` shows saga registration.
  </verify>
  <done>
    CheckoutStateMachine registered with EF Core persistence, all event contracts defined, saga transitions cover happy path and compensation paths, migration adds CheckoutSagas table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration consumers for stock, order confirmation, and cart clearing</name>
  <files>
    src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ReserveStockForOrderConsumer.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/DeductStockConsumer.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ReleaseStockReservationsConsumer.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ConfirmOrderConsumer.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/OrderFailedConsumer.cs
    src/MicroCommerce.ApiService/Features/Ordering/Application/Consumers/ClearCartConsumer.cs
  </files>
  <action>
    Create MassTransit consumers for each saga command. These consumers bridge the saga to the actual domain operations.

    **ReserveStockForOrderConsumer (IConsumer<ReserveStockForOrder>):**
    - Inject `InventoryDbContext` (cross-module read — Inventory module).
    - For each item in `message.Items`: load StockItem by ProductId, call `Reserve(quantity)`. Collect reservation IDs.
    - If all succeed: serialize Dict<productId, reservationId> to JSON, publish `StockReservationCompleted { OrderId, ReservationIdsJson }`.
    - If any fails (insufficient stock): release any already-made reservations, publish `StockReservationFailed { OrderId, Reason = "Insufficient stock for {productName}" }`.
    - Wrap in try/catch — any exception triggers `StockReservationFailed`.

    **DeductStockConsumer (IConsumer<DeductStock>):**
    - Inject `InventoryDbContext`.
    - Deserialize ReservationIdsJson to get product->reservation mapping.
    - For each: load StockItem, call existing `AdjustStock` (negative quantity matching the reserved amount) to permanently deduct. Then release the reservation (it's been converted to permanent deduction).
    - SaveChanges.

    **ReleaseStockReservationsConsumer (IConsumer<ReleaseStockReservations>):**
    - Inject `InventoryDbContext`.
    - Deserialize ReservationIdsJson.
    - For each reservation: load StockItem, call `ReleaseReservation(reservationId)`.
    - SaveChanges. This is the compensation handler.

    **ConfirmOrderConsumer (IConsumer<ConfirmOrder>):**
    - Inject `OrderingDbContext`.
    - Load Order by ID, call `Confirm()`, SaveChanges.

    **OrderFailedConsumer (IConsumer<OrderFailed>):**
    - Inject `OrderingDbContext`.
    - Load Order by ID, call `MarkAsFailed(message.Reason)` if not already failed, SaveChanges.
    - Idempotent: if order already in Failed status, skip.

    **ClearCartConsumer (IConsumer<ClearCart>):**
    - Inject `CartDbContext`.
    - Find cart by BuyerId, delete if exists. Use `ExecuteDeleteAsync` for efficiency (follows cart expiration pattern).

    All consumers are auto-discovered by the existing `x.AddConsumers(typeof(Program).Assembly)` in Program.cs — no additional registration needed.
  </action>
  <verify>
    `dotnet build src/MicroCommerce.ApiService/` compiles. All 6 consumer files exist and implement `IConsumer<T>` for their respective contract types.
  </verify>
  <done>
    All saga consumers operational: stock reservation with rollback on failure, stock deduction on payment success, reservation release on payment failure (compensation), order confirmation/failure status updates, cart clearing after confirmed order.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/` — zero errors
2. CheckoutStateMachine has transitions for all states: Initially -> Submitted -> StockReserved -> Confirmed/Failed
3. Every failure path publishes compensation events (ReleaseStockReservations)
4. ReserveStockForOrderConsumer handles partial failures (rolls back partial reservations)
5. ClearCartConsumer deletes cart by BuyerId after successful checkout
6. Saga registered in Program.cs with EntityFrameworkRepository using OrderingDbContext
7. Migration adds CheckoutSagas table to ordering schema
</verification>

<success_criteria>
- Saga state machine orchestrates full checkout flow: reserve stock -> await payment -> confirm/fail
- Compensation: payment failure releases all stock reservations via ReleaseStockReservationsConsumer
- Stock failure: marks order as failed, no orphaned reservations
- Payment success: permanently deducts stock, confirms order, clears cart
- All consumers auto-discovered by MassTransit assembly scanning
- EF Core migration adds CheckoutSagas table with optimistic concurrency
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-ordering-checkout/07-03-SUMMARY.md`
</output>
