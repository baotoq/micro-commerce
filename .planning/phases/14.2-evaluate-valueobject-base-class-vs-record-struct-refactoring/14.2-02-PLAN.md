---
phase: 14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductName.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/CategoryName.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/Money.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
  - src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/CategoryConfiguration.cs
autonomous: true

must_haves:
  truths:
    - "ProductName is a readonly record struct with structural equality and factory method validation (2-200 chars)"
    - "CategoryName is a readonly record struct with structural equality and factory method validation (2-100 chars)"
    - "Money is a readonly record struct with Amount and Currency properties, factory method validation, and ComplexProperty EF Core mapping"
    - "Product entity uses record struct value objects with no behavioral changes to Create/Update methods"
    - "Category entity uses record struct CategoryName with no behavioral changes"
    - "All EF Core mappings produce identical database columns (no migration needed)"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductName.cs"
      provides: "readonly record struct value object for product names"
      contains: "public readonly record struct ProductName"
    - path: "src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/CategoryName.cs"
      provides: "readonly record struct value object for category names"
      contains: "public readonly record struct CategoryName"
    - path: "src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/Money.cs"
      provides: "readonly record struct value object for monetary amounts"
      contains: "public readonly record struct Money"
    - path: "src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs"
      provides: "ComplexProperty mapping for Money"
      contains: "ComplexProperty"
  key_links:
    - from: "src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs"
      to: "Money.cs, ProductName.cs"
      via: "Price and Name properties, Create/Update methods"
      pattern: "(Money|ProductName)\\.(Create|From)"
    - from: "src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs"
      to: "CategoryName.cs"
      via: "Name property"
      pattern: "CategoryName\\.Create"
    - from: "ProductConfiguration.cs"
      to: "Money.cs"
      via: "ComplexProperty mapping"
      pattern: "ComplexProperty.*Price"
---

<objective>
Migrate all Catalog module value objects (ProductName, CategoryName, Money) from ValueObject base class to readonly record structs.

Purpose: These three value objects use the heavyweight ValueObject base class with reflection-based equality when C# record structs provide the same DDD semantics (immutability, structural equality) with compiler-generated equality (20x faster) and less boilerplate. Money additionally requires EF Core mapping migration from OwnsOne to ComplexProperty.

Output: Three readonly record struct value objects, updated EF Core configurations, identical database schema.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring/14.2-RESEARCH.md
@src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductName.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/CategoryName.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/Money.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
@src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
@src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
@src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/CategoryConfiguration.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ProductName and CategoryName to readonly record structs</name>
  <files>
    src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductName.cs
    src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/CategoryName.cs
    src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
    src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
  </files>
  <action>
    **ProductName.cs -- Convert to readonly record struct:**
    - Remove `using Ardalis.GuardClauses;` and `using MicroCommerce.BuildingBlocks.Common;` imports
    - Change from `public sealed class ProductName : ValueObject` to `public readonly record struct ProductName`
    - Property: `public string Value { get; init; }` (init-only)
    - Keep constants: `public const int MinLength = 2;` and `public const int MaxLength = 200;`
    - Private constructor: `private ProductName(string value) { Value = value; }`
    - Keep static factory `Create(string value)` with same validation (null/whitespace, trim, length 2-200). Replace Guard.Against calls with standard ArgumentException/ArgumentOutOfRangeException to remove Ardalis dependency from this file, OR keep Ardalis if other files in Catalog still use it. Recommend keeping Ardalis for consistency with codebase style.
    - Remove `GetEqualityComponents()` override
    - Keep `ToString()` override: `public override string ToString() => Value;`
    - Keep implicit operator: `public static implicit operator string(ProductName name) => name.Value;`

    **CategoryName.cs -- Convert to readonly record struct (same pattern as ProductName):**
    - Remove `using MicroCommerce.BuildingBlocks.Common;` import (keep Ardalis)
    - Change from `public sealed class CategoryName : ValueObject` to `public readonly record struct CategoryName`
    - Property: `public string Value { get; init; }`
    - Keep constants: MinLength = 2, MaxLength = 100
    - Private constructor + Create factory with same validation
    - Remove `GetEqualityComponents()` override
    - Keep `ToString()` and implicit operator

    **Product.cs -- Update for struct value objects:**
    - Change `public ProductName Name { get; private set; } = null!;` to `public ProductName Name { get; private set; }` (structs cannot be null, remove null-forgiving operator)
    - Change `public Money Price { get; private set; } = null!;` to `public Money Price { get; private set; }` (will be migrated to struct in Task 2, but update now to avoid double-edit)
    - No other changes -- `ProductName.Create()` and `Money.Create()` calls work identically

    **Category.cs -- Update for struct CategoryName:**
    - Read Category.cs to check for `null!` patterns on CategoryName property
    - Remove any `null!` default on the CategoryName property (structs cannot be null)
    - No other changes needed

    **EF Core configurations -- No changes needed for ProductName and CategoryName:**
    - Both use HasConversion (value converter) pattern, not OwnsOne. HasConversion works with both class and struct types. The conversion lambdas `name => name.Value` and `value => ProductName.Create(value)` work identically with readonly record struct.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` -- must compile with zero errors.
    Verify ProductName.cs contains `public readonly record struct ProductName`.
    Verify CategoryName.cs contains `public readonly record struct CategoryName`.
    Verify Product.cs has no `null!` on Name or Price properties.
    Verify no `GetEqualityComponents` remains in ProductName.cs or CategoryName.cs.
  </verify>
  <done>
    ProductName and CategoryName are readonly record structs. Product and Category entities compile with struct properties (no null-forgiving operators). HasConversion EF Core mappings work unchanged. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Money to readonly record struct with ComplexProperty</name>
  <files>
    src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/Money.cs
    src/MicroCommerce.ApiService/Features/Catalog/Infrastructure/Configurations/ProductConfiguration.cs
  </files>
  <action>
    **Money.cs -- Convert to readonly record struct:**
    - Remove `using MicroCommerce.BuildingBlocks.Common;` import (keep Ardalis.GuardClauses)
    - Change from `public sealed class Money : ValueObject` to `public readonly record struct Money`
    - Properties: `public decimal Amount { get; init; }` and `public string Currency { get; init; }` (init-only)
    - Private constructor: `private Money(decimal amount, string currency) { Amount = amount; Currency = currency; }`
    - Keep static factory `Create(decimal amount, string currency = "USD")` with same Guard.Against validation
    - Remove `GetEqualityComponents()` override entirely
    - Keep `ToString()` override: `public override string ToString() => $"{Currency} {Amount:F2}";`
    - Keep `Format()` method: `public string Format() => Amount.ToString("C2", System.Globalization.CultureInfo.GetCultureInfo("en-US"));`

    **ProductConfiguration.cs -- Migrate Money from OwnsOne to ComplexProperty:**
    Change the Price mapping from:
    ```csharp
    builder.OwnsOne(p => p.Price, priceBuilder =>
    {
        priceBuilder.Property(m => m.Amount)
            .HasColumnName("Price")
            .HasPrecision(18, 2)
            .IsRequired();

        priceBuilder.Property(m => m.Currency)
            .HasColumnName("PriceCurrency")
            .HasMaxLength(3)
            .HasDefaultValue("USD")
            .IsRequired();
    });
    ```
    To:
    ```csharp
    builder.ComplexProperty(p => p.Price, priceBuilder =>
    {
        priceBuilder.Property(m => m.Amount)
            .HasColumnName("Price")
            .HasPrecision(18, 2)
            .IsRequired();

        priceBuilder.Property(m => m.Currency)
            .HasColumnName("PriceCurrency")
            .HasMaxLength(3)
            .HasDefaultValue("USD")
            .IsRequired();
    });
    ```

    The database columns remain identical (Price decimal(18,2) and PriceCurrency varchar(3)). ComplexProperty is the correct EF Core 8+ mapping for struct value objects -- it does not create a hidden shadow primary key like OwnsOne does.

    **Note on HasDefaultValue:** ComplexProperty may not support HasDefaultValue the same way as OwnsOne. If build fails on this, remove `.HasDefaultValue("USD")` and ensure the Money.Create factory always provides currency (it does -- defaults to "USD").
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` -- must compile with zero errors.
    Verify Money.cs contains `public readonly record struct Money`.
    Verify ProductConfiguration.cs contains `ComplexProperty` for Price (not `OwnsOne`).
    Verify no `GetEqualityComponents` remains in Money.cs.
  </verify>
  <done>
    Money is a readonly record struct with Amount and Currency properties, factory method, and Format() helper. ProductConfiguration uses ComplexProperty mapping with identical database columns. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` succeeds with zero errors
2. No file in the Catalog module imports `MicroCommerce.BuildingBlocks.Common` for ValueObject inheritance (may still import for StronglyTypedId -- that is correct)
3. All three value objects (ProductName, CategoryName, Money) are `readonly record struct`
4. ProductConfiguration uses ComplexProperty for Money, HasConversion for ProductName (unchanged)
5. CategoryConfiguration uses HasConversion for CategoryName (unchanged)
6. Product and Category entities have no `null!` on struct value object properties
</verification>

<success_criteria>
- ProductName, CategoryName, Money are all readonly record structs
- EF Core Money mapping uses ComplexProperty instead of OwnsOne
- EF Core ProductName/CategoryName mappings use HasConversion (unchanged)
- No ValueObject base class references remain in Catalog value objects
- Full project builds successfully
- Database column layout unchanged (no migration needed)
</success_criteria>

<output>
After completion, create `.planning/phases/14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring/14.2-02-SUMMARY.md`
</output>
