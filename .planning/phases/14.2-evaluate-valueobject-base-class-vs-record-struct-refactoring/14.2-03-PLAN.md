---
phase: 14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring
plan: 03
type: execute
wave: 2
depends_on: ["14.2-01", "14.2-02"]
files_modified:
  - src/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/Quantity.cs
  - src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs
autonomous: true

must_haves:
  truths:
    - "Quantity is a readonly record struct with non-negative validation"
    - "ValueObject base class is marked [Obsolete] with a message directing to record struct or record class patterns"
    - "No value object in the codebase inherits from ValueObject anymore"
    - "Full project builds with zero errors (obsolete warnings are acceptable)"
    - "All 13 strongly-typed IDs still compile correctly (they use StronglyTypedId, not ValueObject)"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/Quantity.cs"
      provides: "readonly record struct value object for quantities"
      contains: "public readonly record struct Quantity"
    - path: "src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs"
      provides: "Deprecated ValueObject base class with Obsolete attribute"
      contains: "[Obsolete"
  key_links:
    - from: "ValueObject.cs"
      to: "No consumers"
      via: "Obsolete attribute prevents new usage"
      pattern: "\\[Obsolete"
---

<objective>
Migrate orphaned Quantity value object and deprecate the ValueObject base class.

Purpose: After Plans 01 and 02 remove all ValueObject inheritance from Address, DisplayName, ProductName, CategoryName, and Money, the base class has zero consumers. Quantity exists as a defined-but-unused value object that should still be modernized. The ValueObject base class should be formally deprecated with [Obsolete] to prevent future usage, while being retained for backward compatibility.

Output: Quantity as readonly record struct, ValueObject marked [Obsolete], clean build confirming zero ValueObject consumers.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring/14.2-RESEARCH.md
@src/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/Quantity.cs
@src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Quantity to readonly record struct and deprecate ValueObject base class</name>
  <files>
    src/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/Quantity.cs
    src/BuildingBlocks/BuildingBlocks.Common/ValueObject.cs
  </files>
  <action>
    **Quantity.cs -- Convert to readonly record struct:**
    - Remove `using MicroCommerce.BuildingBlocks.Common;` import
    - Change from `public sealed class Quantity : ValueObject` to `public readonly record struct Quantity`
    - Property: `public int Value { get; init; }`
    - Private constructor: `private Quantity(int value) { Value = value; }`
    - Keep static factory `From(int value)` with same validation (value < 0 throws ArgumentException)
    - Remove `GetEqualityComponents()` override entirely

    Note: Quantity is currently not used by any entity in the codebase. StockItem uses raw `int QuantityOnHand`. The value object exists but is orphaned. Still convert it for consistency and potential future use.

    **ValueObject.cs -- Add [Obsolete] attribute:**
    - Add `[Obsolete("Use 'readonly record struct' for simple value objects or 'record class' for value objects requiring custom equality. See 14.2-RESEARCH.md for migration patterns.")]` attribute to the class declaration
    - Keep the entire class implementation intact (do not delete methods or change behavior)
    - This preserves backward compatibility while clearly signaling that new code should use record patterns

    The project has `TreatWarningsAsErrors` enabled globally. Since no code inherits from ValueObject after Plans 01 and 02, the [Obsolete] attribute will not cause build errors. If any file still has `using MicroCommerce.BuildingBlocks.Common` but does not actually use ValueObject (only uses StronglyTypedId or other types from the namespace), those imports are fine -- they do not trigger obsolete warnings.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` -- must compile with zero errors.
    Run `dotnet build src/BuildingBlocks/BuildingBlocks.Common/BuildingBlocks.Common.csproj` -- must compile with zero errors.
    Verify Quantity.cs contains `public readonly record struct Quantity`.
    Verify ValueObject.cs contains `[Obsolete` attribute on the class.
    Run a grep for `: ValueObject` across the entire src/ directory -- must return zero matches (confirming no consumers remain).
  </verify>
  <done>
    Quantity is a readonly record struct. ValueObject base class has [Obsolete] attribute. Zero classes inherit from ValueObject anywhere in the codebase. Full project builds with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final verification and cleanup of unused ValueObject imports</name>
  <files>
    src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/Money.cs
    src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/ProductName.cs
    src/MicroCommerce.ApiService/Features/Catalog/Domain/ValueObjects/CategoryName.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs
    src/MicroCommerce.ApiService/Features/Inventory/Domain/ValueObjects/Quantity.cs
  </files>
  <action>
    **Verify no ValueObject references remain in migrated files:**
    Scan all 6 migrated value object files and confirm that none of them contain `using MicroCommerce.BuildingBlocks.Common;` for ValueObject purposes. Files that still need this import for other types (like StronglyTypedId-based IDs in the same namespace) should keep it, but the 6 value object files themselves should not need it.

    Files to check and remove `using MicroCommerce.BuildingBlocks.Common;` if present:
    1. Money.cs -- should only have `using Ardalis.GuardClauses;` and namespace
    2. ProductName.cs -- should only have `using Ardalis.GuardClauses;` and namespace
    3. CategoryName.cs -- should only have `using Ardalis.GuardClauses;` and namespace
    4. DisplayName.cs -- should only have namespace (no external using needed)
    5. Address.cs -- should only have namespace (no external using needed)
    6. Quantity.cs -- should only have namespace (no external using needed)

    **Run full build to confirm everything works together after all 3 plans:**
    `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj`

    **Produce a final summary grep confirming the migration is complete:**
    - Grep for `: ValueObject` in src/ -- expect zero matches
    - Grep for `readonly record struct` in value object files -- expect matches in Money, ProductName, CategoryName, DisplayName, Quantity (5 files)
    - Grep for `sealed record` in Reviews value objects -- expect matches in Rating, ReviewText (2 files, already record class, not in scope)
    - Grep for `sealed record ShippingAddress` in Ordering -- expect match (already record class, not in scope)
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` -- zero errors.
    Grep for `: ValueObject` in src/ returns zero results.
    Grep for `readonly record struct` in Features/*/Domain/ValueObjects/*.cs returns 5 matches (Money, ProductName, CategoryName, DisplayName, Quantity).
    ValueObject.cs has [Obsolete] attribute.
  </verify>
  <done>
    Complete migration verified: 5 value objects converted to readonly record struct, 1 Address promoted to plain entity class, ValueObject base class deprecated. Zero consumers of ValueObject remain. Full project builds cleanly. Migration is complete.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for entire project with zero errors
2. Zero classes inherit from ValueObject (`grep ': ValueObject'` returns nothing in src/)
3. ValueObject.cs has [Obsolete] attribute
4. Five value objects are readonly record struct: Money, ProductName, CategoryName, DisplayName, Quantity
5. Address is a plain sealed class (entity, not value object)
6. Three record class value objects remain unchanged: Rating, ReviewText, ShippingAddress (correct -- not in migration scope)
7. All 13 strongly-typed IDs compile correctly (use StronglyTypedId, unaffected)
</verification>

<success_criteria>
- Zero ValueObject consumers in the codebase
- ValueObject base class deprecated with [Obsolete]
- Quantity is a readonly record struct
- All unused imports cleaned up from migrated files
- Full project builds with zero errors
- Phase 14.2 migration is complete
</success_criteria>

<output>
After completion, create `.planning/phases/14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring/14.2-03-SUMMARY.md`
</output>
