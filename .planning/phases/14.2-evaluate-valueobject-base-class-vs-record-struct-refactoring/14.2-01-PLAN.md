---
phase: 14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs
  - src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
autonomous: true

must_haves:
  truths:
    - "Address no longer inherits from ValueObject -- it is a plain owned entity class with identity and mutators"
    - "DisplayName is a readonly record struct with structural equality and factory method validation"
    - "UserProfile aggregate still manages addresses and display name exactly as before (no behavioral changes)"
    - "EF Core mapping for DisplayName uses ComplexProperty instead of OwnsOne"
    - "All existing functionality (add/update/delete address, set default, update display name) works unchanged"
  artifacts:
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs"
      provides: "Owned entity class without ValueObject inheritance"
      contains: "public sealed class Address"
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs"
      provides: "readonly record struct value object"
      contains: "public readonly record struct DisplayName"
    - path: "src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs"
      provides: "Updated EF Core mapping for DisplayName"
      contains: "ComplexProperty"
  key_links:
    - from: "src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs"
      to: "Address.cs"
      via: "AddAddress, UpdateAddress, DeleteAddress, SetDefaultAddress methods"
      pattern: "Address\\.Create"
    - from: "src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs"
      to: "DisplayName.cs"
      via: "DisplayName property and UpdateDisplayName method"
      pattern: "DisplayName\\.Create"
---

<objective>
Fix Address DDD violation and migrate DisplayName to readonly record struct in the Profiles module.

Purpose: Address currently inherits from ValueObject but has identity (AddressId) and mutators (SetAsDefault, ClearDefault), which is a critical DDD modeling violation identified in Phase 14.1 audit. DisplayName is a simple single-value wrapper that should use modern C# record struct semantics instead of the heavyweight ValueObject base class.

Output: Address as a plain owned entity class, DisplayName as a readonly record struct, updated EF Core configuration.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring/14.2-RESEARCH.md
@src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs
@src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs
@src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs
@src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Promote Address from ValueObject to plain owned entity class</name>
  <files>
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs
  </files>
  <action>
    Remove the `ValueObject` base class inheritance from Address. Address already has identity (AddressId), mutators (SetAsDefault, ClearDefault), and is mapped via OwnsMany with a HasKey -- it IS an entity, not a value object.

    Specific changes to Address.cs:
    1. Remove `using MicroCommerce.BuildingBlocks.Common;` import
    2. Change `public sealed class Address : ValueObject` to `public sealed class Address`
    3. Remove the entire `GetEqualityComponents()` override method (lines yielding Street, City, State, ZipCode, Country)
    4. Keep everything else exactly as-is: AddressId, all properties, private constructors, Create factory method, SetAsDefault(), ClearDefault()

    No changes needed to UserProfileConfiguration.cs for Address -- the OwnsMany mapping with HasKey(nameof(Address.Id)) already treats Address as an owned entity with identity, which is the correct EF Core pattern.

    No changes needed to UserProfile.cs -- all address management methods (AddAddress, UpdateAddress, DeleteAddress, SetDefaultAddress) work with Address as a plain class identically to how they worked with ValueObject inheritance.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` -- must compile with zero errors and zero warnings related to Address.
    Grep for `: ValueObject` in Address.cs -- must not appear.
    Grep for `GetEqualityComponents` in Address.cs -- must not appear.
  </verify>
  <done>
    Address.cs is a plain sealed class with no base class. It retains AddressId, all properties, Create factory, SetAsDefault/ClearDefault mutators. No ValueObject inheritance or equality component overrides. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate DisplayName from ValueObject to readonly record struct</name>
  <files>
    src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs
    src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs
  </files>
  <action>
    **DisplayName.cs -- Convert to readonly record struct:**
    Replace the entire file with a readonly record struct implementation:
    - Remove `using MicroCommerce.BuildingBlocks.Common;` import
    - Change from `public sealed class DisplayName : ValueObject` to `public readonly record struct DisplayName`
    - Property: `public string Value { get; init; }` (init-only, not private set)
    - Keep the private constructor: `private DisplayName(string value) { Value = value; }`
    - Keep the static factory method `Create(string value)` with the same validation logic (null/whitespace check, trim, length 2-50)
    - Remove `GetEqualityComponents()` override entirely -- record struct generates structural equality automatically
    - Keep the same namespace

    **UserProfileConfiguration.cs -- Update DisplayName mapping:**
    Change the DisplayName mapping from OwnsOne to ComplexProperty. The current mapping:
    ```csharp
    builder.OwnsOne(p => p.DisplayName, displayName =>
    {
        displayName.Property(d => d.Value)
            .HasColumnName("DisplayName")
            .IsRequired()
            .HasMaxLength(50);
    });
    ```
    Replace with:
    ```csharp
    builder.ComplexProperty(p => p.DisplayName, displayName =>
    {
        displayName.Property(d => d.Value)
            .HasColumnName("DisplayName")
            .IsRequired()
            .HasMaxLength(50);
    });
    ```

    **Important:** The database column layout does NOT change (still `DisplayName` column with same type/constraints), so no EF Core migration is needed. ComplexProperty maps to the same columns as OwnsOne for single-value types, but without the hidden shadow key that OwnsOne creates.

    **UserProfile.cs -- No changes needed.** The `DisplayName.Create(displayName)` calls in UserProfile work identically with readonly record struct. The property type `DisplayName` is still the same name. The null-forgiving assignment `DisplayName = null!` in the EF Core constructor will need adjustment since structs cannot be null -- change to `DisplayName = default` or remove the null-forgiving operator. Check this during build and fix if needed.

    **Note on UserProfile.cs DisplayName default:** Since DisplayName becomes a struct, the EF Core private constructor line `DisplayName = null!;` will cause a compiler error. Update it to `DisplayName = default;` in UserProfile.cs. This is safe because EF Core will overwrite it when materializing from the database.
  </action>
  <verify>
    Run `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` -- must compile with zero errors.
    Verify DisplayName.cs contains `public readonly record struct DisplayName`.
    Verify UserProfileConfiguration.cs contains `ComplexProperty` for DisplayName (not `OwnsOne`).
    Verify UserProfile.cs no longer has `null!` for DisplayName initialization.
  </verify>
  <done>
    DisplayName is a readonly record struct with factory method validation. EF Core mapping uses ComplexProperty. UserProfile compiles correctly with struct DisplayName (no null-forgiving operator). Build succeeds with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MicroCommerce.ApiService/MicroCommerce.ApiService.csproj` succeeds with zero errors
2. No file in the Profiles module imports or references `ValueObject` base class
3. Address.cs has no base class inheritance
4. DisplayName.cs is `readonly record struct`
5. UserProfileConfiguration.cs uses `ComplexProperty` for DisplayName
</verification>

<success_criteria>
- Address is a plain sealed class without ValueObject inheritance, retaining identity and mutators
- DisplayName is a readonly record struct with init-only Value property and Create factory
- EF Core configuration updated to use ComplexProperty for DisplayName
- Full project builds successfully
- No behavioral changes to UserProfile aggregate operations
</success_criteria>

<output>
After completion, create `.planning/phases/14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring/14.2-01-SUMMARY.md`
</output>
