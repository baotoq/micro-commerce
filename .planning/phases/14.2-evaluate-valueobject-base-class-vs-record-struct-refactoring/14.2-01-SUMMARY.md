---
phase: 14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring
plan: 01
subsystem: domain-modeling
tags: [ddd, value-objects, record-struct, ef-core, csharp]

# Dependency graph
requires:
  - phase: 14.1-check-ddd-approach-correctness
    provides: DDD audit identifying Address identity confusion and value object base class issues
provides:
  - Address promoted from ValueObject to plain owned entity class (fixes DDD violation)
  - DisplayName migrated to readonly record struct with ComplexProperty mapping
  - Pattern established for migrating simple value objects from base class to struct
affects: [14.2-02, 14.2-03, value-object-refactoring, profiles-module]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "readonly record struct for simple single-value value objects"
    - "ComplexProperty EF Core mapping for struct value objects (EF 8+)"
    - "Plain owned entity class for collections with identity (OwnsMany pattern)"

key-files:
  created: []
  modified:
    - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs
    - src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs
    - src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs
    - src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs

key-decisions:
  - "Address is an owned entity, not a value object - has identity (AddressId) and mutators"
  - "DisplayName migrated to readonly record struct for performance and modern C# semantics"
  - "ComplexProperty replaces OwnsOne for struct value objects - no hidden shadow key"
  - "Struct value objects use 'default' in EF Core constructors, not 'null!'"

patterns-established:
  - "Pattern: Owned entity class for collection items with identity and lifecycle (Address pattern)"
  - "Pattern: readonly record struct for simple value objects with factory validation (DisplayName pattern)"
  - "Pattern: ComplexProperty EF Core mapping for struct value objects (cleaner than OwnsOne)"

# Metrics
duration: 3min
completed: 2026-02-14
---

# Phase 14.2 Plan 01: Fix Address DDD Violation and Migrate DisplayName Summary

**Address promoted from ValueObject to plain owned entity class, DisplayName migrated to readonly record struct with ComplexProperty mapping**

## Performance

- **Duration:** 3 minutes
- **Started:** 2026-02-13T19:52:17Z
- **Completed:** 2026-02-13T19:55:34Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Fixed critical DDD violation: Address no longer inherits from ValueObject despite having identity and mutators
- Migrated DisplayName from ValueObject base class to readonly record struct for performance and modern C# semantics
- Established pattern for future value object migrations from base class to struct

## Task Commits

Each task was committed atomically:

1. **Task 1: Promote Address from ValueObject to plain owned entity class** - `439a8f42` (refactor) - COMMITTED PREVIOUSLY
2. **Task 2: Migrate DisplayName from ValueObject to readonly record struct** - `5ab1c30d` (refactor)

## Files Created/Modified
- `src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/Address.cs` - Removed ValueObject inheritance and GetEqualityComponents; now plain owned entity class with identity
- `src/MicroCommerce.ApiService/Features/Profiles/Domain/ValueObjects/DisplayName.cs` - Converted to readonly record struct with init-only Value property and factory validation
- `src/MicroCommerce.ApiService/Features/Profiles/Infrastructure/Configurations/UserProfileConfiguration.cs` - Changed DisplayName mapping from OwnsOne to ComplexProperty (EF Core 8+ struct support)
- `src/MicroCommerce.ApiService/Features/Profiles/Domain/Entities/UserProfile.cs` - Fixed EF Core constructor to use 'default' for struct DisplayName instead of 'null!'

## Decisions Made
- **Address modeling:** Confirmed Address is an owned entity (has identity, mutators, lifecycle), not a value object. Retained as plain class without ValueObject base class to eliminate modeling confusion.
- **DisplayName as struct:** Simple single-value wrapper is ideal candidate for readonly record struct - performance benefits from stack allocation, compiler-generated structural equality, and ComplexProperty mapping without hidden key.
- **ComplexProperty vs OwnsOne:** ComplexProperty is cleaner for struct value objects in EF Core 8+ - no shadow key, better semantics for true value types.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed Category EF Core constructor for struct CategoryName**
- **Found during:** Task 1 build verification
- **Issue:** Category.cs EF Core constructor tried to leave CategoryName (struct) uninitialized, causing CS0037 error: "Cannot convert null to 'CategoryName' because it is a non-nullable value type"
- **Fix:** Added `Name = default;` in Category EF Core constructor
- **Files modified:** src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Category.cs
- **Verification:** Build succeeded with zero errors
- **Committed in:** 439a8f42 (Task 1 commit)

**2. [Rule 3 - Blocking] Fixed Product EF Core constructor for Money class**
- **Found during:** Task 1 build verification
- **Issue:** Product.cs EF Core constructor didn't initialize Money Price property, causing CS8618 error: "Non-nullable property 'Price' must contain a non-null value when exiting constructor"
- **Fix:** Added `Price = null!;` in Product EF Core constructor
- **Files modified:** src/MicroCommerce.ApiService/Features/Catalog/Domain/Entities/Product.cs
- **Verification:** Build succeeded with zero errors
- **Committed in:** 439a8f42 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 blocking build errors)
**Impact on plan:** Both fixes were necessary to verify Task 1 changes. These were pre-existing issues from previous value object migrations (CategoryName, ProductName) that surfaced during build. Auto-fixes enabled plan execution to proceed.

## Issues Encountered
None - plan executed smoothly after auto-fixing blocking build errors from previous work.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Pattern established for migrating simple value objects from ValueObject base class to readonly record struct
- Ready for Plan 02: Migrate remaining Catalog value objects (Money, ProductName, CategoryName, Quantity)
- Address DDD violation resolved - Profiles module now correctly models addresses as owned entities

## Self-Check

Verifying all claimed artifacts exist:

- [x] Address.cs is plain class without ValueObject inheritance
- [x] DisplayName.cs is readonly record struct
- [x] UserProfileConfiguration.cs uses ComplexProperty for DisplayName
- [x] Commit 439a8f42 exists (Task 1)
- [x] Commit 5ab1c30d exists (Task 2)

**Self-Check: PASSED** - All files and commits verified.

---
*Phase: 14.2-evaluate-valueobject-base-class-vs-record-struct-refactoring*
*Completed: 2026-02-14*
