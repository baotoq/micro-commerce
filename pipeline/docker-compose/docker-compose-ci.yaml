version: "3"
services:
  sqldb:
    image: mcr.microsoft.com/mssql/server:2017-latest
    environment:
      - SA_PASSWORD=P@ssw0rd
      - ACCEPT_EULA=Y
    volumes:
      - sqldb-data:/var/opt/mssql
    networks:
      - backend

  identity-api:
    image: identity-api
    build:
      context: ../../src
      dockerfile: Identity.API/Dockerfile
    depends_on:
      - sqldb
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings:DefaultConnection=Server=sqldb,1433;Database=identity-api;User Id=sa;Password=P@ssw0rd;
      - Client:Swagger:Uri:0=https://bshop-catalog.azurewebsites.net
      - Client:Swagger:Uri:1=https://bshop-identity.azurewebsites.net
      - Client:React:Uri=https://bshop.azurewebsites.net
    networks:
      - backend
      - frontend

  catalog-api:
    image: catalog-api
    build:
      context: ../../src
      dockerfile: Catalog.API/Dockerfile
    depends_on:
      - sqldb
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings:DefaultConnection=Server=sqldb,1433;Database=catalog-api;User Id=sa;Password=P@ssw0rd;
      - Identity:Uri=https://bshop-identity.azurewebsites.net
    ports:
      - "${CATALOG_API_PORT}:80"
    networks:
      - backend
      - frontend

  react-web:
    image: react-web
    build:
      context: ../../src
      dockerfile: React.Web/Dockerfile
      args:
        - REACT_APP_IDENTITY_URI=https://bshop-identity.azurewebsites.net
        - REACT_APP_CATALOG_URI=https://bshop-catalog.azurewebsites.net
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
    networks:
      - frontend

volumes:
  sqldb-data:

networks:
  frontend:
  backend: